å¦‚ä½•é«˜æ•ˆçš„ä½¿ç”¨ `context`, [ä¸Šä¸€ç¯‡æ–‡ç« ](https://lanyincao.netlify.com/posts/2019-08-19/form/) è¯¦ç»†çš„è®²è¿°äº†å¦‚ä½•å†™ä¸€ä¸ª `Form`, ä»¥åŠå¦‚ä½•æ”¹é€  `Form` çš„æ€§èƒ½ã€‚é‚£ä¹ˆæ˜¯å¦åŒæ ·çš„
å†™æ³•ä¹Ÿå¯ä»¥è¿ç”¨äºæ™®é€šç»„ä»¶å‘¢ï¼Ÿ

# å›é¡¾ context

[åœ¨ context æ–‡ç« ä¸­](https://lanyincao.netlify.com/posts/2019-08-10/context/)è®²äº†å…·ä½“çš„ç”¨æ³•, åŒæ—¶ä¹Ÿè®²äº† `Hook` ä¸­å’Œ `Class` ä¸­ä½¿ç”¨ `Context` çš„åŒºåˆ«ã€‚åŒæ—¶ä¹Ÿè¯´è¿‡åœ¨ä½¿ç”¨ `Context` çš„
ä¸€äº›é—®é¢˜ã€‚è¿™æ ·çš„é—®é¢˜è¯¥å¦‚ä½•å»è§£å†³å‘¢ï¼Ÿåœ¨ `Form` ä¸­çš„æ–¹æ¡ˆæ˜¯å¦å¯ä»¥å¤ç”¨åˆ°å…¶ä»–æ™®é€šçš„ç»„ä»¶ä¸­å‘¢ï¼Ÿ

# react-redux

[react-redux](https://github.com/reduxjs/react-redux) æ˜¯ç”± [redux](https://github.com/reduxjs/redux) å»¶ä¼¸å‡ºæ¥çš„ï¼Œç”¨äº react ä¸­çš„çŠ¶æ€ç®¡ç†åº“ï¼ŒçŠ¶æ€ç®¡ç†åœ¨ `2018` å¹´æ˜¯éå¸¸éå¸¸çš„ç«ï¼ŒåŒæ—¶
ä¹Ÿå»¶ä¼¸å‡ºäº†ä¸€å¤§æ‰¹çŠ¶æ€ç®¡ç†çš„åº“æ¯”å¦‚ [mobx](https://github.com/mobxjs/mobx), [dva](https://github.com/dvajs/dva) ç­‰ç­‰éƒ½æ˜¯éå¸¸ä¼˜ç§€çš„åº“ã€‚`react-redux` åœ¨å¾ˆå¤šé¡¹ç›®ä¸­éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“ã€‚é‚£ä¹ˆè¿™ä¸ªåº“æ˜¯å¦å­˜åœ¨åŒæ ·çš„
é—®é¢˜å‘¢ï¼Ÿä¸å¦¨ç”¨ä¸€ä¸ªç®€å•çš„ demo æ¥çœ‹ä¸€ä¸‹ã€‚

`react-redux-demo`

ä» `console.log` ä¸­å¯ä»¥çœ‹å‡ºåœ¨ä¿®æ”¹ count çš„æ—¶å€™åªæœ‰ `Count` ç»„ä»¶æ›´æ–°ï¼Œåœ¨ä¿®æ”¹ `person` çš„æ—¶å€™åªæœ‰ `Person` ç»„ä»¶æ›´æ–°ã€‚å› ä¸ºæ— è®ºæ˜¯ `Count` è¿˜æ˜¯ `Person`ï¼Œ
éƒ½åœ¨è‡ªå·±æ‰€éœ€è¦çš„ `props` å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰ä¼šæ›´æ–°ã€‚è¿™ä¸ªæ˜¯ç¬¦åˆ `React` çš„æ­£å¸¸çš„æ•°æ®æµçš„ï¼Œç»„ä»¶çš„ `props` å˜åŒ–ä¼šè®©ç»„ä»¶å‘ç”Ÿæ›´æ–°ã€‚

é‚£ä¹ˆæ˜¯å¦ `connect` æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œå‘¢ï¼Ÿ`connect` æ˜¯ä¸€ä¸ª `HOC`, ä¼šè¿”å›æ–°çš„ç»„ä»¶ï¼Œé‚£ä¸å¦¨åœ¨ `mapStateToProps` ä¸­åŠ å…¥ `console.log`

`mapCountStateToProps`

```js
function mapCountStateToProps(state) {
  console.log('mapCountStateToProps', state);
  const { count } = state;
  return { count };
}
```

`mapPersonStateToProps`

```js
function mapPersonStateToProps(state) {
  console.log('mapPersonStateToProps', state);
  const { name, address } = state;
  return { name, address };
}
```

`Count`

```js
class Count extends React.Component<any, any> {
  render() {
    const { dispatch } = this.props;
    console.log('render count');
    return (
      <div>
        <div>count: {this.props.count}</div>
        <button onClick={() => dispatch({ type: 'increase', payload: 2 })}>
          increase
        </button>
        <button onClick={() => dispatch({ type: 'decrease', payload: 2 })}>
          decrease
        </button>
      </div>
    );
  }
}
```

`Person`

```js
class Person extends React.Component<any> {
  render() {
    const { dispatch, name, address } = this.props;
    console.log('render person');
    return (
      <div>
        <div>
          <span>name: {name}</span>
          <span style={{ marginLeft: 20 }}>address: {address}</span>
        </div>
        <div>
          <button
            onClick={() => dispatch({ type: 'updateName', payload: 'ç‰§äº‘äº‘' })}
          >
            updateName
          </button>
          <button
            onClick={() =>
              dispatch({ type: 'updateAddress', payload: 'hangzhou' })
            }
          >
            updateAddress
          </button>
        </div>
      </div>
    );
  }
}
```

ç‚¹å‡» `increase` æˆ–è€… `decrease` æŒ‰é’®ï¼Œçœ‹ä¸€ä¸‹æ§åˆ¶å°

<div>
  <img src='./context1.jpg' />
</div>

ä»”ç»†è§‚å¯Ÿä¸‹å‘ç° `render count` æ˜¯æ­£å¸¸çš„æ¸²æŸ“ï¼Œå› ä¸ºç‚¹å‡»äº† `increase` æˆ–è€… `decrease`, ä½†æ˜¯ `mapCountStateToProps` ä»¥åŠ
`mapPersonStateToProps` æ¯æ¬¡éƒ½ä¼šè¢«è¾“å‡ºï¼Œå³ä½¿åªæ›´æ–°äº† `count` ç»„ä»¶çš„ `props`, å…¶å®è¿™ä¸ªå¤§å®¶ä¸åŒå¤ªè¿‡äºå…³å¿ƒï¼Œæˆ‘ä¹‹å‰åœ¨ `twitter` ä¸Š
é—®è¿‡ `Dan`, å…³äºæ¸²æŸ“æ¬¡æ•°çš„é—®é¢˜ï¼Œ `Dan` çš„å›ç­”å°±æ˜¯ä¸è¦å¤ªè¿‡åœ¨æ„ `render` æ¬¡æ•°è¿™æ˜¯å†…éƒ¨çš„å®ç°ç»†èŠ‚äº†ã€‚é‚£è¿™ä¸ªåœ°æ–¹ä¼šæœ‰å½±å“å—ï¼Ÿ

`connect` åªæ˜¯ä¸€ä¸ªæ™®é€šçš„é«˜é˜¶ç»„ä»¶ï¼Œä¸å¦¨çœ‹ä¸€ä¸‹ `connect` çš„æºç 

```js
export function createConnect({
  connectHOC = connectAdvanced,
  mapStateToPropsFactories = defaultMapStateToPropsFactories,
  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,
  mergePropsFactories = defaultMergePropsFactories,
  selectorFactory = defaultSelectorFactory
} = {}) {
  return function connect(
    mapStateToProps,
    mapDispatchToProps,
    mergeProps,
    {
      pure = true,
      areStatesEqual = strictEqual,
      areOwnPropsEqual = shallowEqual,
      areStatePropsEqual = shallowEqual,
      areMergedPropsEqual = shallowEqual,
      ...extraOptions
    } = {}
  ) {
    const initMapStateToProps = match(
      mapStateToProps,
      mapStateToPropsFactories,
      'mapStateToProps'
    );
    const initMapDispatchToProps = match(
      mapDispatchToProps,
      mapDispatchToPropsFactories,
      'mapDispatchToProps'
    );
    const initMergeProps = match(mergeProps, mergePropsFactories, 'mergeProps');

    return connectHOC(selectorFactory, {
      // used in error messages
      methodName: 'connect',

      // used to compute Connect's displayName from the wrapped component's displayName.
      getDisplayName: name => `Connect(${name})`,

      // if mapStateToProps is falsy, the Connect component doesn't subscribe to store state changes
      shouldHandleStateChanges: Boolean(mapStateToProps),

      // passed through to selectorFactory
      initMapStateToProps,
      initMapDispatchToProps,
      initMergeProps,
      pure,
      areStatesEqual,
      areOwnPropsEqual,
      areStatePropsEqual,
      areMergedPropsEqual,

      // any extra options args can override defaults of connect or connectAdvanced
      ...extraOptions
    });
  };
}
```

`connect` æœ¬èº«ä¸ä¼šæœ‰ä¸€äº›å¤æ‚çš„è®¡ç®—ï¼Œæ‰€ä»¥å³ä½¿æ¯æ¬¡éƒ½æ‰§è¡Œæ˜¯æ²¡æœ‰å½±å“çš„ã€‚

`æœ‰å¯èƒ½ä½ ç‰¹åˆ«åœ¨æ„ render çš„æ¬¡æ•°ï¼Œå¯èƒ½å°±æ˜¯ä¸æƒ³ connect æ¯æ¬¡éƒ½è¦æ‰§è¡Œï¼Œå°±æ˜¯æœ‰è¿™æ ·çš„å¼ºè¿«ç—‡ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•å»ä¿®æ”¹è¿™ä¸ªå‘¢ï¼Ÿ`

---

# ä»é›¶å®ç°ä¸€ä¸ªçŠ¶æ€ç®¡ç†

åœ¨å¼€å§‹è¿™ä¸ªéƒ¨åˆ†ä¹‹å‰ï¼Œé¦–å…ˆè¦æ¯”è¾ƒç†Ÿæ‚‰ `redux`, å› ä¸ºè¿™éƒ¨åˆ†å¾ˆå¤šä»£ç éƒ½æ˜¯ç»§ç»­æ²¿ç”¨ `redux` ä¸­çš„ä»£ç ã€‚

ä¸€æ­¥ä¸€æ­¥çš„æ¥ï¼Œé¦–å…ˆå¯¹äºçŠ¶æ€ç®¡ç†ï¼Œåº”è¯¥éœ€è¦ä¸€ä¸ª `Provider`, ä¸å¦¨æ¥å®ç°è¿™ä¸ª `Provider`, Provider è¿˜æ˜¯ä½¿ç”¨ `React` çš„ `context api`,
è¿™ä¸ªå®ç°æ˜¯ä½¿ç”¨äº† `TS`, å¦‚æœå¯¹ `TS` ä¸ç†Ÿæ‚‰çš„å¯ä»¥æŸ¥çœ‹[å®˜ç½‘](https://www.typescriptlang.org/)

`Provider`

```js
import * as React from 'react';
import { storeContext, selectorContext } from './context';
import { ProviderProps } from './type';

const { useState } = React;

export default function Provider<T>({ value, children }: ProviderProps<T>) {
  // ç¼“å­˜ value çš„å€¼è¿›è¡Œå±€éƒ¨æ›´æ–°
  const [api] = useState(value);

  return (
    <storeContext.Provider value={value}>
      <selectorContext.Provider value={api}>
        {children}
      </selectorContext.Provider>
    </storeContext.Provider>
  );
}
```

åœ¨ `Provider` ä¸­ä½¿ç”¨äº†ä¸¤ä¸ª `context`, ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸¤ä¸ªä¸€æ¨¡ä¸€æ ·çš„å‘¢ï¼Ÿåé¢ä¼šè¯¦ç»†è§£é‡Š, åœ¨çœ‹ä¸€ä¸‹ `context` çš„å£°æ˜

```js
import * as React from 'react'
import { UseStoreResult } from './type'

export const storeContext = React.createContext<UseStoreResult<any> | undefined>(undefined)

/**
 * selectorContext ç”¨æˆ·è·å–å€¼å¹¶ä¸”å¯ä»¥å’Œ dispatch ç›¸åº”çš„å€¼ è¿™ä¸ªå¯ä»¥è¿›è¡Œç¼“å­˜æ‰€ä»¥çœŸæ­£å­˜å‚¨åªçš„åœ°æ–¹æ˜¯ storeContext
 */
export const selectorContext = React.createContext<UseStoreResult<any> | undefined>(undefined)
```

è¿™äº›ç±»å‹çš„åœ°æ–¹ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿç›´æ¥ç”¨ `any` æ¥ä»£æ›¿, å¯ä»¥çœ‹å‡ºï¼Œåœ¨ `context` ä¸­å£°æ˜äº†ä¸¤ä¸ª `context`, åœ¨ `Provider` ä¸­ä½¿ç”¨äº†
è¿™ä¸¤ä¸ª `context`ã€‚

å› ä¸ºæ•´ä¸ªéƒ¨åˆ†éƒ½æ˜¯é‡‡ç”¨ `Hooks` çš„æ–¹å¼æ¥å¼€å‘çš„ï¼Œæ‰€ä»¥ä¸å†å‘½åä¸º `createStore` æ‰€ä»¥é‡‡ç”¨ `useStore`ã€‚

```js
export default function useStore<T extends object>(
  reducer: ReducerType<T>,
  initialState?: T,
  enhancer?: any
): UseStoreResult<T> {
  const [get, set] = useCurrent(initialState || {})
  const listeners = useRef<Listener[]>([])

  // ç»§ç»­ä½¿ç”¨ redux ä¸­çš„ä¸­é—´ä»¶
  if (
    (typeof initialState === 'function' && typeof enhancer === 'function') ||
    (typeof enhancer === 'function' && typeof arguments[3] === 'function')
  ) {
    throw new Error(
      'It looks like you are passing several store enhancers to ' +
        'useStore(). This is not supported. Instead, compose them ' +
        'together to a single function.'
    )
  }

  if (typeof initialState === 'function' && typeof enhancer === 'undefined') {
    enhancer = initialState
    initialState = undefined
  }

  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }

    return enhancer(useStore)(reducer, initialState)
  }

  /**
   * è¿”å› store å­˜çš„æ‰€æœ‰çš„ state
   */
  const getState = () => get() as T

  /**
   * ç›‘å¬å™¨ç”¨äºæ›´æ–°å­ç»„ä»¶
   * @param listener
   */
  const subscriber = (listener: Listener) => {
    if (typeof listener !== 'object') {
      throw new Error('expected listener to be a object')
    }

    // åŠ å…¥åˆ°ç›‘å¬å™¨ä¸­
    listeners.current.push(listener)

    return () => {
      const index = listeners.current.indexOf(listener)
      listeners.current.splice(index, 1)
    }
  }

  /**
   * ç”¨äºä¿®æ”¹å€¼, ç”¨äºä¸­é—´ä»¶çš„æ—¶å€™å¯ä»¥ä¸ä¼ ç¬¬äºŒä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ selector ä¸­ä»ç„¶éœ€è¦
   * @param action
   * @param deps å¯èƒ½ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…¨éƒ¨æ›´æ–°
   */
  const dispatch = (action: Action, deps?: string[]) => {
    const oldState = get()
    // è·å–åˆ°æ‰§è¡Œåçš„ state
    const state = reducer(oldState as T, action)
    set(state)

    const changeKeys: string[] = []

    // è¿›è¡Œæµ…æ¯”è¾ƒè·å–åˆ°ä¿®æ”¹çš„å€¼
    if (deps) {
      deps.forEach(key => {
        const oldValue = getPath(oldState, key)
        const newValue = getPath(state, key)
        if (oldValue !== newValue) {
          changeKeys.push(key)
        }
      })
    }

    // éå†ç›‘å¬å™¨ï¼Œåªå¯¹å˜åŒ–çš„ç»„ä»¶è¿›è¡Œæ›´æ–°
    listeners.current.forEach(listener => {
      const listenerProps = listener.props
      // å¦‚æœä¾èµ–å­˜åœ¨åˆ™æ›´æ–°ä¾èµ–ä¸­çš„é€‰é¡¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ›´æ–°å…¨éƒ¨
      if (deps) {
        // éå†ç›‘å¬å™¨ï¼Œå¯¹ä¿®æ”¹çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°
        for (let i = 0; i < changeKeys.length; i++) {
          if (listenerProps.indexOf(changeKeys[i]) > -1) {
            listener.listener()
          }
        }
      } else {
        listener.listener()
      }
    })

    return action
  }

  return {
    getState: getState,
    subscriber: subscriber,
    dispatch: dispatch
  }
}
```

`useStore` å‰é¢çš„éƒ¨åˆ†å’Œ `redux` ä¸­çš„ä»£ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹æš‚æ—¶å¯ä»¥ä¸çœ‹, `subscriber` éƒ¨åˆ†ä¹ŸåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä½†æ˜¯
è¿˜æ˜¯è¦çœ‹ä¸€ä¸‹ `listener` çš„å‚æ•°æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚

```js
const subscriber = (listener: Listener) => {
  if (typeof listener !== 'object') {
    throw new Error('expected listener to be a object')
  }

  // åŠ å…¥åˆ°ç›‘å¬å™¨ä¸­
  listeners.current.push(listener)

  return () => {
    const index = listeners.current.indexOf(listener)
    listeners.current.splice(index, 1)
  }
}

export interface Listener {
  listener: () => any
  props: any[]
}
```

å¯ä»¥çœ‹å®šä¹‰çš„æ¥å£ï¼Œ`subscriber` çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­åŒ…æ‹¬ `listener` å‡½æ•°å’Œä¸€ä¸ª `props`, å…·ä½“ç”¨æ³•è¿™ä¸¤ä¸ªæ˜¯å¹²ä»€ä¹ˆç”¨çš„, åé¢ä¼šè®²åˆ°

åœ¨çœ‹ `dispatch` è¿™ä¸ªå‡½æ•°ï¼Œ `dispatch` æ˜¯ä¸»ä½“çš„éƒ¨åˆ†ï¼Œ `dispatch` æ¥å—äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `action` ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª `deps` ä¾èµ–æ•°ç»„
é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„ä¸€ä¸ªä¾èµ–é¡¹å‘¢ï¼Ÿåœ¨çœ‹ä¸‹ `useSelector`

`useSelector` æ˜¯æœ€æœ€æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œåªéœ€è¦ä½¿ç”¨ `useSelector` å°±èƒ½å®ç°`å±€éƒ¨æ¸²æŸ“`

```js
export default function useSelector<T>(
  callback: (state: T) => any[]
): UseSelectorResult<T> {
  const api = useContext(selectorContext);
  const forceUpdate = useForceUpdate();

  if (!api) {
    throw new Error('expected useSelector to be used in Provider');
  }

  const propsRef = React.useRef(callback(api.getState()));
  // è·å–åˆ°è¿”å›çš„ props
  const props = callback(api.getState());

  if (!isSame(propsRef.current, props)) {
    propsRef.current = props;
  }

  const current = propsRef.current;

  useEffect(() => {
    // è®¢é˜…éœ€è¦çš„ä¿¡æ¯
    api.subscriber({
      listener: () => forceUpdate(false),
      props: current
    });
  }, [api, forceUpdate, current]);

  return {
    dispatch: (action: Action) => {
      api.dispatch(action, props);
      return action;
    },
    getState: api.getState
  };
}
```

`useSelector` ä½¿ç”¨äº† `selectorContext`ï¼Œè€Œä¸æ˜¯ `storeContext`, ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºåªè¦ `store` å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ `storeContext` å¿…ç„¶ä¼š
é‡æ–° `render`, `storeContext` é‡æ–° `render`, ä½¿ç”¨ `storeContext` çš„åœ°æ–¹éƒ½ä¼šé‡æ–° `render`, é‚£ä¹ˆä¸ºä»€ä¹ˆ `selectorContext` ä¸ä¼šå‘¢ï¼Ÿ
åœ¨ä¼šæœ‰çœ‹ä¸‹ `Provider` çš„ä»£ç 

```js
export default function Provider<T>({ value, children }: ProviderProps<T>) {
  // ç¼“å­˜ value çš„å€¼è¿›è¡Œå±€éƒ¨æ›´æ–°
>  const [api] = useState(value); ğŸ¤”

  return (
    <storeContext.Provider value={value}>
      <selectorContext.Provider value={api}>
        {children}
      </selectorContext.Provider>
    </storeContext.Provider>
  );
}
```

ç®­å¤´æ‰€æŒ‡çš„è¿™ä¸ªéƒ¨åˆ†å°±æ˜¯å…³é”®æ‰€åœ¨ `const [api] = useState(value)` é€šè¿‡è¿™æ ·ï¼ŒæŠŠ `value` è¿›è¡Œç¼“å­˜äº†ï¼Œè¿™æ ·å³ä½¿æ¯æ¬¡ `render`,
æ­¤æ—¶çš„ `api` éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¹Ÿå°±ä¸ä¼šé€ æˆä½¿ç”¨ `selectorContext` çš„åœ°æ–¹çš„å°±ä¼šæ›´æ–°ã€‚

é‚£ä¹ˆå¦‚æœ `useSelector` ä¸æ›´æ–°é‚£åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ `useSelector()` ä¸ä¹Ÿä¸æ›´æ–°äº†å—ï¼Ÿè¿™æ ·å°±ä¼šé€ æˆ bug çš„äº§ç”Ÿï¼Œè¿™æ˜¯ä¸‡ä¸‡ä¸å…è®¸çš„ã€‚
æ‰€ä»¥åœ¨ `useSelector` å†…éƒ¨ä½¿ç”¨äº† `useForceUpdate`ã€‚

`useForceUpdate`

```js
function forceReducer(state: boolean) {
  return !state;
}

/**
 * forceUpdate
 */
export function useForceUpdate() {
  return React.useReducer(forceReducer, false)[1];
}
```

ç°åœ¨å¯ä»¥çœ‹åˆ°åœ¨ `useSelector` å†…éƒ¨çš„ `useEffect`

```js
const propsRef = React.useRef(callback(api.getState()));
// è·å–åˆ°è¿”å›çš„ props
const props = callback(api.getState());

if (!isSame(propsRef.current, props)) {
  propsRef.current = props;
}

const current = propsRef.current;

useEffect(() => {
  // è®¢é˜…éœ€è¦çš„ä¿¡æ¯
  api.subscriber({
    listener: () => forceUpdate(false),
    props: current
  });
}, [api, forceUpdate, current]);
```

åªæœ‰åœ¨ `current` å˜åŒ–çš„æ—¶å€™ä¼šå†ä¸€æ¬¡é‡æ–°æ³¨å†Œ `listener`, è¿™ä¸ª `current` é€šè¿‡è°ƒç”¨ `callback(api.getState())` æ‰€å¾—ï¼Œ
ä¹Ÿå°±æ˜¯åªæœ‰åœ¨ `useSelector` çš„ä¾èµ–å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰ä¼šé‡æ–°æ³¨å†Œã€‚åœ¨ä¸šåŠ¡é‡Œå¯ä»¥è¿™æ ·ä½¿ç”¨ `useSelector(() => ['a', 'b'])` è¿™é‡Œçš„
`a` å’Œ `b` éƒ½æ˜¯ä½¿ç”¨ `useSelector` ç»„ä»¶é‡Œéœ€è¦ä½¿ç”¨åˆ°çš„å€¼ã€‚æŠŠä½¿ç”¨çš„å€¼ä½œä¸ºä¾èµ–ï¼Œåªè¦ä½¿ç”¨çš„å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œ `render`ã€‚

åœ¨çœ‹ä¸‹ `useSelector` çš„è¿”å›å€¼

```js
return {
  dispatch: (action: Action) => {
    api.dispatch(action, props);
    return action;
  },
  getState: api.getState
};
```

æ­¤æ—¶çš„è¿”å›å€¼æ¥ç®¡äº† `store` ä¸­çš„ `dispatch` å‡½æ•°, dispatch çš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯ `useSelector` çš„ä¾èµ–é¡¹ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œ `dispatch` çš„æ—¶å€™éƒ½ä¼š
æ‰§è¡Œ `selector` çš„ `dispatch`ï¼Œ ç„¶åè°ƒç”¨ `store` ä¸­çš„ `dispatch` ã€‚åœ¨å›å¤´çœ‹ä¸‹ `store` ä¸­çš„ `dispatch`

```js
/**
 * ç”¨äºä¿®æ”¹å€¼, ç”¨äºä¸­é—´ä»¶çš„æ—¶å€™å¯ä»¥ä¸ä¼ ç¬¬äºŒä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ selector ä¸­ä»ç„¶éœ€è¦
 * @param action
 * @param deps å¯èƒ½ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…¨éƒ¨æ›´æ–°
 */
const dispatch = (action: Action, deps?: string[]) => {
  const oldState = get()
  // è·å–åˆ°æ‰§è¡Œåçš„ state
  const state = reducer(oldState as T, action)
  set(state)

  const changeKeys: string[] = []

  // è¿›è¡Œæµ…æ¯”è¾ƒè·å–åˆ°ä¿®æ”¹çš„å€¼
  if (deps) {
    deps.forEach(key => {
      const oldValue = getPath(oldState, key)
      const newValue = getPath(state, key)
      if (oldValue !== newValue) {
        changeKeys.push(key)
      }
    })
  }

  // éå†ç›‘å¬å™¨ï¼Œåªå¯¹å˜åŒ–çš„ç»„ä»¶è¿›è¡Œæ›´æ–°
  listeners.current.forEach(listener => {
    const listenerProps = listener.props
    // å¦‚æœä¾èµ–å­˜åœ¨åˆ™æ›´æ–°ä¾èµ–ä¸­çš„é€‰é¡¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ›´æ–°å…¨éƒ¨
    if (deps) {
      // éå†ç›‘å¬å™¨ï¼Œå¯¹ä¿®æ”¹çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°
      for (let i = 0; i < changeKeys.length; i++) {
        if (listenerProps.indexOf(changeKeys[i]) > -1) {
          listener.listener()
        }
      }
    } else {
      listener.listener()
    }
  })

  return action
}
```

é¦–å…ˆæ ¹æ® `deps` æ‰¾å‡ºå“ªäº›æ˜¯ä¿®æ”¹çš„å€¼ï¼Œå› ä¸ºä¸€ä¸ªç»„ä»¶æœ‰å¯èƒ½ä¼šæœ‰è®¸å¤šä¾èµ–é¡¹ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªç»„ä»¶ä¸­åªä¿®æ”¹äº†ä½¿ç”¨çš„ `a`, `b` æ²¡æœ‰æ”¹å˜ï¼Œ é‚£ä¹ˆå…¶ä»–ç»„ä»¶ä¾èµ–äº†è¿™ä¸ª `b` ä¹Ÿ
ä¸åº”è¯¥æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦æ‰¾å‡ºæ”¹å˜çš„ä¾èµ–é¡¹

```js
if (deps) {
  deps.forEach(key => {
    const oldValue = getPath(oldState, key);
    const newValue = getPath(state, key);
    if (oldValue !== newValue) {
      changeKeys.push(key);
    }
  });
}
```

æ‰¾å‡ºæ”¹å˜çš„ä¾èµ–é¡¹åï¼Œå¯¹ `listeners` è¿›è¡Œéå†, æ‰¾å‡ºæ‰€æœ‰ä½¿ç”¨äº† `useSelector` çš„åœ°æ–¹çš„æ‰€æœ‰ä¾èµ–ï¼Œçœ‹æ˜¯å¦å­˜åœ¨å…¶ä»–çš„ä¾èµ–é¡¹ä¹ŸåŒ…æ‹¬è¿™æ¬¡æ”¹å˜çš„ä¾èµ–é¡¹ï¼Œæ¯”å¦‚æ­¤æ—¶æ›´æ”¹äº†
`a`, é‚£ä¹ˆæ‰€æœ‰å…¶ä»–ç»„ä»¶ä¸­æœ‰å¯¹ `a` çš„ä¾èµ–é¡¹çš„éƒ½åº”è¯¥è¿›è¡Œé‡æ–° `render`ã€‚è¿™ä¹Ÿæ˜¯ `store` ä¸­ `dispatch` çš„ä¸»è¦é€»è¾‘ã€‚

åŸºæœ¬ä¸Šä¸€ä¸ªçŠ¶æ€ç®¡ç†çš„æ‰€æœ‰ä»£ç å·²ç»è®²æ¸…æ¥šäº†ï¼Œé‚£ä¹ˆä¸å¦¨è¯•è¯•ã€‚

ç‚¹å‡» `increase` æˆ–è€… `decrease`, åªæ‰“å°å‡ºäº† `render count selector` æ‰€ä»¥æ¯æ¬¡ `useSelector` ä¹Ÿåªæ˜¯å•æ¬¡æ¸²æŸ“ã€‚è¿™ä¸ªä¹Ÿæ˜¯å±€éƒ¨æ¸²æŸ“äº†ã€‚

<div>
  <img src='./context2.jpg' />
</div>

æœ€åè´´ä¸€ä¸‹ä»£ç ï¼Œä»£ç ä¹Ÿå¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°](https://github.com/snakeUni/lanyincaos.cn/tree/master/src/pages/posts/2019-08-24-how-to-use-context-efficient)

`react-redux-demo`

```js
import * as React from 'react';
import { Provider, connect } from 'react-redux';
import { createStore } from 'redux';

// ä¸€ä¸ªç®€å•çš„ reducer
function reducer(state, action) {
  switch (action.type) {
    case 'increase': {
      return { ...state, count: state.count + action.payload };
    }

    case 'decrease': {
      return { ...state, count: state.count - action.payload };
    }

    case 'updateName': {
      return { ...state, name: action.payload };
    }

    case 'updateAddress': {
      return { ...state, address: action.payload };
    }
    default: {
      return state;
    }
  }
}

const store = createStore(reducer, {
  count: 0,
  name: 'lanyincao',
  address: 'shanghai'
});
class App extends React.Component {
  render() {
    return <Provider store={store}>{this.props.children}</Provider>;
  }
}

function mapCountStateToProps(state) {
  console.log('mapCountStateToProps', state);
  const { count } = state;
  return { count };
}

class Count extends React.Component<any, any> {
  render() {
    const { dispatch } = this.props;
    console.log('render count');
    return (
      <div>
        <div>count: {this.props.count}</div>
        <button onClick={() => dispatch({ type: 'increase', payload: 2 })}>
          increase
        </button>
        <button onClick={() => dispatch({ type: 'decrease', payload: 2 })}>
          decrease
        </button>
      </div>
    );
  }
}

function mapPersonStateToProps(state) {
  console.log('mapPersonStateToProps', state);
  const { name, address } = state;
  return { name, address };
}

class Person extends React.Component<any> {
  render() {
    const { dispatch, name, address } = this.props;
    console.log('render person');
    return (
      <div>
        <div>
          <span>name: {name}</span>
          <span style={{ marginLeft: 20 }}>address: {address}</span>
        </div>
        <div>
          <button
            onClick={() => dispatch({ type: 'updateName', payload: 'ç‰§äº‘äº‘' })}
          >
            updateName
          </button>
          <button
            onClick={() =>
              dispatch({ type: 'updateAddress', payload: 'hangzhou' })
            }
          >
            updateAddress
          </button>
        </div>
      </div>
    );
  }
}

// count
const ConnectCount = connect(mapCountStateToProps)(Count);
// person
const ConnectPerson = connect(mapPersonStateToProps)(Person);

export default function Demo() {
  return (
    <div>
      <App>
        <ConnectCount />
        <ConnectPerson />
      </App>
    </div>
  );
}
```

`react-redux-chaos demo`

```js
import * as React from 'react';
import { useStore, Provider, useSelector } from 'react-redux-chaos';

const initialState = { count: 0, name: 'lanyincao', address: 'shanghai' };

function reducer(state, action) {
  switch (action.type) {
    case 'increase': {
      return { ...state, count: state.count + action.payload };
    }

    case 'decrease': {
      return { ...state, count: state.count - action.payload };
    }

    case 'updateName': {
      return { ...state, name: action.payload };
    }

    case 'updateAddress': {
      return { ...state, address: action.payload };
    }
    default: {
      return state;
    }
  }
}

function App({ children }) {
  const store = useStore(reducer, initialState);
  return <Provider value={store}>{children}</Provider>;
}

function Count() {
  const { getState, dispatch } = useSelector(() => {
    console.log('render count selector');
    return ['count'];
  });

  const state: any = getState();
  return (
    <div>
      <div>count: {state.count}</div>
      <button onClick={() => dispatch({ type: 'increase', payload: 2 })}>
        increase
      </button>
      <button onClick={() => dispatch({ type: 'decrease', payload: 2 })}>
        decrease
      </button>
    </div>
  );
}

function Person() {
  const { getState, dispatch } = useSelector(() => {
    console.log('render person selector');
    return ['name', 'address'];
  });

  const state: any = getState();

  return (
    <div>
      <div>
        <span>name: {state.name}</span>
        <span style={{ marginLeft: 20 }}>address: {state.address}</span>
      </div>
      <div>
        <button
          onClick={() => dispatch({ type: 'updateName', payload: 'ç‰§äº‘äº‘' })}
        >
          updateName
        </button>
        <button
          onClick={() =>
            dispatch({ type: 'updateAddress', payload: 'hangzhou' })
          }
        >
          updateAddress
        </button>
      </div>
    </div>
  );
}

export default function Demo() {
  return (
    <App>
      <Count />
      <Person />
    </App>
  );
}
```

# conclusion

`context` ç”¨æ³•å¾ˆç®€å•ï¼Œå½“æƒ³è¦ä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æ—¶å€™å¯ä»¥å°è¯•ä½¿ç”¨å¤šä¸ª `context` èƒ½åšåˆ°å‡å°‘æ›´æ–°çš„ä½œç”¨ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `useMemo` ç­‰ç›¸å…³çš„ `api`,
æ¯”è¾ƒåœ¨ä¹ `render` æ¬¡æ•°çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨ `react-redux` ä¸€äº›æˆç†Ÿçš„åº“ï¼Œæˆ–è€… [react-redux-chaos](https://github.com/snakeUni/react-redux-chaos)
