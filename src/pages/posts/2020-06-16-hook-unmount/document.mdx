çªç„¶å‘ç°å¥½ä¹…æ²¡å†™æ–‡ç« äº†ï¼Œæ­£å¥½è¿™æ¬¡åœ¨é¡¹ç›®ä¸­é‡åˆ°äº†ä¸€ä¸ªæ–‡ç« å°±å†™äº†è¿™ç¯‡æ–‡ç« ã€‚

åœ¨å†™ä¸€ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦ç”¨ä¸€äº›å¸¸ç”¨çš„ Hook, æ¯”å¦‚ `useState`, `useRef`, `useEffect` ç­‰ã€‚ä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿè¦éœ€è¦ç”¨ç»„ä»¶çš„ unmount,
ä»¥å‰åœ¨å†™ class ç»„ä»¶å¦‚æœéœ€è¦ç”¨ unmount, é€šå¸¸ä¼šä½¿ç”¨ `componentWillUnmount` å£°æ˜å‘¨æœŸã€‚

```jsx{5-7}
import * as React from 'react'
import ReactDOM from 'react-dom'

class App extends React.Component {
  componentWillUnmount() {
    console.log('unmount')
  }

  render() {
    return (
      <div>demo</div>
    )
  }
}

ReactDOM.render(<App />, document.getElementById('root'))
```

å½“ App unmount çš„æ—¶å€™ componentWillUnmount å°†è¢«è°ƒç”¨ã€‚é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ `hooks` æ¥ä»£æ›¿ unmount å‘¢

[å®˜ç½‘](https://reactjs.org/docs/hooks-faq.html)ä¸Šçš„è¯´æ³•æ˜¯ä½¿ç”¨ `useEffect` æ¥ä»£æ›¿, ä¸å¦¨æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„ä»£ç 

```jsx{5-9}
import * as React from 'react'
import ReactDOM from 'react-dom'

function App() {
  React.useEffect(() => {
    return () => {
      console.log('unmount')
    }
  }, [])

  return (
    <div>demo</div>
  )
}

ReactDOM.render(<App />, document.getElementById('root'))
```

å¯ä»¥çœ‹å‡ºä½¿ç”¨ hooks æ¥æ”¹é€ æ˜¯ç®€å•äº†å¾ˆå¤šå¾ˆå¤šï¼Œé‚£ä¹ˆæ˜¯å¦ useEffect èƒ½å®Œå…¨è§£å†³ componentWillUnmount çš„é—®é¢˜å‘¢ï¼Ÿ[çœ‹è¿™æ ·çš„ä¾‹å­](https://codesandbox.io/s/inspiring-williams-8qerf)

```jsx
import * as React from 'react'

function Demo({ name }) {
  const keyMapRef = useRef(new Map())
  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      keyMapRef.current.delete(name)
    }
  }, [name])
  return (
    <div>demo</div>
  )
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¯å½“ name å‘ç”Ÿæ”¹å˜ï¼ŒkeyMap å°±ä¼šåˆ é™¤ä¹‹å‰çš„ name å€¼ï¼Œç„¶åé‡æ–°æ³¨å†Œä¸€ä¸ªæ–°çš„å€¼è¿›å»ã€‚æ‰€ä»¥å½“è¿™æ ·ä½¿ç”¨ Demo çš„æ—¶å€™ï¼Œ name ä¸ºç©ºåœ¨ mount ä¼šè¢«æ³¨å†Œè¿›å»ï¼Œname
æ›´æ–°åï¼Œç©ºå€¼çš„ name ä¼šè¢«åˆ é™¤ï¼Œé‡æ–°æ³¨å†Œæ–°çš„ name å³ test

```jsx
import * as React from 'react'
import ReactDOM from 'react-dom'

function App() {
  const [name, setName] = React.useState('')

  React.useEffect(() => {
    setName('test')
  }, [])

  return (
    <div>
      <Demo name={name}/>
    </div>
  )
}
```

å¦‚æœæ­¤æ—¶çªç„¶æœ‰è¿™æ ·çš„ä¸€ä¸ªéœ€æ±‚ï¼Œå°±æ˜¯å¸Œæœ›åœ¨ä¼ å…¥æŸä¸ª props çš„æ—¶å€™ï¼Œå¸Œæœ›ç»„ä»¶åœ¨ unmount çš„æ—¶å€™å¹¶ä¸ä¼šåˆ é™¤æ³¨å†Œçš„ nameã€‚å‡è®¾è¿™ä¸ª props ä¸º keepName, æ­¤æ—¶åº”è¯¥æ€ä¹ˆåšï¼Ÿ

æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šè¿™ä¹ˆä¿®æ”¹ Demo ç»„ä»¶

```jsx
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())
  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      if (keepName) return
      keyMapRef.current.delete(name)
    }
  }, [name])
  return (
    <div>demo</div>
  )
}
```

è¿™ä¸ªä»£ç ç¬¬ä¸€çœ¼çœ‹èµ·æ¥æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œç¬¬äºŒçœ¼çœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰é—®é¢˜å¯¹å§ã€‚å¦‚æœä½¿ç”¨è€…ä¼ é€’ä¸‹æ¥çš„ name æ˜¯ä¸€ä¸ªé™æ€çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾‹å­æ˜¯ä¸å­˜åœ¨é—®é¢˜ã€‚

```jsx
<Demo name="test" keepName/>
```

å› ä¸º name æ˜¯ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå› æ­¤ä»£ç æ­£å¸¸è¿è¡Œã€‚çœ‹èµ·æ¥æ˜¯å¾ˆå®Œç¾çš„ï¼Œé‚£ä¹ˆå¦‚æœ name æ˜¯åŠ¨æ€çš„å‘¢ï¼Ÿå› ä¸º name åœ¨ä¸æ–­çš„æ”¹å˜ï¼Œæ¯æ¬¡æ”¹å˜éƒ½æ²¡æœ‰
åˆ é™¤ä¹‹å‰çš„ name, é‚£ä¹ˆ keyMapRef é‡Œå°±ä¼šä¸æ–­çš„å¢åŠ æ–°çš„ nameã€‚è¿™æ ·æ˜æ˜¾æ˜¯æœ‰ bug çš„ã€‚


```jsx{14-19}
import * as React from 'react'
import ReactDOM from 'react-dom'

function App() {
  const [name, setName] = React.useState('')

  React.useEffect(() => {
    setName('test')
  }, [])

  return (
    <div>
      <Demo name={name} keepName />
      <button 
        onClick={() => {
        setName(Math.random())
      }}>
        setName
      </button>
    </div>
  )
}
```

å½“ç‚¹å‡» setName æ—¶ï¼Œæ–°çš„ name å°±ä¼šè¢«ä¸æ–­çš„æ³¨å†Œè¿›å»ã€‚å¾ˆæ˜¾ç„¶ bug å‡ºç°äº†ã€‚é‚£ä¹ˆå¦‚ä½•åªåœ¨ unmount çš„æ—¶å€™ä¿ç•™ name å‘¢ï¼Ÿå› ä¸ºå³ä½¿å¢åŠ ä¸€ä¸ªç©ºä¾èµ–çš„ useEffect ä¹Ÿæ˜¯ä¸è¡Œçš„

```jsx{12-18}
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())
  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      keyMapRef.current.delete(name)
    }
  }, [name])

  React.useEffect(() => {
    return () => {
      if (keepName) return
      keyMapRef.current.delete(name)
    }
  }, [])

  return (
    <div>demo</div>
  )
}
```

å³ä½¿å¢åŠ äº†ä¸€ä¸ªç©ºä¾èµ–çš„ useEffect, ä½†æ˜¯å½“ Demo unmount çš„æ—¶å€™ï¼Œä¸Šä¸€ä¸ª useEffect çš„ return ä»ç„¶æ˜¯ä¼šæ‰§è¡Œçš„ã€‚ä»ç„¶ä¼šæŠŠ name ç»™åˆ é™¤æ‰ã€‚å¯èƒ½åˆæœ‰åŒå­¦ä¼šè¿™æ ·æƒ³ï¼Œ
é‚£åœ¨ unmount ååœ¨é‡æ–° set ä¸€æ¬¡ä¸å°±å¥½äº†å˜›

```jsx{16}
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())
  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      keyMapRef.current.delete(name)
    }
  }, [name])

  React.useEffect(() => {
    return () => {
      if (keepName) {
        keyMapRef.current.set(name, '100')
      }
    }
  }, [])

  return (
    <div>demo</div>
  )
}
```

æ­¤æ—¶è¿™ä¸ªä»£ç è¿˜æ˜¯æœ‰ bug çš„ï¼Œå› ä¸º `keyMapRef.current.set(name, '100')` è¿™é‡Œçš„ name ä¸€ç›´éƒ½æ˜¯ç¬¬ä¸€æ¬¡ä¼ é€’è¿›æ¥çš„ name, åˆå§‹åŒ–ä¼ è¿›æ¥æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ name å°±æ˜¯
ç©ºçš„å­—ç¬¦ä¸²ã€‚é‚£ä¹ˆåˆæœ‰åŒå­¦æåˆ°ï¼Œé‚£æˆ‘æ—¶åˆ»è®© name ä¿æŒæœ€æ–°ä¸å°±å¥½äº†å˜›(è¿™ä¹Ÿæ˜¯æˆ‘ä¸€å¼€å§‹çš„åšæ³•)

```jsx{7,6,20}
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())

  const nameRef = useRef(name)
  nameRef.current = name

  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      keyMapRef.current.delete(name)
    }
  }, [name])

  React.useEffect(() => {
    return () => {
      if (keepName) {
        keyMapRef.current.set(nameRef.current, '100')
      }
    }
  }, [])

  return (
    <div>demo</div>
  )
}
```

ç”¨ nameRef è®°å½•æœ€æ–°çš„ name  åœ¨ unmount çš„æ—¶å€™ä½¿ç”¨æœ€æ–°çš„ name é‡æ–° set è¿›å»å°±å¯ä»¥ä¿ç•™äº†ä¹‹å‰çš„ keyã€‚è¿™æ ·çš„åšæ³•æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸€å¼€å§‹çš„åšæ³•ï¼Œé‚£ä¹ˆå¦‚æœä¿ç•™çš„
ä¸åªæ˜¯æœ‰ name å‘¢ï¼Ÿå¦‚æœåé¢è¿˜æœ‰ age, address æ˜¯ä¸æ˜¯æ‰€æœ‰çš„éƒ½è¦æ¥è®°å½•å‘¢ï¼Ÿæ˜¯å¦æœ‰ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•æ¥è§£å†³å‘¢ï¼Ÿçœ‹è¿™æ ·çš„ä¸€ä¸ªä¾‹å­

```jsx
import * as React from 'react'

function CountDemo() {
  const [count, setCount] = React.useState(0)

  React.useEffect(() => {
    console.log('update count ğŸ˜', count)

    return () => {
      console.log('unupdate count ğŸ˜¹', count)
    }
  }, [count])

  return (
    <div>
      <h1>count: {count}</h1>
      <button 
        onClick={() => {
          setCount(count + 1)
      }}>
        setCount
      </button>
    </div>
  )
}
```

ä½¿ç”¨ `CountDemo`

```jsx
import * as React from 'react'
import ReactDOM from 'react-dom'

function App() {
  const [show, setShow] = React.useState(true)

  return (
    <div>
      {show && <CountDemo />}
      <button 
        onClick={() => {
          setShow(!show)
      }}>
        setShow
      </button>
    </div>
  )
}

ReactDOM.render(<App />, document.getElementById('root'))
```

å½“ç‚¹å‡» `setCount` æ—¶ï¼Œconsole çš„ç­”åº”é¡ºåºæ˜¯

```
unupdate count ğŸ˜¹ 0
update count ğŸ˜ 1

unupdate count ğŸ˜¹ 1
update count ğŸ˜ 2

unupdate count ğŸ˜¹ 2
update count ğŸ˜ 3
```

å¯ä»¥çœ‹å‡ºæ¯æ¬¡éƒ½æ˜¯å…ˆ `unupdate` å¹¶ä¸”æ­¤æ—¶æ‹¿åˆ°çš„ count æ˜¯æ—§çš„å€¼ã€‚æ­¤æ—¶ç‚¹å‡»äº† `setCount` ä¸‰æ¬¡ï¼Œé¡µé¢ä¸Šå±•ç¤ºçš„ count ä¸º 3ï¼Œæ­¤æ—¶åœ¨ç‚¹å‡» `setShow`

å¯ä»¥çœ‹å‡ºè¿™æ¬¡çš„æ‰“å°ç»“æœæ˜¯

```
unupdate count ğŸ˜¹ 3
```

å› ä¸ºæ­¤æ—¶ CountDemo è¢« unmount äº†ï¼Œæ‰§è¡Œäº† effect çš„ return, æ‰€ä»¥æ­¤æ—¶çš„ return æ‹¿åˆ°çš„ count å°±æ˜¯ç›®å‰æœ€æ–°çš„ count ä¸º 3, æ—¢ç„¶çŸ¥é“äº†è¿™ä¸ªé¡ºåº
é‚£ä¹ˆæ˜¯å¦å¯ä»¥æ”¹é€ ä¸€ä¸‹ä¹‹å‰çš„ä»£ç å‘¢ï¼Ÿ

```jsx{13-15}
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())

  const nameRef = useRef(name)
  nameRef.current = name

  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      if (nameRef.current === name) {
        return
      }

      keyMapRef.current.delete(name)
    }
  }, [name])

  return (
    <div>demo</div>
  )
}
```

æ­¤æ—¶å¢åŠ äº†ä¸€ä¸ªæ¡ä»¶è¯­å¥

```jsx
if (nameRef.current === name) {
  return
}
```

æ ¹æ®ä¸Šé¢å¾—å‡ºçš„ç»“è®ºï¼Œé‚£ä¹ˆå¦‚æœ name å‘ç”Ÿäº†å˜åŒ–æ‰§è¡Œçš„ effect çš„ return, é‚£ä¹ˆ `nameRef.current !== name`, å¦‚æœæ˜¯ç»„ä»¶åœ¨ unmount çš„æ—¶å€™æ‰§è¡Œçš„ return,
é‚£ä¹ˆæ­¤æ—¶ `nameRef.current === name`, æ­¤æ—¶å‡½æ•°ç›´æ¥è¿”å›,æ— æ³•æ‰§è¡Œåˆ° delete è¯­å¥ã€‚

ç›®å‰åªæœ‰ä¸€ä¸ªä¾èµ–ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼Œé‚£ä¹ˆå¦‚æœä¾èµ–å¾ˆå¤šæ€ä¹ˆåŠï¼Ÿé‚£å°±å¾ˆéš¾æäº†ï¼Œæ€»ä¸èƒ½è®°å½•æ‰€æœ‰çš„ä¾èµ–é¡¹å§(è™½ç„¶è¯´æ˜¯å¯ä»¥çš„)ã€‚æ­¤æ—¶å¯ä»¥ç”¨ React è‡ªå¸¦çš„ä¸€äº› hook æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ
è¿™é‡Œä½¿ç”¨ useMemo æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```jsx{6-8}
import * as React from 'react'

function Demo({ name, keepName }) {
  const keyMapRef = useRef(new Map())

  const depValue = useMemo(() => ({}), [name])
  const depRef = useRef(depValue)
  depRef.current = depValue

  React.useEffect(() => {
    keyMapRef.current.set(name, '100')

    return () => {
      if (depRef.current === depValue) {
        return
      }

      keyMapRef.current.delete(name)
    }
  }, [name])

  return (
    <div>demo</div>
  )
}
```

æ­¤æ—¶ä½¿ç”¨äº† useMemo æ¥è®°å½•æ‰€æœ‰çš„ä¾èµ–ï¼Œè¿™æ ·å³ä½¿åé¢å¢åŠ å†å¤šçš„ä¾èµ–ä¹Ÿä¸ä¼šå­˜åœ¨é—®é¢˜äº†ã€‚å¦‚æœæœ‰éœ€æ±‚å¯ä»¥å°è£…æˆä¸€ä¸ªè‡ªåŠ¨çš„ hook

```jsx
function useUnmount(dep, fn) {
  const depValue = useMemo(() => ({}), dep)
  const depRef = useRef(depValue)

  useEffect(() => {
    return () => {
      fn(depRef.current === depValue)
    }
  }, [dep])
}
```



