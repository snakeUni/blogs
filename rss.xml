<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>lanyincao</title>
        <link>/</link>
        <description>personal blog by lanyincao</description>
        <lastBuildDate>Sat, 24 Aug 2019 07:51:58 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[useCallback]]></title>
            <link>/posts/2019-01-10/cache/</link>
            <guid>/posts/2019-01-10/cache/</guid>
            <pubDate>Wed, 09 Jan 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><div><div class="document_logo__1v782"><img src="/static/media/navi-logo.0f2f9d7f.svg" class="document_logo-navi__bOUrK" alt="logo"/><img src="/static/media/react-logo.5d5d9eef.svg" class="document_logo-react__3-boM" alt="logo"/></div><h2 id="cache-your-event-listener">Cache your event listener</h2><p>åœ¨jsä¸­ï¼Œåˆ›å»ºä¸¤ä¸ªå‡½æ•°æ˜¯ä¸ç­‰çš„ï¼Œå¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·ã€‚æ¥ä¸ªæ —å­çœ‹ä¸‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
a <span class="token operator">===</span> b <span class="token comment">// false</span>
</code></pre><p>å¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
d <span class="token operator">===</span> c <span class="token comment">// false</span>
</code></pre><p>é‚£æˆ‘ä»¬è¿™æ ·å†™  åŒä¸€ä¸ªå¼•ç”¨å°±ç›¸ç­‰äº†</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">d</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> c <span class="token operator">=</span> d
c <span class="token operator">===</span> d <span class="token comment">//true</span>
</code></pre><p>å¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·å°±ä¸å¤šæäº†ï¼Œå¥½äº†å›åˆ°æ­£é¢˜ï¼Œæˆ‘ä»¬åœ¨å†™Reactçš„æ—¶å€™ç»å¸¸éœ€è¦ç»™äº‹ä»¶åŠ ä¸Šç›‘å¬å™¨,çœ‹ä¸€ä¸‹ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ‘ä»¬â€™æ­£å¸¸ï¼ˆ<em>ä¸æ­£å¸¸</em>ï¼‰çš„ä»£ç å¾ˆå¤šéƒ½æ˜¯è¿™æ ·ï¼Œå½“ç„¶ä¸åŒ…å«ä¼šæœ‰äººæ¥å†™<code>é»‘ç§‘æŠ€</code>å•¦ã€‚åœ¨è¿™ä¸ªclickå‡½æ•°é‡Œï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°,å› ä¸ºè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¼ ä¸ªå‚æ•°ã€‚å¤§å®¶å…ˆä¸è¦æ€¥ï¼Œä¼ å˜åŒ–çš„å‚æ•°åé¢ä¼šè¯´åˆ°çš„ã€‚é‚£å¯¹äºè¿™ä¸ªæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ”¹å‘¢ã€‚æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ–è€…</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢å¤§å®¶éƒ½çŸ¥é“ï¼Œé‚£æœ‰åˆ—è¡¨çš„æƒ…å†µä¸‹å‘¢</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token parameter">item</span> <span class="token operator">=></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ªä»£ç æ˜¯æˆ‘ä»¬æ­£å¸¸çš„å†™æ³•äº†ï¼Œåœ¨æ¯æ¬¡ç‚¹å‡»çš„æ—¶å€™éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œé‚£è¿™ä¸ªæˆ‘ä»¬å…¶å®å°±å¯ä»¥åˆ©ç”¨ç¼“å­˜å‡½æ•°äº†ï¼Œè¿™ä¸ªç¼“å­˜å‡½æ•°å¯ä»¥è‡ªå·±å†™æ¯”å¦‚æˆ‘ä»¬è¿™æ ·æ”¹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token function-variable function">getCache</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token parameter">item</span> <span class="token operator">=></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ ·åªåœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œåœ¨åé¢çš„æ¯ä¸€æ¬¡éƒ½ä¼šå¼•ç”¨ä¹‹å‰çš„å‡½æ•°å•¦ã€‚</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Why React Hooks]]></title>
            <link>/posts/2019-02-15/hook/</link>
            <guid>/posts/2019-02-15/hook/</guid>
            <pubDate>Thu, 14 Feb 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h2 id="why-react-hooks">why React Hooks</h2><p>React åœ¨16.8.0çš„æ—¶å€™æ­£å¼å‘å¸ƒäº†<a href="https://reactjs.org/docs/hooks-intro.html">Hook</a>, åŸºç¡€çš„hookæœ‰<code>useState</code>, <code>useReducer</code>, <code>useEffect</code></p><h3 id="mouse-position">Mouse Position</h3><p>è¿™æ˜¯ä¸€ä¸ªè·å–é¼ æ ‡ä½ç½®çš„ğŸŒ°, <a href="https://codesandbox.io/s/xj0ppk0pzw">mousePosition</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MousePostion</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span><span class="token plain-text">
        Mouse X: </span><span class="token punctuation">{</span> x <span class="token punctuation">}</span><span class="token plain-text"> Mouse Y: </span><span class="token punctuation">{</span> y <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨å…¶ä»–çš„åœ°æ–¹å¤ç”¨è¯¥ç»„ä»¶ï¼Œå°±è¦é‡å†™ç›¸åŒçš„ä»£ç   </p><p>å¦‚æœæˆ‘ä»¬æƒ³æ‹¿åˆ°x, yçš„æ—¶å€™åœ¨å»åšå…¶ä»–çš„äº‹æƒ…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å»ä¿®æ”¹è¿™ä¸ªä»£ç ã€‚è¿™ä¸ªè¡Œä¸ºå°±è¢«é™åˆ¶åœ¨è¿™ä¸ªç»„ä»¶é‡Œé¢äº†ã€‚</p><h3 id="hoc">HOC</h3><p>ç”¨hocæ¥ä¿®æ”¹æ­¤ç»„ä»¶ï¼ŒæŠŠx, yä½œä¸ºpropsä¼ ç»™ä»»ä½•éœ€è¦ç”¨x, yçš„ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">withMouseHoc</span><span class="token punctuation">(</span><span class="token parameter">ComponentWrap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Mouse</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      y<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentWrap</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">state</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MouseHocDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        MouseHoc X: </span><span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseHoc Y: </span><span class="token punctuation">{</span>y<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶æˆ‘ä»¬æŠŠé¼ æ ‡çš„è¡Œä¸ºé€šè¿‡hocè¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œä»¥åéœ€è¦ç”¨åˆ°è¯¥è¡Œä¸ºçš„éƒ½å¯ä»¥å®Œå…¨å¤ç”¨ã€‚</p><p>è™½ç„¶è¿™æ˜¯æ›´å¤šçš„ä»£ç ï¼Œä½†æˆ‘ä»¬æ­£åœ¨æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚å®ƒä¸å†ä¸è®¢é˜…è¡Œä¸ºç´§å¯†è€¦åˆã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³æ¸²æŸ“ä¸€äº›ä¸åŒçš„ä¸œè¥¿å‘¢?æˆ‘ä»¬æ€»æ˜¯éœ€è¦åšä¸€ä¸ªæ–°çš„ç»„ä»¶å—?</p><h3 id="render-props">render props</h3><p>ç”¨render propsæ¥æ”¹å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MouseRenderProps</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>this<span class="token punctuation">.</span>state <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MouseRenderPropsDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MouseRenderProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
              MouseRenderProps X: </span><span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseRenderProps Y: </span><span class="token punctuation">{</span>y<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">MouseRenderProps</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>renderPropsä¹Ÿå¯ä»¥è§£å†³ä¹‹å‰mouseçš„é—®é¢˜,å’ŒHOCå…·æœ‰ç›¸åŒçš„åŠŸæ•ˆ</p><p>è¿™ç§ç»†å¾®çš„å·®åˆ«æœ‰ä¸€äº›éå¸¸æ£’çš„å¥½å¤„
ç°åœ¨ï¼Œæä¾›xå’Œyçš„åŠŸèƒ½éå¸¸æ˜æ˜¾ï¼Œæ‚¨è¿˜å¯ä»¥è½»æ¾åœ°é‡å‘½åå®ƒä»¬ï¼Œä»¥é˜²æ­¢åç§°å†²çªã€‚<br/>æˆ‘ä»¬å¯¹æ¸²æŸ“æœ‰çµæ´»çš„æ§åˆ¶ã€‚æˆ‘ä»¬ä¸éœ€è¦åˆ›å»ºæ–°çš„ç»„ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å†³å®šè¿™æ ·åšï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„å¤åˆ¶ç²˜è´´ã€‚<br/>æ‚¨å¯ä»¥åœ¨ç»„ä»¶å‘ˆç°å‡½æ•°ä¸­ç›´æ¥çœ‹åˆ°æ‰€æœ‰è¿™äº›ã€‚æ–°å¼€å‘äººå‘˜å¾ˆå®¹æ˜“è¯†åˆ«å®ƒã€‚<br/>è¿™ç§æ¨¡å¼çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œæ‚¨çš„ç»„ä»¶å¿…é¡»åœ¨å®ƒä»¬çš„å‘ˆç°ä¸­åµŒå¥—è®¸å¤šè¿™æ ·çš„ç»„ä»¶ã€‚ä¸€æ—¦ä½ å¼€å§‹åµŒå¥—å¤šä¸ªæ¸²æŸ“ç»„ä»¶ï¼Œä½ å°±å¾ˆéš¾æ¨æ–­å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚<br/>åŒæ—¶ï¼Œè¿™ä¹Ÿé€ æˆäº†ä¸€ç§é”™è¯¯çš„ç­‰çº§è§‚å¿µã€‚ä»…ä»…å› ä¸ºä¸€ä¸ªè¡Œä¸ºâ€œåµŒå¥—â€åœ¨å¦ä¸€ä¸ªè¡Œä¸ºä¹‹ä¸‹ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒä¾èµ–äºçˆ¶è¡Œä¸º</p><p><em>å¦‚æœæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æ‹¥æœ‰æ‰€æœ‰è¿™äº›èƒ½åŠ›ï¼Œä»¥ä¸€ç§å£°æ˜æ–¹å¼ã€‚ğŸ‘€</em></p><h3 id="hook">Hook</h3><p>ç”¨ hookæ¥æ”¹å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>setPosition<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">MouseHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      MouseHook X: </span><span class="token punctuation">{</span>position<span class="token punctuation">.</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseHook Y: </span><span class="token punctuation">{</span>position<span class="token punctuation">.</span>y<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™å°±æ˜¯æˆ‘æƒ³è¦çš„ä¸€åˆ‡ã€‚</p><p>ä¸ä»…è¡Œä¸ºåœ¨å®ƒè‡ªå·±æ•´æ´çš„å°ç¨‹åºåŒ…ä¸­ï¼ŒuseEffectè¿˜é˜»æ­¢å®ƒåˆ†æ•£åœ¨ä¸‰ä¸ªä¸åŒçš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­
ç»„ä»¶ä»å“ªé‡Œè·å–æ•°æ®æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œå®ƒè¢«æ•´é½åœ°æ”¾ç½®åœ¨renderå‡½æ•°ä¸­ã€‚
æ— è®ºæˆ‘éœ€è¦å¼•å…¥å¤šå°‘è¿™æ ·çš„ä»£ç ï¼Œæˆ‘çš„ä»£ç éƒ½ä¸ä¼šå˜å¾—è¶Šæ¥è¶ŠåµŒå¥—ã€‚</p><p><strong>ä½†æ˜¯ å½“ä½¿ç”¨hooksçš„æ—¶å€™ä¹Ÿè¦éµå®ˆä¸€äº›<a href="https://reactjs.org/docs/hooks-rules.html">åŸåˆ™</a></strong></p><h3 id="final">Final</h3><p>è™½ç„¶hooksçš„å‡ºç°å¸¦æ¥äº†å¾ˆå¤šçš„ä¾¿åˆ©ï¼Œä½†æ˜¯å…ˆä¸è¦æ€¥ç€å»æ”¹å†™å·²æœ‰é¡¹ç›®ä¸­çš„ä»£ç ï¼Œ
æœ‰å¯èƒ½åç»­éƒ¨åˆ†hookè¿˜ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿæœ‰å¯èƒ½è¿˜å­˜åœ¨æŸäº›é—®é¢˜ï¼Œä¹Ÿæœ‰å¯èƒ½æŸäº›æƒ…å†µä¸‹æ˜¯hookæ— æ³•å¤„ç†çš„ã€‚</p><p>è™½ç„¶å¯¹äºhookçš„åˆ©å¼Šæˆ‘è¿˜ä¸å¤ªç†è§£ï¼Œä½†æ˜¯æˆ‘æ•¢äºå»å°è¯•ï¼Œå¦‚æœæœ‰æ„¿æ„ä¸€èµ·ç©çš„ï¼Œä¹Ÿå¯ä»¥è”ç³»æˆ‘ã€‚</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[A try/catch quiz]]></title>
            <link>/posts/2019-02-19/try-catch/</link>
            <guid>/posts/2019-02-19/try-catch/</guid>
            <pubDate>Mon, 18 Feb 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h2 id="a-trycatch-quiz">a try/catch quiz</h2><p>åœ¨async/awaitå‡ºæ¥åï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨äº†è¶Šæ¥è¶Šå¤šçš„try/catch, ä½†æ˜¯å¾ˆå¤šæ—¶å€™å¯¹å®ƒå¹¶ä¸äº†è§£ï¼Œä»¥åŠfinallyï¼Œæ¥ä¸‹æ¥çœ‹å‡ ä¸ªå°æ —å­  </p><h3 id="when-you-throw-a-catch">When you throw a catch</h3><p>å¦‚æœåœ¨catché‡ŒæŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆfinallyè¿˜ä¼šè¿è¡Œå˜›ã€‚çœ‹ä¸‹é¢çš„<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'å‡ºé”™å•¦'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch æ‰§è¡Œ'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> e
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æœ€åæ‰§è¡Œ'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>catch å’Œ finally çš„ <code>console.log</code>éƒ½æ‰§è¡Œäº†ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªconsole.logå¹¶æ²¡æœ‰æ‰§è¡Œ</em></p><h3 id="try-without-catch">Try without catch</h3><p>å½“åªæœ‰try / finallyçš„æ—¶å€™<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'try'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æœ€åæ‰§è¡Œ'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å°½ç®¡æ²¡æœ‰catch finallyä»ç„¶è¢«æ‰§è¡Œäº†ã€‚å½“ç„¶å³ä½¿æœ‰catch finallyè¿˜æ˜¯ä¼šè¢«æ‰§è¡Œ</em></p><h3 id="return-and-finally">Return and finally</h3><p>å¦‚æœåœ¨tryé‡Œé¢è¿”å›,é‚£ä¹ˆ finallyè¿˜ä¼šæ‰§è¡Œå˜›<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'return try'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å³ä½¿åœ¨tryé‡Œè¿›è¡Œäº†return finallyä»ç„¶ä¼šæ‰§è¡Œ</em></p><h3 id="the-rule">The Rule</h3><p>finally åœ¨try/catch/finallyé‡Œï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œã€‚æ‰€ä»¥å¯ä»¥åœ¨finallyå¤„ç†loadingçŠ¶æ€ã€‚é‚£ä¹ˆ<code>Promise.finally</code>æ˜¯å¦ä¹Ÿæ˜¯ä¸€æ ·ã€‚ </p><h3 id="promise-fulfilled">Promise fulfilled</h3><p>å½“promiseçš„çŠ¶æ€ä¸º<code>fulfilled</code>çš„æ—¶å€™, æ‰§è¡Œäº†<a href="https://codepen.io/anon/pen/BMvgdK?editors=1112">finally</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="promise-rejected">Promise rejected</h3><p>å½“promiseçš„çŠ¶æ€ä¸º<code>rejected</code>çš„æ—¶å€™, æ˜¯å¦æ‰§è¡Œäº†<a href="https://codepen.io/anon/pen/BMvgdK?editors=1112">finally</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å½“promiseçš„çŠ¶æ€ä¸º<code>rejected</code>çš„æ—¶å€™, finally ä»ç„¶ä¼šè¢«æ‰§è¡Œã€‚</em></p><p>è¿™ä¹Ÿæ˜¯æœ¬æ–‡çš„çµæ„Ÿæ‰€åœ¨ã€‚<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">promiseæ–‡æ¡£</a><br/>æ¯”å¦‚åœ¨è¯·æ±‚æ¥å£çš„æ—¶å€™ï¼Œåœ¨æ¥å£æ²¡æœ‰è¿”å›ä¹‹å‰æ˜¾ç¤ºloadingä¿¡æ¯ï¼Œæ¥å£è¿”å›åæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½åº”è¯¥å–æ¶ˆloading, æ¥ä¸ª<a href="https://codesandbox.io/s/v10k0xyqwl">æ —å­ğŸŒ°</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">LoadingMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>setLoading<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»åŠ è½½</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>loading <span class="token operator">?</span> <span class="token string">"åŠ è½½ä¸­..."</span> <span class="token punctuation">:</span> <span class="token string">"loading success"</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>å¯¹äºæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯æ‹’ç»çŠ¶æ€éƒ½è¦æ‰§è¡Œçš„ï¼Œå°±å¯ä»¥æ”¾åœ¨finallyé‡Œè¿›è¡Œå¤„ç†å•¦</em></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React.forwardRef]]></title>
            <link>/posts/2019-04-13/forwardRef/</link>
            <guid>/posts/2019-04-13/forwardRef/</guid>
            <pubDate>Fri, 12 Apr 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="reactforwardref">React.forwardRef</h1><p><code>forwardRef</code> ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³é«˜é˜¶ç»„ä»¶ä¸­æ— æ³•æ‹¿åˆ°refçš„é—®é¢˜ï¼Œä»¥åŠåœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°åŸç”Ÿçš„DOMå…ƒç´   <a href="https://reactjs.org/docs/react-api.html#reactforwardref">forwardRef</a>  </p><p>æ¥ä¸‹æ¥ä¸»è¦çœ‹ä¸‹ <code>forwardRef</code> çš„ç”¨æ³•ï¼Œä»¥åŠåœ¨ <code>hooks</code> ä¸­çš„ç›¸å…³ç”¨æ³•</p><h2 id="é«˜é˜¶ç»„ä»¶ä¸­çš„-ref">é«˜é˜¶ç»„ä»¶ä¸­çš„ <code>ref</code></h2><p>åœ¨ç±»ç»„ä»¶ä¸­ï¼Œ æƒ³è¦è°ƒç”¨åŸç”Ÿçš„äº‹ä»¶ï¼Œ æˆ‘ä»¬çš„åšæ³•é€šå¸¸æ˜¯æš´éœ²ä¸€ä¸ªæ–¹æ³•ï¼Œ åœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ï¼Œ æ¯”å¦‚ <code>input</code> çš„ <code>focus</code> äº‹ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>

  <span class="token function-variable function">focus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">el</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef <span class="token operator">=</span> el<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ç»„ä»¶å¤–éƒ¨ï¼Œ æƒ³è¦ä¸»åŠ¨ä½¿ <code>input</code> èšç„¦ </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> testRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>testRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>

testRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>ç”¨è¿‡ä¼ é€’ <code>ref</code>, è°ƒç”¨ç»„ä»¶å†…éƒ¨çš„ <code>focus</code> æ–¹æ³•ï¼Œ ä½¿ <code>input</code> ä¸»åŠ¨èšç„¦  </p><p>é‚£å¦‚æœæ­¤æ—¶æœ‰ä¸€ä¸ªé«˜é˜¶ç»„ä»¶å°è£…äº†è¿™ä¸ª <code>Input</code> ç»„ä»¶ å¦‚ä½•è°ƒç”¨ <code>focus</code> ä½¿ input ä¸»åŠ¨èšç„¦  </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Hoc</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>æ­¤æ—¶ï¼Œ å¦‚ä½•è°ƒç”¨ <code>Input</code> é‡Œçš„ <code>focus</code> æ–¹æ³•ï¼Œ ä¼¼ä¹æ˜¯æ²¡æœ‰åŠæ³•(ä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘ä¸çŸ¥é“), <code>forwardRef</code> ç”±æ­¤è€Œç”Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> testRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
<span class="token punctuation">}</span>

React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span>Hoc<span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Hoc</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>testRef<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>

testRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>æ­¤æ—¶ <code>testRef.current.focus()</code> å°±å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œ ä½¿ <code>input</code> èšç„¦</p><h2 id="å‡½æ•°å¼ç»„ä»¶--ç›´æ¥æ“ä½œ-dom">å‡½æ•°å¼ç»„ä»¶  ç›´æ¥æ“ä½œ <code>DOM</code></h2><p>æˆ‘ä»¬ä¸å¦¨æŠŠ  <code>Input</code> æ”¹æ­£å‡½æ•°å¼ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span>
</code></pre><p>æ­¤æ—¶ <code>Input</code> çš„ <code>ref</code> ç›´æ¥æŒ‚åœ¨åˆ° <code>DOM</code> ä¸Šäº†ï¼Œ ä¸ºäº†ä½¿ <code>input</code> èšç„¦</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>

inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// èšç„¦ ğŸ˜Š</span>
inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// å¤±ç„¦ ğŸ˜ˆ</span>
</code></pre><h2 id="hooks-ä¸­ä½¿ç”¨">hooks ä¸­ä½¿ç”¨</h2><p>å¦‚æœæƒ³è¦è¾¾åˆ°å’Œ <code>class</code> ç›¸åŒçš„æ•ˆæœï¼Œ åœ¨å‡½æ•°ä¸­è¯¥å¦‚ä½•åš, <code>hooks</code> æä¾›äº†ç›¸åº”çš„api</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">blur</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>Input</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>

inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// èšç„¦ ğŸ˜Š</span>
inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// å¤±ç„¦ ğŸ˜ˆ</span>
</code></pre><p>æƒ³è¦è¯¦ç»†äº†è§£ï¼Œ å‰å¾€ <a href="https://reactjs.org/docs/react-api.html#reactforwardref">å®˜ç½‘</a> </p><p><code>React</code> å®˜ç½‘å›¢é˜Ÿ æœ‰äº†æ–°çš„<a href="https://github.com/reactjs/rfcs/pull/107#issuecomment-466304382">æè®®</a>å¯èƒ½ä¼šè§£å†³ <code>forwardRef</code> è¿™ç§å¤æ‚çš„ç”¨æ³•</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Hooks vs Class]]></title>
            <link>/posts/2019-05-28/hooks-vs-class/</link>
            <guid>/posts/2019-05-28/hooks-vs-class/</guid>
            <pubDate>Mon, 27 May 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="hooks-vs-class">Hooks vs Class</h1><p>React é‡Šæ”¾ <code>hooks</code> å·²ç»åŠå¹´äº†ï¼Œä» hooks åˆšåˆšé‡Šæ”¾çš„æ—¶å€™æˆ‘å°±å¼€å§‹å…³æ³¨ï¼Œå¹¶ä¸”å°±å¼€å§‹å»å°è¯•ä½¿ç”¨å®ƒã€‚ ä»é‡Šæ”¾åˆ°ç°åœ¨ hooks åˆšè¿‡ä¸å°‘ï¼Œ å†…éƒ¨æºç è‡³å°‘æ”¹äº†ä¸¤ä¸‰æ¬¡ï¼Œ é‚£ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« å‘¢ ï¼Ÿ æ˜¯å› ä¸ºä¸€æ¬¡å¶ç„¶çš„äº‹æƒ…å¼•å‘çš„ã€‚ æœ‰ä¸€å¤©<code>æ¸Šè™¹</code>è€å“¥æŠ±ç€ç”µè„‘å¯¹æˆ‘è¯´ï¼Œ ä½ çœ‹æˆ‘è¿™ä¸ªè¡¨å•çš„æäº¤æ—¶é—´å°±æ˜¯åœ¨è°ƒç”¨ <code>onSubmit</code> çš„æ—¶å€™æœ‰ç‚¹å»¶è¿Ÿå•Šï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘€? æˆ‘è¯•äº†ä¸€ä¸‹æœç„¶æ˜¯è¿™æ ·ï¼Œ å¾ˆå¥‡æ€ªäº†ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ ? äºæ˜¯æˆ‘æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯éš¾é“æˆ‘æŠŠ<code>åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†</code>å¯¼è‡´çš„ï¼Ÿ è¿˜æ˜¯æœ‰å¯èƒ½çš„å•Šï¼Œäºæ˜¯æˆ‘åœ¨ç¾¤é‡Œé—®äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜</p><img src="https://user-images.githubusercontent.com/17973020/58377052-f8fcdd80-7faa-11e9-9755-773651feb5a1.png" height="500"/><img src="https://user-images.githubusercontent.com/17973020/58377171-0ca94380-7fad-11e9-9030-cd2a7d5fe676.png" height="500"/><p>äºæ˜¯æˆ‘å°±åœ¨ç¬¬äºŒå¤©è·‘äº†ä¸€ä¸‹ï¼Œè¯•è¯•åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†çš„è¯ï¼Œä¼šé€ æˆå¤šå°‘çš„å»¶è¿Ÿã€‚å½“æ•°é‡<code>å°äº100ä¸ª</code>æ—¶å€™ï¼Œç®€å•çš„å‡½æ•°åŒæ­¥å¼‚æ­¥æ—¶é—´åŸºæœ¬ä¸€è‡´ï¼Œ1000 ä¸ªçš„æ—¶å€™æ—¶é—´å°±æœ‰ä¸€äº›å°çš„å·®è·äº†ï¼Œ 10000 ä¸ªçš„æ—¶å€™å·®è·éå¸¸æ˜æ˜¾ï¼Œ <code>æ‰€ä»¥å¿…è¦çš„æ—¶å€™ï¼ŒåŒæ­¥è¿˜æ˜¯åŒæ­¥ï¼Œä¸è¦å½“åšå¼‚æ­¥æ¥å¤„ç†äº†</code>, é‚£ä¸€ä¸ª <code>form</code> å†…éƒ¨è¶…è¿‡ 100 ä¸ªæ ¡éªŒå‡½æ•°åŸºæœ¬ä¸å¯èƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹é¢æˆ‘å°±å¿½ç•¥äº†, é‚£ä¼šä¸ä¼šæ˜¯å¦å¤–ä¸€ç§å¯èƒ½å‘¢ï¼Ÿ</p><h2 id="render-æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ">render æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ</h2><p>å†ä¸€æ¬¡åˆ†æäº†<code>æ¸Šè™¹</code>è€å“¥çš„ä»£ç ï¼Œå‘ç°åœ¨æäº¤è¡¨å•çš„æ—¶å€™ï¼Œ<code>render</code> äº†å››æ¬¡ï¼Œäºæ˜¯æˆ‘å»æŸ¥äº†ä¸‹æºç ï¼Œå‘ç°è¿™å››æ¬¡åˆ†åˆ«æ˜¯ï¼Œ<code>æ ¡éªŒè®¾ç½®é”™è¯¯</code> =&gt; <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>è®¾ç½®è¡¨å•æ˜¯å¦æœ‰æ•ˆ</code> =&gt; <code>è®¾ç½®æäº¤æ¬¡æ•°</code>, ç„¶ååœ¨è°ƒç”¨ <code>onSubmit</code>ï¼Œ å“å‘€è¿™ä¸ªåœ°æ–¹æœ‰æœ‰å¾…ä¿®æ”¹çš„ï¼Œæ¯”å¦‚å¯ä»¥æ”¹æˆè¿™æ · <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>å¦‚æœæœ‰æ•ˆï¼Œè°ƒç”¨ onSubmit åœ¨è®¾ç½®æœ‰æ•ˆçŠ¶æ€å’Œæäº¤æ¬¡æ•°</code>ã€‚ å¦åˆ™åœ¨ <code>è®¾ç½®é”™è¯¯å’ŒçŠ¶æ€</code>ï¼Œ è¿™æ ·å‘¢å°±èƒ½ä¿è¯ <code>onSubmit</code> çš„æäº¤åªæœ‰ä¸€æ¬¡ <code>setState</code> çš„æ“ä½œï¼Œçœ‹ä¸‹ä»£ç çš„æˆªå›¾</p><p>ä¹‹å‰çš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377128-31e98200-7fac-11e9-8627-685ce89c7ccf.png" alt="d97dca23"/></p><p>ä¿®æ”¹åçš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377137-52194100-7fac-11e9-9503-dfc0e707c492.png" alt="fc8f38a3"/></p><p>è¿™æ ·åœ¨ <code>onSubmit</code> ä¹‹å‰å°±ä¼šè°ƒç”¨çš„å¾ˆå¿«ï¼Œ å³ä½¿ <code>render</code> å¾ˆè€—æ—¶</p><p>é‚£è‚¯å®šä¼šæœ‰äººæå‡ºæ¥è¿™æ ·çš„é—®é¢˜ï¼Œ render æ—¶é—´é•¿è¿™ä¸ªæ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„é—®é¢˜å¯¼è‡´çš„ï¼Œ é‚£ä¹ˆ <code>render</code> æ¬¡æ•°è¿‡å¤šè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œä¼š <code>render</code> è¿™ä¹ˆå¤šæ¬¡å‘¢ ï¼Ÿé‚£ä»è¿™é‡Œå°±å¼•èµ·ä»Šå¤©è¿™ä¸ªè¯é¢˜äº†ï¼Ÿ <code>class vs hooks</code></p><p>ä»£ç ç‚¹å‡»è¿™é‡Œ =&gt; <a href="https://codesandbox.io/s/hooks-vs-class-5buww">hooks vs class - CodeSandbox</a></p><p>æœ€ç®€å•çš„å°±æ˜¯åœ¨äº‹ä»¶ä¸­æ¥æµ‹è¯•åŒºåˆ«ã€‚<code>hooks and class</code> çš„ <code>increase</code> äº‹ä»¶éƒ½æ˜¯åŒæ­¥çš„ï¼Œæˆ‘ä»¬åœ¨ç‚¹å‡» <code>increasement</code> çš„æŒ‰é’®çš„æ—¶å€™æ‰“å¼€æ§åˆ¶å°çœ‹ä¸‹è¾“å‡ºæ˜¯ä»€ä¹ˆ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377138-65c4a780-7fac-11e9-9267-9b40f275e8c5.png" alt="45965b8f"/></p><p>å¯ä»¥çœ‹åˆ° <code>console</code> çš„é¡ºåºæ˜¯å…ˆè¾“å‡ºäº†äº‹ä»¶è°ƒç”¨ä¸­çš„ <code>console</code>ï¼Œ åœ¨è¾“å‡ºäº† <code>render</code> ä¸­çš„ <code>console</code>ï¼Œ è¿™ä¸ªå¤§å®¶éƒ½æ˜¯çŸ¥é“çš„ï¼Œ <code>setState</code> æ˜¯<a href="https://reactjs.org/docs/faq-state.html#when-is-setstate-asynchronous">å¼‚æ­¥çš„</a> , ä¿®æ”¹ä¸‹ä»£ç ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶å‡½æ•°é‡Œå¤šæ¬¡ <code>setState</code> ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿç»“æœè¾“å‡ºè¿˜æ˜¯ä¸€æ ·å‘¢ï¼Ÿå¯¹äºè¿™æ ·æ˜¯ä¸ºä»€ä¹ˆï¼Œå¯ä»¥çœ‹<a href="https://reactjs.org/docs/state-and-lifecycle.html#state-updates-may-be-asynchronous">å®˜ç½‘</a>ä»¥åŠ<a href="https://juejin.im/post/5b45c57c51882519790c7441">setState è§£æ</a>ï¼Œ
åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®ï¼Œè¿™ä¸ªå’Œ <code>decrease</code> æ˜¯ä¸€æ ·çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬åªå–ä¸€ä¸ªæ¥åˆ†æï¼Œ ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®åçœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377148-7ecd5880-7fac-11e9-8686-523fb69f01d7.png" alt="e5a1163b"/></p><p><code>hooks</code> render çš„æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œç„¶è€Œåœ¨ class ä¸­ render äº† å››æ¬¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿçœ‹èµ·æ¥å¾ˆå¥‡æ€ªæ˜¯ä¸æ˜¯ã€‚é‚£æˆ‘ä»¬ä¸å¦¨åœ¨ <code>hooks</code> ä¸­åœ¨å¢åŠ å‡ ä¸ªçœ‹çœ‹æ€ä¹ˆæ ·?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377153-8bea4780-7fac-11e9-8757-52307d8b6463.png" alt="2e4c8768"/></p><p>å®Œå…¨ä¸€æ ·ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨ä¿®æ”¹ä¸‹ï¼Œåœ¨ <code>hooks</code> ä¸­æ¯æ¬¡éƒ½è®¾ç½®ä¸ä¸€æ ·çš„å€¼çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¾“å‡ºå¦‚ä¸‹</p><p><img src="https://user-images.githubusercontent.com/17973020/58377157-986ea000-7fac-11e9-88d3-ca0bbd31882c.png" alt="47307b50"/></p><p>è¿™æ¬¡æ˜¯ä¸€è‡´äº†å¯¹ä¸å¯¹ï¼Œ éƒ½æ˜¯ <code>render</code> äº† 4 æ¬¡åæ‰è°ƒç”¨ <code>console</code> çš„ï¼Œè‡³äºåœ¨ class ä¸­ä¸ºä»€ä¹ˆè¡¨ç°æ˜¯è¿™æ ·çš„çœ‹<a href="https://juejin.im/post/5b45c57c51882519790c7441">ä¸Šé¢çš„æ–‡ç« </a></p><p>é‚£åœ¨ <code>hooks</code> ä¸­ä¸ºä»€ä¹ˆä¼šè¡¨ç°çš„å¦‚æ­¤ä¸ä¸€è‡´å‘¢ï¼Ÿ <a href="https://reactjs.org/docs/hooks-reference.html#bailing-out-of-a-state-update">å®˜ç½‘</a>ä¹Ÿè´´äº†å‡ºæ¥</p><p><img src="https://user-images.githubusercontent.com/17973020/58377158-a6bcbc00-7fac-11e9-9b78-54572ac17b52.png" alt="dccae51f"/></p><p>ä¼šç”¨ <code>Objest.is</code> ä¼šè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè®¤ä¸ºæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±ä¼š <code>bailout</code>, æœ‰çš„äººå¯èƒ½ä¼šå’Œæˆ‘æœ‰ä¸€æ ·çš„æƒ³æ³•ï¼Œå½“åˆæˆ‘åœ¨çœ‹è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘è§‰å¾—åœ¨è°ƒç”¨ç¬¬äºŒæ¬¡ <code>render</code> çš„æ—¶å€™å°±çŸ¥é“æ˜¯ä¸€æ ·çš„äº†ï¼Œé‚£åº”è¯¥ä¸ä¼šåœ¨åˆ° <code>commit</code> é˜¶æ®µäº†å§ã€‚æˆ‘ä»¬ä¸å¦¨æ¥è¯•è¯•</p><p>åœ¨ <code>hooks</code> åŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ class ä¸­ä¹ŸåŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®çœ‹ä¸‹è¾“å‡ºå¦‚ä½•ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377167-da97e180-7fac-11e9-930d-74da2f014e1e.png" alt="77290f12"/></p><p>æœçœŸæ˜¯è¿™æ ·çš„ï¼Œ åœ¨ <code>hooks</code> ä¸­ç¬¬äºŒæ¬¡æ‰§è¡Œ <code>render</code> å¹¶ä¸ä¼šåœ¨å»æ‰§è¡Œ <code>commit</code> äº†ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡ <code>render</code> çš„æ—¶å€™æ‰§è¡Œäº† <code>commit</code>ï¼Œ ç„¶è€Œ <code>class</code> ä¸­å´æ¯æ¬¡éƒ½æ‰§è¡Œäº†ã€‚</p><p>æœ‰çš„åŒå­¦ä¼šé—®æ‰§è¡Œ <code>setCount</code> çš„æ—¶å€™å†…éƒ¨æºç è‚¯å®šéƒ½ä¼šå»æ‰§è¡Œï¼Œ é‚£ä¸ºå•¥ä¸æ˜¯ <code>4</code> æ¬¡ <code>render</code>ï¼Œ <code>ä¸€æ¬¡ commit</code> å‘¢ ï¼Ÿé‚£æˆ‘ä»¬æ¥çœ‹ä¸‹æºç ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ</p><p>åœ¨ <code>è°ƒç”¨ setCount</code> çš„æ—¶å€™ä¼šè°ƒç”¨æºç ä¸­çš„ <code>dispatch</code>å‡½æ•°ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>count + number = 2</code> ç»“æœæ˜¯ <code>2</code> ä¸ç­‰äºä¸Šä¸€æ¬¡çš„ <code>0</code>, æ‰€ä»¥ä¼šèµ°åˆ° <code>updateReducer</code>,
åœ¨ <code>updateReducer</code> é‡Œé¢ä¼šè¿›è¡Œæ¯”è¾ƒ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ç›¸åŒä¼šå¦‚ä½•ï¼Œ ä¼šè¿›è¡Œæ ‡è®° <code>didReceiveUpdate</code>, æŠŠ <code>didReceiveUpdate</code> æ ‡è®°ä¸º <code>true</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸º <code>true</code>ï¼Œä¼šè¿›è¡Œæ›´æ–°ã€‚å¯¹äº <code>didReceiveUpdate</code> çš„å…¶ä»–æ ‡è®°æ˜¯åœ¨ <code>beginWork</code> å‡½æ•°ä¸­.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldProps <span class="token operator">=</span> current$$<span class="token number">1.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ˜¯ç¬¬ä¸€æ¬¡ <code>setCount</code>ï¼Œ å½“ç¬¬äºŒæ¬¡ setCount çš„æ—¶å€™, <code>didReceiveUpdate</code> ä¸º <code>false</code>ï¼Œ ä¼šèµ°ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didReceiveUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">bailoutHooks</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
    current$$<span class="token number">1</span><span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    renderExpirationTime
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ®µä»£ç åœ¨å¥½å‡ å¤„éƒ½æœ‰ï¼Œ å…¶ä¸­ä¸€å¤„å°±æ˜¯åœ¨ <code>updateFunctionComponent</code> è¿™ä¸ªå‡½æ•°ä¸­ã€‚é‚£ä¹ˆ <code>bailoutHooks</code> åšäº†ä»€ä¹ˆ ?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>WIP</code> çš„ <code>updateQueue</code> æ›´æ–°ä¸º <code>current</code> çš„ <code>updateQueue</code></p><p><code>bailoutOnAlreadyFinishedWork</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
  <span class="token parameter">current$$<span class="token number">1</span><span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  renderExpirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cancelWorkTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reuse previous context list</span>
    workInProgress<span class="token punctuation">.</span>contextDependencies <span class="token operator">=</span> current$$<span class="token number">1.</span>contextDependencies<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't update "base" render times for bailouts.</span>
    <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check if the children have any pending work.</span>
  <span class="token keyword">var</span> childExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The children don't have any work either. We can skip them.</span>
    <span class="token comment">// TODO: Once we add back resuming, we should check if the children are</span>
    <span class="token comment">// a work-in-progress set. If so, we need to transfer their effects.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// This fiber doesn't have work, but its subtree does. Clone the child</span>
    <span class="token comment">// fibers and continue.</span>
    <span class="token function">cloneChildFibers</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å½“æ‰§è¡Œåˆ°ç¬¬ä¸‰æ¬¡ <code>setCount</code> çš„æ—¶å€™ï¼Œ ä¼šè¢«ç›´æ¥ <code>return</code> ä»£ç åœ¨ <code>dispatchAction</code> ä¸­,
å› ä¸ºåœ¨ <code>queue.dispatch</code> ç»‘å®šäº† <code>dispatchAction</code></p><pre><code class="language-jsx(84)" data-language="jsx(84)" data-highlighted-line-numbers="">function dispatchAction(fiber, queue, action) {
  !(numberOfReRenders &lt; RE_RENDER_LIMIT)
    ? invariant(
        false,
        &quot;Too many re-renders. React limits the number of renders to prevent an infinite loop.&quot;
      )
    : void 0;

  {
    !(arguments.length &lt;= 3)
      ? warning$1(
          false,
          &quot;State updates from the useState() and useReducer() Hooks don&#39;t support the &quot; +
            &quot;second callback argument. To execute a side effect after &quot; +
            &quot;rendering, declare it in the component body with useEffect().&quot;
        )
      : void 0;
  }

  var alternate = fiber.alternate;
  if (
    fiber === currentlyRenderingFiber$1 ||
    (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber$1)
  ) {
    // This is a render phase update. Stash it in a lazily-created map of
    // queue -&gt; linked list of updates. After this render pass, we&#39;ll restart
    // and apply the stashed updates on top of the work-in-progress hook.
    didScheduleRenderPhaseUpdate = true;
    var update = {
      expirationTime: renderExpirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };
    if (renderPhaseUpdates === null) {
      renderPhaseUpdates = new Map();
    }
    var firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);
    if (firstRenderPhaseUpdate === undefined) {
      renderPhaseUpdates.set(queue, update);
    } else {
      // Append the update to the end of the list.
      var lastRenderPhaseUpdate = firstRenderPhaseUpdate;
      while (lastRenderPhaseUpdate.next !== null) {
        lastRenderPhaseUpdate = lastRenderPhaseUpdate.next;
      }
      lastRenderPhaseUpdate.next = update;
    }
  } else {
    flushPassiveEffects();

    var currentTime = requestCurrentTime();
    var _expirationTime = computeExpirationForFiber(currentTime, fiber);

    var _update2 = {
      expirationTime: _expirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };

    // Append the update to the end of the list.
    var _last = queue.last;
    if (_last === null) {
      // This is the first update. Create a circular list.
      _update2.next = _update2;
    } else {
      var first = _last.next;
      if (first !== null) {
        // Still circular.
        _update2.next = first;
      }
      _last.next = _update2;
    }
    queue.last = _update2;

    if (
      fiber.expirationTime === NoWork &amp;&amp;
      (alternate === null || alternate.expirationTime === NoWork)
    ) {
      // The queue is currently empty, which means we can eagerly compute the
      // next state before entering the render phase. If the new state is the
      // same as the current state, we may be able to bail out entirely.
      var _lastRenderedReducer = queue.lastRenderedReducer;
      if (_lastRenderedReducer !== null) {
        var prevDispatcher = void 0;
        {
          prevDispatcher = ReactCurrentDispatcher$1.current;
          ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnUpdateInDEV;
        }
        try {
          var currentState = queue.lastRenderedState;
          var _eagerState = _lastRenderedReducer(currentState, action);
          // Stash the eagerly computed state, and the reducer used to compute
          // it, on the update object. If the reducer hasn&#39;t changed by the
          // time we enter the render phase, then the eager state can be used
          // without calling the reducer again.
          _update2.eagerReducer = _lastRenderedReducer;
          _update2.eagerState = _eagerState;
          if (is(_eagerState, currentState)) {
            console.log(&quot;ç›´æ¥é€€å‡º&quot;);
            // Fast path. We can bail out without scheduling React to re-render.
            // It&#39;s still possible that we&#39;ll need to rebase this update later,
            // if the component re-renders for a different reason and by that
            // time the reducer has changed.
            return;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        } finally {
          {
            ReactCurrentDispatcher$1.current = prevDispatcher;
          }
        }
      }
    }
    {
      if (shouldWarnForUnbatchedSetState === true) {
        warnIfNotCurrentlyBatchingInDev(fiber);
      }
    }
    scheduleWork(fiber, _expirationTime);
  }
}
</code></pre><p><code>_lastRenderedReducer</code> å°±æ˜¯ <code>basicStateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç¬¬ä¸‰ç¬¬å››æ¬¡ä¼šåœ¨è¿™ä¸ªåˆ¤æ–­è¯­å¥é‡Œé€€å‡ºã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is</span><span class="token punctuation">(</span>_eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Fast path. We can bail out without scheduling React to re-render.</span>
  <span class="token comment">// It's still possible that we'll need to rebase this update later,</span>
  <span class="token comment">// if the component re-renders for a different reason and by that</span>
  <span class="token comment">// time the reducer has changed.</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é‚£ä¹ˆç¬¬äºŒæ¬¡ä¸ºä»€ä¹ˆä¸åœ¨è¿™é‡Œé€€å‡ºå‘¢ ï¼Ÿ åœ¨ç¬¬äºŒæ¬¡è¿™é‡Œçš„è¯­å¥æ˜¯ <code>false</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>è¿½æº¯ä¸‹å†…éƒ¨çš„è°ƒç”¨ï¼Œ åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ <code>fiber.expirationTime !== NoWork</code>, æ‰€ä»¥è¿™ä¸ªåˆ¤æ–­è¯­å¥å°±ä¸ä¼šèµ°, é‚£ä¹ˆç¬¬ä¸‰æ¬¡ä¸ºä»€ä¹ˆåˆç›¸ç­‰äº†å‘¢ï¼Ÿå†ä¸€æ¬¡çœ‹ä¸‹ <code>bailoutHooks</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>current.expirationTime = NoWork;</code> è¿›è¡Œäº†èµ‹å€¼ã€‚æ‰€ä»¥è¿™å°±æ˜¯æ•´ä¸ªè¿‡ç¨‹äº†ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p><code>class</code> å’Œ <code>hooks</code> ä¸­åŸºæœ¬ä¿æŒä¸€è‡´, ä½†æ˜¯ <code>hooks</code> ä¸­ä¼šåšä¸€å±‚ <code>Object.is</code> çš„åˆ¤æ–­ï¼Œ
æ‰€ä»¥åœ¨è¿›è¡ŒçŠ¶æ€æ›´æ–°çš„æ—¶å€™ï¼Œ éœ€è¦æ³¨æ„ä¸‹è¿™ç‚¹ã€‚è¿˜æœ‰åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œ <code>hooks</code> ä¹Ÿæ— æ³•æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œ å› ä¸ºåœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œ æ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°ï¼Œ æ‰€ä»¥è¾“å‡ºçš„éƒ½æ˜¯ä¹‹å‰çš„å€¼ï¼Œ è¿™ä¸ªç‚¹è¦æ³¨æ„ä¸€ä¸‹ã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒ <code>Dan</code> çš„åšå®¢ <a href="https://overreacted.io/a-complete-guide-to-useeffect/">A Complete Guide to useEffect</a></p><p><a href="https://codesandbox.io/s/hooks-vs-class-5buww">æŸ¥çœ‹ä»£ç </a></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Hooks State ğŸ¤”]]></title>
            <link>/posts/2019-06-03/state/</link>
            <guid>/posts/2019-06-03/state/</guid>
            <pubDate>Sun, 02 Jun 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="setxxxx-vs-setstate">setXXXX vs setState</h1><p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºäº†åˆ†æ <code>Hooks</code> ä¸­ <code>setXXX</code> å’Œ class ä¸­ <code>setState</code> çš„ä¸€äº›ä¸åŒä¹‹å¤„ï¼Œ <a href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> åˆ†æäº† <code>state</code> çš„éƒ¨åˆ†ä¸åŒï¼Œä»¥åŠå„è‡ªè°ƒç”¨è§¦å‘çš„ <code>render</code> æ¬¡æ•°çš„åˆ†æï¼Œ åŒæ­¥å’Œå¼‚æ­¥çŠ¶æ€ä¸‹çš„åŒºåˆ«ã€‚è¦è®°ä½çš„æ˜¯åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œ<code>setXXX</code> ä¼šè¿›è¡Œ <code>Object.is</code> è¿›è¡Œæ¯”è¾ƒã€‚</p><h2 id="åŸå› ">åŸå› </h2><p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºæ˜¨å¤© <code>åŸå‹é“¾</code> åœ¨å†™ <code>form</code> çš„æ—¶å€™é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œ è‡³äºä¸ºä»€ä¹ˆåˆæ˜¯ <code>form</code> æˆ‘å°±ä¸å¤šåšæè¿°äº†ã€‚è¿™æ˜¯æˆ‘å’Œ <code>åŸå‹é“¾</code> çš„å¯¹è¯:</p><p><code>åŸå‹é“¾</code>: è“é“¶è‰ä¸ºä»€ä¹ˆæˆ‘è°ƒç”¨ <code>setFieldValue</code> è®¾ç½®çš„å€¼ä¸æ­£ç¡®å‘¢ï¼Ÿ
<code>æˆ‘</code>ï¼šä½ æ˜¯æ€ä¹ˆè°ƒç”¨çš„å‘¢ï¼Ÿ
<code>åŸå‹é“¾</code>: æˆ‘æ˜¯è¿ç»­è°ƒç”¨ <code>setFieldValue</code> ä¸¤æ¬¡ï¼Œç»“æœéƒ½æ˜¯æœ€åä¸€æ¬¡ç”Ÿæ•ˆï¼Œä½†æ˜¯è°ƒç”¨ <code>setValues</code> å°±æ˜¯å¥½çš„ã€‚
<code>æˆ‘</code>ï¼šä¸å¯èƒ½å§ï¼Œæˆ‘çœ‹ä¸‹ä½ çš„å®ç°ï¼Œçœ‹äº†ä¸‹åŸå‹é“¾çš„æ¼”ç¤ºï¼ŒåŸæ¥å¦‚æ­¤ï¼Œæˆ‘çŸ¥é“äº†ä¸ºä»€ä¹ˆåªæ˜¾ç¤ºæœ€åä¸€ä¸ªäº†ï¼Œè¿™æ˜¯ <code>React</code> å‡½æ•°ç»„ä»¶å¯¼è‡´çš„è¿™ä¸ªé—®é¢˜ã€‚</p><p><a href="https://codesandbox.io/s/funny-mclean-6lru4">å…·ä½“æ —å­ç‚¹å‡»è¿™é‡Œ</a></p><p><code>hook</code> ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render hook"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hooks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      name:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby sync</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick1<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick2<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick3<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ä»£ç é‡Œç‚¹å‡»æŒ‰é’®ï¼Œç„¶åè®¾ç½® <code>name</code> å’Œ <code>hobby</code>, å¯èƒ½æœ‰äººä¼šé—®è¿™ä¸æ˜¯ä¸¤ä¸ªå±æ€§å€¼ä¸€èµ·è®¾ç½®å˜›ï¼Œä¸ºä»€ä¹ˆä¸<code>setState({ ...state, name: &#x27;ç‰§äº‘äº‘&#x27;, hobby: &#x27;coding&#x27; })</code>, å› ä¸ºå½“æ—¶ <code>setFieldValue</code> çš„ç”¨æ³•æ˜¯ <code>setFieldValue(key, value)</code>, æ‰€ä»¥å°±è°ƒç”¨äº†å¤šæ¬¡ã€‚æ­¤æ—¶ç‚¹å‡» <code>set name and hobby sync</code> æŒ‰é’®ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817731-a3221800-9353-11e9-8a15-88bdbc67bcdd.png" alt="cc37e062"/></p><p>å¯ä»¥çœ‹åˆ°åœ¨äº‹ä»¶ä¸­è¾“å‡ºçš„éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ <code>state</code>, ç„¶å <code>render</code> äº†ä¸€æ¬¡ï¼Œä¸ºä»€ä¹ˆ <code>render</code> äº†ä¸€æ¬¡å¯ä»¥çœ‹æˆ‘<a href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> ä¸­çš„é“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè·³è¿‡è¿™é‡Œï¼Œçœ‹ <code>render éƒ¨åˆ†</code>çš„è¾“å‡º</p><p><code>handleClick</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>å¯ä»¥çœ‹å‡ºåªæœ‰ç¬¬äºŒä¸ªç”Ÿæ•ˆäº†ï¼Œç›´æ¥çœ‹è¿™ä¸ªåº”è¯¥å¾ˆå®¹æ˜“çŸ¥é“ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸€æ¬¡ <code>setState</code> çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>name</code> æ˜¯ <code>ç‰§äº‘äº‘</code>, ä½†æ˜¯åœ¨è®¾ç½®ç¬¬äºŒä¸ªçš„æ—¶å€™ï¼Œ æ­¤æ—¶çš„ <code>state</code> è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ <code>name: ç‰§è€å¸ˆ</code> è¿™ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥åœ¨åˆå¹¶çš„è¿‡ç¨‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœ€åä¸€æ¬¡çš„ <code>setState</code> çš„å†…å®¹ï¼Œé‚£ä¹ˆè¾“å‡ºçš„å°±æ˜¯åªæœ‰ <code>hobby: coding</code> ç”Ÿæ•ˆã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥è¿‡ç¨‹ä¸­å‘¢ï¼Ÿæˆ–è€…æ˜¯ <code>é React åˆæˆäº‹ä»¶å’Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­</code>, å†æ¬¡ç‚¹å‡» <code>set name and hobby async</code>, é‚£ä¹ˆè¾“å‡ºåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><code>handleClick1</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setTimeout(() => {</span>
    <span class="token comment">//   setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">//   console.log("hook state change name async", state);</span>
    <span class="token comment">// }, 3000);</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817757-b8974200-9353-11e9-9dda-b211de81e24d.png" alt="55a12b25"/></p><p>å¯ä»¥çœ‹åˆ° <code>render</code> äº†ä¸¤æ¬¡ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¹Ÿèµ°äº†ä¸¤æ¬¡ï¼Œè¿™ä¸ªä¸æ˜¯æˆ‘ä»¬ä»Šå¤©å…³å¿ƒçš„é‡ç‚¹ï¼Œä»Šå¤©å…³å¿ƒçš„é‡ç‚¹åœ¨ <code>state</code> çš„æ›´æ–°ä¸Š, ç¬¬ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ <code>name</code> å‘ç”Ÿäº†å˜æ›´ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> ä»ç„¶æ˜¯ä¹‹å‰çš„ <code>name: ç‰§è€å¸ˆ</code>ï¼Œ æ‰€ä»¥ç¬¬ä¸€æ¬¡è®¾ç½®çš„ <code>name: ç‰§äº‘äº‘</code> è¢«è¦†ç›–äº†ï¼Œé¡µé¢ä¸ŠåŸºæœ¬çœ‹ä¸å‡ºæ¥ <code>name</code> å˜åŒ–çš„è¿‡ç¨‹, é‚£æˆ‘ä»¬æŠŠç¬¬äºŒä¸ª <code>setState</code> æ”¾åˆ° <code>setTimeout</code> ä¸­å‘¢ï¼Œ æ­¤æ—¶é¡µé¢çš„å˜åŒ–è¿‡ç¨‹æ˜¯å¾ˆå®¹æ˜“çœ‹å‡ºæ¥çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">// console.log("hook state change name async", state);</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ ·ä¿®æ”¹çš„è¯ï¼Œ é¡µé¢çš„å˜åŒ–è¿‡ç¨‹å°±å¾ˆæ¸…æ™°.è¿™ä¸ªå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ä¾‹å­.</p><h4 id="usecallback">useCallback</h4><p><code>setState</code> åœ¨ hooks ä¸­å’Œ class ä¸­éƒ½æ˜¯æ”¯æŒå›è°ƒçš„æ–¹å¼çš„ï¼Œé‚£ä¹ˆä¸å¦¨å°è¯•ä¸€ä¸‹å›è°ƒçš„æ–¹å¼</p><p><code>handleClick2</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆè¾“å‡ºçš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817787-d5337a00-9353-11e9-88e1-e2306f65b8cf.png" alt="42e8111c"/></p><p>å’Œæˆ‘ä»¬é¢„æœŸçš„æ˜¯ä¸€è‡´çš„ï¼Œ<code>name</code> å’Œ <code>hobby</code> éƒ½å‘ç”Ÿäº†æ›´æ–°, è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå•ç‹¬çœ‹ä»£ç å¯ä»¥çŸ¥é“åœ¨æ‰§è¡Œå‡½æ•°çš„æ—¶å€™éƒ½ä¼šæŠŠä¸Šä¸€æ¬¡çš„ <code>state</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ¯æ¬¡ <code>preState</code> éƒ½æ˜¯ä¸Šä¸€æ¬¡æœ€æ–°çš„ <code>state</code> æ‰€ä»¥èƒ½æ‹¿åˆ°æœ€æ–°çš„ã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥ä¸­è¡¨ç°åˆæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ
æ‰§è¡Œå¼‚æ­¥çš„ä»£ç </p><p><code>handleClick3</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817797-e2506900-9353-11e9-8aac-c71f58ceb4e6.png" alt="1bf0c6c2"/></p><p>è¡¨ç°çš„æ˜¯ä¸€è‡´çš„ã€‚åœ¨ class ä¸­è¡¨ç°çš„æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ ?</p><h3 id="class">Class</h3><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Class</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
        name:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ç‚¹å‡»æŒ‰é’®çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817816-f5fbcf80-9353-11e9-8d37-9aa3820dacbb.png" alt="c6f6e146"/></p><p><code>class</code> ä¸­è¡¨ç°çš„æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåœ¨ class ä¸­ï¼Œ state æ˜¯æŒ‚åœ¨ <code>this</code> ä¸Šå§‹ç»ˆè¿™ä¸ª state éƒ½æ˜¯ç›¸åŒçš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡ <code>setState</code> åï¼Œæ­¤æ—¶çš„ <code>name</code> ä¿®æ”¹ä¸ºäº† <code>ç‰§äº‘äº‘</code>ï¼Œ å†ä¸€æ¬¡è°ƒç”¨ <code>setState</code> çš„æ—¶å€™ï¼Œå†…éƒ¨æ‹¿åˆ°çš„ <code>this.state</code> å·²ç»æ˜¯æœ€æ–°çš„ <code>name</code> äº†ï¼Œæ‰€ä»¥åœ¨è®¾ç½® <code>hobby</code> çš„æ—¶å€™å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚</p><p>çœ‹ä¸‹ <code>updateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
  <span class="token operator">!</span><span class="token punctuation">(</span>queue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Should have a queue. This is likely a bug in React. Please file an issue.'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>numberOfReRenders <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a re-render. Apply the new render phase updates to the previous</span>
    <span class="token keyword">var</span> _dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render phase updates are stored in a map of queue -> linked list</span>
      <span class="token operator">...</span>çœç•¥éƒ¨åˆ†
    <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> _dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The last update in the entire queue</span>
  <span class="token keyword">var</span> last <span class="token operator">=</span> queue<span class="token punctuation">.</span>last<span class="token punctuation">;</span>
  <span class="token comment">// The last update that is part of the base state.</span>
  <span class="token keyword">var</span> baseUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">;</span>
  <span class="token keyword">var</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>

  <span class="token comment">// Find the first unprocessed update.</span>
  <span class="token keyword">var</span> first <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseUpdate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// For the first update, the queue is a circular linked list where</span>
      <span class="token comment">// `queue.last.next = queue.first`. Once the first update commits, and</span>
      <span class="token comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span>
      last<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    first <span class="token operator">=</span> baseUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    first <span class="token operator">=</span> last <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> last<span class="token punctuation">.</span>next <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _newState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevUpdate <span class="token operator">=</span> baseUpdate<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _update <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token keyword">var</span> didSkip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> _update<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Priority is insufficient. Skip this update. If this is the first</span>
        <span class="token comment">// skipped update, the previous update/state is the new base</span>
        <span class="token comment">// update/state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          didSkip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
          newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update the remaining priority in the queue.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">></span> remainingExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          remainingExpirationTime <span class="token operator">=</span> updateExpirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Process this update.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
          <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
          _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
          _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      prevUpdate <span class="token operator">=</span> _update<span class="token punctuation">;</span>
      _update <span class="token operator">=</span> _update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>_update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> _update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
      newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark that the fiber performed work, but only if the new state is</span>
    <span class="token comment">// different from the current state.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseUpdate <span class="token operator">=</span> newBaseUpdate<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>

    queue<span class="token punctuation">.</span>lastRenderedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817874-23e11400-9354-11e9-8f56-bf6995fc93e3.jpg" alt="ddda387a"/></p><p>å…³æ³¨è¿™å—ä»£ç </p><p><img src="https://user-images.githubusercontent.com/17973020/59817900-38bda780-9354-11e9-8769-0d2e3d62336d.jpg" alt="8764128b"/></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
  <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
  _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
  _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ª <code>reducer</code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span>basicStateReducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰€ä»¥è¿™ä¸ª <code>reducer</code> å°±æ˜¯ <code>basicStateReducer</code>, ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°å°±æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯å‡½æ•°å°±ç›´æ¥è¿”å›è¿™ä¸ª <code>state</code>. <code>_update.action</code> å­˜å‚¨çš„å°±æ˜¯<code>setXX</code> çš„å‚æ•°ï¼Œæ‰€ä»¥åœ¨ä¼ é€’çš„ä¸æ˜¯å‡½æ•°çš„æ—¶å€™ç›´æ¥å°±ä¼šè¿”å› <code>_action2</code>, å¦åˆ™å°±ä¼šè¿”å› <code>_action2(_newState)</code> æ‹¿åˆ°æœ€æ–°çš„å€¼.</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆ <code>ä¼ é€’è¿›å»çš„ State</code> ä¸æ˜¯æœ€æ–°çš„å‘¢ï¼Ÿ å¯ä»¥å‚è€ƒ <a href="https://overreacted.io/how-are-function-components-different-from-classes/">How Are Function Components Different from Classes?</a> <code>Dan</code> åœ¨è¿™ç¯‡æ–‡ç« é‡Œé¢è¯¦ç»†è¯´æ˜äº†ï¼Œæ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°.</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç±»ç»„ä»¶ä¸­ï¼Œ <code>setState</code> ä¼šè‡ªåŠ¨è¿›è¡Œå€¼çš„åˆå¹¶ï¼Œæ‰€ä»¥å¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ <code>hooks</code> ä¸­åœ¨è°ƒç”¨ <code>setXXX</code> çš„æ—¶å€™å¿…é¡»è¦è®¾ç½®å…¨éƒ¨çš„å€¼ï¼Œå¹¶ä¸”ç”±äºå‡½æ•°é—­åŒ…çš„ç‰¹æ€§ï¼Œè°ƒç”¨å¤šæ¬¡ <code>setXXXX</code> è¿›è¡Œå¯¹è±¡ç»“æ„èµ‹å€¼çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> å§‹ç»ˆæ˜¯ä¹‹å‰çš„ <code>state</code>ï¼Œ å¦‚æœè¦æƒ³è·å–åˆ°æœ€æ–°çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>setXXX(callback)</code> çš„æ–¹å¼æ‹¿åˆ°æœ€æ–°çš„å€¼.</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Context ğŸ˜]]></title>
            <link>/posts/2019-08-10/context/</link>
            <guid>/posts/2019-08-10/context/</guid>
            <pubDate>Fri, 09 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="context">Context</h1><p><a href="https://reactjs.org/docs/context.html#when-to-use-context">context</a> åœ¨ react ä¸­æ˜¯ä¸€ä¸ªç¥å¥‡çš„ä¸œè¥¿ï¼Œ<code>context</code> çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³åœ¨ react ä¸­ä¼ é€’ props éœ€è¦å¤šå±‚ä¼ é€’çš„é—®é¢˜ï¼Œ
åœ¨ä½¿ç”¨äº† context ä¹‹åå¯ä»¥æœ‰æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä» 15 ç‰ˆæœ¬åˆ° 16 ç‰ˆæœ¬, <code>context</code> çš„ api ä¹Ÿå‘ç”Ÿäº†ä¸å°‘çš„å˜åŒ–ã€‚å…ˆçœ‹ä¸‹åœ¨ class ä¸­å¦‚ä½•ä½¿ç”¨ context</p><h2 id="class-context">Class Context</h2><p>é¦–å…ˆéœ€è¦å…ˆå£°æ˜ä¸€ä¸ª context, å¦‚ä½•å£°æ˜ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡è°ƒç”¨ <code>React.createContext</code> æ¥åˆ›å»ºä¸€ä¸ª context çš„å£°æ˜, å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæ¯”å¦‚æ­¤æ—¶æœ‰çˆ¶ç»„ä»¶å«åš app</p><p>app.js</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'lanyincao'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Provider
          value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span> updateState<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>updateState <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å¯ä»¥é€šè¿‡è°ƒç”¨ <code>context.Provider</code> æ¥ä½œä¸ºçˆ¶ç»„ä»¶çš„é‚£ä¸€å±‚ï¼Œæ­¤æ—¶éœ€è¦æ¥å—ä¸€ä¸ª <code>value</code> çš„ props, æ¯æ¬¡ value å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šè§¦å‘ <code>context</code> çš„é‡æ–°æ¸²æŸ“ã€‚</p><p>æ—¢ç„¶ <code>context</code> çš„ç›®çš„æ˜¯ä¸ºäº†è§£å†³ props ä¼ é€’çš„é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å­ç»„ä»¶ä¸­æ˜¯å¦‚ä½•æ‹¿åˆ°åœ¨ app.js ä¸­çš„æ•°æ®å‘¢, å‡è®¾æ­¤æ—¶æœ‰å­ç»„ä»¶å« <code>ExampleA.js</code></p><p>ExampleA.js</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>div<span class="token operator">></span>xxxx<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨å­ç»„ä»¶ä¸­éœ€è¦ä½¿ç”¨ <code>context.Consumer</code>, è¿™æ˜¯ä¸€ä¸ª <a href="https://reactjs.org/docs/render-props.html#use-render-props-for-cross-cutting-concerns">render props</a> ç»„ä»¶, æ¥æ”¶ä¸€ä¸ªå‚æ•°å«åš
<code>value</code>, æ­¤æ—¶çš„ <code>value</code> å°±æ˜¯ <code>context.Provider</code> ä¼ é€’ä¸‹æ¥çš„ <code>value</code>, æ‰€ä»¥å°±å¯ä»¥åœ¨å†…éƒ¨ä½¿ç”¨æ‹¿åˆ°çš„ <code>value</code>ã€‚</p><h2 id="tips">Tips</h2><p>åœ¨ä½¿ç”¨ <code>context</code> çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€äº›ç‚¹ï¼Œé¦–å…ˆ <code>context</code> æ˜¯æ— æ³•è¢« <code>bailout</code> æ„æ€å°±æ˜¯æ— è®ºä½ æ˜¯ä½¿ç”¨ <code>PureComponent</code> è¿˜æ˜¯ <code>memo</code> éƒ½æ˜¯æ— æ³•é˜»æ­¢ <code>context</code> çš„æ›´æ–°çš„ã€‚å¹¶ä¸”å¦‚æœ context æ‰€åœ¨çš„ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä½†æ˜¯ context å‘ç”Ÿäº†æ›´æ–°ï¼Œ
é‚£ä¹ˆæ­¤æ—¶åªä¼šæ¸²æŸ“ <code>context</code> çš„éƒ¨åˆ†, æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleB</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ç‚¹å‡» <code>updateAge</code> ä¼šè°ƒç”¨é¡¶å±‚çš„ <code>updateAge</code>, é‚£ä¹ˆ <code>app</code> ç»„ä»¶è¢«æ›´æ–°ï¼Œæ‰€ä»¥ <code>Provider</code> çš„ <code>value</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€ä»¥ <code>context</code> å°†ä¼šæ›´æ–°ã€‚ä½†æ˜¯ <code>ExampleB</code> ç»„ä»¶ä¸­çš„ <code>console.log(111)</code> å¹¶
æ²¡æœ‰è¢«æ‰“å°å‡ºæ¥ï¼Œé‡Œé¢çš„ <code>age</code> å´å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ <code>react</code> æœ¬èº«åšçš„ä¼˜åŒ–ä¹‹ä¸€å§ï¼Œå‘ç”Ÿåšä¸å¿…è¦çš„æ¸²æŸ“ã€‚é‚£ä¹ˆåœ¨çœ‹ä¸‹ <code>ExampleC</code> ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleC</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ <code>ExampleC</code> ç»„ä»¶æ˜¯ <code>PureComponent</code>, <code>PureComponent</code> å¯¹ç»„ä»¶åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼Œå½“ <code>props</code> æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ˜¯ä¸ä¼š <code>render</code> çš„ï¼Œæ­¤æ—¶ <code>ExampleC</code> ç»„ä»¶æ²¡æœ‰å¤šä½™çš„ props, ç‚¹å‡» <code>updateAge</code>, ä¼šå‘ç° <code>ExampleC</code> ä¸­çš„
<code>age</code> ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯ <code>console.log(111)</code> ä»ç„¶ä¹Ÿæ²¡æœ‰è¾“å‡ºï¼Œæ‰€ä»¥æ— è®ºæ˜¯ <code>PureComponent</code> è¿˜æ˜¯ <code>memo</code>ï¼Œ <code>shouldComponentUpdate</code> éƒ½æ˜¯æ— æ³•é˜»æ­¢ <code>context</code> çš„æ›´æ–°çš„ã€‚</p><h2 id="hook-context">Hook Context</h2><p><code>React</code> å›¢é˜Ÿåœ¨å»å¹´ 10 æœˆä»½çš„ <code>conf</code> ä¸Šè®²åˆ°äº† <code>Hook</code>, å¯ä»¥åœ¨å‡½æ•°ä¸­ä½¿ç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆ <code>Hook</code> è§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåœ¨ <code>class</code> ä¸­å¾ˆå¤šæ—¶å€™éœ€è¦ä½¿ç”¨ <code>Hoc</code>, <code>render props</code>, è¿™äº›é«˜é˜¶çš„æ–¹æ³•æ¥å°è£…ä¸€äº›æ–¹æ³•ï¼Œåœ¨ <code>js</code> ä¸­ï¼Œ
éƒ½çŸ¥é“<code>å›è°ƒåœ°ç‹±</code>ï¼Œ é‚£ä¹ˆåœ¨ <code>react</code> ä¸­å°±å­˜åœ¨äº†ä¸€ç§å«åš <code>åµŒå¥—åœ°ç‹±</code> çš„å½¢å¼ï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
  <span class="token operator">&lt;</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
          <span class="token operator">&lt;</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
                  <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
    <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
</code></pre><p>è¿™ç§æœ‰å¯èƒ½ä¼šåµŒå¥—çš„éå¸¸éå¸¸çš„ç¥ï¼Œå¯¹äºè°ƒè¯•æ¥è¯´ä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚è¿™ä¹Ÿæ˜¯ <code>Hook</code> å‡ºæ¥çš„åŸå› ä¹‹ä¸€ã€‚å…·ä½“ <a href="https://reactjs.org/docs/hooks-intro.html">Hook ç”¨æ³•</a> å¯ä»¥å»å‚ç…§å®˜ç½‘å³å¯ã€‚</p><p>ä»Šå¤©åœ¨è¿™é‡Œä¸»è¦æ¥ä»‹ç»åœ¨ <code>Hook</code> ä¸­å¦‚ä½•ä½¿ç”¨ <code>context</code>ï¼Œ åœ¨ <code>Hook</code> æœ‰ä¸€ä¸ª <code>hook</code> å«åš <a href="https://reactjs.org/docs/hooks-reference.html#usecontext">useContext</a></p><p><code>éœ€è¦æ³¨æ„çš„æ˜¯æ‰€æœ‰çš„</code>Hook<code>åªèƒ½ç”¨äºå‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œå¦‚æœåœ¨ class ä¸­è¿˜éœ€è¦ç”¨ class çš„ç”¨æ³•</code></p><p>ä¸æ”¾æŠŠä¸Šé¢çš„ <code>ExampleB</code> ç»„ä»¶è¿›è¡Œæ”¹é€ æˆå‡½æ•°ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ExampleB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨å‡½æ•°é‡Œä½¿ç”¨äº† <code>useContext</code>, æ³¨æ„æ‰€æœ‰çš„ <code>Hook</code> éƒ½å¿…è¦åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„é¡¶å±‚ä½¿ç”¨ï¼ï¼ï¼
<code>useContext</code> æ¥æ”¶çš„å‚æ•°æ˜¯ <code>context</code>, è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ä¸€ä¸‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">Correct<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
Incorrect<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
Incorrect<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>useContext</code> çš„è¿”å›å€¼å°±æ˜¯ <code>context.Provider</code> çš„ <code>value</code> çš„å€¼ï¼Œå½“ <code>value</code> å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>context</code> çš„åœ°æ–¹å°±ä¼šå‘ç”Ÿæ›´æ–°ã€‚æ¯”å¦‚æ­¤æ—¶ç‚¹å‡»
<code>updateAge</code>ï¼Œ é‚£ä¹ˆ <code>ExampleB</code> å°±ä¼šå‘ç”Ÿæ›´æ–°ï¼Œ<code>age</code> å°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><p>åœ¨ <code>Hook</code> ä¸­ä½¿ç”¨ <code>useContext</code> æä¸ºç®€å•ï¼Œä½†æ˜¯ä¸€å®šè¦è®°å¾—åœ¨<code>é¡¶å±‚ä½¿ç”¨</code>ã€‚<code>context</code> é€šå¸¸ä¼šä¸ <code>useReducer</code> ä¸€èµ·ä½¿ç”¨, æ¯”å¦‚åˆ›å»ºä¸€ä¸ªç®€å•çš„è¡¨å•ï¼Œå°±å¯ä»¥è¿™ä¹ˆå¤„ç†ã€‚è‡³äºå¦‚ä½•åˆ›å»º
é«˜æ•ˆçš„ <code>Form</code>, è¿™é‡Œå°±ä¸åšè¯¦ç»†çš„é˜è¿°ã€‚</p><h2 id="context-is-necessary">context is necessary?</h2><p><code>context</code> ä¸€èˆ¬èƒ½è§£å†³å¤§éƒ¨åˆ†çš„åœºæ™¯ï¼Œä½†æ˜¯æ˜¯å¦æ‰€æœ‰çš„åœºæ™¯éƒ½é€‚åˆ <code>context</code> å‘¢ï¼Ÿç°åœ¨å¸‚åœºä¸Šæœ‰å¾ˆå¤šçš„çŠ¶æ€ç®¡ç†çš„åº“æ¯”å¦‚ <code>redux</code>, <code>mobx</code>, <code>rematch</code>, <code>reselect</code>, <code>dva</code> ç­‰ä¸€äº›åº“æ¥å¤„ç†
çŠ¶æ€çš„é—®é¢˜ã€‚è¿™äº›åº“å¯èƒ½å¤„ç†çš„ä¸ä»…ä»…æ˜¯çŠ¶æ€çš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›å‰¯ä½œç”¨çš„å¤„ç†ç­‰ã€‚ä»¥ <code>react-redux</code> ä¸ºä¾‹</p><p>åœ¨ <code>react-redux</code> ä¸­ä¹Ÿä½¿ç”¨äº† context, ä½†æ˜¯å†…éƒ¨ä»£ç ç¡®é‡‡ç”¨äº† <code>subscriber</code> çš„æ–¹å¼ï¼Œä¸ºä»€ä¹ˆï¼Ÿåœ¨ <code>class</code> ä¸­è¯´è¿‡åªè¦ä½¿ç”¨ <code>context</code> çš„åœ°æ–¹,éƒ½ä¼šé€ æˆæ›´æ–°ï¼Œé‚£ä¹ˆæ¯”å¦‚åœ¨ A ç»„ä»¶ä¸­åªéœ€è¦ <code>age</code> å­—æ®µ
åœ¨ <code>B</code> ç»„ä»¶ä¸­åªéœ€è¦ <code>name</code> å­—æ®µï¼Œæ‰€å¸Œæœ›çš„æ˜¯åœ¨ä¿®æ”¹ <code>age</code> çš„æ—¶å€™ï¼Œ <code>B</code> ç»„ä»¶æ˜¯ä¸åº”è¯¥å‘ç”Ÿ <code>render</code> çš„ï¼Œæ‰€ä»¥ <code>react-redux</code> å†…éƒ¨é‡‡ç”¨äº†è¿™ç§æ–¹å¼æ¥å¤„ç† <code>context</code> å¼•èµ·çš„æ€§èƒ½é—®é¢˜ã€‚é€šå¸¸åœ¨æ—¥å¸¸çš„ä¸šåŠ¡ä»£ç ä¸­
ä¸ç”¨å¤ªå…³å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ <code>context</code> çš„æ—¶å€™é€šå¸¸æ¶‰åŠçš„ç»„ä»¶æ•°é‡ä¸ä¼šå¾ˆå¤šï¼Œå³ä½¿å¤š <code>render</code> äº†å‡ æ¬¡ä¹Ÿä¸ä¼šé€ æˆå¤ªå¤§çš„å½±å“ã€‚</p><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ <code>context</code>ï¼Œåˆé‡åˆ°äº†åŒæ ·çš„æ€§èƒ½é—®é¢˜ï¼Œå¯èƒ½ä½ å¹¶ä¸æƒ³ç”¨ <code>react-redux</code>ï¼Œé‚£ä¹ˆæˆ‘æ¨èä½¿ç”¨ <a href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> è¿™ä¸ªåº“ï¼Œè¿™ä¸ªåº“çš„å†™æ³•å¾ˆç®€å•ï¼Œä¹Ÿ
åšåˆ°äº†éƒ¨åˆ†æ¸²æŸ“ï¼Œä¿®æ”¹ A ç»„ä»¶å¹¶ä¸ä¼šå½±å“åˆ° B ç»„ä»¶ã€‚åªéœ€è¦åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>useSelector</code> å³å¯</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux-chaos'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ExampleA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      age<span class="token punctuation">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateAge'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ã€‚</p><h2 id="conslusion">Conslusion</h2><p><code>context</code> è§£å†³äº†çŠ¶æ€å¤šå±‚ä¼ é€’çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ä¼šå¼•èµ·ä¸€äº›æ€§èƒ½æ–‡è‰ºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦å¤ªå¤šå…³æ³¨è¿™ä¸ªæ€§èƒ½é—®é¢˜ï¼Œé™¤éçœŸæ­£çš„é‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚åœ¨å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨ <code>useContext</code> æ–°çš„ <code>Hook</code> æ¥è¾¾åˆ°å’Œ class ä¸­
åŒæ ·çš„æ•ˆæœã€‚</p><h2 id="thanks">Thanks</h2></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ğŸ¤” Form]]></title>
            <link>/posts/2019-08-19/form/</link>
            <guid>/posts/2019-08-19/form/</guid>
            <pubDate>Sun, 18 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>è¡¨å•ç»„ä»¶æ˜¯åœ¨ <code>Bç«¯</code> å¼€å‘ä¸­æœ€å¸¸ç”¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, <code>Textarea</code>, <code>DatePicker</code> ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„è¡¨å•ç±»ç»„ä»¶ï¼Œç„¶è€Œè¡¨å•çš„ç®¡ç†ç¡®æ˜¯æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†ã€‚å¸¸è§„åœ¨å¼€å‘è¡¨å•çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™å¯èƒ½ä¸ä½¿ç”¨ <code>Form</code> è¿™æ ·çš„ç»„ä»¶è€Œæ˜¯è¿™æ ·</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">submit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å§“å<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>name<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å¹´é¾„<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>age<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> age<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>åœ°å€<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>address<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> address<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">></span>æäº¤<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ä½¿ç”¨åŸºç¡€çš„ <code>form</code> æ ‡ç­¾ï¼ŒåŸºç¡€è¡¨å•åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ä¹ˆå†™çš„ï¼Œå£°æ˜è¡¨å•ä¸­æ‰€éœ€è¦çš„çŠ¶æ€ï¼Œå¯¹åº”çš„ <code>value</code> ä¸å„è‡ªçš„ç»„ä»¶å¯¹åº”èµ·æ¥ï¼Œå¦‚æœå­˜åœ¨æ ¡éªŒä¿¡æ¯çš„æ˜¯ï¼Œè¿˜éœ€è¦è¿›è¡Œæ ¡éªŒã€‚å› ä¸ºè¡¨å•å¾ˆå¤šæ—¶å€™æ˜¯éœ€è¦è¿›è¡Œå®æ—¶æ ¡éªŒçš„ï¼ŒåŠæ—¶è®©ç”¨æˆ·å‘ç°é—®é¢˜ï¼Œç„¶åèƒ½åŠæ—¶æ”¹æ­£é—®é¢˜ã€‚é‚£è¿™æ ·æ¯ä¸€ä¸ª <code>Input</code> è¿™æ ·çš„ç»„ä»¶éƒ½åº”è¯¥éœ€è¦ <code>validate</code> è¿™æ ·çš„ä¸€ä¸ªæ ¡éªŒå‡½æ•°ï¼Œè¿˜æœ‰æ˜¯å¦åœ¨ <code>onChange</code> æ—¶å€™æ ¡éªŒè¿˜æ˜¯åœ¨ <code>onBlur</code> çš„æ—¶å€™æ ¡éªŒï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬çš„çŠ¶æ€ä¸æ˜¯ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·å†™æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿä½†æ˜¯å³ä½¿æ˜¯è¿™æ ·ç®€å•çš„è¡¨å•ï¼Œå¦‚æœæ­¤æ—¶æ˜¯ <code>A</code> é¡µé¢éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ <code>B</code> é¡µé¢ä¹ŸåŒæ ·éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ<code>validate</code> ç­‰éƒ½éœ€è¦ã€‚é‚£ä¹ˆè¦ä¸å»æ‹·è´ä»£ç è¿‡æ¥ä¿®æ”¹ä¸€ä¸‹ï¼Œè¦ä¸è‡ªå·±å°è£…ä¸€ä¸ª <code>Form</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="å°è£…-form-">å°è£… Form ğŸ˜²</h2><p>è€ƒè™‘ä¸€ä¸‹ä¸Šé¢çš„ä»£ç å¦‚ä½•å°è£…æˆä¸€ä¸ª <code>Form</code> å‘¢ï¼Ÿå°±åƒä¸Šé¢çš„ä»£ç ä¸€æ ·ï¼Œç»„ä»¶çš„åç§°å·²ç»å‘½åä¸º <code>Form</code> äº†, æ˜¯å¦è¿™æ ·å°±å¯ä»¥äº†å‘¢ï¼Ÿå¦‚æœå­˜åœ¨è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span>'<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span>'<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span>' <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span>'<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span>'<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æ­¤æ—¶ <code>C</code> ç»„ä»¶å†…éƒ¨æ‰ç”¨äº† <code>Input</code> è¿™æ ·çš„ç»„ä»¶ï¼Œé‚£å¦‚æœåœ¨ <code>C&#x27;</code> ç»„ä»¶ä¸­ç”¨åˆ°äº† <code>C</code> ç»„ä»¶çš„ä¿¡æ¯æ€ä¹ˆåŠå‘¢ï¼Ÿ
é‡åˆ°è¿™ç§åœºæ™¯é€šå¸¸çš„åšæ³•å«åš <code>lifting state up</code>, çŠ¶æ€æå‡ï¼Œåœ¨æ›´æ–° <code>C</code> ç»„ä»¶çš„æ—¶å€™ï¼ŒæŠŠçŠ¶æ€åŒæ­¥æ›´æ–°åˆ° <code>Form</code> ç»„ä»¶ï¼Œ <code>Form</code> ç»„ä»¶åˆæŠŠè¿™ä¸ªæ•°æ®ä¼ é€’åˆ° <code>C&#x27;</code> ç»„ä»¶ï¼Œ <code>C&#x27;</code> ç»„ä»¶æ‹¿åˆ°äº†æ­£ç¡®çš„æ•°æ®ã€‚<code>Nice</code>, é€šè¿‡çŠ¶æ€æå‡ï¼ŒæˆåŠŸçš„è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™æ ·æ¯æ¬¡å°±éœ€è¦åœ¨ <code>Form</code> ä¸­å­˜å‚¨çŠ¶æ€ï¼Œç„¶åè¿˜éœ€è¦ä¼ é€’å›è°ƒå‡½æ•°åˆ°éœ€è¦çš„ç»„ä»¶ä¸­ï¼Œæ›´æ–°ç›¸åº”çš„çŠ¶æ€ã€‚å¦‚æœç»„ä»¶åµŒå¥—åªæœ‰ <code>2 - 3</code> å±‚çš„æ—¶å€™ï¼Œè¿™æ ·æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœç»„ä»¶åµŒå¥—æœ‰å¾ˆå¤šå±‚å‘¢ï¼Ÿæ¯”å¦‚æ­¤æ—¶ <code>E ç»„ä»¶</code> æ‰æ˜¯ <code>Input</code> ç»„ä»¶çš„æ‰€åœ¨ï¼Œé‚£ä¹ˆè¿™æ ·åµŒå¥—ä¸‹å»ä¼ é€’</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token constant">D</span><span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">D</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">C</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>çš„å±‚æ•°åªä¼šè¶Šæ¥è¶Šå¤šï¼Œåé¢ç»´æŠ¤èµ·æ¥è¦æ¯ä¸€å±‚æ¯ä¸€å±‚å»çœ‹ï¼Œé˜²æ­¢å…¶ä¸­ä¸€å±‚å‡ºç°é—®é¢˜äº†ã€‚é’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆå¤šç«¥é‹ä¼šæƒ³åˆ° <code>react-redux</code>, <code>mbox</code> é€šè¿‡çŠ¶æ€ç®¡ç†å·¥å…·æ¥è§£å†³è¿™æ ·çš„ä¼ é€’çš„é—®é¢˜ï¼Œæ­å–œæ€è·¯æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œé€šè¿‡ç›®å‰çš„ä¸€äº›çŠ¶æ€ç®¡ç†åº“æ˜¯å¯ä»¥åšåˆ°çš„ã€‚ä¸å¦¨ä»¥ <code>react-redux</code> ä¸¾ä¾‹ï¼Œ <code>react-redux</code> å†…éƒ¨ä½¿ç”¨äº† <code>React Context</code>, æ˜¯çš„ï¼Œ <code>React</code> å›¢é˜Ÿä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæä¾›äº† <code>context</code> è¿™æ ·çš„ <code>api</code>, é‚£ä¹ˆ <code>context</code> å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> createContext<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> FormContext <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch<span class="token punctuation">:</span> setValue <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é¦–å…ˆéœ€è¦ä½¿ç”¨ <code>React.createContext</code> æ¥åˆ›å»ºä¸€ä¸ª <code>context</code>, ç„¶ååœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>context.Provider</code>, <code>context.Provider</code> æ¥å—ä¸€ä¸ª <code>value</code> propsï¼Œ å¦‚ä½•è·å–åˆ° <code>value</code> ä¸­çš„å€¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>FormContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡åœ¨<code>å­ç»„ä»¶</code>ä¸­ä½¿ç”¨ <code>useContext()</code> è·å–åˆ°ç›¸åº”çš„ value, å¦‚æœåœ¨ <code>class ç»„ä»¶</code>ä¸­åˆ™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Field</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨ <code>FormContext.Consumer</code> çš„æ–¹å¼ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>render props</code> çš„ç»„ä»¶ã€‚å› ä¸ºä¸€ä¸ªæ™®é€šçš„ <code>Form</code> å°±å¯ä»¥ç®€æ´çš„å®Œæˆäº†, é¦–å…ˆåœ¨ <code>Form</code> ç»„ä»¶ä¸­åˆ©ç”¨ <code>context.Provider</code> æŠŠæƒ³è¦çš„å€¼å’Œæ–¹æ³•ä¼ é€’ä¸‹å»ï¼Œåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ‹¿åˆ° <code>value</code> å’Œ <code>dispatch</code>, è¿™æ ·å°±è§£å†³äº†å¤šå±‚ä¼ é€’çŠ¶æ€çš„é—®é¢˜ã€‚è¿™æ ·ç®€çº¦çš„è¡¨å•ç”¨èµ·æ¥å¾ˆçˆ½ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡çš„æ…¢æ…¢å¤æ‚ï¼Œéœ€è¦çš„åŠŸèƒ½ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œè¡¨å•ä¸­çš„ç»„ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æœ‰å¯èƒ½è¿™æ ·çš„ <code>Field</code> ç»„ä»¶å¯èƒ½æœ‰å‡ åä¸ªç”šè‡³ä¸Šç™¾ä¸ªï¼Œç„¶åå‘ç°è¡¨å•å˜å¾—è¶Šæ¥è¶Šæ…¢è¶Šæ¥è¶Šæ…¢ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ¯æ¬¡æ‰§è¡Œ <code>dispatch</code> éƒ½ä¼šä¿®æ”¹é¡¶å±‚çš„ value, é¡¶å±‚çš„ <code>value</code> å‘ç”Ÿå˜åŒ–äº†ï¼Œè¿™æ ·æ¯ä¸€ä¸ª <code>Field</code> ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œåªè¦æ˜¯ä½¿ç”¨äº† <code>useContext()</code> è¿™æ ·çš„ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œè¿™ä¸ªæ¸²æŸ“çš„é‡å¯èƒ½éå¸¸éå¸¸çš„å¤§ï¼ŒåŠæ—¶ä¸€ä¸ªç®€å•çš„ <code>Input</code> ä¿®æ”¹äº†å…¶ä¸­çš„ä¸€ä¸ªå€¼ï¼Œä¹Ÿä¼šé€ æˆæ•´ä¸ª <code>Form</code> é‡æ–° render, ä¸€ä¸¤æ¬¡ render å¯èƒ½è€—æ—¶éå¸¸å°‘ï¼Œä½†æ˜¯å½“è¾¾åˆ°ä¸Šç™¾ä¸ªçš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>render</code> è€—æ—¶å°±ä¼šéå¸¸éå¸¸çš„é«˜ã€‚å¯èƒ½è¿™ç¬¬ä¸€ä¸ª <code>Field</code> ä¸­åªä¿®æ”¹äº† <code>a</code> å±æ€§ï¼Œå¯æ˜¯å…¶ä»–çš„ <code>Field</code> ä¸­éƒ½æ²¡æœ‰ç”¨åˆ° <code>a</code> å±æ€§ï¼Œå…¶ä½™çš„å­ç»„ä»¶çš„æ¸²æŸ“æ˜¯å¤šä½™çš„ã€‚ä½†æ˜¯ <code>context</code> æ˜¯æ— æ³•è¢« <code>bail out</code> çš„, æ‰€ä»¥æ‰€æœ‰çš„ <code>Field</code> éƒ½ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆä¸å¦¨æ§åˆ¶ä¸‹ <code>Field</code> çš„å­ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Sub name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> validate<span class="token operator">=</span><span class="token punctuation">{</span>validate<span class="token punctuation">}</span> validateOnChange <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnchange<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>Field</code> ç»„ä»¶é€šè¿‡ä½¿ç”¨ <code>useMemo</code> è¿›è¡Œç¼“å­˜ï¼Œåªæœ‰å½“æ•°ç»„çš„å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰ä¼šå†ä¸€æ¬¡é‡æ–° <code>render</code>, <code>useMemo</code> çš„ä½œç”¨å’Œ <code>react-redux</code> çš„ <code>connect</code> é«˜é˜¶å‡½æ•°çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡ä½¿ç”¨ <code>useMemo</code> å¯ä»¥æŠŠ <code>render æ—¶é—´é•¿çš„å­ç»„ä»¶</code> è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘ <code>render</code> æ—¶é—´ï¼Œæå‡æ€§èƒ½ã€‚</p><h2 id="optimize-form-">optimize form ğŸ˜Š</h2><p>æ­¤æ—¶æ˜¯å¦å·²ç»å®Œæˆäº†æ•´ä¸ª <code>Form</code> çš„ä¼˜åŒ–è¿‡ç¨‹äº†ï¼Œæ­¤æ—¶çš„ <code>Form</code>, åŒ…æ‹¬å¸¸è§„ä½¿ç”¨çš„ <code>context</code> é€šè¿‡ <code>memo</code> è¿›è¡Œä¼˜åŒ–å®é™…ä¸Šå·²ç»æé«˜äº†å¾ˆå¤šã€‚ä½†æ˜¯å³ä½¿æ˜¯å•çº¯çš„ä¸€ä¸ª <code>Field</code> ç»„ä»¶ï¼Œå¦‚æœæ•°é‡å¾ˆå¤šçš„æƒ…å†µä¸‹ä»ç„¶è¿˜æ˜¯ä¼šå­˜åœ¨å¡é¡¿çš„æƒ…å†µçš„ã€‚ç‰¹åˆ«æ˜¯å½“æ¥å…¥äº†ç¬¬ä¸‰æ–¹ç»„ä»¶åº“çš„æ—¶å€™ã€‚æœ¬èº«ç¬¬ä¸‰æ–¹ç»„ä»¶æä¾›çš„åŠŸèƒ½æœ‰å¾ˆå¤šï¼Œç»„ä»¶æœ¬èº«ä¹Ÿä¼šå¾ˆå¤æ‚ï¼Œä¸åƒåŸç”Ÿçš„ <code>input</code> é‚£æ ·ç®€å•ï¼Œå‡è®¾æ­¤æ—¶æ¥å…¥çš„æ˜¯ <code>antd</code> çš„ç»„ä»¶åº“</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">CustomInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Field<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨å¯¹ <code>Input</code> è¿›è¡Œå¿«é€Ÿè¾“å…¥çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢çš„å“åº”ä¼šæœ‰æ‰€å»¶è¿Ÿï¼Œå¦‚æœæ‰“å¼€ <code>chrome</code> çš„ <code>performance</code> è¿›è¡Œå½•åˆ¶çš„æ—¶å€™ï¼Œå°±ä¼šçœ‹åˆ°ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œå…³äº <code>é•¿ä»»åŠ¡</code> è¿™é‡Œä¸åšè¯¦ç»†æè¿°ï¼Œè¿™ç§å¯ä»¥é€šè¿‡æ—¶é—´åˆ†ç‰‡ï¼ˆtime slicingï¼‰ æ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬é›†ä¸­åœ¨ <code>Field</code> æ¸²æŸ“è¿™å—ï¼Œ<code>Input</code> çš„æ”¹åŠ¨æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œé‚£ä¹ˆé¡¶å±‚çš„ <code>context</code> ä¿®æ”¹çš„ä¹Ÿéå¸¸é¢‘ç¹ï¼Œå³ä½¿ä½¿ç”¨äº† <code>useMemo</code> ä»ç„¶è¿˜æœ‰å¡é¡¿çš„ç°è±¡ã€‚<code>React æˆå‘˜ Dan</code> åœ¨ twitter ä¸­è¯´è¿‡ <code>context</code> å¹¶ä¸é€‚åˆä¿®æ”¹ç‰¹åˆ«é¢‘ç¹çš„ç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, ä½†æ˜¯åœ¨ <code>Form</code> ä¸­çš„ç¡®éœ€è¦ <code>context</code> æ¥å¤„ç†è¿™æ ·çš„é—®é¢˜ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Ÿå¦‚ä½•æ¥ä¼˜åŒ– <code>Form</code>?</p><p>ç›®å‰æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å­˜åœ¨äº† <code>Form</code> çš„é¡¶å±‚ï¼Œåœ¨é¡¶å±‚æ›´æ–°è§¦å‘å­ç»„ä»¶çš„æ›´æ–°ï¼Œé‚£ä¹ˆé’ˆå¯¹ <code>Field</code> è¿™ä¹ˆé¢‘ç¹çš„æ¸²æŸ“ï¼Œèƒ½å¦åšåˆ°æ¯æ¬¡ä¿®æ”¹å½“å‰ <code>Field</code> çš„æ—¶å€™ï¼Œåªä¼šæ¸²æŸ“å½“å‰çš„ <code>Field</code> å‘¢ï¼Ÿ</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>Form.js</code> ä¸­é¦–å…ˆæœ‰ä¸‰ä¸ª <code>context</code> åˆ†åˆ«æ˜¯ <code>formContext</code>, <code>formStateContext</code>, <code>formApiContext</code>ã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ä¸€ä¸ª context å‘¢ï¼Ÿå› ä¸ºé€šè¿‡ä¸‰ä¸ª context, æŠŠå„è‡ªçš„èŒèƒ½è¿›è¡ŒåŒºåˆ†ã€‚å¤šä¸ª context ä¹Ÿèƒ½èµ·åˆ°ä¼˜åŒ–çš„ä½œç”¨ï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆæ¯æ¬¡ <code>formStateContext</code> çš„ value æ›´æ–°çš„æ—¶å€™ï¼Œ<code>formApiContext</code> çš„ä½¿ç”¨å¤„çš†ä¸å—å½±å“ï¼Œ<code>A</code> ç»„ä»¶ä¸ä¼šå› ä¸º <code>B</code> ç»„ä»¶ä½¿ç”¨çš„ <code>context</code> çš„å€¼çš„å˜åŒ–è€Œè¿›è¡Œæ›´æ–°ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨å¤šä¸ª <code>context</code>ã€‚</p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>useForm.js</code> ä¸­å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>useReducer</code>, è¿™é‡Œä¸»è¦ä¸ºäº†é˜è¿°æ€æƒ³ï¼Œä½¿ç”¨ <code>useState</code>ã€‚æœ‰ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ <code>setValue</code> å’Œ <code>setError</code>, <code>setValue:</code> æ˜¯ç”¨æ¥æ›´æ–°ä¿®æ”¹çš„å€¼ï¼Œ <code>setError:</code> ç”¨æ¥è®¾ç½®é”™è¯¯çš„ä¿¡æ¯ã€‚<code>useRegister</code> è¿™é‡Œå…ˆæš‚ä¸è®¨è®ºï¼Œå…ˆçœ‹ä¸€ä¸‹å¸¸è§„çš„ <code>Field</code> ç»„ä»¶ã€‚</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸€ä¸ªç®€å•çš„ <code>Field</code> ç”¨äºä¿®æ”¹ <code>form</code> çš„å€¼ï¼Œå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Field name<span class="token operator">=</span><span class="token string">'name'</span><span class="token operator">></span>
  <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> handleChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
</code></pre><p>è¿™å°±æ˜¯ <code>Field</code> çš„ç®€å•ç”¨æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ï¼Œåªè¦ä½¿ç”¨ <code>Field</code> çš„ç»„ä»¶åœ¨å…¶ä¸­ä¸€ä¸ª <code>Field</code> ç»„ä»¶å‘ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œå…¶ä»–çš„æ‰€æœ‰çš„ <code>Field</code> ç»„ä»¶ä¹Ÿä¼šå‘ç”Ÿæ›´æ–°ã€‚å› ä¸ºåœ¨æ¯æ¬¡æ›´æ–°å€¼çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>setValue</code>, <code>useForm</code> æ›´æ–°ï¼Œè¿”å›æ–°çš„å€¼ï¼Œ<code>context</code> çš„ value å‘ç”Ÿå˜åŒ–ï¼Œæ‰€æœ‰ç”¨åˆ° <code>context</code> åœ°æ–¹éƒ½ä¼šå‘ç”Ÿæ›´æ–°ã€‚æ­¤æ—¶ä¹Ÿè®¸ä¼šæƒ³åˆ°æ¯æ¬¡è¿”å›çš„ <code>formApi</code> éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡å¥½åƒæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ˜¯çš„ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹å‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šä¸ª <code>context</code>, å› ä¸ºæ¯æ¬¡éƒ½æ˜¯æ–°çš„å¼•ç”¨è¿™æ˜¯å®Œå…¨æ²¡æœ‰æ„ä¹‰çš„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯åº”è¯¥è¿›è¡Œç¼“å­˜å‘¢ï¼Ÿè²Œä¼¼è¿™ç§æƒ³æ³•æ˜¯å¯ä»¥çš„ï¼ŒOKï¼Œåšä¸‹å»ã€‚</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>useState</code> å¯¹ <code>formApi</code> è¿›è¡Œç¼“å­˜ï¼Œç°åœ¨æ¯æ¬¡æ›´æ–°ï¼Œ<code>formApi</code> éƒ½æ˜¯ä¹‹å‰çš„å¼•ç”¨ä¸åœ¨æ˜¯æ–°çš„å¼•ç”¨ï¼Œæ¯æ¬¡å‘ç”Ÿå˜åŒ–çš„æ˜¯ <code>formState</code>, æ­¤æ—¶ä¿®æ”¹ <code>Input</code> çš„å€¼å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<code>Input</code> è¾“å…¥ä¸è¿›å»äº†ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶æ˜¯ä½¿ç”¨äº† <code>useFormApi</code></p><p><code>useFormApi.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formApiContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½†æ˜¯å› ä¸ºåœ¨ <code>Form</code> ä¸­å¯¹ <code>formApi</code> è¿›è¡Œäº†ç¼“å­˜ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>useFormApi</code> çš„ç»„ä»¶éƒ½ä¸ä¼šé‡æ–° <code>render</code>, æ‰€ä»¥ <code>Input</code> ä¸­çš„å€¼ä¼šè¾“å…¥ä¸è¿›å»ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯éœ€è¦æŠŠåœ¨ <code>Field</code> ç»„ä»¶ä¸­åœ¨ä½¿ç”¨ <code>useFormState</code> å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formState <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚ä½•ä½¿ç”¨ <code>useFormState</code> çš„è¯ï¼Œ é‚£å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Œå› ä¸ºæ¯ä¸€ä¸ª <code>Field</code> éƒ½ä¼šè¿›è¡Œ <code>render</code>, æ‰€ä»¥è¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ <code>useFormApi</code>, ç°åœ¨è€ƒè™‘ä¸€ä¸‹å¦‚ä½•è®©å•ä¸ª <code>Field</code> æ¸²æŸ“ä¸å½±å“å…¶ä»–çš„å‘¢ï¼Ÿ</p><p>åœ¨ä¸šåŠ¡ä¸­ï¼Œå†™ç»„ä»¶çš„æ—¶å€™ï¼Œä¸¤ä¸ªç»„ä»¶å¦‚ä½•åšåˆ°äº’ä¸å½±å“ï¼Œé‚£å°±æ˜¯ç»„ä»¶ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œæ¯”å¦‚:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'lanyincao'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>A</code> ç»„ä»¶çš„çŠ¶æ€åªåœ¨è‡ªå·±çš„ç»„ä»¶çš„å†…éƒ¨ï¼Œæ‰€ä»¥æœ¬èº« <code>A</code> ç»„ä»¶çš„æ›´æ–°å¹¶ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ç»„ä»¶çš„å˜åŒ–ã€‚é‚£æ˜¯å¦ <code>Field</code> ç»„ä»¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšå‘¢ï¼Ÿ</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> register <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ä½ç½®å†…éƒ¨å€¼çš„çŠ¶æ€</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    register<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      setValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ç”¨è¿‡ä¸€ä¸ª register æŠŠæ¯ä¸€ä¸ª <code>Field</code> çš„ setValue æ³¨å†Œè¿›å»ï¼Œå¾ˆå¤šå…¶ä»–çš„é«˜æ€§èƒ½çš„ <code>Form</code> éƒ½æ˜¯é‡‡å– <code>Observer</code> çš„å½¢å¼çš„ï¼ŒåŒ…æ‹¬ <code>react-redux</code> å¦‚ä½•è§£å†³æ€§èƒ½é—®é¢˜çš„ï¼Œéƒ½æ˜¯é€šè¿‡ <code>Observer</code> çš„å½¢å¼ã€‚çœ‹ä¸‹ <code>useRegister</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">unregister</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> unregister <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æŠŠ <code>Form</code> ä¸­çš„ <code>useRegister</code> ç§»åˆ° <code>useForm</code> ä¸­, ä¿®æ”¹ <code>useForm</code> çš„è¿”å›å€¼, ä»¥åŠä¿®æ”¹ <code>setValue</code></p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useRegister <span class="token keyword">from</span> <span class="token string">'./register'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–åˆ°å½“å‰ä¿®æ”¹çš„ field</span>
    <span class="token keyword">const</span> currentField <span class="token operator">=</span> fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨å†…éƒ¨çš„ setValue</span>
    currentField<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldsApi<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ç°åœ¨ä¿®æ”¹å…¶ä¸­ä¸€ä¸ª <code>Field</code> çš„æ—¶å€™ä¼šè°ƒç”¨å†…éƒ¨çš„ <code>setValue</code> æ–¹æ³•ï¼Œå®ç°å±€éƒ¨æ¸²æŸ“ã€‚</p><h2 id="conclusion">conclusion</h2><ul><li><code>context</code> æ¯”è¾ƒé€‚åˆäºæ”¹åŠ¨ä¸æ˜¯å¾ˆé¢‘ç¹çš„ç»„ä»¶</li><li>å¯¹äº render æ—¶é—´è¾ƒé•¿çš„å¯ä»¥ä½¿ç”¨ <code>useMemo</code> æ¥ä¼˜åŒ–</li><li>å˜åŠ¨é¢‘ç¹çš„å¯ä»¥é‡‡ç”¨å·²æœ‰çš„çŠ¶æ€ç®¡ç†åº“æ¯”å¦‚ <a href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> æˆ–è€…é‡‡å– <code>Observer</code> çš„å½¢å¼æ¥å¤„ç†</li></ul></div>]]></content:encoded>
        </item>
    </channel>
</rss>