<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>lanyincao</title>
        <link>/</link>
        <description>personal blog by lanyincao</description>
        <lastBuildDate>Sun, 01 Dec 2019 01:45:22 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[useCallback]]></title>
            <link>/posts/2019-01-10/cache/</link>
            <guid>/posts/2019-01-10/cache/</guid>
            <pubDate>Wed, 09 Jan 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><div><div class="document_logo__1v782"><img src="./static/media/navi-logo.0f2f9d7f.svg" class="document_logo-navi__bOUrK" alt="logo"/><img src="./static/media/react-logo.5d5d9eef.svg" class="document_logo-react__3-boM" alt="logo"/></div><h2 id="cache-your-event-listener">Cache your event listener</h2><p>åœ¨jsä¸­ï¼Œåˆ›å»ºä¸¤ä¸ªå‡½æ•°æ˜¯ä¸ç­‰çš„ï¼Œå¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·ã€‚æ¥ä¸ªæ —å­çœ‹ä¸‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
a <span class="token operator">===</span> b <span class="token comment">// false</span>
</code></pre><p>å¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
d <span class="token operator">===</span> c <span class="token comment">// false</span>
</code></pre><p>é‚£æˆ‘ä»¬è¿™æ ·å†™  åŒä¸€ä¸ªå¼•ç”¨å°±ç›¸ç­‰äº†</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">d</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> c <span class="token operator">=</span> d
c <span class="token operator">===</span> d <span class="token comment">//true</span>
</code></pre><p>å¯¹è±¡ä¹Ÿæ˜¯è¿™æ ·å°±ä¸å¤šæäº†ï¼Œå¥½äº†å›åˆ°æ­£é¢˜ï¼Œæˆ‘ä»¬åœ¨å†™Reactçš„æ—¶å€™ç»å¸¸éœ€è¦ç»™äº‹ä»¶åŠ ä¸Šç›‘å¬å™¨,çœ‹ä¸€ä¸‹ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ‘ä»¬â€™æ­£å¸¸ï¼ˆ<em>ä¸æ­£å¸¸</em>ï¼‰çš„ä»£ç å¾ˆå¤šéƒ½æ˜¯è¿™æ ·ï¼Œå½“ç„¶ä¸åŒ…å«ä¼šæœ‰äººæ¥å†™<code>é»‘ç§‘æŠ€</code>å•¦ã€‚åœ¨è¿™ä¸ªclickå‡½æ•°é‡Œï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°,å› ä¸ºè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¼ ä¸ªå‚æ•°ã€‚å¤§å®¶å…ˆä¸è¦æ€¥ï¼Œä¼ å˜åŒ–çš„å‚æ•°åé¢ä¼šè¯´åˆ°çš„ã€‚é‚£å¯¹äºè¿™ä¸ªæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ”¹å‘¢ã€‚æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ–è€…</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»æµ‹è¯•</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢å¤§å®¶éƒ½çŸ¥é“ï¼Œé‚£æœ‰åˆ—è¡¨çš„æƒ…å†µä¸‹å‘¢</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\

<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token parameter">item</span> <span class="token operator">=></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ªä»£ç æ˜¯æˆ‘ä»¬æ­£å¸¸çš„å†™æ³•äº†ï¼Œåœ¨æ¯æ¬¡ç‚¹å‡»çš„æ—¶å€™éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œé‚£è¿™ä¸ªæˆ‘ä»¬å…¶å®å°±å¯ä»¥åˆ©ç”¨ç¼“å­˜å‡½æ•°äº†ï¼Œè¿™ä¸ªç¼“å­˜å‡½æ•°å¯ä»¥è‡ªå·±å†™æ¯”å¦‚æˆ‘ä»¬è¿™æ ·æ”¹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token function-variable function">getCache</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
          list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token parameter">item</span> <span class="token operator">=></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ ·åªåœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œåœ¨åé¢çš„æ¯ä¸€æ¬¡éƒ½ä¼šå¼•ç”¨ä¹‹å‰çš„å‡½æ•°å•¦ã€‚</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Why React Hooks]]></title>
            <link>/posts/2019-02-15/hook/</link>
            <guid>/posts/2019-02-15/hook/</guid>
            <pubDate>Thu, 14 Feb 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h2 id="why-react-hooks">why React Hooks</h2><p>React åœ¨16.8.0çš„æ—¶å€™æ­£å¼å‘å¸ƒäº†<a href="https://reactjs.org/docs/hooks-intro.html">Hook</a>, åŸºç¡€çš„hookæœ‰<code>useState</code>, <code>useReducer</code>, <code>useEffect</code></p><h3 id="mouse-position">Mouse Position</h3><p>è¿™æ˜¯ä¸€ä¸ªè·å–é¼ æ ‡ä½ç½®çš„ğŸŒ°, <a href="https://codesandbox.io/s/xj0ppk0pzw">mousePosition</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MousePostion</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span><span class="token plain-text">
        Mouse X: </span><span class="token punctuation">{</span> x <span class="token punctuation">}</span><span class="token plain-text"> Mouse Y: </span><span class="token punctuation">{</span> y <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨å…¶ä»–çš„åœ°æ–¹å¤ç”¨è¯¥ç»„ä»¶ï¼Œå°±è¦é‡å†™ç›¸åŒçš„ä»£ç   </p><p>å¦‚æœæˆ‘ä»¬æƒ³æ‹¿åˆ°x, yçš„æ—¶å€™åœ¨å»åšå…¶ä»–çš„äº‹æƒ…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å»ä¿®æ”¹è¿™ä¸ªä»£ç ã€‚è¿™ä¸ªè¡Œä¸ºå°±è¢«é™åˆ¶åœ¨è¿™ä¸ªç»„ä»¶é‡Œé¢äº†ã€‚</p><h3 id="hoc">HOC</h3><p>ç”¨hocæ¥ä¿®æ”¹æ­¤ç»„ä»¶ï¼ŒæŠŠx, yä½œä¸ºpropsä¼ ç»™ä»»ä½•éœ€è¦ç”¨x, yçš„ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">withMouseHoc</span><span class="token punctuation">(</span><span class="token parameter">ComponentWrap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Mouse</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      y<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentWrap</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">state</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MouseHocDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        MouseHoc X: </span><span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseHoc Y: </span><span class="token punctuation">{</span>y<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶æˆ‘ä»¬æŠŠé¼ æ ‡çš„è¡Œä¸ºé€šè¿‡hocè¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œä»¥åéœ€è¦ç”¨åˆ°è¯¥è¡Œä¸ºçš„éƒ½å¯ä»¥å®Œå…¨å¤ç”¨ã€‚</p><p>è™½ç„¶è¿™æ˜¯æ›´å¤šçš„ä»£ç ï¼Œä½†æˆ‘ä»¬æ­£åœ¨æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚å®ƒä¸å†ä¸è®¢é˜…è¡Œä¸ºç´§å¯†è€¦åˆã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³æ¸²æŸ“ä¸€äº›ä¸åŒçš„ä¸œè¥¿å‘¢?æˆ‘ä»¬æ€»æ˜¯éœ€è¦åšä¸€ä¸ªæ–°çš„ç»„ä»¶å—?</p><h3 id="render-props">render props</h3><p>ç”¨render propsæ¥æ”¹å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MouseRenderProps</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>this<span class="token punctuation">.</span>state <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MouseRenderPropsDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MouseRenderProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
              MouseRenderProps X: </span><span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseRenderProps Y: </span><span class="token punctuation">{</span>y<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">MouseRenderProps</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>renderPropsä¹Ÿå¯ä»¥è§£å†³ä¹‹å‰mouseçš„é—®é¢˜,å’ŒHOCå…·æœ‰ç›¸åŒçš„åŠŸæ•ˆ</p><p>è¿™ç§ç»†å¾®çš„å·®åˆ«æœ‰ä¸€äº›éå¸¸æ£’çš„å¥½å¤„
ç°åœ¨ï¼Œæä¾›xå’Œyçš„åŠŸèƒ½éå¸¸æ˜æ˜¾ï¼Œæ‚¨è¿˜å¯ä»¥è½»æ¾åœ°é‡å‘½åå®ƒä»¬ï¼Œä»¥é˜²æ­¢åç§°å†²çªã€‚<br/>æˆ‘ä»¬å¯¹æ¸²æŸ“æœ‰çµæ´»çš„æ§åˆ¶ã€‚æˆ‘ä»¬ä¸éœ€è¦åˆ›å»ºæ–°çš„ç»„ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å†³å®šè¿™æ ·åšï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„å¤åˆ¶ç²˜è´´ã€‚<br/>æ‚¨å¯ä»¥åœ¨ç»„ä»¶å‘ˆç°å‡½æ•°ä¸­ç›´æ¥çœ‹åˆ°æ‰€æœ‰è¿™äº›ã€‚æ–°å¼€å‘äººå‘˜å¾ˆå®¹æ˜“è¯†åˆ«å®ƒã€‚<br/>è¿™ç§æ¨¡å¼çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œæ‚¨çš„ç»„ä»¶å¿…é¡»åœ¨å®ƒä»¬çš„å‘ˆç°ä¸­åµŒå¥—è®¸å¤šè¿™æ ·çš„ç»„ä»¶ã€‚ä¸€æ—¦ä½ å¼€å§‹åµŒå¥—å¤šä¸ªæ¸²æŸ“ç»„ä»¶ï¼Œä½ å°±å¾ˆéš¾æ¨æ–­å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚<br/>åŒæ—¶ï¼Œè¿™ä¹Ÿé€ æˆäº†ä¸€ç§é”™è¯¯çš„ç­‰çº§è§‚å¿µã€‚ä»…ä»…å› ä¸ºä¸€ä¸ªè¡Œä¸ºâ€œåµŒå¥—â€åœ¨å¦ä¸€ä¸ªè¡Œä¸ºä¹‹ä¸‹ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒä¾èµ–äºçˆ¶è¡Œä¸º</p><p><em>å¦‚æœæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æ‹¥æœ‰æ‰€æœ‰è¿™äº›èƒ½åŠ›ï¼Œä»¥ä¸€ç§å£°æ˜æ–¹å¼ã€‚ğŸ‘€</em></p><h3 id="hook">Hook</h3><p>ç”¨ hookæ¥æ”¹å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">mousemove</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> y<span class="token punctuation">:</span> e<span class="token punctuation">.</span>clientY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> mousemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>setPosition<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">MouseHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      MouseHook X: </span><span class="token punctuation">{</span>position<span class="token punctuation">.</span>x<span class="token punctuation">}</span><span class="token plain-text">, MouseHook Y: </span><span class="token punctuation">{</span>position<span class="token punctuation">.</span>y<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™å°±æ˜¯æˆ‘æƒ³è¦çš„ä¸€åˆ‡ã€‚</p><p>ä¸ä»…è¡Œä¸ºåœ¨å®ƒè‡ªå·±æ•´æ´çš„å°ç¨‹åºåŒ…ä¸­ï¼ŒuseEffectè¿˜é˜»æ­¢å®ƒåˆ†æ•£åœ¨ä¸‰ä¸ªä¸åŒçš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­
ç»„ä»¶ä»å“ªé‡Œè·å–æ•°æ®æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œå®ƒè¢«æ•´é½åœ°æ”¾ç½®åœ¨renderå‡½æ•°ä¸­ã€‚
æ— è®ºæˆ‘éœ€è¦å¼•å…¥å¤šå°‘è¿™æ ·çš„ä»£ç ï¼Œæˆ‘çš„ä»£ç éƒ½ä¸ä¼šå˜å¾—è¶Šæ¥è¶ŠåµŒå¥—ã€‚</p><p><strong>ä½†æ˜¯ å½“ä½¿ç”¨hooksçš„æ—¶å€™ä¹Ÿè¦éµå®ˆä¸€äº›<a href="https://reactjs.org/docs/hooks-rules.html">åŸåˆ™</a></strong></p><h3 id="final">Final</h3><p>è™½ç„¶hooksçš„å‡ºç°å¸¦æ¥äº†å¾ˆå¤šçš„ä¾¿åˆ©ï¼Œä½†æ˜¯å…ˆä¸è¦æ€¥ç€å»æ”¹å†™å·²æœ‰é¡¹ç›®ä¸­çš„ä»£ç ï¼Œ
æœ‰å¯èƒ½åç»­éƒ¨åˆ†hookè¿˜ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿæœ‰å¯èƒ½è¿˜å­˜åœ¨æŸäº›é—®é¢˜ï¼Œä¹Ÿæœ‰å¯èƒ½æŸäº›æƒ…å†µä¸‹æ˜¯hookæ— æ³•å¤„ç†çš„ã€‚</p><p>è™½ç„¶å¯¹äºhookçš„åˆ©å¼Šæˆ‘è¿˜ä¸å¤ªç†è§£ï¼Œä½†æ˜¯æˆ‘æ•¢äºå»å°è¯•ï¼Œå¦‚æœæœ‰æ„¿æ„ä¸€èµ·ç©çš„ï¼Œä¹Ÿå¯ä»¥è”ç³»æˆ‘ã€‚</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[A try/catch quiz]]></title>
            <link>/posts/2019-02-19/try-catch/</link>
            <guid>/posts/2019-02-19/try-catch/</guid>
            <pubDate>Mon, 18 Feb 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h2 id="a-trycatch-quiz">a try/catch quiz</h2><p>åœ¨async/awaitå‡ºæ¥åï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨äº†è¶Šæ¥è¶Šå¤šçš„try/catch, ä½†æ˜¯å¾ˆå¤šæ—¶å€™å¯¹å®ƒå¹¶ä¸äº†è§£ï¼Œä»¥åŠfinallyï¼Œæ¥ä¸‹æ¥çœ‹å‡ ä¸ªå°æ —å­  </p><h3 id="when-you-throw-a-catch">When you throw a catch</h3><p>å¦‚æœåœ¨catché‡ŒæŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆfinallyè¿˜ä¼šè¿è¡Œå˜›ã€‚çœ‹ä¸‹é¢çš„<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'å‡ºé”™å•¦'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch æ‰§è¡Œ'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> e
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æœ€åæ‰§è¡Œ'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>catch å’Œ finally çš„ <code>console.log</code>éƒ½æ‰§è¡Œäº†ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªconsole.logå¹¶æ²¡æœ‰æ‰§è¡Œ</em></p><h3 id="try-without-catch">Try without catch</h3><p>å½“åªæœ‰try / finallyçš„æ—¶å€™<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'try'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æœ€åæ‰§è¡Œ'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å°½ç®¡æ²¡æœ‰catch finallyä»ç„¶è¢«æ‰§è¡Œäº†ã€‚å½“ç„¶å³ä½¿æœ‰catch finallyè¿˜æ˜¯ä¼šè¢«æ‰§è¡Œ</em></p><h3 id="return-and-finally">Return and finally</h3><p>å¦‚æœåœ¨tryé‡Œé¢è¿”å›,é‚£ä¹ˆ finallyè¿˜ä¼šæ‰§è¡Œå˜›<a href="https://codepen.io/anon/pen/LqMoJd?editors=1111">ä¾‹å­</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'return try'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally è¿è¡Œ'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å³ä½¿åœ¨tryé‡Œè¿›è¡Œäº†return finallyä»ç„¶ä¼šæ‰§è¡Œ</em></p><h3 id="the-rule">The Rule</h3><p>finally åœ¨try/catch/finallyé‡Œï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œã€‚æ‰€ä»¥å¯ä»¥åœ¨finallyå¤„ç†loadingçŠ¶æ€ã€‚é‚£ä¹ˆ<code>Promise.finally</code>æ˜¯å¦ä¹Ÿæ˜¯ä¸€æ ·ã€‚ </p><h3 id="promise-fulfilled">Promise fulfilled</h3><p>å½“promiseçš„çŠ¶æ€ä¸º<code>fulfilled</code>çš„æ—¶å€™, æ‰§è¡Œäº†<a href="https://codepen.io/anon/pen/BMvgdK?editors=1112">finally</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="promise-rejected">Promise rejected</h3><p>å½“promiseçš„çŠ¶æ€ä¸º<code>rejected</code>çš„æ—¶å€™, æ˜¯å¦æ‰§è¡Œäº†<a href="https://codepen.io/anon/pen/BMvgdK?editors=1112">finally</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><em>å½“promiseçš„çŠ¶æ€ä¸º<code>rejected</code>çš„æ—¶å€™, finally ä»ç„¶ä¼šè¢«æ‰§è¡Œã€‚</em></p><p>è¿™ä¹Ÿæ˜¯æœ¬æ–‡çš„çµæ„Ÿæ‰€åœ¨ã€‚<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">promiseæ–‡æ¡£</a><br/>æ¯”å¦‚åœ¨è¯·æ±‚æ¥å£çš„æ—¶å€™ï¼Œåœ¨æ¥å£æ²¡æœ‰è¿”å›ä¹‹å‰æ˜¾ç¤ºloadingä¿¡æ¯ï¼Œæ¥å£è¿”å›åæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½åº”è¯¥å–æ¶ˆloading, æ¥ä¸ª<a href="https://codesandbox.io/s/v10k0xyqwl">æ —å­ğŸŒ°</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">LoadingMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>setLoading<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">ç‚¹å‡»åŠ è½½</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>loading <span class="token operator">?</span> <span class="token string">"åŠ è½½ä¸­..."</span> <span class="token punctuation">:</span> <span class="token string">"loading success"</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>å¯¹äºæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯æ‹’ç»çŠ¶æ€éƒ½è¦æ‰§è¡Œçš„ï¼Œå°±å¯ä»¥æ”¾åœ¨finallyé‡Œè¿›è¡Œå¤„ç†å•¦</em></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React.forwardRef]]></title>
            <link>/posts/2019-04-13/forwardRef/</link>
            <guid>/posts/2019-04-13/forwardRef/</guid>
            <pubDate>Fri, 12 Apr 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="reactforwardref">React.forwardRef</h1><p><code>forwardRef</code> ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³é«˜é˜¶ç»„ä»¶ä¸­æ— æ³•æ‹¿åˆ°refçš„é—®é¢˜ï¼Œä»¥åŠåœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°åŸç”Ÿçš„DOMå…ƒç´   <a href="https://reactjs.org/docs/react-api.html#reactforwardref">forwardRef</a>  </p><p>æ¥ä¸‹æ¥ä¸»è¦çœ‹ä¸‹ <code>forwardRef</code> çš„ç”¨æ³•ï¼Œä»¥åŠåœ¨ <code>hooks</code> ä¸­çš„ç›¸å…³ç”¨æ³•</p><h2 id="é«˜é˜¶ç»„ä»¶ä¸­çš„-ref">é«˜é˜¶ç»„ä»¶ä¸­çš„ <code>ref</code></h2><p>åœ¨ç±»ç»„ä»¶ä¸­ï¼Œ æƒ³è¦è°ƒç”¨åŸç”Ÿçš„äº‹ä»¶ï¼Œ æˆ‘ä»¬çš„åšæ³•é€šå¸¸æ˜¯æš´éœ²ä¸€ä¸ªæ–¹æ³•ï¼Œ åœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ï¼Œ æ¯”å¦‚ <code>input</code> çš„ <code>focus</code> äº‹ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>

  <span class="token function-variable function">focus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">el</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef <span class="token operator">=</span> el<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ç»„ä»¶å¤–éƒ¨ï¼Œ æƒ³è¦ä¸»åŠ¨ä½¿ <code>input</code> èšç„¦ </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> testRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>testRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>

testRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>ç”¨è¿‡ä¼ é€’ <code>ref</code>, è°ƒç”¨ç»„ä»¶å†…éƒ¨çš„ <code>focus</code> æ–¹æ³•ï¼Œ ä½¿ <code>input</code> ä¸»åŠ¨èšç„¦  </p><p>é‚£å¦‚æœæ­¤æ—¶æœ‰ä¸€ä¸ªé«˜é˜¶ç»„ä»¶å°è£…äº†è¿™ä¸ª <code>Input</code> ç»„ä»¶ å¦‚ä½•è°ƒç”¨ <code>focus</code> ä½¿ input ä¸»åŠ¨èšç„¦  </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Hoc</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>æ­¤æ—¶ï¼Œ å¦‚ä½•è°ƒç”¨ <code>Input</code> é‡Œçš„ <code>focus</code> æ–¹æ³•ï¼Œ ä¼¼ä¹æ˜¯æ²¡æœ‰åŠæ³•(ä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘ä¸çŸ¥é“), <code>forwardRef</code> ç”±æ­¤è€Œç”Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> testRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
<span class="token punctuation">}</span>

React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span>Hoc<span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Hoc</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>testRef<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>

testRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>æ­¤æ—¶ <code>testRef.current.focus()</code> å°±å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œ ä½¿ <code>input</code> èšç„¦</p><h2 id="å‡½æ•°å¼ç»„ä»¶--ç›´æ¥æ“ä½œ-dom">å‡½æ•°å¼ç»„ä»¶  ç›´æ¥æ“ä½œ <code>DOM</code></h2><p>æˆ‘ä»¬ä¸å¦¨æŠŠ  <code>Input</code> æ”¹æ­£å‡½æ•°å¼ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span>
</code></pre><p>æ­¤æ—¶ <code>Input</code> çš„ <code>ref</code> ç›´æ¥æŒ‚åœ¨åˆ° <code>DOM</code> ä¸Šäº†ï¼Œ ä¸ºäº†ä½¿ <code>input</code> èšç„¦</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>

inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// èšç„¦ ğŸ˜Š</span>
inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// å¤±ç„¦ ğŸ˜ˆ</span>
</code></pre><h2 id="hooks-ä¸­ä½¿ç”¨">hooks ä¸­ä½¿ç”¨</h2><p>å¦‚æœæƒ³è¦è¾¾åˆ°å’Œ <code>class</code> ç›¸åŒçš„æ•ˆæœï¼Œ åœ¨å‡½æ•°ä¸­è¯¥å¦‚ä½•åš, <code>hooks</code> æä¾›äº†ç›¸åº”çš„api</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">blur</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>Input</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>

inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// èšç„¦ ğŸ˜Š</span>
inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// å¤±ç„¦ ğŸ˜ˆ</span>
</code></pre><p>æƒ³è¦è¯¦ç»†äº†è§£ï¼Œ å‰å¾€ <a href="https://reactjs.org/docs/react-api.html#reactforwardref">å®˜ç½‘</a> </p><p><code>React</code> å®˜ç½‘å›¢é˜Ÿ æœ‰äº†æ–°çš„<a href="https://github.com/reactjs/rfcs/pull/107#issuecomment-466304382">æè®®</a>å¯èƒ½ä¼šè§£å†³ <code>forwardRef</code> è¿™ç§å¤æ‚çš„ç”¨æ³•</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Hooks vs Class]]></title>
            <link>/posts/2019-05-28/hooks-vs-class/</link>
            <guid>/posts/2019-05-28/hooks-vs-class/</guid>
            <pubDate>Mon, 27 May 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="hooks-vs-class">Hooks vs Class</h1><p>React é‡Šæ”¾ <code>hooks</code> å·²ç»åŠå¹´äº†ï¼Œä» hooks åˆšåˆšé‡Šæ”¾çš„æ—¶å€™æˆ‘å°±å¼€å§‹å…³æ³¨ï¼Œå¹¶ä¸”å°±å¼€å§‹å»å°è¯•ä½¿ç”¨å®ƒã€‚ ä»é‡Šæ”¾åˆ°ç°åœ¨ hooks åˆšè¿‡ä¸å°‘ï¼Œ å†…éƒ¨æºç è‡³å°‘æ”¹äº†ä¸¤ä¸‰æ¬¡ï¼Œ é‚£ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« å‘¢ ï¼Ÿ æ˜¯å› ä¸ºä¸€æ¬¡å¶ç„¶çš„äº‹æƒ…å¼•å‘çš„ã€‚ æœ‰ä¸€å¤©<code>æ¸Šè™¹</code>è€å“¥æŠ±ç€ç”µè„‘å¯¹æˆ‘è¯´ï¼Œ ä½ çœ‹æˆ‘è¿™ä¸ªè¡¨å•çš„æäº¤æ—¶é—´å°±æ˜¯åœ¨è°ƒç”¨ <code>onSubmit</code> çš„æ—¶å€™æœ‰ç‚¹å»¶è¿Ÿå•Šï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘€? æˆ‘è¯•äº†ä¸€ä¸‹æœç„¶æ˜¯è¿™æ ·ï¼Œ å¾ˆå¥‡æ€ªäº†ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ ? äºæ˜¯æˆ‘æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯éš¾é“æˆ‘æŠŠ<code>åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†</code>å¯¼è‡´çš„ï¼Ÿ è¿˜æ˜¯æœ‰å¯èƒ½çš„å•Šï¼Œäºæ˜¯æˆ‘åœ¨ç¾¤é‡Œé—®äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜</p><img src="https://user-images.githubusercontent.com/17973020/58377052-f8fcdd80-7faa-11e9-9755-773651feb5a1.png" height="500"/><img src="https://user-images.githubusercontent.com/17973020/58377171-0ca94380-7fad-11e9-9030-cd2a7d5fe676.png" height="500"/><p>äºæ˜¯æˆ‘å°±åœ¨ç¬¬äºŒå¤©è·‘äº†ä¸€ä¸‹ï¼Œè¯•è¯•åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†çš„è¯ï¼Œä¼šé€ æˆå¤šå°‘çš„å»¶è¿Ÿã€‚å½“æ•°é‡<code>å°äº100ä¸ª</code>æ—¶å€™ï¼Œç®€å•çš„å‡½æ•°åŒæ­¥å¼‚æ­¥æ—¶é—´åŸºæœ¬ä¸€è‡´ï¼Œ1000 ä¸ªçš„æ—¶å€™æ—¶é—´å°±æœ‰ä¸€äº›å°çš„å·®è·äº†ï¼Œ 10000 ä¸ªçš„æ—¶å€™å·®è·éå¸¸æ˜æ˜¾ï¼Œ <code>æ‰€ä»¥å¿…è¦çš„æ—¶å€™ï¼ŒåŒæ­¥è¿˜æ˜¯åŒæ­¥ï¼Œä¸è¦å½“åšå¼‚æ­¥æ¥å¤„ç†äº†</code>, é‚£ä¸€ä¸ª <code>form</code> å†…éƒ¨è¶…è¿‡ 100 ä¸ªæ ¡éªŒå‡½æ•°åŸºæœ¬ä¸å¯èƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹é¢æˆ‘å°±å¿½ç•¥äº†, é‚£ä¼šä¸ä¼šæ˜¯å¦å¤–ä¸€ç§å¯èƒ½å‘¢ï¼Ÿ</p><h2 id="render-æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ">render æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ</h2><p>å†ä¸€æ¬¡åˆ†æäº†<code>æ¸Šè™¹</code>è€å“¥çš„ä»£ç ï¼Œå‘ç°åœ¨æäº¤è¡¨å•çš„æ—¶å€™ï¼Œ<code>render</code> äº†å››æ¬¡ï¼Œäºæ˜¯æˆ‘å»æŸ¥äº†ä¸‹æºç ï¼Œå‘ç°è¿™å››æ¬¡åˆ†åˆ«æ˜¯ï¼Œ<code>æ ¡éªŒè®¾ç½®é”™è¯¯</code> =&gt; <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>è®¾ç½®è¡¨å•æ˜¯å¦æœ‰æ•ˆ</code> =&gt; <code>è®¾ç½®æäº¤æ¬¡æ•°</code>, ç„¶ååœ¨è°ƒç”¨ <code>onSubmit</code>ï¼Œ å“å‘€è¿™ä¸ªåœ°æ–¹æœ‰æœ‰å¾…ä¿®æ”¹çš„ï¼Œæ¯”å¦‚å¯ä»¥æ”¹æˆè¿™æ · <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>å¦‚æœæœ‰æ•ˆï¼Œè°ƒç”¨ onSubmit åœ¨è®¾ç½®æœ‰æ•ˆçŠ¶æ€å’Œæäº¤æ¬¡æ•°</code>ã€‚ å¦åˆ™åœ¨ <code>è®¾ç½®é”™è¯¯å’ŒçŠ¶æ€</code>ï¼Œ è¿™æ ·å‘¢å°±èƒ½ä¿è¯ <code>onSubmit</code> çš„æäº¤åªæœ‰ä¸€æ¬¡ <code>setState</code> çš„æ“ä½œï¼Œçœ‹ä¸‹ä»£ç çš„æˆªå›¾</p><p>ä¹‹å‰çš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377128-31e98200-7fac-11e9-8627-685ce89c7ccf.png" alt="d97dca23"/></p><p>ä¿®æ”¹åçš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377137-52194100-7fac-11e9-9503-dfc0e707c492.png" alt="fc8f38a3"/></p><p>è¿™æ ·åœ¨ <code>onSubmit</code> ä¹‹å‰å°±ä¼šè°ƒç”¨çš„å¾ˆå¿«ï¼Œ å³ä½¿ <code>render</code> å¾ˆè€—æ—¶</p><p>é‚£è‚¯å®šä¼šæœ‰äººæå‡ºæ¥è¿™æ ·çš„é—®é¢˜ï¼Œ render æ—¶é—´é•¿è¿™ä¸ªæ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„é—®é¢˜å¯¼è‡´çš„ï¼Œ é‚£ä¹ˆ <code>render</code> æ¬¡æ•°è¿‡å¤šè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œä¼š <code>render</code> è¿™ä¹ˆå¤šæ¬¡å‘¢ ï¼Ÿé‚£ä»è¿™é‡Œå°±å¼•èµ·ä»Šå¤©è¿™ä¸ªè¯é¢˜äº†ï¼Ÿ <code>class vs hooks</code></p><p>ä»£ç ç‚¹å‡»è¿™é‡Œ =&gt; <a href="https://codesandbox.io/s/hooks-vs-class-5buww">hooks vs class - CodeSandbox</a></p><p>æœ€ç®€å•çš„å°±æ˜¯åœ¨äº‹ä»¶ä¸­æ¥æµ‹è¯•åŒºåˆ«ã€‚<code>hooks and class</code> çš„ <code>increase</code> äº‹ä»¶éƒ½æ˜¯åŒæ­¥çš„ï¼Œæˆ‘ä»¬åœ¨ç‚¹å‡» <code>increasement</code> çš„æŒ‰é’®çš„æ—¶å€™æ‰“å¼€æ§åˆ¶å°çœ‹ä¸‹è¾“å‡ºæ˜¯ä»€ä¹ˆ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377138-65c4a780-7fac-11e9-9267-9b40f275e8c5.png" alt="45965b8f"/></p><p>å¯ä»¥çœ‹åˆ° <code>console</code> çš„é¡ºåºæ˜¯å…ˆè¾“å‡ºäº†äº‹ä»¶è°ƒç”¨ä¸­çš„ <code>console</code>ï¼Œ åœ¨è¾“å‡ºäº† <code>render</code> ä¸­çš„ <code>console</code>ï¼Œ è¿™ä¸ªå¤§å®¶éƒ½æ˜¯çŸ¥é“çš„ï¼Œ <code>setState</code> æ˜¯<a href="https://reactjs.org/docs/faq-state.html#when-is-setstate-asynchronous">å¼‚æ­¥çš„</a> , ä¿®æ”¹ä¸‹ä»£ç ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶å‡½æ•°é‡Œå¤šæ¬¡ <code>setState</code> ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿç»“æœè¾“å‡ºè¿˜æ˜¯ä¸€æ ·å‘¢ï¼Ÿå¯¹äºè¿™æ ·æ˜¯ä¸ºä»€ä¹ˆï¼Œå¯ä»¥çœ‹<a href="https://reactjs.org/docs/state-and-lifecycle.html#state-updates-may-be-asynchronous">å®˜ç½‘</a>ä»¥åŠ<a href="https://juejin.im/post/5b45c57c51882519790c7441">setState è§£æ</a>ï¼Œ
åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®ï¼Œè¿™ä¸ªå’Œ <code>decrease</code> æ˜¯ä¸€æ ·çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬åªå–ä¸€ä¸ªæ¥åˆ†æï¼Œ ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®åçœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377148-7ecd5880-7fac-11e9-8686-523fb69f01d7.png" alt="e5a1163b"/></p><p><code>hooks</code> render çš„æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œç„¶è€Œåœ¨ class ä¸­ render äº† å››æ¬¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿçœ‹èµ·æ¥å¾ˆå¥‡æ€ªæ˜¯ä¸æ˜¯ã€‚é‚£æˆ‘ä»¬ä¸å¦¨åœ¨ <code>hooks</code> ä¸­åœ¨å¢åŠ å‡ ä¸ªçœ‹çœ‹æ€ä¹ˆæ ·?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377153-8bea4780-7fac-11e9-8757-52307d8b6463.png" alt="2e4c8768"/></p><p>å®Œå…¨ä¸€æ ·ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨ä¿®æ”¹ä¸‹ï¼Œåœ¨ <code>hooks</code> ä¸­æ¯æ¬¡éƒ½è®¾ç½®ä¸ä¸€æ ·çš„å€¼çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¾“å‡ºå¦‚ä¸‹</p><p><img src="https://user-images.githubusercontent.com/17973020/58377157-986ea000-7fac-11e9-88d3-ca0bbd31882c.png" alt="47307b50"/></p><p>è¿™æ¬¡æ˜¯ä¸€è‡´äº†å¯¹ä¸å¯¹ï¼Œ éƒ½æ˜¯ <code>render</code> äº† 4 æ¬¡åæ‰è°ƒç”¨ <code>console</code> çš„ï¼Œè‡³äºåœ¨ class ä¸­ä¸ºä»€ä¹ˆè¡¨ç°æ˜¯è¿™æ ·çš„çœ‹<a href="https://juejin.im/post/5b45c57c51882519790c7441">ä¸Šé¢çš„æ–‡ç« </a></p><p>é‚£åœ¨ <code>hooks</code> ä¸­ä¸ºä»€ä¹ˆä¼šè¡¨ç°çš„å¦‚æ­¤ä¸ä¸€è‡´å‘¢ï¼Ÿ <a href="https://reactjs.org/docs/hooks-reference.html#bailing-out-of-a-state-update">å®˜ç½‘</a>ä¹Ÿè´´äº†å‡ºæ¥</p><p><img src="https://user-images.githubusercontent.com/17973020/58377158-a6bcbc00-7fac-11e9-9b78-54572ac17b52.png" alt="dccae51f"/></p><p>ä¼šç”¨ <code>Objest.is</code> ä¼šè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè®¤ä¸ºæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±ä¼š <code>bailout</code>, æœ‰çš„äººå¯èƒ½ä¼šå’Œæˆ‘æœ‰ä¸€æ ·çš„æƒ³æ³•ï¼Œå½“åˆæˆ‘åœ¨çœ‹è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘è§‰å¾—åœ¨è°ƒç”¨ç¬¬äºŒæ¬¡ <code>render</code> çš„æ—¶å€™å°±çŸ¥é“æ˜¯ä¸€æ ·çš„äº†ï¼Œé‚£åº”è¯¥ä¸ä¼šåœ¨åˆ° <code>commit</code> é˜¶æ®µäº†å§ã€‚æˆ‘ä»¬ä¸å¦¨æ¥è¯•è¯•</p><p>åœ¨ <code>hooks</code> åŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ class ä¸­ä¹ŸåŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®çœ‹ä¸‹è¾“å‡ºå¦‚ä½•ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377167-da97e180-7fac-11e9-930d-74da2f014e1e.png" alt="77290f12"/></p><p>æœçœŸæ˜¯è¿™æ ·çš„ï¼Œ åœ¨ <code>hooks</code> ä¸­ç¬¬äºŒæ¬¡æ‰§è¡Œ <code>render</code> å¹¶ä¸ä¼šåœ¨å»æ‰§è¡Œ <code>commit</code> äº†ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡ <code>render</code> çš„æ—¶å€™æ‰§è¡Œäº† <code>commit</code>ï¼Œ ç„¶è€Œ <code>class</code> ä¸­å´æ¯æ¬¡éƒ½æ‰§è¡Œäº†ã€‚</p><p>æœ‰çš„åŒå­¦ä¼šé—®æ‰§è¡Œ <code>setCount</code> çš„æ—¶å€™å†…éƒ¨æºç è‚¯å®šéƒ½ä¼šå»æ‰§è¡Œï¼Œ é‚£ä¸ºå•¥ä¸æ˜¯ <code>4</code> æ¬¡ <code>render</code>ï¼Œ <code>ä¸€æ¬¡ commit</code> å‘¢ ï¼Ÿé‚£æˆ‘ä»¬æ¥çœ‹ä¸‹æºç ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ</p><p>åœ¨ <code>è°ƒç”¨ setCount</code> çš„æ—¶å€™ä¼šè°ƒç”¨æºç ä¸­çš„ <code>dispatch</code>å‡½æ•°ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>count + number = 2</code> ç»“æœæ˜¯ <code>2</code> ä¸ç­‰äºä¸Šä¸€æ¬¡çš„ <code>0</code>, æ‰€ä»¥ä¼šèµ°åˆ° <code>updateReducer</code>,
åœ¨ <code>updateReducer</code> é‡Œé¢ä¼šè¿›è¡Œæ¯”è¾ƒ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ç›¸åŒä¼šå¦‚ä½•ï¼Œ ä¼šè¿›è¡Œæ ‡è®° <code>didReceiveUpdate</code>, æŠŠ <code>didReceiveUpdate</code> æ ‡è®°ä¸º <code>true</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸º <code>true</code>ï¼Œä¼šè¿›è¡Œæ›´æ–°ã€‚å¯¹äº <code>didReceiveUpdate</code> çš„å…¶ä»–æ ‡è®°æ˜¯åœ¨ <code>beginWork</code> å‡½æ•°ä¸­.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldProps <span class="token operator">=</span> current$$<span class="token number">1.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ˜¯ç¬¬ä¸€æ¬¡ <code>setCount</code>ï¼Œ å½“ç¬¬äºŒæ¬¡ setCount çš„æ—¶å€™, <code>didReceiveUpdate</code> ä¸º <code>false</code>ï¼Œ ä¼šèµ°ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didReceiveUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">bailoutHooks</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
    current$$<span class="token number">1</span><span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    renderExpirationTime
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ®µä»£ç åœ¨å¥½å‡ å¤„éƒ½æœ‰ï¼Œ å…¶ä¸­ä¸€å¤„å°±æ˜¯åœ¨ <code>updateFunctionComponent</code> è¿™ä¸ªå‡½æ•°ä¸­ã€‚é‚£ä¹ˆ <code>bailoutHooks</code> åšäº†ä»€ä¹ˆ ?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>WIP</code> çš„ <code>updateQueue</code> æ›´æ–°ä¸º <code>current</code> çš„ <code>updateQueue</code></p><p><code>bailoutOnAlreadyFinishedWork</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
  <span class="token parameter">current$$<span class="token number">1</span><span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  renderExpirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cancelWorkTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reuse previous context list</span>
    workInProgress<span class="token punctuation">.</span>contextDependencies <span class="token operator">=</span> current$$<span class="token number">1.</span>contextDependencies<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't update "base" render times for bailouts.</span>
    <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check if the children have any pending work.</span>
  <span class="token keyword">var</span> childExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The children don't have any work either. We can skip them.</span>
    <span class="token comment">// TODO: Once we add back resuming, we should check if the children are</span>
    <span class="token comment">// a work-in-progress set. If so, we need to transfer their effects.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// This fiber doesn't have work, but its subtree does. Clone the child</span>
    <span class="token comment">// fibers and continue.</span>
    <span class="token function">cloneChildFibers</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å½“æ‰§è¡Œåˆ°ç¬¬ä¸‰æ¬¡ <code>setCount</code> çš„æ—¶å€™ï¼Œ ä¼šè¢«ç›´æ¥ <code>return</code> ä»£ç åœ¨ <code>dispatchAction</code> ä¸­,
å› ä¸ºåœ¨ <code>queue.dispatch</code> ç»‘å®šäº† <code>dispatchAction</code></p><pre><code class="language-jsx(84)" data-language="jsx(84)" data-highlighted-line-numbers="">function dispatchAction(fiber, queue, action) {
  !(numberOfReRenders &lt; RE_RENDER_LIMIT)
    ? invariant(
        false,
        &quot;Too many re-renders. React limits the number of renders to prevent an infinite loop.&quot;
      )
    : void 0;

  {
    !(arguments.length &lt;= 3)
      ? warning$1(
          false,
          &quot;State updates from the useState() and useReducer() Hooks don&#39;t support the &quot; +
            &quot;second callback argument. To execute a side effect after &quot; +
            &quot;rendering, declare it in the component body with useEffect().&quot;
        )
      : void 0;
  }

  var alternate = fiber.alternate;
  if (
    fiber === currentlyRenderingFiber$1 ||
    (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber$1)
  ) {
    // This is a render phase update. Stash it in a lazily-created map of
    // queue -&gt; linked list of updates. After this render pass, we&#39;ll restart
    // and apply the stashed updates on top of the work-in-progress hook.
    didScheduleRenderPhaseUpdate = true;
    var update = {
      expirationTime: renderExpirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };
    if (renderPhaseUpdates === null) {
      renderPhaseUpdates = new Map();
    }
    var firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);
    if (firstRenderPhaseUpdate === undefined) {
      renderPhaseUpdates.set(queue, update);
    } else {
      // Append the update to the end of the list.
      var lastRenderPhaseUpdate = firstRenderPhaseUpdate;
      while (lastRenderPhaseUpdate.next !== null) {
        lastRenderPhaseUpdate = lastRenderPhaseUpdate.next;
      }
      lastRenderPhaseUpdate.next = update;
    }
  } else {
    flushPassiveEffects();

    var currentTime = requestCurrentTime();
    var _expirationTime = computeExpirationForFiber(currentTime, fiber);

    var _update2 = {
      expirationTime: _expirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };

    // Append the update to the end of the list.
    var _last = queue.last;
    if (_last === null) {
      // This is the first update. Create a circular list.
      _update2.next = _update2;
    } else {
      var first = _last.next;
      if (first !== null) {
        // Still circular.
        _update2.next = first;
      }
      _last.next = _update2;
    }
    queue.last = _update2;

    if (
      fiber.expirationTime === NoWork &amp;&amp;
      (alternate === null || alternate.expirationTime === NoWork)
    ) {
      // The queue is currently empty, which means we can eagerly compute the
      // next state before entering the render phase. If the new state is the
      // same as the current state, we may be able to bail out entirely.
      var _lastRenderedReducer = queue.lastRenderedReducer;
      if (_lastRenderedReducer !== null) {
        var prevDispatcher = void 0;
        {
          prevDispatcher = ReactCurrentDispatcher$1.current;
          ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnUpdateInDEV;
        }
        try {
          var currentState = queue.lastRenderedState;
          var _eagerState = _lastRenderedReducer(currentState, action);
          // Stash the eagerly computed state, and the reducer used to compute
          // it, on the update object. If the reducer hasn&#39;t changed by the
          // time we enter the render phase, then the eager state can be used
          // without calling the reducer again.
          _update2.eagerReducer = _lastRenderedReducer;
          _update2.eagerState = _eagerState;
          if (is(_eagerState, currentState)) {
            console.log(&quot;ç›´æ¥é€€å‡º&quot;);
            // Fast path. We can bail out without scheduling React to re-render.
            // It&#39;s still possible that we&#39;ll need to rebase this update later,
            // if the component re-renders for a different reason and by that
            // time the reducer has changed.
            return;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        } finally {
          {
            ReactCurrentDispatcher$1.current = prevDispatcher;
          }
        }
      }
    }
    {
      if (shouldWarnForUnbatchedSetState === true) {
        warnIfNotCurrentlyBatchingInDev(fiber);
      }
    }
    scheduleWork(fiber, _expirationTime);
  }
}
</code></pre><p><code>_lastRenderedReducer</code> å°±æ˜¯ <code>basicStateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç¬¬ä¸‰ç¬¬å››æ¬¡ä¼šåœ¨è¿™ä¸ªåˆ¤æ–­è¯­å¥é‡Œé€€å‡ºã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is</span><span class="token punctuation">(</span>_eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Fast path. We can bail out without scheduling React to re-render.</span>
  <span class="token comment">// It's still possible that we'll need to rebase this update later,</span>
  <span class="token comment">// if the component re-renders for a different reason and by that</span>
  <span class="token comment">// time the reducer has changed.</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é‚£ä¹ˆç¬¬äºŒæ¬¡ä¸ºä»€ä¹ˆä¸åœ¨è¿™é‡Œé€€å‡ºå‘¢ ï¼Ÿ åœ¨ç¬¬äºŒæ¬¡è¿™é‡Œçš„è¯­å¥æ˜¯ <code>false</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>è¿½æº¯ä¸‹å†…éƒ¨çš„è°ƒç”¨ï¼Œ åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ <code>fiber.expirationTime !== NoWork</code>, æ‰€ä»¥è¿™ä¸ªåˆ¤æ–­è¯­å¥å°±ä¸ä¼šèµ°, é‚£ä¹ˆç¬¬ä¸‰æ¬¡ä¸ºä»€ä¹ˆåˆç›¸ç­‰äº†å‘¢ï¼Ÿå†ä¸€æ¬¡çœ‹ä¸‹ <code>bailoutHooks</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>current.expirationTime = NoWork;</code> è¿›è¡Œäº†èµ‹å€¼ã€‚æ‰€ä»¥è¿™å°±æ˜¯æ•´ä¸ªè¿‡ç¨‹äº†ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p><code>class</code> å’Œ <code>hooks</code> ä¸­åŸºæœ¬ä¿æŒä¸€è‡´, ä½†æ˜¯ <code>hooks</code> ä¸­ä¼šåšä¸€å±‚ <code>Object.is</code> çš„åˆ¤æ–­ï¼Œ
æ‰€ä»¥åœ¨è¿›è¡ŒçŠ¶æ€æ›´æ–°çš„æ—¶å€™ï¼Œ éœ€è¦æ³¨æ„ä¸‹è¿™ç‚¹ã€‚è¿˜æœ‰åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œ <code>hooks</code> ä¹Ÿæ— æ³•æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œ å› ä¸ºåœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œ æ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°ï¼Œ æ‰€ä»¥è¾“å‡ºçš„éƒ½æ˜¯ä¹‹å‰çš„å€¼ï¼Œ è¿™ä¸ªç‚¹è¦æ³¨æ„ä¸€ä¸‹ã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒ <code>Dan</code> çš„åšå®¢ <a href="https://overreacted.io/a-complete-guide-to-useeffect/">A Complete Guide to useEffect</a></p><p><a href="https://codesandbox.io/s/hooks-vs-class-5buww">æŸ¥çœ‹ä»£ç </a></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Hooks State ğŸ¤”]]></title>
            <link>/posts/2019-06-03/state/</link>
            <guid>/posts/2019-06-03/state/</guid>
            <pubDate>Sun, 02 Jun 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="setxxxx-vs-setstate">setXXXX vs setState</h1><p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºäº†åˆ†æ <code>Hooks</code> ä¸­ <code>setXXX</code> å’Œ class ä¸­ <code>setState</code> çš„ä¸€äº›ä¸åŒä¹‹å¤„ï¼Œ <a href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> åˆ†æäº† <code>state</code> çš„éƒ¨åˆ†ä¸åŒï¼Œä»¥åŠå„è‡ªè°ƒç”¨è§¦å‘çš„ <code>render</code> æ¬¡æ•°çš„åˆ†æï¼Œ åŒæ­¥å’Œå¼‚æ­¥çŠ¶æ€ä¸‹çš„åŒºåˆ«ã€‚è¦è®°ä½çš„æ˜¯åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œ<code>setXXX</code> ä¼šè¿›è¡Œ <code>Object.is</code> è¿›è¡Œæ¯”è¾ƒã€‚</p><h2 id="åŸå› ">åŸå› </h2><p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºæ˜¨å¤© <code>åŸå‹é“¾</code> åœ¨å†™ <code>form</code> çš„æ—¶å€™é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œ è‡³äºä¸ºä»€ä¹ˆåˆæ˜¯ <code>form</code> æˆ‘å°±ä¸å¤šåšæè¿°äº†ã€‚è¿™æ˜¯æˆ‘å’Œ <code>åŸå‹é“¾</code> çš„å¯¹è¯:</p><p><code>åŸå‹é“¾</code>: è“é“¶è‰ä¸ºä»€ä¹ˆæˆ‘è°ƒç”¨ <code>setFieldValue</code> è®¾ç½®çš„å€¼ä¸æ­£ç¡®å‘¢ï¼Ÿ
<code>æˆ‘</code>ï¼šä½ æ˜¯æ€ä¹ˆè°ƒç”¨çš„å‘¢ï¼Ÿ
<code>åŸå‹é“¾</code>: æˆ‘æ˜¯è¿ç»­è°ƒç”¨ <code>setFieldValue</code> ä¸¤æ¬¡ï¼Œç»“æœéƒ½æ˜¯æœ€åä¸€æ¬¡ç”Ÿæ•ˆï¼Œä½†æ˜¯è°ƒç”¨ <code>setValues</code> å°±æ˜¯å¥½çš„ã€‚
<code>æˆ‘</code>ï¼šä¸å¯èƒ½å§ï¼Œæˆ‘çœ‹ä¸‹ä½ çš„å®ç°ï¼Œçœ‹äº†ä¸‹åŸå‹é“¾çš„æ¼”ç¤ºï¼ŒåŸæ¥å¦‚æ­¤ï¼Œæˆ‘çŸ¥é“äº†ä¸ºä»€ä¹ˆåªæ˜¾ç¤ºæœ€åä¸€ä¸ªäº†ï¼Œè¿™æ˜¯ <code>React</code> å‡½æ•°ç»„ä»¶å¯¼è‡´çš„è¿™ä¸ªé—®é¢˜ã€‚</p><p><a href="https://codesandbox.io/s/funny-mclean-6lru4">å…·ä½“æ —å­ç‚¹å‡»è¿™é‡Œ</a></p><p><code>hook</code> ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render hook"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hooks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      name:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby sync</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick1<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick2<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick3<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ä»£ç é‡Œç‚¹å‡»æŒ‰é’®ï¼Œç„¶åè®¾ç½® <code>name</code> å’Œ <code>hobby</code>, å¯èƒ½æœ‰äººä¼šé—®è¿™ä¸æ˜¯ä¸¤ä¸ªå±æ€§å€¼ä¸€èµ·è®¾ç½®å˜›ï¼Œä¸ºä»€ä¹ˆä¸<code>setState({ ...state, name: &#x27;ç‰§äº‘äº‘&#x27;, hobby: &#x27;coding&#x27; })</code>, å› ä¸ºå½“æ—¶ <code>setFieldValue</code> çš„ç”¨æ³•æ˜¯ <code>setFieldValue(key, value)</code>, æ‰€ä»¥å°±è°ƒç”¨äº†å¤šæ¬¡ã€‚æ­¤æ—¶ç‚¹å‡» <code>set name and hobby sync</code> æŒ‰é’®ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817731-a3221800-9353-11e9-8a15-88bdbc67bcdd.png" alt="cc37e062"/></p><p>å¯ä»¥çœ‹åˆ°åœ¨äº‹ä»¶ä¸­è¾“å‡ºçš„éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ <code>state</code>, ç„¶å <code>render</code> äº†ä¸€æ¬¡ï¼Œä¸ºä»€ä¹ˆ <code>render</code> äº†ä¸€æ¬¡å¯ä»¥çœ‹æˆ‘<a href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> ä¸­çš„é“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè·³è¿‡è¿™é‡Œï¼Œçœ‹ <code>render éƒ¨åˆ†</code>çš„è¾“å‡º</p><p><code>handleClick</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>å¯ä»¥çœ‹å‡ºåªæœ‰ç¬¬äºŒä¸ªç”Ÿæ•ˆäº†ï¼Œç›´æ¥çœ‹è¿™ä¸ªåº”è¯¥å¾ˆå®¹æ˜“çŸ¥é“ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸€æ¬¡ <code>setState</code> çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>name</code> æ˜¯ <code>ç‰§äº‘äº‘</code>, ä½†æ˜¯åœ¨è®¾ç½®ç¬¬äºŒä¸ªçš„æ—¶å€™ï¼Œ æ­¤æ—¶çš„ <code>state</code> è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ <code>name: ç‰§è€å¸ˆ</code> è¿™ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥åœ¨åˆå¹¶çš„è¿‡ç¨‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœ€åä¸€æ¬¡çš„ <code>setState</code> çš„å†…å®¹ï¼Œé‚£ä¹ˆè¾“å‡ºçš„å°±æ˜¯åªæœ‰ <code>hobby: coding</code> ç”Ÿæ•ˆã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥è¿‡ç¨‹ä¸­å‘¢ï¼Ÿæˆ–è€…æ˜¯ <code>é React åˆæˆäº‹ä»¶å’Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­</code>, å†æ¬¡ç‚¹å‡» <code>set name and hobby async</code>, é‚£ä¹ˆè¾“å‡ºåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><code>handleClick1</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setTimeout(() => {</span>
    <span class="token comment">//   setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">//   console.log("hook state change name async", state);</span>
    <span class="token comment">// }, 3000);</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817757-b8974200-9353-11e9-9dda-b211de81e24d.png" alt="55a12b25"/></p><p>å¯ä»¥çœ‹åˆ° <code>render</code> äº†ä¸¤æ¬¡ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¹Ÿèµ°äº†ä¸¤æ¬¡ï¼Œè¿™ä¸ªä¸æ˜¯æˆ‘ä»¬ä»Šå¤©å…³å¿ƒçš„é‡ç‚¹ï¼Œä»Šå¤©å…³å¿ƒçš„é‡ç‚¹åœ¨ <code>state</code> çš„æ›´æ–°ä¸Š, ç¬¬ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ <code>name</code> å‘ç”Ÿäº†å˜æ›´ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> ä»ç„¶æ˜¯ä¹‹å‰çš„ <code>name: ç‰§è€å¸ˆ</code>ï¼Œ æ‰€ä»¥ç¬¬ä¸€æ¬¡è®¾ç½®çš„ <code>name: ç‰§äº‘äº‘</code> è¢«è¦†ç›–äº†ï¼Œé¡µé¢ä¸ŠåŸºæœ¬çœ‹ä¸å‡ºæ¥ <code>name</code> å˜åŒ–çš„è¿‡ç¨‹, é‚£æˆ‘ä»¬æŠŠç¬¬äºŒä¸ª <code>setState</code> æ”¾åˆ° <code>setTimeout</code> ä¸­å‘¢ï¼Œ æ­¤æ—¶é¡µé¢çš„å˜åŒ–è¿‡ç¨‹æ˜¯å¾ˆå®¹æ˜“çœ‹å‡ºæ¥çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">// console.log("hook state change name async", state);</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ ·ä¿®æ”¹çš„è¯ï¼Œ é¡µé¢çš„å˜åŒ–è¿‡ç¨‹å°±å¾ˆæ¸…æ™°.è¿™ä¸ªå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ä¾‹å­.</p><h4 id="usecallback">useCallback</h4><p><code>setState</code> åœ¨ hooks ä¸­å’Œ class ä¸­éƒ½æ˜¯æ”¯æŒå›è°ƒçš„æ–¹å¼çš„ï¼Œé‚£ä¹ˆä¸å¦¨å°è¯•ä¸€ä¸‹å›è°ƒçš„æ–¹å¼</p><p><code>handleClick2</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆè¾“å‡ºçš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817787-d5337a00-9353-11e9-88e1-e2306f65b8cf.png" alt="42e8111c"/></p><p>å’Œæˆ‘ä»¬é¢„æœŸçš„æ˜¯ä¸€è‡´çš„ï¼Œ<code>name</code> å’Œ <code>hobby</code> éƒ½å‘ç”Ÿäº†æ›´æ–°, è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå•ç‹¬çœ‹ä»£ç å¯ä»¥çŸ¥é“åœ¨æ‰§è¡Œå‡½æ•°çš„æ—¶å€™éƒ½ä¼šæŠŠä¸Šä¸€æ¬¡çš„ <code>state</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ¯æ¬¡ <code>preState</code> éƒ½æ˜¯ä¸Šä¸€æ¬¡æœ€æ–°çš„ <code>state</code> æ‰€ä»¥èƒ½æ‹¿åˆ°æœ€æ–°çš„ã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥ä¸­è¡¨ç°åˆæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ
æ‰§è¡Œå¼‚æ­¥çš„ä»£ç </p><p><code>handleClick3</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817797-e2506900-9353-11e9-8aac-c71f58ceb4e6.png" alt="1bf0c6c2"/></p><p>è¡¨ç°çš„æ˜¯ä¸€è‡´çš„ã€‚åœ¨ class ä¸­è¡¨ç°çš„æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ ?</p><h3 id="class">Class</h3><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Class</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
        name:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ç‚¹å‡»æŒ‰é’®çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817816-f5fbcf80-9353-11e9-8d37-9aa3820dacbb.png" alt="c6f6e146"/></p><p><code>class</code> ä¸­è¡¨ç°çš„æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåœ¨ class ä¸­ï¼Œ state æ˜¯æŒ‚åœ¨ <code>this</code> ä¸Šå§‹ç»ˆè¿™ä¸ª state éƒ½æ˜¯ç›¸åŒçš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡ <code>setState</code> åï¼Œæ­¤æ—¶çš„ <code>name</code> ä¿®æ”¹ä¸ºäº† <code>ç‰§äº‘äº‘</code>ï¼Œ å†ä¸€æ¬¡è°ƒç”¨ <code>setState</code> çš„æ—¶å€™ï¼Œå†…éƒ¨æ‹¿åˆ°çš„ <code>this.state</code> å·²ç»æ˜¯æœ€æ–°çš„ <code>name</code> äº†ï¼Œæ‰€ä»¥åœ¨è®¾ç½® <code>hobby</code> çš„æ—¶å€™å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚</p><p>çœ‹ä¸‹ <code>updateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
  <span class="token operator">!</span><span class="token punctuation">(</span>queue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Should have a queue. This is likely a bug in React. Please file an issue.'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>numberOfReRenders <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a re-render. Apply the new render phase updates to the previous</span>
    <span class="token keyword">var</span> _dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render phase updates are stored in a map of queue -> linked list</span>
      <span class="token operator">...</span>çœç•¥éƒ¨åˆ†
    <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> _dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The last update in the entire queue</span>
  <span class="token keyword">var</span> last <span class="token operator">=</span> queue<span class="token punctuation">.</span>last<span class="token punctuation">;</span>
  <span class="token comment">// The last update that is part of the base state.</span>
  <span class="token keyword">var</span> baseUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">;</span>
  <span class="token keyword">var</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>

  <span class="token comment">// Find the first unprocessed update.</span>
  <span class="token keyword">var</span> first <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseUpdate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// For the first update, the queue is a circular linked list where</span>
      <span class="token comment">// `queue.last.next = queue.first`. Once the first update commits, and</span>
      <span class="token comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span>
      last<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    first <span class="token operator">=</span> baseUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    first <span class="token operator">=</span> last <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> last<span class="token punctuation">.</span>next <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _newState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevUpdate <span class="token operator">=</span> baseUpdate<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _update <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token keyword">var</span> didSkip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> _update<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Priority is insufficient. Skip this update. If this is the first</span>
        <span class="token comment">// skipped update, the previous update/state is the new base</span>
        <span class="token comment">// update/state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          didSkip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
          newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update the remaining priority in the queue.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">></span> remainingExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          remainingExpirationTime <span class="token operator">=</span> updateExpirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Process this update.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
          <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
          _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
          _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      prevUpdate <span class="token operator">=</span> _update<span class="token punctuation">;</span>
      _update <span class="token operator">=</span> _update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>_update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> _update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
      newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark that the fiber performed work, but only if the new state is</span>
    <span class="token comment">// different from the current state.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseUpdate <span class="token operator">=</span> newBaseUpdate<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>

    queue<span class="token punctuation">.</span>lastRenderedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817874-23e11400-9354-11e9-8f56-bf6995fc93e3.jpg" alt="ddda387a"/></p><p>å…³æ³¨è¿™å—ä»£ç </p><p><img src="https://user-images.githubusercontent.com/17973020/59817900-38bda780-9354-11e9-8769-0d2e3d62336d.jpg" alt="8764128b"/></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
  <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
  _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
  _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ª <code>reducer</code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span>basicStateReducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰€ä»¥è¿™ä¸ª <code>reducer</code> å°±æ˜¯ <code>basicStateReducer</code>, ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°å°±æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯å‡½æ•°å°±ç›´æ¥è¿”å›è¿™ä¸ª <code>state</code>. <code>_update.action</code> å­˜å‚¨çš„å°±æ˜¯<code>setXX</code> çš„å‚æ•°ï¼Œæ‰€ä»¥åœ¨ä¼ é€’çš„ä¸æ˜¯å‡½æ•°çš„æ—¶å€™ç›´æ¥å°±ä¼šè¿”å› <code>_action2</code>, å¦åˆ™å°±ä¼šè¿”å› <code>_action2(_newState)</code> æ‹¿åˆ°æœ€æ–°çš„å€¼.</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆ <code>ä¼ é€’è¿›å»çš„ State</code> ä¸æ˜¯æœ€æ–°çš„å‘¢ï¼Ÿ å¯ä»¥å‚è€ƒ <a href="https://overreacted.io/how-are-function-components-different-from-classes/">How Are Function Components Different from Classes?</a> <code>Dan</code> åœ¨è¿™ç¯‡æ–‡ç« é‡Œé¢è¯¦ç»†è¯´æ˜äº†ï¼Œæ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°.</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç±»ç»„ä»¶ä¸­ï¼Œ <code>setState</code> ä¼šè‡ªåŠ¨è¿›è¡Œå€¼çš„åˆå¹¶ï¼Œæ‰€ä»¥å¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ <code>hooks</code> ä¸­åœ¨è°ƒç”¨ <code>setXXX</code> çš„æ—¶å€™å¿…é¡»è¦è®¾ç½®å…¨éƒ¨çš„å€¼ï¼Œå¹¶ä¸”ç”±äºå‡½æ•°é—­åŒ…çš„ç‰¹æ€§ï¼Œè°ƒç”¨å¤šæ¬¡ <code>setXXXX</code> è¿›è¡Œå¯¹è±¡ç»“æ„èµ‹å€¼çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> å§‹ç»ˆæ˜¯ä¹‹å‰çš„ <code>state</code>ï¼Œ å¦‚æœè¦æƒ³è·å–åˆ°æœ€æ–°çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>setXXX(callback)</code> çš„æ–¹å¼æ‹¿åˆ°æœ€æ–°çš„å€¼.</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[React Context ğŸ˜]]></title>
            <link>/posts/2019-08-10/context/</link>
            <guid>/posts/2019-08-10/context/</guid>
            <pubDate>Fri, 09 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><h1 id="context">Context</h1><p><a href="https://reactjs.org/docs/context.html#when-to-use-context">context</a> åœ¨ react ä¸­æ˜¯ä¸€ä¸ªç¥å¥‡çš„ä¸œè¥¿ï¼Œ<code>context</code> çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³åœ¨ react ä¸­ä¼ é€’ props éœ€è¦å¤šå±‚ä¼ é€’çš„é—®é¢˜ï¼Œ
åœ¨ä½¿ç”¨äº† context ä¹‹åå¯ä»¥æœ‰æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä» 15 ç‰ˆæœ¬åˆ° 16 ç‰ˆæœ¬, <code>context</code> çš„ api ä¹Ÿå‘ç”Ÿäº†ä¸å°‘çš„å˜åŒ–ã€‚å…ˆçœ‹ä¸‹åœ¨ class ä¸­å¦‚ä½•ä½¿ç”¨ context</p><h2 id="class-context">Class Context</h2><p>é¦–å…ˆéœ€è¦å…ˆå£°æ˜ä¸€ä¸ª context, å¦‚ä½•å£°æ˜ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡è°ƒç”¨ <code>React.createContext</code> æ¥åˆ›å»ºä¸€ä¸ª context çš„å£°æ˜, å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæ¯”å¦‚æ­¤æ—¶æœ‰çˆ¶ç»„ä»¶å«åš app</p><p>app.js</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'lanyincao'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Provider
          value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span> updateState<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>updateState <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å¯ä»¥é€šè¿‡è°ƒç”¨ <code>context.Provider</code> æ¥ä½œä¸ºçˆ¶ç»„ä»¶çš„é‚£ä¸€å±‚ï¼Œæ­¤æ—¶éœ€è¦æ¥å—ä¸€ä¸ª <code>value</code> çš„ props, æ¯æ¬¡ value å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šè§¦å‘ <code>context</code> çš„é‡æ–°æ¸²æŸ“ã€‚</p><p>æ—¢ç„¶ <code>context</code> çš„ç›®çš„æ˜¯ä¸ºäº†è§£å†³ props ä¼ é€’çš„é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å­ç»„ä»¶ä¸­æ˜¯å¦‚ä½•æ‹¿åˆ°åœ¨ app.js ä¸­çš„æ•°æ®å‘¢, å‡è®¾æ­¤æ—¶æœ‰å­ç»„ä»¶å« <code>ExampleA.js</code></p><p>ExampleA.js</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>div<span class="token operator">></span>xxxx<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨å­ç»„ä»¶ä¸­éœ€è¦ä½¿ç”¨ <code>context.Consumer</code>, è¿™æ˜¯ä¸€ä¸ª <a href="https://reactjs.org/docs/render-props.html#use-render-props-for-cross-cutting-concerns">render props</a> ç»„ä»¶, æ¥æ”¶ä¸€ä¸ªå‚æ•°å«åš
<code>value</code>, æ­¤æ—¶çš„ <code>value</code> å°±æ˜¯ <code>context.Provider</code> ä¼ é€’ä¸‹æ¥çš„ <code>value</code>, æ‰€ä»¥å°±å¯ä»¥åœ¨å†…éƒ¨ä½¿ç”¨æ‹¿åˆ°çš„ <code>value</code>ã€‚</p><h2 id="tips">Tips</h2><p>åœ¨ä½¿ç”¨ <code>context</code> çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€äº›ç‚¹ï¼Œé¦–å…ˆ <code>context</code> æ˜¯æ— æ³•è¢« <code>bailout</code> æ„æ€å°±æ˜¯æ— è®ºä½ æ˜¯ä½¿ç”¨ <code>PureComponent</code> è¿˜æ˜¯ <code>memo</code> éƒ½æ˜¯æ— æ³•é˜»æ­¢ <code>context</code> çš„æ›´æ–°çš„ã€‚å¹¶ä¸”å¦‚æœ context æ‰€åœ¨çš„ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä½†æ˜¯ context å‘ç”Ÿäº†æ›´æ–°ï¼Œ
é‚£ä¹ˆæ­¤æ—¶åªä¼šæ¸²æŸ“ <code>context</code> çš„éƒ¨åˆ†, æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleB</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ç‚¹å‡» <code>updateAge</code> ä¼šè°ƒç”¨é¡¶å±‚çš„ <code>updateAge</code>, é‚£ä¹ˆ <code>app</code> ç»„ä»¶è¢«æ›´æ–°ï¼Œæ‰€ä»¥ <code>Provider</code> çš„ <code>value</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€ä»¥ <code>context</code> å°†ä¼šæ›´æ–°ã€‚ä½†æ˜¯ <code>ExampleB</code> ç»„ä»¶ä¸­çš„ <code>console.log(111)</code> å¹¶
æ²¡æœ‰è¢«æ‰“å°å‡ºæ¥ï¼Œé‡Œé¢çš„ <code>age</code> å´å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ <code>react</code> æœ¬èº«åšçš„ä¼˜åŒ–ä¹‹ä¸€å§ï¼Œå‘ç”Ÿåšä¸å¿…è¦çš„æ¸²æŸ“ã€‚é‚£ä¹ˆåœ¨çœ‹ä¸‹ <code>ExampleC</code> ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ExampleC</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
              <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>context<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ <code>ExampleC</code> ç»„ä»¶æ˜¯ <code>PureComponent</code>, <code>PureComponent</code> å¯¹ç»„ä»¶åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼Œå½“ <code>props</code> æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ˜¯ä¸ä¼š <code>render</code> çš„ï¼Œæ­¤æ—¶ <code>ExampleC</code> ç»„ä»¶æ²¡æœ‰å¤šä½™çš„ props, ç‚¹å‡» <code>updateAge</code>, ä¼šå‘ç° <code>ExampleC</code> ä¸­çš„
<code>age</code> ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯ <code>console.log(111)</code> ä»ç„¶ä¹Ÿæ²¡æœ‰è¾“å‡ºï¼Œæ‰€ä»¥æ— è®ºæ˜¯ <code>PureComponent</code> è¿˜æ˜¯ <code>memo</code>ï¼Œ <code>shouldComponentUpdate</code> éƒ½æ˜¯æ— æ³•é˜»æ­¢ <code>context</code> çš„æ›´æ–°çš„ã€‚</p><h2 id="hook-context">Hook Context</h2><p><code>React</code> å›¢é˜Ÿåœ¨å»å¹´ 10 æœˆä»½çš„ <code>conf</code> ä¸Šè®²åˆ°äº† <code>Hook</code>, å¯ä»¥åœ¨å‡½æ•°ä¸­ä½¿ç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆ <code>Hook</code> è§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåœ¨ <code>class</code> ä¸­å¾ˆå¤šæ—¶å€™éœ€è¦ä½¿ç”¨ <code>Hoc</code>, <code>render props</code>, è¿™äº›é«˜é˜¶çš„æ–¹æ³•æ¥å°è£…ä¸€äº›æ–¹æ³•ï¼Œåœ¨ <code>js</code> ä¸­ï¼Œ
éƒ½çŸ¥é“<code>å›è°ƒåœ°ç‹±</code>ï¼Œ é‚£ä¹ˆåœ¨ <code>react</code> ä¸­å°±å­˜åœ¨äº†ä¸€ç§å«åš <code>åµŒå¥—åœ°ç‹±</code> çš„å½¢å¼ï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
  <span class="token operator">&lt;</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
          <span class="token operator">&lt;</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
              <span class="token operator">&lt;</span>div<span class="token operator">></span>
                <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
                  <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span>Hoc<span class="token operator">></span>
    <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Hoc<span class="token operator">></span>
</code></pre><p>è¿™ç§æœ‰å¯èƒ½ä¼šåµŒå¥—çš„éå¸¸éå¸¸çš„ç¥ï¼Œå¯¹äºè°ƒè¯•æ¥è¯´ä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚è¿™ä¹Ÿæ˜¯ <code>Hook</code> å‡ºæ¥çš„åŸå› ä¹‹ä¸€ã€‚å…·ä½“ <a href="https://reactjs.org/docs/hooks-intro.html">Hook ç”¨æ³•</a> å¯ä»¥å»å‚ç…§å®˜ç½‘å³å¯ã€‚</p><p>ä»Šå¤©åœ¨è¿™é‡Œä¸»è¦æ¥ä»‹ç»åœ¨ <code>Hook</code> ä¸­å¦‚ä½•ä½¿ç”¨ <code>context</code>ï¼Œ åœ¨ <code>Hook</code> æœ‰ä¸€ä¸ª <code>hook</code> å«åš <a href="https://reactjs.org/docs/hooks-reference.html#usecontext">useContext</a></p><p><code>éœ€è¦æ³¨æ„çš„æ˜¯æ‰€æœ‰çš„</code>Hook<code>åªèƒ½ç”¨äºå‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œå¦‚æœåœ¨ class ä¸­è¿˜éœ€è¦ç”¨ class çš„ç”¨æ³•</code></p><p>ä¸æ”¾æŠŠä¸Šé¢çš„ <code>ExampleB</code> ç»„ä»¶è¿›è¡Œæ”¹é€ æˆå‡½æ•°ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> context <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ExampleB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        name<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>updateState<span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨å‡½æ•°é‡Œä½¿ç”¨äº† <code>useContext</code>, æ³¨æ„æ‰€æœ‰çš„ <code>Hook</code> éƒ½å¿…è¦åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„é¡¶å±‚ä½¿ç”¨ï¼ï¼ï¼
<code>useContext</code> æ¥æ”¶çš„å‚æ•°æ˜¯ <code>context</code>, è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ä¸€ä¸‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">Correct<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
Incorrect<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
Incorrect<span class="token punctuation">:</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>useContext</code> çš„è¿”å›å€¼å°±æ˜¯ <code>context.Provider</code> çš„ <code>value</code> çš„å€¼ï¼Œå½“ <code>value</code> å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>context</code> çš„åœ°æ–¹å°±ä¼šå‘ç”Ÿæ›´æ–°ã€‚æ¯”å¦‚æ­¤æ—¶ç‚¹å‡»
<code>updateAge</code>ï¼Œ é‚£ä¹ˆ <code>ExampleB</code> å°±ä¼šå‘ç”Ÿæ›´æ–°ï¼Œ<code>age</code> å°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><p>åœ¨ <code>Hook</code> ä¸­ä½¿ç”¨ <code>useContext</code> æä¸ºç®€å•ï¼Œä½†æ˜¯ä¸€å®šè¦è®°å¾—åœ¨<code>é¡¶å±‚ä½¿ç”¨</code>ã€‚<code>context</code> é€šå¸¸ä¼šä¸ <code>useReducer</code> ä¸€èµ·ä½¿ç”¨, æ¯”å¦‚åˆ›å»ºä¸€ä¸ªç®€å•çš„è¡¨å•ï¼Œå°±å¯ä»¥è¿™ä¹ˆå¤„ç†ã€‚è‡³äºå¦‚ä½•åˆ›å»º
é«˜æ•ˆçš„ <code>Form</code>, è¿™é‡Œå°±ä¸åšè¯¦ç»†çš„é˜è¿°ã€‚</p><h2 id="context-is-necessary">context is necessary?</h2><p><code>context</code> ä¸€èˆ¬èƒ½è§£å†³å¤§éƒ¨åˆ†çš„åœºæ™¯ï¼Œä½†æ˜¯æ˜¯å¦æ‰€æœ‰çš„åœºæ™¯éƒ½é€‚åˆ <code>context</code> å‘¢ï¼Ÿç°åœ¨å¸‚åœºä¸Šæœ‰å¾ˆå¤šçš„çŠ¶æ€ç®¡ç†çš„åº“æ¯”å¦‚ <code>redux</code>, <code>mobx</code>, <code>rematch</code>, <code>reselect</code>, <code>dva</code> ç­‰ä¸€äº›åº“æ¥å¤„ç†
çŠ¶æ€çš„é—®é¢˜ã€‚è¿™äº›åº“å¯èƒ½å¤„ç†çš„ä¸ä»…ä»…æ˜¯çŠ¶æ€çš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›å‰¯ä½œç”¨çš„å¤„ç†ç­‰ã€‚ä»¥ <code>react-redux</code> ä¸ºä¾‹</p><p>åœ¨ <code>react-redux</code> ä¸­ä¹Ÿä½¿ç”¨äº† context, ä½†æ˜¯å†…éƒ¨ä»£ç ç¡®é‡‡ç”¨äº† <code>subscriber</code> çš„æ–¹å¼ï¼Œä¸ºä»€ä¹ˆï¼Ÿåœ¨ <code>class</code> ä¸­è¯´è¿‡åªè¦ä½¿ç”¨ <code>context</code> çš„åœ°æ–¹,éƒ½ä¼šé€ æˆæ›´æ–°ï¼Œé‚£ä¹ˆæ¯”å¦‚åœ¨ A ç»„ä»¶ä¸­åªéœ€è¦ <code>age</code> å­—æ®µ
åœ¨ <code>B</code> ç»„ä»¶ä¸­åªéœ€è¦ <code>name</code> å­—æ®µï¼Œæ‰€å¸Œæœ›çš„æ˜¯åœ¨ä¿®æ”¹ <code>age</code> çš„æ—¶å€™ï¼Œ <code>B</code> ç»„ä»¶æ˜¯ä¸åº”è¯¥å‘ç”Ÿ <code>render</code> çš„ï¼Œæ‰€ä»¥ <code>react-redux</code> å†…éƒ¨é‡‡ç”¨äº†è¿™ç§æ–¹å¼æ¥å¤„ç† <code>context</code> å¼•èµ·çš„æ€§èƒ½é—®é¢˜ã€‚é€šå¸¸åœ¨æ—¥å¸¸çš„ä¸šåŠ¡ä»£ç ä¸­
ä¸ç”¨å¤ªå…³å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ <code>context</code> çš„æ—¶å€™é€šå¸¸æ¶‰åŠçš„ç»„ä»¶æ•°é‡ä¸ä¼šå¾ˆå¤šï¼Œå³ä½¿å¤š <code>render</code> äº†å‡ æ¬¡ä¹Ÿä¸ä¼šé€ æˆå¤ªå¤§çš„å½±å“ã€‚</p><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ <code>context</code>ï¼Œåˆé‡åˆ°äº†åŒæ ·çš„æ€§èƒ½é—®é¢˜ï¼Œå¯èƒ½ä½ å¹¶ä¸æƒ³ç”¨ <code>react-redux</code>ï¼Œé‚£ä¹ˆæˆ‘æ¨èä½¿ç”¨ <a href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> è¿™ä¸ªåº“ï¼Œè¿™ä¸ªåº“çš„å†™æ³•å¾ˆç®€å•ï¼Œä¹Ÿ
åšåˆ°äº†éƒ¨åˆ†æ¸²æŸ“ï¼Œä¿®æ”¹ A ç»„ä»¶å¹¶ä¸ä¼šå½±å“åˆ° B ç»„ä»¶ã€‚åªéœ€è¦åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>useSelector</code> å³å¯</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux-chaos'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ExampleA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      age<span class="token punctuation">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>age<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateAge'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>updateAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ã€‚</p><h2 id="conslusion">Conslusion</h2><p><code>context</code> è§£å†³äº†çŠ¶æ€å¤šå±‚ä¼ é€’çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ä¼šå¼•èµ·ä¸€äº›æ€§èƒ½æ–‡è‰ºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦å¤ªå¤šå…³æ³¨è¿™ä¸ªæ€§èƒ½é—®é¢˜ï¼Œé™¤éçœŸæ­£çš„é‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚åœ¨å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨ <code>useContext</code> æ–°çš„ <code>Hook</code> æ¥è¾¾åˆ°å’Œ class ä¸­
åŒæ ·çš„æ•ˆæœã€‚</p><h2 id="thanks">Thanks</h2></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ğŸ¤” Form]]></title>
            <link>/posts/2019-08-19/form/</link>
            <guid>/posts/2019-08-19/form/</guid>
            <pubDate>Sun, 18 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>è¡¨å•ç»„ä»¶æ˜¯åœ¨ <code>Bç«¯</code> å¼€å‘ä¸­æœ€å¸¸ç”¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, <code>Textarea</code>, <code>DatePicker</code> ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„è¡¨å•ç±»ç»„ä»¶ï¼Œç„¶è€Œè¡¨å•çš„ç®¡ç†ç¡®æ˜¯æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†ã€‚å¸¸è§„åœ¨å¼€å‘è¡¨å•çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™å¯èƒ½ä¸ä½¿ç”¨ <code>Form</code> è¿™æ ·çš„ç»„ä»¶è€Œæ˜¯è¿™æ ·</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">submit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å§“å<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>name<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å¹´é¾„<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>age<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> age<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>åœ°å€<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>address<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> address<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">></span>æäº¤<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ä½¿ç”¨åŸºç¡€çš„ <code>form</code> æ ‡ç­¾ï¼ŒåŸºç¡€è¡¨å•åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ä¹ˆå†™çš„ï¼Œå£°æ˜è¡¨å•ä¸­æ‰€éœ€è¦çš„çŠ¶æ€ï¼Œå¯¹åº”çš„ <code>value</code> ä¸å„è‡ªçš„ç»„ä»¶å¯¹åº”èµ·æ¥ï¼Œå¦‚æœå­˜åœ¨æ ¡éªŒä¿¡æ¯çš„æ˜¯ï¼Œè¿˜éœ€è¦è¿›è¡Œæ ¡éªŒã€‚å› ä¸ºè¡¨å•å¾ˆå¤šæ—¶å€™æ˜¯éœ€è¦è¿›è¡Œå®æ—¶æ ¡éªŒçš„ï¼ŒåŠæ—¶è®©ç”¨æˆ·å‘ç°é—®é¢˜ï¼Œç„¶åèƒ½åŠæ—¶æ”¹æ­£é—®é¢˜ã€‚é‚£è¿™æ ·æ¯ä¸€ä¸ª <code>Input</code> è¿™æ ·çš„ç»„ä»¶éƒ½åº”è¯¥éœ€è¦ <code>validate</code> è¿™æ ·çš„ä¸€ä¸ªæ ¡éªŒå‡½æ•°ï¼Œè¿˜æœ‰æ˜¯å¦åœ¨ <code>onChange</code> æ—¶å€™æ ¡éªŒè¿˜æ˜¯åœ¨ <code>onBlur</code> çš„æ—¶å€™æ ¡éªŒï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬çš„çŠ¶æ€ä¸æ˜¯ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·å†™æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿä½†æ˜¯å³ä½¿æ˜¯è¿™æ ·ç®€å•çš„è¡¨å•ï¼Œå¦‚æœæ­¤æ—¶æ˜¯ <code>A</code> é¡µé¢éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ <code>B</code> é¡µé¢ä¹ŸåŒæ ·éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ<code>validate</code> ç­‰éƒ½éœ€è¦ã€‚é‚£ä¹ˆè¦ä¸å»æ‹·è´ä»£ç è¿‡æ¥ä¿®æ”¹ä¸€ä¸‹ï¼Œè¦ä¸è‡ªå·±å°è£…ä¸€ä¸ª <code>Form</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="å°è£…-form-">å°è£… Form ğŸ˜²</h2><p>è€ƒè™‘ä¸€ä¸‹ä¸Šé¢çš„ä»£ç å¦‚ä½•å°è£…æˆä¸€ä¸ª <code>Form</code> å‘¢ï¼Ÿå°±åƒä¸Šé¢çš„ä»£ç ä¸€æ ·ï¼Œç»„ä»¶çš„åç§°å·²ç»å‘½åä¸º <code>Form</code> äº†, æ˜¯å¦è¿™æ ·å°±å¯ä»¥äº†å‘¢ï¼Ÿå¦‚æœå­˜åœ¨è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span>'<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span>'<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span>' <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span>'<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span>'<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æ­¤æ—¶ <code>C</code> ç»„ä»¶å†…éƒ¨æ‰ç”¨äº† <code>Input</code> è¿™æ ·çš„ç»„ä»¶ï¼Œé‚£å¦‚æœåœ¨ <code>C&#x27;</code> ç»„ä»¶ä¸­ç”¨åˆ°äº† <code>C</code> ç»„ä»¶çš„ä¿¡æ¯æ€ä¹ˆåŠå‘¢ï¼Ÿ
é‡åˆ°è¿™ç§åœºæ™¯é€šå¸¸çš„åšæ³•å«åš <code>lifting state up</code>, çŠ¶æ€æå‡ï¼Œåœ¨æ›´æ–° <code>C</code> ç»„ä»¶çš„æ—¶å€™ï¼ŒæŠŠçŠ¶æ€åŒæ­¥æ›´æ–°åˆ° <code>Form</code> ç»„ä»¶ï¼Œ <code>Form</code> ç»„ä»¶åˆæŠŠè¿™ä¸ªæ•°æ®ä¼ é€’åˆ° <code>C&#x27;</code> ç»„ä»¶ï¼Œ <code>C&#x27;</code> ç»„ä»¶æ‹¿åˆ°äº†æ­£ç¡®çš„æ•°æ®ã€‚<code>Nice</code>, é€šè¿‡çŠ¶æ€æå‡ï¼ŒæˆåŠŸçš„è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™æ ·æ¯æ¬¡å°±éœ€è¦åœ¨ <code>Form</code> ä¸­å­˜å‚¨çŠ¶æ€ï¼Œç„¶åè¿˜éœ€è¦ä¼ é€’å›è°ƒå‡½æ•°åˆ°éœ€è¦çš„ç»„ä»¶ä¸­ï¼Œæ›´æ–°ç›¸åº”çš„çŠ¶æ€ã€‚å¦‚æœç»„ä»¶åµŒå¥—åªæœ‰ <code>2 - 3</code> å±‚çš„æ—¶å€™ï¼Œè¿™æ ·æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœç»„ä»¶åµŒå¥—æœ‰å¾ˆå¤šå±‚å‘¢ï¼Ÿæ¯”å¦‚æ­¤æ—¶ <code>E ç»„ä»¶</code> æ‰æ˜¯ <code>Input</code> ç»„ä»¶çš„æ‰€åœ¨ï¼Œé‚£ä¹ˆè¿™æ ·åµŒå¥—ä¸‹å»ä¼ é€’</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token constant">D</span><span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">D</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">C</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>çš„å±‚æ•°åªä¼šè¶Šæ¥è¶Šå¤šï¼Œåé¢ç»´æŠ¤èµ·æ¥è¦æ¯ä¸€å±‚æ¯ä¸€å±‚å»çœ‹ï¼Œé˜²æ­¢å…¶ä¸­ä¸€å±‚å‡ºç°é—®é¢˜äº†ã€‚é’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆå¤šç«¥é‹ä¼šæƒ³åˆ° <code>react-redux</code>, <code>mbox</code> é€šè¿‡çŠ¶æ€ç®¡ç†å·¥å…·æ¥è§£å†³è¿™æ ·çš„ä¼ é€’çš„é—®é¢˜ï¼Œæ­å–œæ€è·¯æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œé€šè¿‡ç›®å‰çš„ä¸€äº›çŠ¶æ€ç®¡ç†åº“æ˜¯å¯ä»¥åšåˆ°çš„ã€‚ä¸å¦¨ä»¥ <code>react-redux</code> ä¸¾ä¾‹ï¼Œ <code>react-redux</code> å†…éƒ¨ä½¿ç”¨äº† <code>React Context</code>, æ˜¯çš„ï¼Œ <code>React</code> å›¢é˜Ÿä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæä¾›äº† <code>context</code> è¿™æ ·çš„ <code>api</code>, é‚£ä¹ˆ <code>context</code> å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> createContext<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> FormContext <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch<span class="token punctuation">:</span> setValue <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é¦–å…ˆéœ€è¦ä½¿ç”¨ <code>React.createContext</code> æ¥åˆ›å»ºä¸€ä¸ª <code>context</code>, ç„¶ååœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>context.Provider</code>, <code>context.Provider</code> æ¥å—ä¸€ä¸ª <code>value</code> propsï¼Œ å¦‚ä½•è·å–åˆ° <code>value</code> ä¸­çš„å€¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>FormContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡åœ¨<code>å­ç»„ä»¶</code>ä¸­ä½¿ç”¨ <code>useContext()</code> è·å–åˆ°ç›¸åº”çš„ value, å¦‚æœåœ¨ <code>class ç»„ä»¶</code>ä¸­åˆ™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Field</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨ <code>FormContext.Consumer</code> çš„æ–¹å¼ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>render props</code> çš„ç»„ä»¶ã€‚å› ä¸ºä¸€ä¸ªæ™®é€šçš„ <code>Form</code> å°±å¯ä»¥ç®€æ´çš„å®Œæˆäº†, é¦–å…ˆåœ¨ <code>Form</code> ç»„ä»¶ä¸­åˆ©ç”¨ <code>context.Provider</code> æŠŠæƒ³è¦çš„å€¼å’Œæ–¹æ³•ä¼ é€’ä¸‹å»ï¼Œåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ‹¿åˆ° <code>value</code> å’Œ <code>dispatch</code>, è¿™æ ·å°±è§£å†³äº†å¤šå±‚ä¼ é€’çŠ¶æ€çš„é—®é¢˜ã€‚è¿™æ ·ç®€çº¦çš„è¡¨å•ç”¨èµ·æ¥å¾ˆçˆ½ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡çš„æ…¢æ…¢å¤æ‚ï¼Œéœ€è¦çš„åŠŸèƒ½ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œè¡¨å•ä¸­çš„ç»„ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æœ‰å¯èƒ½è¿™æ ·çš„ <code>Field</code> ç»„ä»¶å¯èƒ½æœ‰å‡ åä¸ªç”šè‡³ä¸Šç™¾ä¸ªï¼Œç„¶åå‘ç°è¡¨å•å˜å¾—è¶Šæ¥è¶Šæ…¢è¶Šæ¥è¶Šæ…¢ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ¯æ¬¡æ‰§è¡Œ <code>dispatch</code> éƒ½ä¼šä¿®æ”¹é¡¶å±‚çš„ value, é¡¶å±‚çš„ <code>value</code> å‘ç”Ÿå˜åŒ–äº†ï¼Œè¿™æ ·æ¯ä¸€ä¸ª <code>Field</code> ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œåªè¦æ˜¯ä½¿ç”¨äº† <code>useContext()</code> è¿™æ ·çš„ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œè¿™ä¸ªæ¸²æŸ“çš„é‡å¯èƒ½éå¸¸éå¸¸çš„å¤§ï¼ŒåŠæ—¶ä¸€ä¸ªç®€å•çš„ <code>Input</code> ä¿®æ”¹äº†å…¶ä¸­çš„ä¸€ä¸ªå€¼ï¼Œä¹Ÿä¼šé€ æˆæ•´ä¸ª <code>Form</code> é‡æ–° render, ä¸€ä¸¤æ¬¡ render å¯èƒ½è€—æ—¶éå¸¸å°‘ï¼Œä½†æ˜¯å½“è¾¾åˆ°ä¸Šç™¾ä¸ªçš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>render</code> è€—æ—¶å°±ä¼šéå¸¸éå¸¸çš„é«˜ã€‚å¯èƒ½è¿™ç¬¬ä¸€ä¸ª <code>Field</code> ä¸­åªä¿®æ”¹äº† <code>a</code> å±æ€§ï¼Œå¯æ˜¯å…¶ä»–çš„ <code>Field</code> ä¸­éƒ½æ²¡æœ‰ç”¨åˆ° <code>a</code> å±æ€§ï¼Œå…¶ä½™çš„å­ç»„ä»¶çš„æ¸²æŸ“æ˜¯å¤šä½™çš„ã€‚ä½†æ˜¯ <code>context</code> æ˜¯æ— æ³•è¢« <code>bail out</code> çš„, æ‰€ä»¥æ‰€æœ‰çš„ <code>Field</code> éƒ½ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆä¸å¦¨æ§åˆ¶ä¸‹ <code>Field</code> çš„å­ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Sub name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> validate<span class="token operator">=</span><span class="token punctuation">{</span>validate<span class="token punctuation">}</span> validateOnChange <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnchange<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>Field</code> ç»„ä»¶é€šè¿‡ä½¿ç”¨ <code>useMemo</code> è¿›è¡Œç¼“å­˜ï¼Œåªæœ‰å½“æ•°ç»„çš„å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰ä¼šå†ä¸€æ¬¡é‡æ–° <code>render</code>, <code>useMemo</code> çš„ä½œç”¨å’Œ <code>react-redux</code> çš„ <code>connect</code> é«˜é˜¶å‡½æ•°çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡ä½¿ç”¨ <code>useMemo</code> å¯ä»¥æŠŠ <code>render æ—¶é—´é•¿çš„å­ç»„ä»¶</code> è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘ <code>render</code> æ—¶é—´ï¼Œæå‡æ€§èƒ½ã€‚</p><h2 id="optimize-form-">optimize form ğŸ˜Š</h2><p>æ­¤æ—¶æ˜¯å¦å·²ç»å®Œæˆäº†æ•´ä¸ª <code>Form</code> çš„ä¼˜åŒ–è¿‡ç¨‹äº†ï¼Œæ­¤æ—¶çš„ <code>Form</code>, åŒ…æ‹¬å¸¸è§„ä½¿ç”¨çš„ <code>context</code> é€šè¿‡ <code>memo</code> è¿›è¡Œä¼˜åŒ–å®é™…ä¸Šå·²ç»æé«˜äº†å¾ˆå¤šã€‚ä½†æ˜¯å³ä½¿æ˜¯å•çº¯çš„ä¸€ä¸ª <code>Field</code> ç»„ä»¶ï¼Œå¦‚æœæ•°é‡å¾ˆå¤šçš„æƒ…å†µä¸‹ä»ç„¶è¿˜æ˜¯ä¼šå­˜åœ¨å¡é¡¿çš„æƒ…å†µçš„ã€‚ç‰¹åˆ«æ˜¯å½“æ¥å…¥äº†ç¬¬ä¸‰æ–¹ç»„ä»¶åº“çš„æ—¶å€™ã€‚æœ¬èº«ç¬¬ä¸‰æ–¹ç»„ä»¶æä¾›çš„åŠŸèƒ½æœ‰å¾ˆå¤šï¼Œç»„ä»¶æœ¬èº«ä¹Ÿä¼šå¾ˆå¤æ‚ï¼Œä¸åƒåŸç”Ÿçš„ <code>input</code> é‚£æ ·ç®€å•ï¼Œå‡è®¾æ­¤æ—¶æ¥å…¥çš„æ˜¯ <code>antd</code> çš„ç»„ä»¶åº“</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">CustomInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Field<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨å¯¹ <code>Input</code> è¿›è¡Œå¿«é€Ÿè¾“å…¥çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢çš„å“åº”ä¼šæœ‰æ‰€å»¶è¿Ÿï¼Œå¦‚æœæ‰“å¼€ <code>chrome</code> çš„ <code>performance</code> è¿›è¡Œå½•åˆ¶çš„æ—¶å€™ï¼Œå°±ä¼šçœ‹åˆ°ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œå…³äº <code>é•¿ä»»åŠ¡</code> è¿™é‡Œä¸åšè¯¦ç»†æè¿°ï¼Œè¿™ç§å¯ä»¥é€šè¿‡æ—¶é—´åˆ†ç‰‡ï¼ˆtime slicingï¼‰ æ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬é›†ä¸­åœ¨ <code>Field</code> æ¸²æŸ“è¿™å—ï¼Œ<code>Input</code> çš„æ”¹åŠ¨æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œé‚£ä¹ˆé¡¶å±‚çš„ <code>context</code> ä¿®æ”¹çš„ä¹Ÿéå¸¸é¢‘ç¹ï¼Œå³ä½¿ä½¿ç”¨äº† <code>useMemo</code> ä»ç„¶è¿˜æœ‰å¡é¡¿çš„ç°è±¡ã€‚<code>React æˆå‘˜ Dan</code> åœ¨ twitter ä¸­è¯´è¿‡ <code>context</code> å¹¶ä¸é€‚åˆä¿®æ”¹ç‰¹åˆ«é¢‘ç¹çš„ç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, ä½†æ˜¯åœ¨ <code>Form</code> ä¸­çš„ç¡®éœ€è¦ <code>context</code> æ¥å¤„ç†è¿™æ ·çš„é—®é¢˜ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Ÿå¦‚ä½•æ¥ä¼˜åŒ– <code>Form</code>?</p><p>ç›®å‰æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å­˜åœ¨äº† <code>Form</code> çš„é¡¶å±‚ï¼Œåœ¨é¡¶å±‚æ›´æ–°è§¦å‘å­ç»„ä»¶çš„æ›´æ–°ï¼Œé‚£ä¹ˆé’ˆå¯¹ <code>Field</code> è¿™ä¹ˆé¢‘ç¹çš„æ¸²æŸ“ï¼Œèƒ½å¦åšåˆ°æ¯æ¬¡ä¿®æ”¹å½“å‰ <code>Field</code> çš„æ—¶å€™ï¼Œåªä¼šæ¸²æŸ“å½“å‰çš„ <code>Field</code> å‘¢ï¼Ÿ</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>Form.js</code> ä¸­é¦–å…ˆæœ‰ä¸‰ä¸ª <code>context</code> åˆ†åˆ«æ˜¯ <code>formContext</code>, <code>formStateContext</code>, <code>formApiContext</code>ã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ä¸€ä¸ª context å‘¢ï¼Ÿå› ä¸ºé€šè¿‡ä¸‰ä¸ª context, æŠŠå„è‡ªçš„èŒèƒ½è¿›è¡ŒåŒºåˆ†ã€‚å¤šä¸ª context ä¹Ÿèƒ½èµ·åˆ°ä¼˜åŒ–çš„ä½œç”¨ï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆæ¯æ¬¡ <code>formStateContext</code> çš„ value æ›´æ–°çš„æ—¶å€™ï¼Œ<code>formApiContext</code> çš„ä½¿ç”¨å¤„çš†ä¸å—å½±å“ï¼Œ<code>A</code> ç»„ä»¶ä¸ä¼šå› ä¸º <code>B</code> ç»„ä»¶ä½¿ç”¨çš„ <code>context</code> çš„å€¼çš„å˜åŒ–è€Œè¿›è¡Œæ›´æ–°ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨å¤šä¸ª <code>context</code>ã€‚</p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>useForm.js</code> ä¸­å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>useReducer</code>, è¿™é‡Œä¸»è¦ä¸ºäº†é˜è¿°æ€æƒ³ï¼Œä½¿ç”¨ <code>useState</code>ã€‚æœ‰ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ <code>setValue</code> å’Œ <code>setError</code>, <code>setValue:</code> æ˜¯ç”¨æ¥æ›´æ–°ä¿®æ”¹çš„å€¼ï¼Œ <code>setError:</code> ç”¨æ¥è®¾ç½®é”™è¯¯çš„ä¿¡æ¯ã€‚<code>useRegister</code> è¿™é‡Œå…ˆæš‚ä¸è®¨è®ºï¼Œå…ˆçœ‹ä¸€ä¸‹å¸¸è§„çš„ <code>Field</code> ç»„ä»¶ã€‚</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸€ä¸ªç®€å•çš„ <code>Field</code> ç”¨äºä¿®æ”¹ <code>form</code> çš„å€¼ï¼Œå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Field name<span class="token operator">=</span><span class="token string">'name'</span><span class="token operator">></span>
  <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> handleChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
</code></pre><p>è¿™å°±æ˜¯ <code>Field</code> çš„ç®€å•ç”¨æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ï¼Œåªè¦ä½¿ç”¨ <code>Field</code> çš„ç»„ä»¶åœ¨å…¶ä¸­ä¸€ä¸ª <code>Field</code> ç»„ä»¶å‘ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œå…¶ä»–çš„æ‰€æœ‰çš„ <code>Field</code> ç»„ä»¶ä¹Ÿä¼šå‘ç”Ÿæ›´æ–°ã€‚å› ä¸ºåœ¨æ¯æ¬¡æ›´æ–°å€¼çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>setValue</code>, <code>useForm</code> æ›´æ–°ï¼Œè¿”å›æ–°çš„å€¼ï¼Œ<code>context</code> çš„ value å‘ç”Ÿå˜åŒ–ï¼Œæ‰€æœ‰ç”¨åˆ° <code>context</code> åœ°æ–¹éƒ½ä¼šå‘ç”Ÿæ›´æ–°ã€‚æ­¤æ—¶ä¹Ÿè®¸ä¼šæƒ³åˆ°æ¯æ¬¡è¿”å›çš„ <code>formApi</code> éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡å¥½åƒæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ˜¯çš„ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹å‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šä¸ª <code>context</code>, å› ä¸ºæ¯æ¬¡éƒ½æ˜¯æ–°çš„å¼•ç”¨è¿™æ˜¯å®Œå…¨æ²¡æœ‰æ„ä¹‰çš„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯åº”è¯¥è¿›è¡Œç¼“å­˜å‘¢ï¼Ÿè²Œä¼¼è¿™ç§æƒ³æ³•æ˜¯å¯ä»¥çš„ï¼ŒOKï¼Œåšä¸‹å»ã€‚</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>useState</code> å¯¹ <code>formApi</code> è¿›è¡Œç¼“å­˜ï¼Œç°åœ¨æ¯æ¬¡æ›´æ–°ï¼Œ<code>formApi</code> éƒ½æ˜¯ä¹‹å‰çš„å¼•ç”¨ä¸åœ¨æ˜¯æ–°çš„å¼•ç”¨ï¼Œæ¯æ¬¡å‘ç”Ÿå˜åŒ–çš„æ˜¯ <code>formState</code>, æ­¤æ—¶ä¿®æ”¹ <code>Input</code> çš„å€¼å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<code>Input</code> è¾“å…¥ä¸è¿›å»äº†ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶æ˜¯ä½¿ç”¨äº† <code>useFormApi</code></p><p><code>useFormApi.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formApiContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½†æ˜¯å› ä¸ºåœ¨ <code>Form</code> ä¸­å¯¹ <code>formApi</code> è¿›è¡Œäº†ç¼“å­˜ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>useFormApi</code> çš„ç»„ä»¶éƒ½ä¸ä¼šé‡æ–° <code>render</code>, æ‰€ä»¥ <code>Input</code> ä¸­çš„å€¼ä¼šè¾“å…¥ä¸è¿›å»ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯éœ€è¦æŠŠåœ¨ <code>Field</code> ç»„ä»¶ä¸­åœ¨ä½¿ç”¨ <code>useFormState</code> å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formState <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚ä½•ä½¿ç”¨ <code>useFormState</code> çš„è¯ï¼Œ é‚£å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Œå› ä¸ºæ¯ä¸€ä¸ª <code>Field</code> éƒ½ä¼šè¿›è¡Œ <code>render</code>, æ‰€ä»¥è¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ <code>useFormApi</code>, ç°åœ¨è€ƒè™‘ä¸€ä¸‹å¦‚ä½•è®©å•ä¸ª <code>Field</code> æ¸²æŸ“ä¸å½±å“å…¶ä»–çš„å‘¢ï¼Ÿ</p><p>åœ¨ä¸šåŠ¡ä¸­ï¼Œå†™ç»„ä»¶çš„æ—¶å€™ï¼Œä¸¤ä¸ªç»„ä»¶å¦‚ä½•åšåˆ°äº’ä¸å½±å“ï¼Œé‚£å°±æ˜¯ç»„ä»¶ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œæ¯”å¦‚:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'lanyincao'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>A</code> ç»„ä»¶çš„çŠ¶æ€åªåœ¨è‡ªå·±çš„ç»„ä»¶çš„å†…éƒ¨ï¼Œæ‰€ä»¥æœ¬èº« <code>A</code> ç»„ä»¶çš„æ›´æ–°å¹¶ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ç»„ä»¶çš„å˜åŒ–ã€‚é‚£æ˜¯å¦ <code>Field</code> ç»„ä»¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšå‘¢ï¼Ÿ</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> register <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ä½ç½®å†…éƒ¨å€¼çš„çŠ¶æ€</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    register<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      setValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ç”¨è¿‡ä¸€ä¸ª register æŠŠæ¯ä¸€ä¸ª <code>Field</code> çš„ setValue æ³¨å†Œè¿›å»ï¼Œå¾ˆå¤šå…¶ä»–çš„é«˜æ€§èƒ½çš„ <code>Form</code> éƒ½æ˜¯é‡‡å– <code>Observer</code> çš„å½¢å¼çš„ï¼ŒåŒ…æ‹¬ <code>react-redux</code> å¦‚ä½•è§£å†³æ€§èƒ½é—®é¢˜çš„ï¼Œéƒ½æ˜¯é€šè¿‡ <code>Observer</code> çš„å½¢å¼ã€‚çœ‹ä¸‹ <code>useRegister</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">unregister</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> unregister <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æŠŠ <code>Form</code> ä¸­çš„ <code>useRegister</code> ç§»åˆ° <code>useForm</code> ä¸­, ä¿®æ”¹ <code>useForm</code> çš„è¿”å›å€¼, ä»¥åŠä¿®æ”¹ <code>setValue</code></p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useRegister <span class="token keyword">from</span> <span class="token string">'./register'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–åˆ°å½“å‰ä¿®æ”¹çš„ field</span>
    <span class="token keyword">const</span> currentField <span class="token operator">=</span> fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨å†…éƒ¨çš„ setValue</span>
    currentField<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldsApi<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ç°åœ¨ä¿®æ”¹å…¶ä¸­ä¸€ä¸ª <code>Field</code> çš„æ—¶å€™ä¼šè°ƒç”¨å†…éƒ¨çš„ <code>setValue</code> æ–¹æ³•ï¼Œå®ç°å±€éƒ¨æ¸²æŸ“ã€‚</p><h2 id="conclusion">conclusion</h2><ul><li><code>context</code> æ¯”è¾ƒé€‚åˆäºæ”¹åŠ¨ä¸æ˜¯å¾ˆé¢‘ç¹çš„ç»„ä»¶</li><li>å¯¹äº render æ—¶é—´è¾ƒé•¿çš„å¯ä»¥ä½¿ç”¨ <code>useMemo</code> æ¥ä¼˜åŒ–</li><li>å˜åŠ¨é¢‘ç¹çš„å¯ä»¥é‡‡ç”¨å·²æœ‰çš„çŠ¶æ€ç®¡ç†åº“æ¯”å¦‚ <a href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> æˆ–è€…é‡‡å– <code>Observer</code> çš„å½¢å¼æ¥å¤„ç†</li></ul></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[How to use context efficient]]></title>
            <link>/posts/2019-08-24/how-to-use-context-efficient/</link>
            <guid>/posts/2019-08-24/how-to-use-context-efficient/</guid>
            <pubDate>Fri, 23 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>å¦‚ä½•é«˜æ•ˆçš„ä½¿ç”¨ <code>context</code>, <a href="https://lanyincao.netlify.com/posts/2019-08-19/form/">ä¸Šä¸€ç¯‡æ–‡ç« </a> è¯¦ç»†çš„è®²è¿°äº†å¦‚ä½•å†™ä¸€ä¸ª <code>Form</code>, ä»¥åŠå¦‚ä½•æ”¹é€  <code>Form</code> çš„æ€§èƒ½ã€‚é‚£ä¹ˆæ˜¯å¦åŒæ ·çš„
å†™æ³•ä¹Ÿå¯ä»¥è¿ç”¨äºæ™®é€šç»„ä»¶å‘¢ï¼Ÿ</p><h1 id="å›é¡¾-context">å›é¡¾ context</h1><p><a href="https://lanyincao.netlify.com/posts/2019-08-10/context/">åœ¨ context æ–‡ç« ä¸­</a>è®²äº†å…·ä½“çš„ç”¨æ³•, åŒæ—¶ä¹Ÿè®²äº† <code>Hook</code> ä¸­å’Œ <code>Class</code> ä¸­ä½¿ç”¨ <code>Context</code> çš„åŒºåˆ«ã€‚åŒæ—¶ä¹Ÿè¯´è¿‡åœ¨ä½¿ç”¨ <code>Context</code> çš„
ä¸€äº›é—®é¢˜ã€‚è¿™æ ·çš„é—®é¢˜è¯¥å¦‚ä½•å»è§£å†³å‘¢ï¼Ÿåœ¨ <code>Form</code> ä¸­çš„æ–¹æ¡ˆæ˜¯å¦å¯ä»¥å¤ç”¨åˆ°å…¶ä»–æ™®é€šçš„ç»„ä»¶ä¸­å‘¢ï¼Ÿ</p><h1 id="react-redux">react-redux</h1><p><a href="https://github.com/reduxjs/react-redux">react-redux</a> æ˜¯ç”± <a href="https://github.com/reduxjs/redux">redux</a> å»¶ä¼¸å‡ºæ¥çš„ï¼Œç”¨äº react ä¸­çš„çŠ¶æ€ç®¡ç†åº“ï¼ŒçŠ¶æ€ç®¡ç†åœ¨ <code>2018</code> å¹´æ˜¯éå¸¸éå¸¸çš„ç«ï¼ŒåŒæ—¶
ä¹Ÿå»¶ä¼¸å‡ºäº†ä¸€å¤§æ‰¹çŠ¶æ€ç®¡ç†çš„åº“æ¯”å¦‚ <a href="https://github.com/mobxjs/mobx">mobx</a>, <a href="https://github.com/dvajs/dva">dva</a> ç­‰ç­‰éƒ½æ˜¯éå¸¸ä¼˜ç§€çš„åº“ã€‚<code>react-redux</code> åœ¨å¾ˆå¤šé¡¹ç›®ä¸­éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“ã€‚é‚£ä¹ˆè¿™ä¸ªåº“æ˜¯å¦å­˜åœ¨åŒæ ·çš„
é—®é¢˜å‘¢ï¼Ÿä¸å¦¨ç”¨ä¸€ä¸ªç®€å•çš„ demo æ¥çœ‹ä¸€ä¸‹ã€‚</p><p><code>react-redux-demo</code></p><p>ä» <code>console.log</code> ä¸­å¯ä»¥çœ‹å‡ºåœ¨ä¿®æ”¹ count çš„æ—¶å€™åªæœ‰ <code>Count</code> ç»„ä»¶æ›´æ–°ï¼Œåœ¨ä¿®æ”¹ <code>person</code> çš„æ—¶å€™åªæœ‰ <code>Person</code> ç»„ä»¶æ›´æ–°ã€‚å› ä¸ºæ— è®ºæ˜¯ <code>Count</code> è¿˜æ˜¯ <code>Person</code>ï¼Œ
éƒ½åœ¨è‡ªå·±æ‰€éœ€è¦çš„ <code>props</code> å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰ä¼šæ›´æ–°ã€‚è¿™ä¸ªæ˜¯ç¬¦åˆ <code>React</code> çš„æ­£å¸¸çš„æ•°æ®æµçš„ï¼Œç»„ä»¶çš„ <code>props</code> å˜åŒ–ä¼šè®©ç»„ä»¶å‘ç”Ÿæ›´æ–°ã€‚</p><p>é‚£ä¹ˆæ˜¯å¦ <code>connect</code> æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œå‘¢ï¼Ÿ<code>connect</code> æ˜¯ä¸€ä¸ª <code>HOC</code>, ä¼šè¿”å›æ–°çš„ç»„ä»¶ï¼Œé‚£ä¸å¦¨åœ¨ <code>mapStateToProps</code> ä¸­åŠ å…¥ <code>console.log</code></p><p><code>mapCountStateToProps</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">mapCountStateToProps</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mapCountStateToProps'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>mapPersonStateToProps</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">mapPersonStateToProps</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mapPersonStateToProps'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>Count</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render count'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>count<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'increase'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          increase
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'decrease'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          decrease
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>Person</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render person'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
          <span class="token operator">&lt;</span>span<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
          <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>address<span class="token punctuation">:</span> <span class="token punctuation">{</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
          <span class="token operator">&lt;</span>button
            onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateName'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'ç‰§äº‘äº‘'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">></span>
            updateName
          <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
          <span class="token operator">&lt;</span>button
            onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
              <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateAddress'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'hangzhou'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token operator">></span>
            updateAddress
          <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ç‚¹å‡» <code>increase</code> æˆ–è€… <code>decrease</code> æŒ‰é’®ï¼Œçœ‹ä¸€ä¸‹æ§åˆ¶å°</p><p><img src="https://user-images.githubusercontent.com/17973020/63645933-381e0480-c73b-11e9-891b-f4bf7ba23a84.jpg" alt="context1"/></p><p>ä»”ç»†è§‚å¯Ÿä¸‹å‘ç° <code>render count</code> æ˜¯æ­£å¸¸çš„æ¸²æŸ“ï¼Œå› ä¸ºç‚¹å‡»äº† <code>increase</code> æˆ–è€… <code>decrease</code>, ä½†æ˜¯ <code>mapCountStateToProps</code> ä»¥åŠ
<code>mapPersonStateToProps</code> æ¯æ¬¡éƒ½ä¼šè¢«è¾“å‡ºï¼Œå³ä½¿åªæ›´æ–°äº† <code>count</code> ç»„ä»¶çš„ <code>props</code>, å…¶å®è¿™ä¸ªå¤§å®¶ä¸åŒå¤ªè¿‡äºå…³å¿ƒï¼Œæˆ‘ä¹‹å‰åœ¨ <code>twitter</code> ä¸Š
é—®è¿‡ <code>Dan</code>, å…³äºæ¸²æŸ“æ¬¡æ•°çš„é—®é¢˜ï¼Œ <code>Dan</code> çš„å›ç­”å°±æ˜¯ä¸è¦å¤ªè¿‡åœ¨æ„ <code>render</code> æ¬¡æ•°è¿™æ˜¯å†…éƒ¨çš„å®ç°ç»†èŠ‚äº†ã€‚é‚£è¿™ä¸ªåœ°æ–¹ä¼šæœ‰å½±å“å—ï¼Ÿ</p><p><code>connect</code> åªæ˜¯ä¸€ä¸ªæ™®é€šçš„é«˜é˜¶ç»„ä»¶ï¼Œä¸å¦¨çœ‹ä¸€ä¸‹ <code>connect</code> çš„æºç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  connectHOC <span class="token operator">=</span> connectAdvanced<span class="token punctuation">,</span>
  mapStateToPropsFactories <span class="token operator">=</span> defaultMapStateToPropsFactories<span class="token punctuation">,</span>
  mapDispatchToPropsFactories <span class="token operator">=</span> defaultMapDispatchToPropsFactories<span class="token punctuation">,</span>
  mergePropsFactories <span class="token operator">=</span> defaultMergePropsFactories<span class="token punctuation">,</span>
  selectorFactory <span class="token operator">=</span> defaultSelectorFactory
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">mapStateToProps<span class="token punctuation">,</span>
    mapDispatchToProps<span class="token punctuation">,</span>
    mergeProps<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      pure <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      areStatesEqual <span class="token operator">=</span> strictEqual<span class="token punctuation">,</span>
      areOwnPropsEqual <span class="token operator">=</span> shallowEqual<span class="token punctuation">,</span>
      areStatePropsEqual <span class="token operator">=</span> shallowEqual<span class="token punctuation">,</span>
      areMergedPropsEqual <span class="token operator">=</span> shallowEqual<span class="token punctuation">,</span>
      <span class="token operator">...</span>extraOptions
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> initMapStateToProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>
      mapStateToProps<span class="token punctuation">,</span>
      mapStateToPropsFactories<span class="token punctuation">,</span>
      <span class="token string">'mapStateToProps'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> initMapDispatchToProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>
      mapDispatchToProps<span class="token punctuation">,</span>
      mapDispatchToPropsFactories<span class="token punctuation">,</span>
      <span class="token string">'mapDispatchToProps'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> initMergeProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>mergeProps<span class="token punctuation">,</span> mergePropsFactories<span class="token punctuation">,</span> <span class="token string">'mergeProps'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">connectHOC</span><span class="token punctuation">(</span>selectorFactory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// used in error messages</span>
      methodName<span class="token punctuation">:</span> <span class="token string">'connect'</span><span class="token punctuation">,</span>

      <span class="token comment">// used to compute Connect's displayName from the wrapped component's displayName.</span>
      <span class="token function-variable function">getDisplayName</span><span class="token punctuation">:</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connect(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>

      <span class="token comment">// if mapStateToProps is falsy, the Connect component doesn't subscribe to store state changes</span>
      shouldHandleStateChanges<span class="token punctuation">:</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token comment">// passed through to selectorFactory</span>
      initMapStateToProps<span class="token punctuation">,</span>
      initMapDispatchToProps<span class="token punctuation">,</span>
      initMergeProps<span class="token punctuation">,</span>
      pure<span class="token punctuation">,</span>
      areStatesEqual<span class="token punctuation">,</span>
      areOwnPropsEqual<span class="token punctuation">,</span>
      areStatePropsEqual<span class="token punctuation">,</span>
      areMergedPropsEqual<span class="token punctuation">,</span>

      <span class="token comment">// any extra options args can override defaults of connect or connectAdvanced</span>
      <span class="token operator">...</span>extraOptions
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>connect</code> æœ¬èº«ä¸ä¼šæœ‰ä¸€äº›å¤æ‚çš„è®¡ç®—ï¼Œæ‰€ä»¥å³ä½¿æ¯æ¬¡éƒ½æ‰§è¡Œæ˜¯æ²¡æœ‰å½±å“çš„ã€‚</p><p><code>æœ‰å¯èƒ½ä½ ç‰¹åˆ«åœ¨æ„ render çš„æ¬¡æ•°ï¼Œå¯èƒ½å°±æ˜¯ä¸æƒ³ connect æ¯æ¬¡éƒ½è¦æ‰§è¡Œï¼Œå°±æ˜¯æœ‰è¿™æ ·çš„å¼ºè¿«ç—‡ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•å»ä¿®æ”¹è¿™ä¸ªå‘¢ï¼Ÿ</code></p><hr/><h1 id="ä»é›¶å®ç°ä¸€ä¸ªçŠ¶æ€ç®¡ç†">ä»é›¶å®ç°ä¸€ä¸ªçŠ¶æ€ç®¡ç†</h1><p>åœ¨å¼€å§‹è¿™ä¸ªéƒ¨åˆ†ä¹‹å‰ï¼Œé¦–å…ˆè¦æ¯”è¾ƒç†Ÿæ‚‰ <code>redux</code>, å› ä¸ºè¿™éƒ¨åˆ†å¾ˆå¤šä»£ç éƒ½æ˜¯ç»§ç»­æ²¿ç”¨ <code>redux</code> ä¸­çš„ä»£ç ã€‚</p><p>ä¸€æ­¥ä¸€æ­¥çš„æ¥ï¼Œé¦–å…ˆå¯¹äºçŠ¶æ€ç®¡ç†ï¼Œåº”è¯¥éœ€è¦ä¸€ä¸ª <code>Provider</code>, ä¸å¦¨æ¥å®ç°è¿™ä¸ª <code>Provider</code>, Provider è¿˜æ˜¯ä½¿ç”¨ <code>React</code> çš„ <code>context api</code>,
è¿™ä¸ªå®ç°æ˜¯ä½¿ç”¨äº† <code>TS</code>, å¦‚æœå¯¹ <code>TS</code> ä¸ç†Ÿæ‚‰çš„å¯ä»¥æŸ¥çœ‹<a href="https://www.typescriptlang.org/">å®˜ç½‘</a></p><p><code>Provider</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeContext<span class="token punctuation">,</span> selectorContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ProviderProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./type'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> Provider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">:</span> ProviderProps<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¼“å­˜ value çš„å€¼è¿›è¡Œå±€éƒ¨æ›´æ–°</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>api<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>storeContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>selectorContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>selectorContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>storeContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ <code>Provider</code> ä¸­ä½¿ç”¨äº†ä¸¤ä¸ª <code>context</code>, ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸¤ä¸ªä¸€æ¨¡ä¸€æ ·çš„å‘¢ï¼Ÿåé¢ä¼šè¯¦ç»†è§£é‡Š, åœ¨çœ‹ä¸€ä¸‹ <code>context</code> çš„å£°æ˜</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UseStoreResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./type'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> storeContext <span class="token operator">=</span> React<span class="token punctuation">.</span>createContext<span class="token operator">&lt;</span>UseStoreResult<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * selectorContext ç”¨æˆ·è·å–å€¼å¹¶ä¸”å¯ä»¥å’Œ dispatch ç›¸åº”çš„å€¼ è¿™ä¸ªå¯ä»¥è¿›è¡Œç¼“å­˜æ‰€ä»¥çœŸæ­£å­˜å‚¨åªçš„åœ°æ–¹æ˜¯ storeContext
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> selectorContext <span class="token operator">=</span> React<span class="token punctuation">.</span>createContext<span class="token operator">&lt;</span>UseStoreResult<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
</code></pre><p>è¿™äº›ç±»å‹çš„åœ°æ–¹ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿç›´æ¥ç”¨ <code>any</code> æ¥ä»£æ›¿, å¯ä»¥çœ‹å‡ºï¼Œåœ¨ <code>context</code> ä¸­å£°æ˜äº†ä¸¤ä¸ª <code>context</code>, åœ¨ <code>Provider</code> ä¸­ä½¿ç”¨äº†
è¿™ä¸¤ä¸ª <code>context</code>ã€‚</p><p>å› ä¸ºæ•´ä¸ªéƒ¨åˆ†éƒ½æ˜¯é‡‡ç”¨ <code>Hooks</code> çš„æ–¹å¼æ¥å¼€å‘çš„ï¼Œæ‰€ä»¥ä¸å†å‘½åä¸º <code>createStore</code> æ‰€ä»¥é‡‡ç”¨ <code>useStore</code>ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> useStore<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">></span><span class="token punctuation">(</span>
  reducer<span class="token punctuation">:</span> ReducerType<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
  initialState<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  enhancer<span class="token operator">?</span><span class="token punctuation">:</span> any
<span class="token punctuation">)</span><span class="token punctuation">:</span> UseStoreResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useCurrent</span><span class="token punctuation">(</span>initialState <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>Listener<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// ç»§ç»­ä½¿ç”¨ redux ä¸­çš„ä¸­é—´ä»¶</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'It looks like you are passing several store enhancers to '</span> <span class="token operator">+</span>
        <span class="token string">'useStore(). This is not supported. Instead, compose them '</span> <span class="token operator">+</span>
        <span class="token string">'together to a single function.'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    enhancer <span class="token operator">=</span> initialState
    initialState <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the enhancer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>useStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * è¿”å› store å­˜çš„æ‰€æœ‰çš„ state
   */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span>

  <span class="token comment">/**
   * ç›‘å¬å™¨ç”¨äºæ›´æ–°å­ç»„ä»¶
   * @param listener
   */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">subscriber</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">listener<span class="token punctuation">:</span> Listener</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> listener <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'expected listener to be a object'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åŠ å…¥åˆ°ç›‘å¬å™¨ä¸­</span>
    listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
      listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * ç”¨äºä¿®æ”¹å€¼, ç”¨äºä¸­é—´ä»¶çš„æ—¶å€™å¯ä»¥ä¸ä¼ ç¬¬äºŒä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ selector ä¸­ä»ç„¶éœ€è¦
   * @param action
   * @param deps å¯èƒ½ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…¨éƒ¨æ›´æ–°
   */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">:</span> Action<span class="token punctuation">,</span> deps<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldState <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// è·å–åˆ°æ‰§è¡Œåçš„ state</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>oldState <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>

    <span class="token keyword">const</span> changeKeys<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment">// è¿›è¡Œæµ…æ¯”è¾ƒè·å–åˆ°ä¿®æ”¹çš„å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>oldState<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          changeKeys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// éå†ç›‘å¬å™¨ï¼Œåªå¯¹å˜åŒ–çš„ç»„ä»¶è¿›è¡Œæ›´æ–°</span>
    listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> listenerProps <span class="token operator">=</span> listener<span class="token punctuation">.</span>props
      <span class="token comment">// å¦‚æœä¾èµ–å­˜åœ¨åˆ™æ›´æ–°ä¾èµ–ä¸­çš„é€‰é¡¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ›´æ–°å…¨éƒ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// éå†ç›‘å¬å™¨ï¼Œå¯¹ä¿®æ”¹çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> changeKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerProps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>changeKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listener<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        listener<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> action
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    getState<span class="token punctuation">:</span> getState<span class="token punctuation">,</span>
    subscriber<span class="token punctuation">:</span> subscriber<span class="token punctuation">,</span>
    dispatch<span class="token punctuation">:</span> dispatch
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>useStore</code> å‰é¢çš„éƒ¨åˆ†å’Œ <code>redux</code> ä¸­çš„ä»£ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹æš‚æ—¶å¯ä»¥ä¸çœ‹, <code>subscriber</code> éƒ¨åˆ†ä¹ŸåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä½†æ˜¯
è¿˜æ˜¯è¦çœ‹ä¸€ä¸‹ <code>listener</code> çš„å‚æ•°æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">subscriber</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">listener<span class="token punctuation">:</span> Listener</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> listener <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'expected listener to be a object'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åŠ å…¥åˆ°ç›‘å¬å™¨ä¸­</span>
  listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
    listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Listener</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">listener</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> any
  props<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p>å¯ä»¥çœ‹å®šä¹‰çš„æ¥å£ï¼Œ<code>subscriber</code> çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­åŒ…æ‹¬ <code>listener</code> å‡½æ•°å’Œä¸€ä¸ª <code>props</code>, å…·ä½“ç”¨æ³•è¿™ä¸¤ä¸ªæ˜¯å¹²ä»€ä¹ˆç”¨çš„, åé¢ä¼šè®²åˆ°</p><p>åœ¨çœ‹ <code>dispatch</code> è¿™ä¸ªå‡½æ•°ï¼Œ <code>dispatch</code> æ˜¯ä¸»ä½“çš„éƒ¨åˆ†ï¼Œ <code>dispatch</code> æ¥å—äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>action</code> ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª <code>deps</code> ä¾èµ–æ•°ç»„
é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„ä¸€ä¸ªä¾èµ–é¡¹å‘¢ï¼Ÿåœ¨çœ‹ä¸‹ <code>useSelector</code></p><p><code>useSelector</code> æ˜¯æœ€æœ€æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œåªéœ€è¦ä½¿ç”¨ <code>useSelector</code> å°±èƒ½å®ç°<code>å±€éƒ¨æ¸²æŸ“</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> useSelector<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token function-variable function">callback</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">:</span> <span class="token constant">T</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> UseSelectorResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>selectorContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> forceUpdate <span class="token operator">=</span> <span class="token function">useForceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>api<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'expected useSelector to be used in Provider'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> propsRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å–åˆ°è¿”å›çš„ props</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSame</span><span class="token punctuation">(</span>propsRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    propsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> current <span class="token operator">=</span> propsRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¢é˜…éœ€è¦çš„ä¿¡æ¯</span>
    api<span class="token punctuation">.</span><span class="token function">subscriber</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">listener</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      props<span class="token punctuation">:</span> current
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>api<span class="token punctuation">,</span> forceUpdate<span class="token punctuation">,</span> current<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">dispatch</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">:</span> Action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      api<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> action<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getState<span class="token punctuation">:</span> api<span class="token punctuation">.</span>getState
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>useSelector</code> ä½¿ç”¨äº† <code>selectorContext</code>ï¼Œè€Œä¸æ˜¯ <code>storeContext</code>, ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºåªè¦ <code>store</code> å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ <code>storeContext</code> å¿…ç„¶ä¼š
é‡æ–° <code>render</code>, <code>storeContext</code> é‡æ–° <code>render</code>, ä½¿ç”¨ <code>storeContext</code> çš„åœ°æ–¹éƒ½ä¼šé‡æ–° <code>render</code>, é‚£ä¹ˆä¸ºä»€ä¹ˆ <code>selectorContext</code> ä¸ä¼šå‘¢ï¼Ÿ
åœ¨ä¼šæœ‰çœ‹ä¸‹ <code>Provider</code> çš„ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> Provider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">:</span> ProviderProps<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¼“å­˜ value çš„å€¼è¿›è¡Œå±€éƒ¨æ›´æ–°</span>
<span class="token operator">></span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>api<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> ğŸ¤”

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>storeContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>selectorContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>selectorContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>storeContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç®­å¤´æ‰€æŒ‡çš„è¿™ä¸ªéƒ¨åˆ†å°±æ˜¯å…³é”®æ‰€åœ¨ <code>const [api] = useState(value)</code> é€šè¿‡è¿™æ ·ï¼ŒæŠŠ <code>value</code> è¿›è¡Œç¼“å­˜äº†ï¼Œè¿™æ ·å³ä½¿æ¯æ¬¡ <code>render</code>,
æ­¤æ—¶çš„ <code>api</code> éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¹Ÿå°±ä¸ä¼šé€ æˆä½¿ç”¨ <code>selectorContext</code> çš„åœ°æ–¹çš„å°±ä¼šæ›´æ–°ã€‚</p><p>é‚£ä¹ˆå¦‚æœ <code>useSelector</code> ä¸æ›´æ–°é‚£åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ <code>useSelector()</code> ä¸ä¹Ÿä¸æ›´æ–°äº†å—ï¼Ÿè¿™æ ·å°±ä¼šé€ æˆ bug çš„äº§ç”Ÿï¼Œè¿™æ˜¯ä¸‡ä¸‡ä¸å…è®¸çš„ã€‚
æ‰€ä»¥åœ¨ <code>useSelector</code> å†…éƒ¨ä½¿ç”¨äº† <code>useForceUpdate</code>ã€‚</p><p><code>useForceUpdate</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">forceReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * forceUpdate
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useForceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useReducer</span><span class="token punctuation">(</span>forceReducer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç°åœ¨å¯ä»¥çœ‹åˆ°åœ¨ <code>useSelector</code> å†…éƒ¨çš„ <code>useEffect</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> propsRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–åˆ°è¿”å›çš„ props</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSame</span><span class="token punctuation">(</span>propsRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  propsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> current <span class="token operator">=</span> propsRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è®¢é˜…éœ€è¦çš„ä¿¡æ¯</span>
  api<span class="token punctuation">.</span><span class="token function">subscriber</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">listener</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span> current
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>api<span class="token punctuation">,</span> forceUpdate<span class="token punctuation">,</span> current<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åªæœ‰åœ¨ <code>current</code> å˜åŒ–çš„æ—¶å€™ä¼šå†ä¸€æ¬¡é‡æ–°æ³¨å†Œ <code>listener</code>, è¿™ä¸ª <code>current</code> é€šè¿‡è°ƒç”¨ <code>callback(api.getState())</code> æ‰€å¾—ï¼Œ
ä¹Ÿå°±æ˜¯åªæœ‰åœ¨ <code>useSelector</code> çš„ä¾èµ–å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰ä¼šé‡æ–°æ³¨å†Œã€‚åœ¨ä¸šåŠ¡é‡Œå¯ä»¥è¿™æ ·ä½¿ç”¨ <code>useSelector(() =&gt; [&#x27;a&#x27;, &#x27;b&#x27;])</code> è¿™é‡Œçš„
<code>a</code> å’Œ <code>b</code> éƒ½æ˜¯ä½¿ç”¨ <code>useSelector</code> ç»„ä»¶é‡Œéœ€è¦ä½¿ç”¨åˆ°çš„å€¼ã€‚æŠŠä½¿ç”¨çš„å€¼ä½œä¸ºä¾èµ–ï¼Œåªè¦ä½¿ç”¨çš„å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œ <code>render</code>ã€‚</p><p>åœ¨çœ‹ä¸‹ <code>useSelector</code> çš„è¿”å›å€¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">return</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">dispatch</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">:</span> Action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> action<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getState<span class="token punctuation">:</span> api<span class="token punctuation">.</span>getState
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶çš„è¿”å›å€¼æ¥ç®¡äº† <code>store</code> ä¸­çš„ <code>dispatch</code> å‡½æ•°, dispatch çš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯ <code>useSelector</code> çš„ä¾èµ–é¡¹ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œ <code>dispatch</code> çš„æ—¶å€™éƒ½ä¼š
æ‰§è¡Œ <code>selector</code> çš„ <code>dispatch</code>ï¼Œ ç„¶åè°ƒç”¨ <code>store</code> ä¸­çš„ <code>dispatch</code> ã€‚åœ¨å›å¤´çœ‹ä¸‹ <code>store</code> ä¸­çš„ <code>dispatch</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token comment">/**
 * ç”¨äºä¿®æ”¹å€¼, ç”¨äºä¸­é—´ä»¶çš„æ—¶å€™å¯ä»¥ä¸ä¼ ç¬¬äºŒä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ selector ä¸­ä»ç„¶éœ€è¦
 * @param action
 * @param deps å¯èƒ½ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…¨éƒ¨æ›´æ–°
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">:</span> Action<span class="token punctuation">,</span> deps<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldState <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// è·å–åˆ°æ‰§è¡Œåçš„ state</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>oldState <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>

  <span class="token keyword">const</span> changeKeys<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// è¿›è¡Œæµ…æ¯”è¾ƒè·å–åˆ°ä¿®æ”¹çš„å€¼</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>oldState<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        changeKeys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// éå†ç›‘å¬å™¨ï¼Œåªå¯¹å˜åŒ–çš„ç»„ä»¶è¿›è¡Œæ›´æ–°</span>
  listeners<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> listenerProps <span class="token operator">=</span> listener<span class="token punctuation">.</span>props
    <span class="token comment">// å¦‚æœä¾èµ–å­˜åœ¨åˆ™æ›´æ–°ä¾èµ–ä¸­çš„é€‰é¡¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ›´æ–°å…¨éƒ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// éå†ç›‘å¬å™¨ï¼Œå¯¹ä¿®æ”¹çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> changeKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerProps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>changeKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          listener<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      listener<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> action
<span class="token punctuation">}</span>
</code></pre><p>é¦–å…ˆæ ¹æ® <code>deps</code> æ‰¾å‡ºå“ªäº›æ˜¯ä¿®æ”¹çš„å€¼ï¼Œå› ä¸ºä¸€ä¸ªç»„ä»¶æœ‰å¯èƒ½ä¼šæœ‰è®¸å¤šä¾èµ–é¡¹ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªç»„ä»¶ä¸­åªä¿®æ”¹äº†ä½¿ç”¨çš„ <code>a</code>, <code>b</code> æ²¡æœ‰æ”¹å˜ï¼Œ é‚£ä¹ˆå…¶ä»–ç»„ä»¶ä¾èµ–äº†è¿™ä¸ª <code>b</code> ä¹Ÿ
ä¸åº”è¯¥æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦æ‰¾å‡ºæ”¹å˜çš„ä¾èµ–é¡¹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>oldState<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      changeKeys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰¾å‡ºæ”¹å˜çš„ä¾èµ–é¡¹åï¼Œå¯¹ <code>listeners</code> è¿›è¡Œéå†, æ‰¾å‡ºæ‰€æœ‰ä½¿ç”¨äº† <code>useSelector</code> çš„åœ°æ–¹çš„æ‰€æœ‰ä¾èµ–ï¼Œçœ‹æ˜¯å¦å­˜åœ¨å…¶ä»–çš„ä¾èµ–é¡¹ä¹ŸåŒ…æ‹¬è¿™æ¬¡æ”¹å˜çš„ä¾èµ–é¡¹ï¼Œæ¯”å¦‚æ­¤æ—¶æ›´æ”¹äº†
<code>a</code>, é‚£ä¹ˆæ‰€æœ‰å…¶ä»–ç»„ä»¶ä¸­æœ‰å¯¹ <code>a</code> çš„ä¾èµ–é¡¹çš„éƒ½åº”è¯¥è¿›è¡Œé‡æ–° <code>render</code>ã€‚è¿™ä¹Ÿæ˜¯ <code>store</code> ä¸­ <code>dispatch</code> çš„ä¸»è¦é€»è¾‘ã€‚</p><p>åŸºæœ¬ä¸Šä¸€ä¸ªçŠ¶æ€ç®¡ç†çš„æ‰€æœ‰ä»£ç å·²ç»è®²æ¸…æ¥šäº†ï¼Œé‚£ä¹ˆä¸å¦¨è¯•è¯•ã€‚</p><p>ç‚¹å‡» <code>increase</code> æˆ–è€… <code>decrease</code>, åªæ‰“å°å‡ºäº† <code>render count selector</code> æ‰€ä»¥æ¯æ¬¡ <code>useSelector</code> ä¹Ÿåªæ˜¯å•æ¬¡æ¸²æŸ“ã€‚è¿™ä¸ªä¹Ÿæ˜¯å±€éƒ¨æ¸²æŸ“äº†ã€‚</p><p><img src="https://user-images.githubusercontent.com/17973020/63645935-4c620180-c73b-11e9-8536-122dfed705a7.jpg" alt="context2"/></p><p>æœ€åè´´ä¸€ä¸‹ä»£ç ï¼Œä»£ç ä¹Ÿå¯ä»¥åœ¨<a href="https://github.com/snakeUni/lanyincaos.cn/tree/master/src/pages/posts/2019-08-24-how-to-use-context-efficient">è¿™é‡Œæ‰¾åˆ°</a></p><p><code>react-redux-demo</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider<span class="token punctuation">,</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸€ä¸ªç®€å•çš„ reducer</span>
<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'increase'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'decrease'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'updateName'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'updateAddress'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> address<span class="token punctuation">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token string">'lanyincao'</span><span class="token punctuation">,</span>
  address<span class="token punctuation">:</span> <span class="token string">'shanghai'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mapCountStateToProps</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mapCountStateToProps'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render count'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>count<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'increase'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          increase
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'decrease'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          decrease
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mapPersonStateToProps</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mapPersonStateToProps'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> name<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render person'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
          <span class="token operator">&lt;</span>span<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
          <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>address<span class="token punctuation">:</span> <span class="token punctuation">{</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
          <span class="token operator">&lt;</span>button
            onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateName'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'ç‰§äº‘äº‘'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">></span>
            updateName
          <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
          <span class="token operator">&lt;</span>button
            onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
              <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateAddress'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'hangzhou'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token operator">></span>
            updateAddress
          <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// count</span>
<span class="token keyword">const</span> ConnectCount <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>mapCountStateToProps<span class="token punctuation">)</span><span class="token punctuation">(</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// person</span>
<span class="token keyword">const</span> ConnectPerson <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>mapPersonStateToProps<span class="token punctuation">)</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>App<span class="token operator">></span>
        <span class="token operator">&lt;</span>ConnectCount <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>ConnectPerson <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>App<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>react-redux-chaos demo</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> useSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux-chaos'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'lanyincao'</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> <span class="token string">'shanghai'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'increase'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'decrease'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'updateName'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'updateAddress'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> address<span class="token punctuation">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render count selector'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> state<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>count<span class="token punctuation">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'increase'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        increase
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'decrease'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        decrease
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render person selector'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> state<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>span<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
        <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>address<span class="token punctuation">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button
          onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateName'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'ç‰§äº‘äº‘'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">></span>
          updateName
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button
          onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'updateAddress'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token string">'hangzhou'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token operator">></span>
          updateAddress
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>App<span class="token operator">></span>
      <span class="token operator">&lt;</span>Count <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Person <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>App<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="conclusion">conclusion</h1><p><code>context</code> ç”¨æ³•å¾ˆç®€å•ï¼Œå½“æƒ³è¦ä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æ—¶å€™å¯ä»¥å°è¯•ä½¿ç”¨å¤šä¸ª <code>context</code> èƒ½åšåˆ°å‡å°‘æ›´æ–°çš„ä½œç”¨ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>useMemo</code> ç­‰ç›¸å…³çš„ <code>api</code>,
æ¯”è¾ƒåœ¨ä¹ <code>render</code> æ¬¡æ•°çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨ <code>react-redux</code> ä¸€äº›æˆç†Ÿçš„åº“ï¼Œæˆ–è€… <a href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[How to write test]]></title>
            <link>/posts/2019-08-30/how-to-write-test/</link>
            <guid>/posts/2019-08-30/how-to-write-test/</guid>
            <pubDate>Thu, 29 Aug 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>æµ‹è¯•æœ‰å¯èƒ½å¾ˆå¤šäººéƒ½è®¤ä¸ºæ˜¯è¿™æ˜¯æµ‹è¯•äººå‘˜åº”è¯¥åšçš„äº‹æƒ…ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™å¼€å‘ä¹Ÿéœ€è¦æ¥å†™æµ‹è¯•ï¼Œ
å¾ˆä¹…ä»¥å‰å¯èƒ½è¢«å¤§å®¶æ‰€çŸ¥é“çš„å°±æ˜¯ <a href="https://zh.wikipedia.org/wiki/%E9%BB%91%E7%9B%92%E6%B5%8B%E8%AF%95">é»‘ç›’æµ‹è¯•</a>
å’Œ <a href="https://zh.wikipedia.org/wiki/%E7%99%BD%E7%9B%92%E6%B5%8B%E8%AF%95">ç™½ç›’æµ‹è¯•</a>ï¼Œ ä¸€èˆ¬å¼€å‘åœ¨æµ‹è¯•è‡ªå·±çš„ä»£ç çš„æ—¶å€™éƒ½æ˜¯
ç™½ç›’æµ‹è¯•ï¼Œå› ä¸ºç™½ç›’æµ‹è¯•æ˜¯çŸ¥é“å†…éƒ¨ä»£ç çš„é€»è¾‘çš„ã€‚ç›¸å½“äºæ˜¯å®Œå…¨é€æ˜çš„ã€‚</p><h2 id="æµ‹è¯•æ˜¯å¦æœ‰å¿…è¦">æµ‹è¯•æ˜¯å¦æœ‰å¿…è¦</h2><p>å¾ˆå¤šå¼€å‘å¯èƒ½ä¸ä¼šå»ä¸»åŠ¨å†™æµ‹è¯•ï¼Œä¸å†™æµ‹è¯•çš„åŸå› å¯èƒ½ä¼šæœ‰å¾ˆå¤šã€‚ä½†æ˜¯æ— éä»¥ä¸‹å‡ ä¸ª</p><ul><li>ä¸çŸ¥é“æµ‹è¯•æ˜¯ä»€ä¹ˆ</li><li>çŸ¥é“éƒ¨åˆ†æµ‹è¯•ï¼Œä½†æ˜¯ä¸ä¼šå†™</li><li>å¿™äºä¸šåŠ¡ï¼Œæ ¹æœ¬æ²¡æ—¶é—´å»å†™</li><li>ä»£ç å®Œç¾ï¼Œæ¯«æ— ç ´ç»½ï¼Œå®Œå…¨ä¸éœ€è¦å»å†™</li></ul><p>é‚£ä¹ˆæ˜¯å¦éœ€è¦äº›æµ‹è¯•å‘¢ï¼Ÿæµ‹è¯•çš„ä½œç”¨æ˜¯è®©ä½ å¯¹ä½ çš„ä»£ç æœ‰ä¿¡å¿ƒï¼Œå¯ä»¥åŠæ—¶çš„å‘ç°å†…éƒ¨çš„é—®é¢˜ï¼Œç„¶ååŠæ—¶ä¿®å¤ï¼Œé¿å…å‘åˆ°çº¿ä¸Šçš„æ—¶å€™ä¼šå‡ºç°çº¿ä¸Šé—®é¢˜ï¼Œ
é‚£ä¹ˆåº”è¯¥å¦‚ä½•å†™æµ‹è¯•å‘¢ï¼Ÿ</p><h2 id="what-are-you-testing">what are you testing?</h2><p>åœ¨å¼€å§‹å†™ä¸€ä¸ªæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦é—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦æµ‹è¯•ä»€ä¹ˆï¼Ÿé¦–å…ˆå¯¹ç†è§£æƒ³è¦æµ‹è¯•çš„ä»€ä¹ˆï¼Œæ‰å¯ä»¥çœŸæ­£çš„å¼€å§‹å†™æµ‹è¯•ï¼Œæ¯”å¦‚ä¸€ä¸ª <code>sum</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ˜¯ä¸€ä¸ªæ±‚å’Œå‡½æ•°ï¼Œå‡å¦‚æ­¤æ—¶å‡†å¤‡å¼€å§‹å†™æµ‹è¯•äº†ï¼Œæ‰€ä»¥ç¡®è®¤éœ€è¦æµ‹è¯•çš„å°±æ˜¯ <code>sum</code> è¿™ä¸ªå‡½æ•°, çŸ¥é“è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯æ±‚å’Œï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯ <code>ç¡®è®¤éœ€è¦æµ‹è¯•çš„æ˜¯ä»€ä¹ˆ</code></p><h2 id="what-should-it-do">What should it do?</h2><p>æµ‹è¯•çš„è¿™ä¸ªåšäº†ä»€ä¹ˆï¼Œè¿˜æ˜¯ä»¥æ±‚å’Œå‡½æ•°ä¸ºä¾‹ï¼Œæ±‚å’Œå‡½æ•°åšçš„å°±æ˜¯æ±‚å’Œï¼Œå¹¶ä¸”çŸ¥é“è°ƒç”¨æ±‚å’Œå‡½æ•° <code>sum(1,2)</code> åº”è¯¥è¿”å›æ•°å­— <code>3</code>, åªæœ‰çŸ¥é“æµ‹è¯•ä»€ä¹ˆä»¥åŠï¼Œæµ‹è¯•çš„è¿™ä¸ªåšäº†
ä»€ä¹ˆæ‰èƒ½å¾ˆå¤šçš„å†™å‡ºæµ‹è¯•çš„æè¿°ä¿¡æ¯</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'sum(1, 2) should return 3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="what-is-the-output">what is the Output</h2><p>è¾“å…¥æ˜¯ä»€ä¹ˆï¼Œåœ¨å†™ä¸€ä¸ªæµ‹è¯•çš„æ—¶å€™éœ€è¦çŸ¥é“ä¸¤ä¸ªè¾“å…¥ï¼Œç¬¬ä¸€ä¸ªæ˜¯å®é™…çš„è¾“å‡ºï¼Œæ¯”å¦‚ <code>sum(1, 2)</code>, åœ¨è°ƒç”¨ <code>sum(1, 2)</code> çš„æ—¶å€™åº”è¯¥è¿”å› <code>3</code>, è¿™ä¸ªæ•°å­— <code>3</code> å°±æ˜¯å®é™…çš„è¾“å‡ºã€‚
ç¬¬äºŒä¸ªæ˜¯æœŸæœ›çš„è¾“å‡ºï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªæ–­è¨€ï¼Œæ¯”å¦‚ <code>sum(2, 2)</code> å®é™…è¾“å‡ºæ˜¯ <code>4</code>, ä½†æ˜¯æœŸæœ›è¾“å‡º <code>5</code>, é‚£ä¹ˆæ˜¯å¦æ˜¯ä»£ç å†…éƒ¨é€»è¾‘çš„é”™è¯¯å‘¢ï¼Ÿè¿™å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œå°±éœ€è¦å»æŸ¥çœ‹æ˜¯å¦
æ˜¯å†…éƒ¨é€»è¾‘å¯¼è‡´çš„åŸå› ã€‚</p><h2 id="how-to-write-test">How to write test</h2><p>åœ¨å†™æµ‹è¯•å¼€å§‹ä¹‹å‰ï¼Œä¸Šé¢ä¸‰ä¸ªé—®é¢˜æ˜¯é¦–å…ˆè¦è€ƒè™‘çš„ï¼Œè¿˜æ˜¯ä»¥ <code>sum</code> å‡½æ•°ä¸ºä¾‹ï¼Œæƒ³è¦æµ‹è¯• <code>sum</code> å‡½æ•°ï¼Œé¦–å…ˆå°±æ˜¯éœ€è¦æµ‹è¯•æ­£å¸¸çš„æƒ…å†µï¼Œæ¯”å¦‚éƒ½æ˜¯æ•°å­—çš„æ—¶å€™ï¼Œç°åœ¨å¼€å§‹å†™ä¸€ä¸ªåŸºæœ¬çš„æµ‹è¯•</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'è¿™é‡Œæ˜¯æè¿°ä¿¡æ¯ï¼Œå†™çš„æ˜¯æµ‹è¯•äº†ä»€ä¹ˆï¼Œä»¥åŠæœŸæœ›è¿”å›æ˜¯ä»€ä¹ˆ'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªå›è°ƒï¼Œä¸»è¦å†™æµ‹è¯•çš„ä»£ç  æ¯”å¦‚</span>
  <span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¥ä¸‹æ¥å¼€å§‹å†™æ–­è¨€ï¼Œtotal æœŸæœ›çš„å€¼æ˜¯ 2, æ‰€ä»¥å¯ä»¥å†™, è¿™é‡Œä½¿ç”¨çš„éƒ½æ˜¯ jest</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡è¿™æ ·ä¸€ä¸ªåŸºç¡€çš„æµ‹è¯•å°±å¯ä»¥å®Œæˆäº†ã€‚è¿™æ˜¯å¯¹äº<code>å·¥å…·å‡½æ•°</code>çš„åŸºæœ¬æµ‹è¯•ï¼Œé‚£ä¹ˆå¯¹äº <code>react component</code> ä»¥åŠè‡ªå®šä¹‰çš„ <code>react hook</code> åº”è¯¥å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ</p><h2 id="test-react-component">test react component</h2><p>ä¸å¦¨å†™ä¸€ä¸ªåŸºç¡€çš„ <code>Count</code> ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>span<span class="token operator">></span>count<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>increase<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>decrease<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ˜¯ä¸€ä¸ª <code>Count</code> åŸºç¡€ç»„ä»¶, è¿™ä¸ªç»„ä»¶åŒ…å«äº†ä¸¤ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆæ˜¯ <code>increase</code> å¢åŠ  <code>count</code>, è¿˜æœ‰ä¸€ä¸ªæ˜¯ <code>decrease</code> å‡å°‘ <code>count</code>, é‚£ä¹ˆå¯¹äº
è¿™ä¸ªç»„ä»¶éœ€è¦æµ‹è¯•ä»€ä¹ˆå‘¢ï¼Ÿé’ˆå¯¹è¿™ä¸ªç»„ä»¶ï¼Œéœ€è¦æµ‹è¯•çš„å°±æ˜¯ <code>increase</code> å’Œ <code>decrease</code>, é¦–å…ˆè¦ä¿è¯è¿™ä¸¤ä¸ªæŒ‰é’®çš„åŠŸèƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¦åˆ™è¦ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™
å¾ˆå¯èƒ½å°±ä¼šå­˜åœ¨ <code>bug</code> å¯¼è‡´ç™½å±ã€‚</p><p><code>åé¢ä½¿ç”¨çš„æµ‹è¯•åº“éƒ½æ˜¯ @testing/react-library</code></p><p>ç°åœ¨å¼€å§‹å†™è¿™ä¸ªæµ‹è¯•ï¼Œé¦–å…ˆæŒ‰ç…§æ–‡ç« å¼€å¤´è¯´çš„ï¼Œéœ€è¦æµ‹è¯•çš„æ˜¯ä»€ä¹ˆï¼Œéœ€è¦æµ‹è¯•çš„æ˜¯ <code>Count</code> ç»„ä»¶ï¼Œé‚£ä¹ˆéœ€è¦æµ‹è¯• <code>Count</code> ç»„ä»¶çš„ä»€ä¹ˆï¼Ÿéœ€è¦æµ‹è¯•çš„æ˜¯ <code>Count</code>
ç»„ä»¶çš„ <code>increase</code> å’Œ <code>decrease</code> åŠŸèƒ½ã€‚ç°åœ¨çŸ¥é“æµ‹è¯•çš„æ˜¯ä»€ä¹ˆäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¿™ä¸ªç»„ä»¶çš„è¡Œä¸ºæ˜¯ä»€ä¹ˆï¼Ÿç‚¹å‡» <code>increase</code> æœŸæœ› <code>count</code> æ˜¯å¢åŠ äº† <code>1</code>,
ç‚¹å‡» <code>decrease</code>, æœŸæœ› <code>count</code> æ˜¯å‡å°‘äº† <code>1</code>ã€‚é‚£ä¹ˆç°åœ¨æ‰€æœ‰æƒ…å†µéƒ½çŸ¥é“äº†ï¼Œä¸å¦¨å¼€å§‹å†™è¿™ä¸ªæµ‹è¯•ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> fireEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing/react-library'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'expect count increase 1 by trigger increase'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// render æ–¹æ³•æ˜¯ @testing/react-library å†…ç½®çš„æ–¹æ³•</span>
  <span class="token comment">// getByText æ˜¯é€šè¿‡æ–‡æœ¬æ¥æŸ¥æ‰¾å¯¹åº”çš„ dom èŠ‚ç‚¹</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Count <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰¾åˆ° increase çš„ dom èŠ‚ç‚¹, getByText æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼</span>
  <span class="token keyword">const</span> increaseNode <span class="token operator">=</span> <span class="token function">getByText</span><span class="token punctuation">(</span><span class="token regex">/increase/i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è§¦å‘ç‚¹å‡»æ•ˆæœ</span>
  fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>increaseNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿™ä¸ªçš„æ–­è¨€æ˜¯å¾ˆé‡è¦çš„, åœ¨ Count ç»„ä»¶ä¸­æœ‰ä¸ª &lt;span>count: {count}&lt;/span></span>
  <span class="token comment">// æ‰€ä»¥ç‚¹å‡»æŒ‰é’®åï¼Œè¿™é‡Œçš„ `count` å˜ä¸ºäº† 2, åªéœ€è¦æŸ¥æ‰¾è¿™ä¸ª 2 æ˜¯å¦å­˜åœ¨</span>
  <span class="token comment">// toBeNull éƒ½æ˜¯ jest ä¸­çš„æ–¹æ³•</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token regex">/count: 2/i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>increase</code> çš„æµ‹è¯•æ˜¯å®Œå…¨é€šè¿‡çš„ï¼Œé‚£ä¹ˆ <code>decrease</code> ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> fireEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing/react-library'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'expect count decrease 1 by trigger decrease'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// render æ–¹æ³•æ˜¯ @testing/react-library å†…ç½®çš„æ–¹æ³•</span>
  <span class="token comment">// getByText æ˜¯é€šè¿‡æ–‡æœ¬æ¥æŸ¥æ‰¾å¯¹åº”çš„ dom èŠ‚ç‚¹</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Count <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰¾åˆ° increase çš„ dom èŠ‚ç‚¹, getByText æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼</span>
  <span class="token keyword">const</span> decreaseNode <span class="token operator">=</span> <span class="token function">getByText</span><span class="token punctuation">(</span><span class="token regex">/decrease/i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è§¦å‘ç‚¹å‡»æ•ˆæœ</span>
  fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>decreaseNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿™ä¸ªçš„æ–­è¨€æ˜¯å¾ˆé‡è¦çš„, åœ¨ Count ç»„ä»¶ä¸­æœ‰ä¸ª &lt;span>count: {count}&lt;/span></span>
  <span class="token comment">// æ‰€ä»¥ç‚¹å‡»æŒ‰é’®åï¼Œè¿™é‡Œçš„ `count` å˜ä¸ºäº† -1, åªéœ€è¦æŸ¥æ‰¾è¿™ä¸ª -1 æ˜¯å¦å­˜åœ¨</span>
  <span class="token comment">// toBeNull éƒ½æ˜¯ jest ä¸­çš„æ–¹æ³•</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token regex">/count: -1/i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™å°±æ˜¯ä¸€ä¸ªåŸºç¡€çš„ç»„ä»¶çš„æµ‹è¯•ã€‚é‚£ä¹ˆå¦‚æœæ˜¯è‡ªå®šä¹‰çš„ <code>Hook</code> å‘¢?</p><h2 id="test-custom-hook">test custom hook</h2><p>è‡ªå®šä¹‰çš„ <code>Hook</code> é€šå¸¸è¿”å›çš„å¹¶ä¸æ˜¯ <code>ReactNode</code>, è€Œæ˜¯ä¸€äº›å€¼æˆ–è€…è¯´æ˜¯å‡½æ•°ä¹‹ç±»çš„ã€‚é‚£ä¹ˆä¸å¦¨å°†ä¸Šé¢çš„ <code>Count</code> ç»„ä»¶ä¿®æ”¹æˆä¸€ä¸ª
è‡ªå®šä¹‰çš„ <code>Count</code> hookã€‚</p><p>é¦–å…ˆç¡®è®¤è¿™ä¸ªè‡ªå®šä¹‰çš„ <code>Hook</code>, æœ‰ <code>increase</code> å’Œ <code>decrease</code> åŠŸèƒ½ï¼Œä»¥åŠåº”è¯¥è¿”å› <code>count</code> å˜é‡ã€‚é‚£ä¹ˆå¼€å§‹å†™è¿™ä¸ªè‡ªå®šä¹‰çš„ <code>Hook</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">increase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">decrease</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> <span class="token punctuation">{</span> increase<span class="token punctuation">,</span> decrease <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é’ˆå¯¹è¿™ä¸ªåº”è¯¥å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿè¿™ä¸ªå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä½†æ˜¯åˆä¸èƒ½å½“åšæ™®é€šå‡½æ•°æ¥æµ‹è¯•ã€‚è¿™é‡Œä¹Ÿ<a href="https://github.com/testing-library/react-hooks-testing-library/issues">ä½¿ç”¨ä¸€ä¸ªåº“</a>ï¼Œè¿™ä¸ªåº“æœ¬èº«å¾ˆç®€å•ï¼Œå°±æ˜¯å°è£…äº† <code>react</code> æä¾›çš„æµ‹è¯•å·¥å…·ã€‚</p><p>å¼€å§‹è¿™ä¸ªæµ‹è¯•</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> renderHook<span class="token punctuation">,</span> act <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-hooks-testing-library'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'use count'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">useCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‹¿åˆ°è¿”å›çš„ç»“æœ, result åŒ…å«ä¸€ä¸ª current, å…¶ä¸­ current æŒ‡å‘è¿”å›å€¼</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>current<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è°ƒç”¨ increase</span>
  <span class="token function">act</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>current<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è°ƒç”¨ decrease, å› ä¸ºä¹‹å‰å·²ç»å˜ä¸º 1 äº†</span>
  <span class="token function">act</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">decrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>current<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="conclusion">conclusion</h2><p>åœ¨å†™ä¸€ä¸ªæµ‹è¯•çš„æ—¶å€™é¦–å…ˆéœ€è¦æ˜ç¡®æµ‹è¯•çš„æ˜¯ä»€ä¹ˆï¼ŸçŸ¥é“æµ‹è¯•çš„æ˜¯ä»€ä¹ˆåï¼Œéœ€è¦çŸ¥é“æµ‹è¯•çš„è¿™ä¸ªåšäº†ä»€ä¹ˆï¼Ÿç„¶åè¾“å‡ºæ˜¯ä»€ä¹ˆï¼ŸæœŸæœ›è¾“å…¥æ˜¯ä»€ä¹ˆï¼Ÿå½“çŸ¥é“äº†è¿™äº›ä¹‹å
å†å»å†™æµ‹è¯•ï¼Œå°±ä¼šå¾ˆç®€å•ã€‚</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[The Rules of React]]></title>
            <link>/posts/2019-09-06/the-rule-of-react/</link>
            <guid>/posts/2019-09-06/the-rule-of-react/</guid>
            <pubDate>Thu, 05 Sep 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>æ‰€æœ‰çš„åº“éƒ½ä¼šæœ‰ä¸€äº›å¾®å¦™çš„è§„åˆ™ï¼Œæ‚¨å¿…é¡»éµå¾ªè¿™äº›è§„åˆ™æ‰èƒ½å¾ˆå¥½çš„å·¥ä½œã€‚é€šå¸¸ï¼Œæœ‰äº›è§„åˆ™æ˜¯éšå¼çš„ï¼Œæ²¡æœ‰æ–‡æ¡£çš„ï¼Œæ‚¨å¿…é¡»è¾¹èµ°è¾¹å­¦ä¹ ã€‚</p><p>æ¯”å¦‚åœ¨ä½¿ç”¨ React Hook çš„æ—¶å€™ï¼Œå¿…é¡»è¦éµå®ˆ <code>Hook</code> çš„è§„åˆ™ï¼Œåœ¨ä½¿ç”¨ Vue çš„æ—¶å€™å¿…é¡»è¦éµå®ˆ Vue çš„ä½¿ç”¨è§„åˆ™ã€‚ è¿™é‡Œä¸»è¦è°ˆä¸€ä¸‹ <code>React</code> çš„ä¸€äº›éšå¼è§„åˆ™</p><h2 id="what-functions-are-pure">What Functions Are â€œPureâ€?</h2><p><a href="https://en.wikipedia.org/wiki/Pure_function">Pure function</a> åœ¨ç»´åŸºç™¾ç§‘ä¸­ä¸»è¦æœ‰ä¸¤ç‚¹çš„è§£é‡Š</p><ul><li>Its return value is the same for the same arguments (no variation with local static variables, non-local variables, mutable reference arguments or input streams from I/O devices).
<code>ç›¸åŒçš„è¾“å…¥æ€»æ˜¯æœ‰ç›¸åŒçš„è¾“å‡º</code></li><li>Its evaluation has no side effects (no mutation of local static variables, non-local variables, mutable reference arguments or I/O streams).
<code>æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ IO çš„å†™æ“ä½œ</code></li></ul><p>é‚£ä¹ˆåœ¨ <code>React</code> ä¸­æœ‰å“ªäº›æ–¹æ³•è¢«è®¤è¯†æ˜¯ â€œpureâ€ çš„</p><p>åœ¨ <code>class</code> ä¸­é€šå¸¸ <code>constructor</code>, <code>getDerivedStateFromProps</code>, <code>shouldComponentUpdate</code> and <code>render</code> è¢«è®¤ä¸ºæ˜¯çº¯çš„.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pure</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pure</span>
  <span class="token punctuation">}</span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pure</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pure</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>componentDidMount</code>, <code>componentDidUpdate</code>, <code>componentWillUnmount</code> å’Œè‡ªå®šä¹‰çš„äº‹ä»¶å‡½æ•°å¹¶ä¸è¢«è¦æ±‚æ˜¯çº¯çš„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// not pure</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// not pure</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// not pure</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// not pure</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pure</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>setState</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚å¿…é¡»æ˜¯çº¯çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// pure</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä½†æ˜¯ç¬¬äºŒä¸ªå‚æ•°å¹¶ä¸è¦æ±‚æ˜¯çº¯çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// not pure</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å‡½æ•°å¼ç»„ä»¶ä¹Ÿæ˜¯çº¯çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// pure</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="getter-in-state">Getter in State</h3><p><code>setState</code> è¿˜æœ‰ä¸€ä¸ªç‰¹å®šçš„é™åˆ¶ã€‚ä¼ é€’ç»™ <code>setState</code> æˆ–è€…ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‡½æ•°æ—¶è¿”å›çš„å¯¹è±¡ä¸èƒ½åŒ…å«è¿åä¸Šè¿°ä»»ä½•è§„åˆ™çš„ <code>getter</code> æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬ä¹Ÿæ˜¯çº¯å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚</p><h2 id="what-does-pure-mean-in-react">What Does â€œPureâ€ Mean in React?</h2><p>åœ¨ <code>React</code> ä¸­ï¼Œçº¯å‡½æ•°é€šå¸¸æ„å‘³ç€æ˜¯<a href="https://zh.wikipedia.org/wiki/%E5%86%AA%E7%AD%89">å¹‚ç­‰</a>çš„</p><h3 id="forbidden">Forbidden</h3><hr/><p>é€šå¸¸æ¥è¯´è¿™æ„å‘³ç€åœ¨è¿™äº›å‡½æ•°ä¸­ï¼Œä½ ä¸èƒ½ï¼š</p><ul><li>ä¿®æ”¹å˜é‡çš„ç»‘å®šï¼Œé™¤éè¯¥ç»‘å®šæ˜¯<code>æ–°åˆ›å»ºçš„</code>, å› ä¸ºå¦‚æœæ˜¯æ–°åˆ›å»ºçš„é‚£ä¹ˆæ¯æ¬¡åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™éƒ½ä¼šæ–°åˆ›å»ºè¿™ä¸ªç»‘å®šï¼Œé‚£ä¹ˆå³ä½¿å†…éƒ¨ä¿®æ”¹ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„</li><li>ä¿®æ”¹å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œé™¤éè¯¥å¯¹è±¡æ˜¯<code>æ–°åˆ›å»ºçš„</code></li></ul><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// pure</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  b<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ <code>a</code> ä¸­ï¼Œ <code>b</code> æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹å¯¹è±¡ä¸Šçš„å±æ€§ã€‚å› ä¸ºæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šé‡å¤è¿™ä¸ªæ“ä½œ</p><ul><li>ä¿®æ”¹ <code>this</code> ä¸Šçš„å±æ€§ï¼Œé™¤éæ˜¯åœ¨æ„é€ å‡½æ•°ä¸­</li></ul><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è™½ç„¶æ¯æ¬¡ <code>b</code> éƒ½è¢«èµ‹å€¼ä¸º 1ï¼Œä½†æ˜¯åœ¨å…¶ä»–å‡½æ•°ä¸­ç”¨åˆ°äº†è¿™ä¸ª <code>b</code> çš„æ—¶å€™å°±è¢«ä¿®æ”¹äº†</p><ul><li>ä»å¯¹è±¡ä¸­è¯»å–å±æ€§ï¼Œé™¤éè¯¥å¯¹è±¡æ˜¯<code>æ–°åˆ›å»ºçš„</code>ï¼Œ æˆ–è€…å±æ€§åœ¨è¯»å–ä¸€æ¬¡åä¸ä¼šæ›´æ”¹</li></ul><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// not pure</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
  <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// pure</span>
  v<span class="token punctuation">.</span>a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ <code>a</code> ä¸­è¯»å–äº† this ä¸Šçš„ a, ä½†æ˜¯è¿™ä¸ª a å¦‚æœåœ¨å…¶ä»–åœ°æ–¹è¢«æ”¹å˜äº†å°±æ˜¯ä¸è¡Œçš„ã€‚</p><ul><li>è¯»å–å˜é‡ç»‘å®šï¼Œé™¤éè¯¥å¯¹è±¡æ˜¯<code>æ–°åˆ›å»ºçš„</code>, æˆ–è€…ç»‘å®šåœ¨è¯»å–ä¸€æ¬¡ä¹‹åä¸å†æ›´æ”¹ã€‚</li><li>è°ƒç”¨ <code>Math.random()</code> æˆ–è€… <code>Date.now()</code>, å› ä¸ºè¿™æ ·è¯»å–çš„å€¼æ˜¯å¯å˜çš„ã€‚</li><li>è°ƒç”¨ <code>setState</code>, å› ä¸ºå®ƒä¼šçªå˜</li><li>å‘èµ·ç½‘ç»œè¯·æ±‚(POST)ã€æ–‡ä»¶ç³»ç»Ÿæˆ–å…¶ä»– I/O, å°†å…¶å†™å…¥æŒä¹…æ€§å­˜å‚¨ã€‚æ¯”å¦‚ï¼Œæ—¥å¿—ã€åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ç»„ä»¶ç±»å‹ã€‚æ–°çš„ç»„ä»¶ä¼šè¢«ä½¿ç”¨åé¢çš„ <code>JSX</code> ä¸­ã€‚</li></ul><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">C</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ ·æ¯æ¬¡ <code>render</code> éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>C</code></p><ul><li>è°ƒç”¨å¦ä¸€ä¸ªå¯èƒ½æ‰§è¡Œä»¥ä¸Šä»»ä½•æ“ä½œçš„å‡½æ•°ã€‚</li></ul><p><code>æ–°åˆ›å»ºçš„</code>æ„å‘³ç€æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œéƒ½ä¼šé‡å¤è¿™ä¸€æ­¥éª¤ã€‚</p><h3 id="allowed">Allowed</h3><p>è™½ç„¶æœ‰ä¸€äº›å¯èƒ½ä¸è®¤ä¸ºæ˜¯çº¯çš„ï¼Œä½†æ˜¯åœ¨ <code>React</code> ä¸­é‚£æ˜¯ ok çš„</p><ul><li>è¯»å– <code>this.props</code> æˆ–è€… <code>this.state</code> åœ¨ç±»ç»„ä»¶ä¸­çš„æ˜¯å®Œå…¨å¯ä»¥çš„ï¼Œè™½ç„¶å®ƒä»¬ä¼šæ”¹å˜</li><li>æŠ›å‡ºé”™è¯¯æˆ–è€…ä»»ä½•å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯å¯ä»¥çš„</li><li>åªè¦å¯¹è±¡æ˜¯<code>æ–°åˆ›å»ºçš„</code>, å°±å¯ä»¥ä¿®æ”¹å¯¹è±¡</li><li>åªè¦ç»‘å®šæ˜¯<code>æ–°åˆ›å»ºçš„</code>, å°±å¯ä»¥ä¿®æ”¹ç»‘å®š</li><li>ä½ å¯ä»¥è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥ä¿®æ”¹ä¼ å…¥çš„å¯¹è±¡ï¼Œåªè¦è¯¥å¯¹è±¡æ˜¯<code>æ–°åˆ›å»ºçš„</code></li><li>åœ¨æ„é€ å‡½æ•°ä¸­ä¿®æ”¹å±æ€§æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åœ¨ç±»æ„é€ å‡½æ•°ä¸­<code>æ–°åˆ›å»ºçš„</code></li><li>åˆ›å»ºéçº¯å‡½æ•°æ˜¯å¯ä»¥çš„ï¼Œåªè¦å®ƒä»¬åé¢åœ¨çº¯å‡½æ•°ä¹‹å¤–è°ƒç”¨</li><li>å‘å‡ºç½‘ç»œè¯·æ±‚(GET), ä»æ–‡ä»¶ç³»ç»Ÿæˆ–å…¶ä»– I/O ä¸­è¯»å–æ•°æ®æ˜¯å¯ä»¥çš„</li></ul><h3 id="lazy-initialization">Lazy Initialization</h3><p>åœ¨è¿™äº›è§„åˆ™ä¸­æœ‰ä¸€ä¸ªä¾‹å¤–å°±æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå€¼ç”¨äºå»¶è¿Ÿåˆå§‹åŒ–ï¼Œåˆ™å¯ä»¥è¯»å–å’Œä¿®æ”¹å®ƒã€‚æ„æ€å°±æ˜¯ï¼Œå¦‚æœå€¼æ²¡æœ‰è¢«åˆå§‹åŒ–åˆ™åˆå§‹åŒ–ï¼Œå¦‚æœåˆå§‹åŒ–äº†åˆ™è¿›è¡Œç¼“å­˜å¹¶ç›´æ¥è¯»å–å€¼ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">var</span> lazy<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">lazy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// ok</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> lazy<span class="token punctuation">;</span> <span class="token comment">// ok</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¹Ÿå¯ä»¥ç”¨äºå¤šä¸ªå€¼ï¼Œåªè¦ key æ˜¯å”¯ä¸€å°±å¥½</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="mutating-objects-created-by-render">Mutating Objects Created by Render</h2><p>å¦å¤–ä¸€ä¸ªé™åˆ¶æ˜¯ï¼Œåœ¨æ¸²æŸ“å®Œæˆåï¼Œæ‚¨ä¸èƒ½ä¿®æ”¹åœ¨è¿™äº›å‡½æ•°ä¸­åˆ›å»ºçš„å¯¹è±¡æˆ–é—­åŒ…ç»‘å®šã€‚å®ƒä»¬æ˜¯éšå¼å†»ç»“çš„ã€‚ä¾‹å¤–æƒ…å†µæ˜¯å­˜å‚¨åœ¨çŠ¶æ€å¯¹è±¡ä¸­çš„å¯å˜å¯¹è±¡ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token punctuation">{</span> active<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// not ok</span>
    y<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// not ok</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> mutableBox<span class="token punctuation">:</span> <span class="token punctuation">{</span> active<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>mutableBox<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// ok, but discouraged</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>mutableBox<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// ok, but discouraged</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[A little About React]]></title>
            <link>/posts/2019-09-19/a-little-react/</link>
            <guid>/posts/2019-09-19/a-little-react/</guid>
            <pubDate>Wed, 18 Sep 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>æœ¬æ¥æ˜¯ä¸æ‰“ç®—å†™è¿™ç¯‡æ–‡ç« çš„ï¼Œä½†æ˜¯æœ€è¿‘æ­£å¥½é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ–è€…è¯´æ˜¯ç»„å†…é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå°±é¡ºä¾¿å†™è¿™ç¯‡æ–‡ç« </p><h2 id="ç›®å½•">ç›®å½•</h2><ul><li>React Virtual Dom Terminology</li><li>useLayoutEffect and useEffect</li></ul><h2 id="react-virtual-dom-terminology">React Virtual Dom Terminology</h2><p>åœ¨ React ä¸­æœ‰å‡ ä¸ªç±»å‹éœ€è¦åŒºåˆ†æ¸…æ¥šï¼Œåœ¨åŒ <code>TS</code> å†™çš„æ—¶å€™ä¹Ÿä¼šç»å¸¸é‡åˆ°è¿™å‡ ç§ç±»å‹</p><ul><li>ReactElement / ReactElement Factory</li><li>ReactNode</li><li>ReactComponent / ReactComponent Class</li></ul><h3 id="react-elements">React Elements</h3><p>åœ¨ React ä¸­åŸå§‹ç±»å‹å°±æ˜¯ ReactElementï¼ŒReactElement æœ‰å››ä¸ªå±æ€§åˆ†åˆ«ä¸º <code>type</code>, <code>props</code>, <code>key</code>, <code>ref</code>. åç»­ key æœ‰å¯èƒ½ä¼šä» props ä¸­
è¿›è¡Œå‰¥ç¦». å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨æ–¹æ³•å’Œå…¶ä»–çš„ä»»ä½•ä¸œè¥¿åœ¨ <code>prototype</code> ä¸Š.</p><p>åœ¨ React ä¸­å¯ä»¥é€šè¿‡è°ƒç”¨ React.createElement æ¥åˆ›å»º</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> root <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä¸ºäº†æ¸²æŸ“åˆ° DOM ä¸­ï¼Œéœ€è¦æŠŠåˆ›å»ºçš„ <code>ReactElement</code> ä¼ é€’ç»™ <code>React.render</code> å¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ­£å¸¸çš„ DOM å…ƒç´ æ¯”å¦‚ <code>HTMLElement</code>, <code>ReactElement</code> æ˜¯ä¸€ä¸ª
æ— çŠ¶æ€çš„ï¼Œä¸å¯çªå˜çš„ï¼Œè™šæ‹Ÿçš„ dom elementã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœéœ€è¦ä¼ é€’é¢å¤–çš„å±æ€§ï¼Œåœ¨ React.createElement çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æä¸ªå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª child</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> child <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'my-root'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœä½¿ç”¨ <code>JSX</code>, é‚£ä¹ˆè¿™æ ·å†™ä¹Ÿæ˜¯ä¸€æ ·çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'my-root'</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>text<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="factory">Factory</h4><p>ä¸€ä¸ª <code>ReactElement</code> çš„å·¥å‚æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æ¥åˆ›å»º <code>ReactElement</code> å¸¦ç€ç‰¹å®šçš„ <code>type</code>ã€‚React æœ¬èº«å†…éƒ¨æ˜¯æœ‰è¿™æ ·çš„ä¸€ä¸ªå‡½æ•°çš„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ ·å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç±»å‹çš„å‡½æ•°ï¼Œç„¶ååœ¨æ­¤è°ƒç”¨å‡½æ•°ï¼Œä¸éœ€è¦åœ¨ä¼ é€’é¢å¤–çš„ç±»å‹ã€‚æ¯”å¦‚ä¸åœ¨éœ€è¦æ¯æ¬¡éƒ½ä¼ å…¥ç±»å‹ <code>React.createElement(&#x27;type&#x27;)</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> div <span class="token operator">=</span> <span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'my-root'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœä½¿ç”¨çš„æ˜¯ <code>JSX</code> çš„è¯ï¼Œé‚£ä¹ˆæ ¹æœ¬ä¸éœ€è¦è¿™ä¹ˆåšï¼Œ React å†…éƒ¨å·²ç»å¤„ç†å¥½äº†ã€‚</p><h3 id="react-nodes">React Nodes</h3><p><code>React Node</code> å¯èƒ½æ˜¯å…¶ä¸­çš„ä¸€ç§ï¼š</p><ul><li>React Element</li><li>string</li><li>number</li><li>ReactFrament</li></ul><p>å¯ä»¥ç›´æ¥çœ‹ ReactNode çš„å®šä¹‰</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">type ReactNode <span class="token operator">=</span>
  <span class="token operator">|</span> ReactChild
  <span class="token operator">|</span> ReactFragment
  <span class="token operator">|</span> ReactPortal
  <span class="token operator">|</span> boolean
  <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
</code></pre><p>ç›¸å…³ç±»å‹çš„å®šä¹‰</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">type ReactText <span class="token operator">=</span> string <span class="token operator">|</span> number<span class="token punctuation">;</span>
type ReactChild <span class="token operator">=</span> ReactElement <span class="token operator">|</span> ReactText<span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ReactNodeArray</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>ReactNode<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
type ReactFragment <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">|</span> ReactNodeArray<span class="token punctuation">;</span>
</code></pre><p><code>React Element</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">ReactElement</span><span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">=</span> any<span class="token punctuation">,</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">string</span> <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> string <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span>any<span class="token operator">>></span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
      props<span class="token punctuation">:</span> <span class="token constant">P</span><span class="token punctuation">;</span>
      key<span class="token punctuation">:</span> Key <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><h3 id="react-components">React Components</h3><p>ä¸€ä¸ª <code>React Components</code> Class å°±æ˜¯ä¸€ä¸ªç®€å•çš„ js class</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å½“è¿™ä¸ªæ„é€ å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°†è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ä¸€å®šè¦æœ‰ä¸€ä¸ª <code>render</code> å‡½æ•°åœ¨å†…éƒ¨ã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯ <code>ReactComponent</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyComponent</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// never do this</span>
</code></pre><p>é™¤éæ˜¯ä¸ºäº†æµ‹è¯•ï¼Œå¦åˆ™åƒä¸‡ä¸è¦è¿™ä¹ˆå†™ã€‚React ä¼šåœ¨å†…éƒ¨è°ƒç”¨çš„ã€‚Dan ä¹Ÿåœ¨<a href="https://overreacted.io/how-does-react-tell-a-class-from-a-function/">ä¹‹å‰çš„æ–‡ç« </a>ä¸­è¯´è¿‡åŸå› </p><p>ä¹Ÿå¯ä»¥æŠŠ <code>ReactComponent</code> class ä¼ é€’ç»™ React.createElement å¾—åˆ°ä¸€ä¸ª ReactElement</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>JSX</code> çš„æ–¹å¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
</code></pre><p>å½“è¿™ä¸ªè¢«ä¼ é€’ç»™ <code>React.render</code> æ—¶ï¼ŒReact å°†è°ƒç”¨æ„é€ å‡½æ•°å¹¶ä¸”è¿”å›ä¸€ä¸ª <code>ReactComponent</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> component <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœç»§ç»­è°ƒç”¨ <code>React.render</code> å¸¦ç€ç›¸åŒçš„ <code>ReactElement</code> å’Œç›¸åŒçš„ dom, é‚£ä¹ˆæ€»æ˜¯è¿”å›ç›¸åŒçš„å®ä¾‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> componentA <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> componentB <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
componentA <span class="token operator">===</span> componentB<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><h2 id="uselayouteffect--useeffect">useLayoutEffect &amp; useEffect</h2><p>åœ¨<a href="https://reactjs.org/docs/hooks-intro.html">å®˜æ–¹æ–‡æ¡£</a> ä¸­å·²ç»è¯¦ç»†çš„ä»‹ç»äº†å„ä¸ª hook çš„åŒºåˆ«ã€‚</p><p>å®˜æ–¹ä»‹ç»æ˜¯è¿™æ ·è¯´çš„ï¼š</p><p>The signature is identical to useEffect, but it fires synchronously after all DOM mutations.
Use this to read layout from the DOM and synchronously re-render.
Updates scheduled inside useLayoutEffect will be flushed synchronously, <code>before the browser has a chance to paint</code>.</p><p>Tip</p><p>If youâ€™re migrating code from a class component, note useLayoutEffect fires in the same phase as componentDidMount and componentDidUpdate.
However, we recommend starting with useEffect first and only trying useLayoutEffect if that causes a problem.</p><p>If you use server rendering, keep in mind that neither useLayoutEffect nor useEffect can run until the JavaScript is downloaded.
This is why React warns when a server-rendered component contains useLayoutEffect.
To fix this, either move that logic to useEffect (if it isnâ€™t necessary for the first render),
or delay showing that component until after the client renders (if the HTML looks broken until useLayoutEffect runs).</p><p>To exclude a component that needs layout effects from the server-rendered HTML,
render it conditionally with <code>showChild &amp;&amp; &lt;Child /&gt;</code> and defer showing it with useEffect(() =&gt; { setShowChild(true); }, []).
This way, the UI doesnâ€™t appear broken before hydration.</p><p>è¿™æ˜¯åœ¨ <code>useLayoutEffect</code> ä¸­ä»‹ç»çš„ã€‚</p><p><a href="https://reactjs.org/docs/hooks-reference.html#useeffect">useEffect</a> çš„ä»‹ç»å‚è€ƒå®˜ç½‘ã€‚</p><p>å…¶ä¸­åœ¨ <code>useLayoutEffect</code> ä¸­çš„ä»‹ç»æœ‰å‡ ç‚¹éœ€è¦å…³æ³¨çš„ã€‚é¦–å…ˆ <code>it fires synchronously after all DOM mutations</code>, åŒæ­¥è§¦å‘ã€‚
ç¬¬äºŒ <code>Updates scheduled inside useLayoutEffect will be flushed synchronously, before the browser has a chance to paint</code>
åœ¨æµè§ˆå™¨æœ‰æœºä¼šç»˜ç”»ä¹‹å‰ã€‚</p><p>é‚£è¿™ä¸ªåˆ°åº•é€‚åˆäºä»€ä¹ˆæ ·çš„åœºæ™¯å‘¢ï¼Ÿä¸å¦‚å…ˆä»ä¸€ä¸ªä¾‹å­æ¥åˆ†æ, å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªæœç´¢å†å²çš„çš„éœ€æ±‚ï¼Œæœç´¢è¿‡çš„å†…å®¹éœ€è¦å¢åŠ åˆ°æœç´¢å†å²ä¸­ã€‚å¹¶ä¸”æœç´¢å†å²ä¸èƒ½è¶…è¿‡
ä¸€è¡Œï¼Œè¶…è¿‡äº†ä¸€è¡Œåˆ™è¿›è¡Œæˆªå–ï¼ŒæŠŠè¶…è¿‡çš„é‚£éƒ¨åˆ†å»æ‰ã€‚</p><div><img src="./static/media/his.a2578714.jpg"/></div><p>æ­¤æ—¶æˆ‘ä»¬åº”è¯¥å¦‚ä½•å»åšã€‚åŸºæœ¬åšæ³•åº”è¯¥æ˜¯ç‚¹å‡»æœç´¢ï¼Œåœ¨ <code>useEffect</code> é‡Œè¿›è¡Œè®¡ç®—å·²æ¸²æŸ“çš„å†å²çš„èŠ‚ç‚¹çš„å®½åº¦ï¼Œç„¶åéå†å†å²çš„ dom èŠ‚ç‚¹è¿›è¡Œå®½åº¦ç›¸åŠ ï¼Œæœ€åæ¥åˆ¤æ–­
æ˜¯å¦è¶…è¿‡äº†æœ€å¤§å®½åº¦ï¼Œå¦‚æœè¶…è¿‡äº†æœ€å¤§å®½åº¦ï¼Œé‚£ä¹ˆè¿›è¡Œæˆªå–ï¼Œå¦åˆ™ä¸è¿›è¡Œæˆªå–ã€‚ï¼ˆå½“ç„¶å¦‚æœè¦æ˜¯èƒ½æå‰çŸ¥é“ <code>input</code> è¾“å…¥çš„å†…å®¹åŒºçš„å®½åº¦ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨äº‹ä»¶å‡½æ•°ä¸­è¿›è¡Œæå‰åˆ¤æ–­å¤„ç†)ã€‚
ç›®å‰å¤„ç†æ˜¯åœ¨ <code>useEffect</code> ä¸­è¿›è¡Œéå†æ¥è®¡ç®—å®½åº¦çš„ã€‚è¿™ä¸ªçœ‹èµ·æ¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¯¹å§ã€‚ä¸å¦¨çœ‹ä¸€ä¸‹æ•ˆæœ</p><div><img src="./static/media/useEffect.578d1fbd.gif"/></div><p>å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªé—ªåŠ¨çš„è¿‡ç¨‹ï¼Œå› ä¸ºåœ¨ useEffect ä¸­è¿›è¡Œäº†æˆªå–ï¼Œæ­¤æ—¶è¿™ä¸ª dom å·²ç»è¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šäº†ã€‚åœ¨è¿›è¡Œæˆªå–ï¼Œå°±ä¼šçœ‹åˆ°<code>é—ªåŠ¨</code>çš„ç°è±¡ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nextHistory <span class="token operator">=</span> <span class="token function">getNextHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">saveHistory</span><span class="token punctuation">(</span>nextHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getNextHistory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cloneHistory <span class="token operator">=</span> history<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> totalWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> historyRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> node <span class="token operator">=</span> historyRefs<span class="token punctuation">.</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> width <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      totalWidth <span class="token operator">+=</span> width <span class="token operator">+</span> offset<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>totalWidth <span class="token operator">></span> <span class="token constant">MAX_HISTORY_LENGTH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cloneHistory <span class="token operator">=</span> cloneHistory<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cloneHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£å¦‚æœæ¢æˆ <code>useLayoutEffect</code> å‘¢ï¼Ÿ</p><div><img src="./static/media/useLayoutEffect.3545cf97.gif"/></div><p>å¯ä»¥çœ‹å‡ºåœ¨ä½¿ç”¨ <code>useLayoutEffect</code> çš„æ—¶å€™ä¹‹å‰çš„é—ªåŠ¨ä¸å­˜åœ¨äº†ã€‚å›å¤´çœ‹ä¸€ä¸‹ä¹‹å‰æ ‡è®°çš„åœ°æ–¹ã€‚å…¶ä¸­æœ‰ä¸€å¤„åƒè¿™æ ·çš„</p><p><code>Updates scheduled inside useLayoutEffect will be flushed synchronously, before the browser has a chance to paint</code></p><p>æ‰€ä»¥é’ˆå¯¹å‡ºç°éœ€è¦é¢‘ç¹ä¿®æ”¹ dom æˆ–è€…éœ€è¦åœ¨ dom æ¸²æŸ“ååˆè¦ç«‹é©¬æ“ä½œ dom çš„ä»¥åŠè¿›è¡Œä¸€äº›å¸ƒå±€æ“ä½œçš„éƒ½å¯ä»¥ä½¿ç”¨ <code>useLayoutEffect</code>ã€‚æ¯”å¦‚ <code>Popover</code>,
<code>ToolTip</code>, <code>DronDown</code> ç­‰ç›¸å…³ç»„ä»¶ã€‚</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[the dep of useHook]]></title>
            <link>/posts/2019-10-02/the-dep-of-use-hook/</link>
            <guid>/posts/2019-10-02/the-dep-of-use-hook/</guid>
            <pubDate>Tue, 01 Oct 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>æ˜¨å¤©æ˜¯ <code>10æœˆ1æ—¥</code> å›½åº†èŠ‚ï¼Œé¦–å…ˆç¥è´ºä¼Ÿå¤§çš„ç¥–å›½ 70 å¹´ç”Ÿæ—¥å¿«ä¹ï¼ï¼ï¼ï¼</p><p>ä»Šå¤©æ˜¯å›½åº†èŠ‚çš„ç¬¬äºŒå¤©ï¼Œåœ¨è¿™é‡Œå…ˆç¥ç¦å¤§å®¶å›½åº†èŠ‚å¿«ä¹ï¼Œåƒå¥½å–å¥½ï¼ï¼ï¼</p><p>ä»Šå¤©é—²æ¥æ— äº‹ï¼Œä¸ç”±è‡ªç”±çš„å°±å¼€äº†ç”µè„‘ï¼Œè¿™å¯èƒ½æ˜¯åšæŠ€æœ¯çš„äººçš„é€šç—…ï¼Ÿæ„Ÿè§‰æœ‰çš„æ—¶å€™ä¸è‡ªè§‰å°±ä¼šæ‰“å¼€ç”µè„‘ï¼Œçœ‹äº›æŠ€æœ¯
æ–‡ç« å‘€ä»€ä¹ˆçš„ã€‚æ­£å¥½åœ¨çœ‹æ–‡ç« çš„æ—¶å€™ï¼Œæƒ³èµ·æ¥ä¹‹å‰åœ¨å·¥ä½œä¸­äº¦æ˜¯æ˜¯åœ¨å­¦ä¹ ä¸­é‡åˆ°ä¸€äº›é—®é¢˜ï¼Œä»Šå¤©å°±åœ¨è¿™ç¯‡æ–‡ç« é‡Œæ€»ç»“
ä¸€ä¸‹å§ã€‚</p><h2 id="ç›®å½•">ç›®å½•</h2><ul><li>å¸¸è§ <code>Hook</code> çš„ç”¨æ³•</li><li><code>Hook</code> çš„æ³¨æ„é¡¹ä»¥åŠè§„åˆ™</li><li>å¦‚ä½•å¤„ç† <code>Hook</code> çš„ä¾èµ–</li></ul><h3 id="å¸¸è§-hook-çš„ç”¨æ³•">å¸¸è§ <code>Hook</code> çš„ç”¨æ³•</h3><p>React å‘å¸ƒäº†å¾ˆå¤š <code>Hook</code>, ä»Šå¤©åœ¨è¿™ç¯‡æ–‡ç« é‡Œä¸»è¦å‡å°‘å‡ ä¸ª Hook åˆ†åˆ«æ˜¯ <code>useEffect</code>, <code>useMemo</code>, <code>useCallback</code>
ä¸ºä»€ä¹ˆåªä»‹ç»è¿™ä¸‰ä¸ªï¼Œå› ä¸ºè¿™ä¸‰ä¸ªéƒ½æ¶‰åŠåˆ°ä¾èµ–é¡¹çš„é—®é¢˜ã€‚<code>useLayoutEffect</code> è¿™ä¸ªä¸ç®—è¯¦ç»†ä»‹ç»ï¼Œå‚è€ƒ <code>useEffect</code> å³å¯</p><h4 id="useeffect">useEffect</h4><p><code>useEffect</code> çš„ç”¨æ³•å¾ˆç®€å•ï¼Œè¿™ä¸ª Hook é€šå¸¸æ˜¯ç”¨æ¥å¤„ç†ä¸€äº›å‰¯ä½œç”¨çš„ï¼Œæ¯”å¦‚æ•°æ®è¯·æ±‚ã€‚ä½ å¯ä»¥å½“åš class ä¸­çš„
<code>componentDidMount</code> å’Œ <code>componentDidUpdate</code> çš„ç»“åˆä½“æ¥ä½¿ç”¨ã€‚ä»¥å‰éœ€è¦è¯·æ±‚æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæŠŠè¯·æ±‚æ•°æ®çš„
æ“ä½œæ”¾åœ¨ <code>componentDidMount</code> ä¸­ã€‚æ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="2,3,4"><span class="token keyword">class</span> <span class="token class-name">Text</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span>
</code></pre><p>ä½†æ˜¯åœ¨ Hook é‡Œå°±å¯ä»¥è¿™æ ·å»å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶éœ€è¦æ³¨æ„çš„å°±æ˜¯ <code>ä¾èµ–é¡¹</code> çš„é—®é¢˜ï¼Œè¿™ä¸ªä¾‹å­ä¸­ä¾èµ–é¡¹æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œé‚£ä¹ˆå°±ä»£è¡¨åªåœ¨ <code>mount</code> çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œ
ä¸‹ä¸€æ¬¡ä¸ä¼šæ‰§è¡Œè¿™ä¸ª <code>Hook</code>ã€‚</p><p>åŒç†ï¼Œ <code>useEffect</code> ä¹Ÿå¯ä»¥å–ä»£ <code>componentDidUpdate</code>ã€‚æ¯”å¦‚åœ¨ class ä¸­ä½¿ç”¨ <code>update</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Text</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">preProps<span class="token punctuation">,</span> preState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preProps<span class="token punctuation">.</span>xx <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>xx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// doing</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ <code>Hook</code> é‡Œå°±å¯ä»¥è¿™æ ·å»å†™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// doing</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>xx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åªè¦å½“ <code>xx</code> å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å°±æ‰§è¡Œè¿™ä¸ª <code>effect</code>ã€‚ç”¨èµ·æ¥è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚</p><h3 id="hook-çš„æ³¨æ„é¡¹ä»¥åŠè§„åˆ™"><code>Hook</code> çš„æ³¨æ„é¡¹ä»¥åŠè§„åˆ™</h3><p>åœ¨ä½¿ç”¨ <code>Hook</code> çš„æ—¶å€™ä¸€å®šè¦éµå¾ªå®ƒçš„<a href="https://reactjs.org/docs/hooks-rules.html?no-cache=1">è§„åˆ™</a></p><p>Donâ€™t call Hooks from regular JavaScript functions. Instead, you can:</p><ul><li>âœ… Call Hooks from React function components.</li><li>âœ… Call Hooks from custom Hooks (weâ€™ll learn about them on the next page).</li></ul><p>å¿…é¡»è¦éµå¾ªä¸Šè¿°çš„è§„åˆ™ï¼Œæ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨ <code>Hook</code></p><h3 id="å¦‚ä½•å¤„ç†-hook-çš„ä¾èµ–">å¦‚ä½•å¤„ç† <code>Hook</code> çš„ä¾èµ–</h3><p>åœ¨ä½¿ç”¨ <code>Hook</code> çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šè£…å®˜æ–¹æä¾›çš„ <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks">hook eslint</a> ä½¿ç”¨
å®˜æ–¹æä¾›çš„ eslint æœ‰å¾ˆå¤šå¥½å¤„ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å¸®åŠ©æˆ‘ä»¬é¿å…ä¸€äº›ä½¿ç”¨ hook çš„é”™è¯¯ï¼Œæ¯”å¦‚éœ€è¦åœ¨é¡¶å±‚ä½¿ç”¨ã€‚å¦‚æœä½ åœ¨æ¡ä»¶è¯­å¥ä¸­
ä½¿ç”¨å°±ä¼šæŠ¥é”™ã€‚ä½¿ç”¨ lint å‡å°‘äº†é”™è¯¯çš„å‘ç”Ÿã€‚ä½†æ˜¯ç›®å‰çš„ eslint æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½ä¼šè¢«å¤§å®¶æ‰€è¯Ÿç—…å§ã€‚å°±æ˜¯è‡ªå®šæ·»åŠ ä¾èµ–çš„é—®é¢˜
å½“åœ¨ eslint ä¸­è¿™æ ·é…ç½®</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token comment">// Your ESLint configuration</span>
<span class="token punctuation">{</span>
  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string">"react-hooks"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"rules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string">"react-hooks/rules-of-hooks"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token comment">// Checks rules of Hooks</span>
    <span class="token string">"react-hooks/exhaustive-deps"</span><span class="token punctuation">:</span> <span class="token string">"warn"</span> <span class="token comment">// Checks effect dependencies</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>react-hooks/exhaustive-deps</code> è¿™ä¸ªè§„åˆ™ä¼šæ£€æŸ¥ä¾èµ–é¡¹ï¼Œå¸¸è§æœ‰ <code>useEffect</code>, <code>useMemo</code>, <code>useCallback</code>
ä¼šè‡ªåŠ¨ç»™è¿™ä¸ªå‡ ä¸ª <code>Hook</code> åŠ ä¸Šä¾èµ–ï¼Œé‚£ä¹ˆè¿™æ ·å°±ä¼šå­˜åœ¨é—®é¢˜ï¼Œæœ‰çš„æ—¶å€™å¯èƒ½æˆ‘å°±æ˜¯ä¸æƒ³è¦è¿™ä¸ªä¾èµ–ï¼Œä½†æ˜¯å› ä¸º lint é…ç½®äº†è¿™ä¸ª
çš„åŸå› ï¼Œè‡ªåŠ¨åŠ ä¸Šäº†ä¾èµ–ï¼Œé‡åˆ°è¿™ç§æƒ…å†µåº”è¯¥æ€ä¹ˆå»è§£å†³æˆ–è€…è¯´å¦‚ä½•ä¼˜é›…çš„æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿï¼ˆ<code>åˆ æ‰è¿™ä¸ªè§„åˆ™ç¾æ»‹æ»‹-æœ€å¥½ä¸è¦åˆ </code>ï¼‰</p><p>è¿™ä¸ªåœ¨ React çš„ github <a href="https://github.com/facebook/react/issues/14920">issue</a> ä¸­æœ‰æåˆ°è¿‡è¿™æ ·çš„é—®é¢˜ï¼Œå°±æ˜¯å¸Œæœ›åœ¨ä½¿ç”¨è¿™ä¸ª
è§„åˆ™çš„æ—¶å€™ä¸è¦è‡ªåŠ¨åŠ ä¸Šä¾èµ–ï¼Œå¯ä»¥ç»™å‡ºè­¦å‘Šï¼Œä½†æ˜¯ä¸è¦è‡ªåŠ¨æ·»åŠ åˆ°ä»£ç ä¸­ã€‚ä»Šå¤©ä»å®˜æ–¹çš„ issue æ¥åˆ†æä¸€ä¸ªä¸€ä¸ªè¿™æ ·çš„ä¾‹å­ï¼Œæ˜¯å¦å¯ä»¥åœ¨ä¸å»æ‰è¿™ä¸ª
è§„åˆ™çš„å‰æä¸‹ï¼Œè§£å†³è¿™æ ·çš„ä¾èµ–é—®é¢˜ã€‚</p><h4 id="example-1">Example-1</h4><p><a href="https://codesandbox.io/s/nqy69ol00">codesandbox</a></p><p>This is an uncontrolled Checkbox component which takes a defaultIndeterminate prop to set the indeterminate status on initial render (which can only be done in JS using a ref because thereâ€™s no indeterminate element attribute). This prop is intended to behave like defaultValue, where its value is used only on initial render.</p><p>The rule complains that defaultIndeterminate is missing from the dependency array, but adding it would cause the component to incorrectly overwrite the uncontrolled state if a new value is passed. The dependency array canâ€™t be removed entirely because it would cause the indeterminate status to be fully controlled by the prop.</p><p>I donâ€™t see any way of distinguishing between this and the type of case that the rule is meant to catch, but it would be great if the final rule documentation could include a suggested workaround. ğŸ™‚</p><p><code>åŸå§‹ä»£ç ç‰‡æ®µ</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="9,10,11,12,13"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Checkbox</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> defaultIndeterminate<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line">  React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="highlighted-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultIndeterminate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> inputRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>indeterminate <span class="token operator">=</span> defaultIndeterminate<span class="token punctuation">;</span></span><span class="highlighted-line">    <span class="token punctuation">}</span></span><span class="highlighted-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>input <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">'checkbox'</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rootElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Checkbox defaultIndeterminate <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> rootElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™ä¸ªä¾‹å­ä¼šæŠ¥ä¸€ä¸ªè­¦å‘Šå°±æ˜¯ <code>useLayoutEffect</code> ç¼ºå°‘ä¸€ä¸ªä¾èµ–å°±æ˜¯ <code>defaultIndeterminate</code>, é‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªä¾èµ–æ”¾åœ¨
è¿™é‡Œæ˜¯å¦åˆé€‚å‘¢ï¼Ÿæ˜æ˜¾çœ‹å‡ºæ˜¯ä¸åˆé€‚çš„ï¼Œå› ä¸º <code>default</code> çš„æ•ˆæœæ˜¯ä»€ä¹ˆå°±æ˜¯åˆå§‹åŒ–æˆ–è€…è¯´åªå¯¹äº mount çš„æ—¶å€™èµ·ä½œç”¨ï¼Œä¸‹ä¸€æ¬¡
ä¿®æ”¹ default çš„å€¼ä¸åº”è¯¥ä¸åœ¨åº”ç”¨è¿™ä¸ªå€¼ã€‚ä½†æ˜¯å¦‚æœä½œä¸ºä¾èµ–ï¼Œé‚£ä¹ˆæ¯æ¬¡è¿™ä¸ªå€¼å‘ç”Ÿå˜åŒ–éƒ½ä¼šå¯¼è‡´é‡æ–°åº”ç”¨è¿™ä¸ªå€¼ï¼Œå¦‚æœè¾¾åˆ°è¿™ä¸ªä½œç”¨
ä¸å°±æ˜¯ value çš„æ•ˆæœäº†å˜›ã€‚è€Œä¸æ˜¯ <code>defaultValue</code> æˆ– <code>defaultIndeterminate</code> çš„æ•ˆæœã€‚å¦‚æœè¦æƒ³è¾¾åˆ° default çš„æ•ˆæœåˆä¸æ˜¯
disabled lint, å¯ä»¥è¯•è¯•è¿™æ ·æ¥ä¿®æ”¹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="5"><span class="token keyword">function</span> <span class="token function">Checkbox</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> defaultIndeterminate<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line">  <span class="token keyword">const</span> indeterminate <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>defaultIndeterminate<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
  React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indeterminate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> inputRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>indeterminate <span class="token operator">=</span> indeterminate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>indeterminate<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>input <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">'checkbox'</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨ <code>useState</code> æŠŠ <code>indeterminate</code> ä½œä¸ºä¾èµ–ã€‚</p><p>æ€»ç»“ï¼š å¦‚æœè¦è¾¾åˆ° <code>default</code> çš„æ•ˆæœå…¶å®éƒ½å¯ä»¥è¿™ä¹ˆæ¥å¤„ç†ã€‚ä½¿ç”¨ useState å¯ä»¥è¾¾åˆ°ç¼“å­˜çš„æ•ˆæœ</p><h4 id="example-2">Example-2</h4><p>ç¬¬äºŒä¸ªåœºæ™¯è¿˜æ˜¯å¾ˆç®€å•çš„åœ¨ issue ä¸­æ˜¯è¿™æ ·çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨å¤–éƒ¨åˆ›å»ºäº† <code>foo</code> å‡½æ•°ï¼Œä½†æ˜¯è°ƒç”¨éœ€è¦åœ¨ useEffect å†…éƒ¨è°ƒç”¨ä¹Ÿæœ‰å¯èƒ½åœ¨å…¶ä»–çš„äº‹ä»¶å‡½æ•°ä¸­è°ƒç”¨ã€‚è¿™ç§åœºæ™¯åœ¨å¼€å‘ä¸­è¿˜æ˜¯å¾ˆå¸¸è§çš„ä¸€ç§ã€‚è¿™ç§åœºæ™¯ä¸‹
ä¼šæŠŠ <code>foo</code> åŠ å…¥åˆ°ä¾èµ–ä¸­ã€‚ä½†æ˜¯æ¯æ¬¡å½“ç»„ä»¶ <code>rerender</code> çš„æ—¶å€™, foo éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ç§åœºæ™¯ä¸‹å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><p>è¿™ç§åˆ†ä¸¤ç§æƒ…å†µæ¥å¤„ç†ï¼Œç¬¬ä¸€å°±æ˜¯å¦‚æœå‡½æ•°åœ¨ <code>effect</code> å†…éƒ¨ä½¿ç”¨ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°å¹¶ä¸ä¼šåœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±éœ€è¦<code>å£°æ˜åœ¨ effect å†…éƒ¨</code>,
ç¬¬äºŒå°±æ˜¯è¿™ä¸ªå‡½æ•°ä¸ä»…åœ¨ <code>effect</code> å†…éƒ¨ä¹Ÿéœ€è¦åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚é‚£ä¹ˆæ­¤æ—¶éœ€è¦ä½¿ç”¨ <code>useCallback</code> è¿›è¡ŒåŒ…è£¹èµ·æ¥ï¼Œåœ¨ <code>useCallback</code> ä¸­
å¤„ç†å¥½ä¾èµ–å…³ç³»å°±å¯ä»¥ã€‚ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨ useState, ä¹‹å‰è¯´è¿‡ useState ä¹Ÿèƒ½èµ·åˆ°ç¼“å­˜çš„ä½œç”¨ã€‚é‚£ä¹ˆå¦‚æœå¯¹å‡½æ•°è¿›è¡Œç¼“å­˜ï¼Œä¹Ÿæ˜¯å¯ä»¥
è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœçš„</p><h4 id="example-3">Example-3</h4><p>å¦‚æœåœ¨ <code>useEffect</code> å†…éƒ¨ç›´æ¥ä½¿ç”¨ <code>props.xxx</code>, é‚£ä¹ˆæ­¤æ—¶ä¼šè‡ªåŠ¨æŠŠ props åŠ å…¥åˆ°ä¾èµ–ä¸­ã€‚æ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">.</span><span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>props<span class="token punctuation">.</span>setLoading<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼Œæ‰€ä»¥å¯¹äºåœ¨ useEffect ä¸­ä½¿ç”¨ props, æœ€å¥½å…ˆè§£æ„å‡ºç›¸åº”çš„å±æ€§ã€‚ The best practice is always destructuring.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="1"><span class="highlighted-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> setLoading <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span></span><span class="token function">useEffect</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>setLoading<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="example-4">Example-4</h4><p>è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨äºæ•°æ®è¯·æ±‚çš„ä¾‹å­ï¼Œåœ¨ <code>useEffect</code> å†…éƒ¨å‘é€è¯·æ±‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="21,22,23,24,25,26,27,28,29"><span class="token keyword">const</span> <span class="token function-variable function">useDataApi</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> setData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoading<span class="token punctuation">,</span> setIsLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isError<span class="token punctuation">,</span> setIsError<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">fetchData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response<span class="token punctuation">;</span>
    <span class="token function">setIsError</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setIsLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">setData</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setIsError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setIsLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="highlighted-line"></span><span class="highlighted-line">  <span class="token function">useEffect</span><span class="token punctuation">(</span></span><span class="highlighted-line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="highlighted-line">      <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="highlighted-line">    <span class="token comment">// react-hooks/exhaustive-deps gives me warning that I should put fetchData into</span></span><span class="highlighted-line">    <span class="token comment">// dependency array &amp; remove url</span></span><span class="highlighted-line">    <span class="token comment">// if I put fetchData as a dependency and remove url the request will be fired continuously</span></span><span class="highlighted-line">    <span class="token punctuation">[</span>url<span class="token punctuation">]</span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> isLoading<span class="token punctuation">,</span> isError <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>useEffect</code> æ˜¯éœ€è¦ <code>fetchData</code> ä½œä¸ºä¾èµ–ï¼Œä½†æ˜¯å½“éœ€è¦å‡½æ•°ä½œä¸ºä¾èµ–çš„æ—¶å€™æ­£å¦‚ä¹‹å‰æ‰€è¯´çš„ï¼Œæœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªã€‚ç¬¬ä¸€æŠŠè¿™ä¸ªå‡½æ•°æ”¾åœ¨å†…éƒ¨ï¼Œ
ç¬¬äºŒä½¿ç”¨ <code>useCallback</code>, ç¬¬ä¸‰ä½¿ç”¨ ref æˆ–è€… state è®°å½•è¯¥å‡½æ•°ã€‚å…¶å®è¿˜æœ‰ä¸€ç§å°±æ˜¯æŠŠè¿™ä¸ªå‡½æ•°æ”¾åœ¨è¿™ä¸ª <code>Hook</code> çš„å¤–éƒ¨ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä¸å¦¨æ¥ä¸€æ­¥ä¸€æ­¥çš„ä¿®æ”¹ã€‚
é¦–å…ˆæŠŠå‡½æ•°æ”¾åœ¨å†…éƒ¨åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">fetchData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> response<span class="token punctuation">;</span>
      <span class="token function">setIsError</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setData</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setIsError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">setIsLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// react-hooks/exhaustive-deps gives me warning that I should put fetchData into</span>
  <span class="token comment">// dependency array &amp; remove url</span>
  <span class="token comment">// if I put fetchData as a dependency and remove url the request will be fired continuously</span>
  <span class="token punctuation">[</span>url<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div><img src="./static/media/data.18efbfa5.jpg"/></div><p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶ä¾èµ–é—®é¢˜å·²ç»è§£å†³ã€‚å…¶ä»–çš„éƒ½æ˜¯ä¸€æ ·çš„å¤„ç†ï¼Œè¿™ä¸ªä¾‹å­å°±ä¸åšè¿‡å¤šçš„é˜è¿°ã€‚</p><h4 id="example-5">Example-5</h4><p>ç¬¬äº”ä¸ªä¾‹å­ä¹Ÿæ˜¯ä¸šåŠ¡ä¸­å¸¸è§çš„ä¸€ä¸ªä¾‹å­ï¼Œå°±æ˜¯æ¨¡æ‹Ÿ <code>componentDidUpdate</code> æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥é“çš„ï¼Œ <code>useEffect</code> æœ‰è¿™ä¸ªä½œç”¨ã€‚ä½†æ˜¯é‡åˆ°è¿™ç§æƒ…å†µ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">preProps<span class="token punctuation">,</span> preState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>preProps<span class="token punctuation">.</span>xxx <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¾‹å­ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">MyComponent</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getData<span class="token punctuation">,</span> someId<span class="token punctuation">,</span> refreshRequest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">fetchData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">getData</span><span class="token punctuation">(</span>someId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>refreshRequest<span class="token punctuation">]</span> <span class="token comment">//This is what I want -- just invoke useEffect on intial component mount and when refreshRequest is updated</span>
    <span class="token comment">//[refreshRequest, someId, getData] //Linter wants everything in useEffect function second array argument, or nothing.  So, if any prop changes, then it will invoke useEffect. Not what I want</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      My component has rendered<span class="token punctuation">.</span> Check out the console <span class="token keyword">for</span> when data is
      <span class="token string">'fetched'</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¿™ä¸ªåœ¨ <code>useEffect</code> ä¸­å¾ˆä¸å¥½å¤„ç†ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸º <code>fetchData</code> å’Œ <code>url</code> éƒ½è¢«è®¤ä¸ºæ˜¯ä¾èµ–ï¼Œå®é™…ä¸ŠçœŸæ­£çš„ä¾èµ–åº”è¯¥æ˜¯ <code>xxx</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token punctuation">{</span> xxx<span class="token punctuation">,</span> fetchData<span class="token punctuation">,</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>xxx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™ä¸ªå°±ä¼šæŠ¥è­¦å‘Šã€‚é‚£ä¹ˆè¿™æ ·çš„é—®é¢˜å¦‚ä½•è§£å†³å‘¢ï¼ŸæŒ‰ç…§ä¹‹å‰è¯´çš„æ–¹æ³•ï¼Œç¬¬ä¸€æˆ‘ä»¬ä½¿ç”¨ <code>useCallback</code> æ¥è¯•è¯•çœ‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>fetchData<span class="token punctuation">,</span> url<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>fetch<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>fetchData</code> å’Œ <code>url</code> éƒ½ä¼šè¢«åŠ åˆ°ä¾èµ–ä¸­ã€‚è¿™ä¸ªè¿˜æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºåªè¦ url æˆ– fetchData å˜åŒ–å°±ä¼šè§¦å‘æ•°æ®çš„è¯·æ±‚ï¼Œè€Œä¸ <code>xxx</code> è¿™ä¸ªå±æ€§æ¯«æ— å…³ç³»ã€‚è¿™ä¸ªä¾‹å­ä¸å¦¨åœ¨åˆ†æä¸€ä¸‹
ä½¿ç”¨äº† <code>props</code> ä½†æ˜¯æœ‰ä¸€äº› props æ˜¯ä¾èµ–äºå…¶ä»–çš„ props, è¿™ç§æ›´åƒæ˜¯ class ä¸­çš„ <code>getDerivedStateFromProps</code>. é‚£ä¹ˆä¸å¦¨æŒ‰ç…§è¿™ä¸ªæ–¹å‘æ¥å¤„ç†è¿™ä¸ªä¾èµ–çš„é—®é¢˜ã€‚ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•
<code>useState</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="4,5,6,7"><span class="token keyword">const</span> <span class="token punctuation">[</span>currentGetData<span class="token punctuation">,</span> setCurrentGetData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>getData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>prevRefreshRequest<span class="token punctuation">,</span> setPrevRefreshRequest<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>refreshRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>prevRefreshRequest <span class="token operator">!==</span> refreshRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">  <span class="token function">setPrevRefreshRequest</span><span class="token punctuation">(</span>refreshRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">  <span class="token function">setCurrentGetData</span><span class="token punctuation">(</span>getData<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line"><span class="token punctuation">}</span></span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">currentGetData</span><span class="token punctuation">(</span>someId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>currentGetData<span class="token punctuation">,</span> someId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>æ¨¡æ‹Ÿäº† <code>getDerivedStateFromProps</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯è¿™ä¸ªä¾‹å­å¹¶ä¸æ˜¯ä¸€ä¸ªå¯å–çš„ä¾‹å­ï¼Œå°†å¼‚æ­¥å‡½æ•°ä¼ é€’ä¸‹æ¥ã€‚å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç° <code>ç«æ€</code> çš„æƒ…å†µã€‚å°±æ˜¯ä¸¤ä¸ªè¯·æ±‚å‘å‡ºçš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚æ¯”
ç¬¬äºŒä¸ªè¯·æ±‚è¦æ…¢ã€‚å®é™…ä¸Šæˆ‘ä»¬éœ€è¦æ˜¯ç¬¬äºŒä¸ªè¯·æ±‚è¿”å›çš„ç»“æœã€‚æ‰€ä»¥æœ€å¥½å¤„ç†å¥½è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœè¯·æ±‚æ•°æ®çš„å°±æ˜¯è¿™ä¸ªç»„ä»¶çš„æœ¬èº«çš„è¯ï¼Œå¯ä»¥åœ¨ <code>useEffect</code> çš„ clean å‡½æ•°ä¸­è®¾ç½®<code>å¿½ç•¥</code>æ ‡å¿—ä»¥è§£å†³è¿™ç§
<code>ç«æ€</code>çš„åœºæ™¯ã€‚å½“ç„¶å¦‚æœ <code>React</code> åç»­çš„ <code>Suspense</code> å‡ºæ¥äº†ï¼Œæ•°æ®è¯·æ±‚æ”¾åœ¨ <code>Suspense</code> ä¸­æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p><h2 id="conclusion">Conclusion</h2><p>å¯¹äºä½¿ç”¨ <code>useEffect</code> çš„ä¾èµ–å¯ä»¥é‡‡å–å››ç§æ–¹å¼æ¥è§£å†³ã€‚</p><ul><li>ä½¿ç”¨ <code>useState</code> è¿›è¡Œç¼“å­˜ã€‚åŒæ—¶å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿ class ä¸­çš„ <code>getDerivedStateFromProps</code></li><li>å¯¹äºåœ¨ <code>useEffect</code> å¤–éƒ¨çš„å£°æ˜ï¼Œå†…éƒ¨åˆè¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚å¯ä»¥æ”¾å…¥åˆ° <code>useEffect</code> å†…éƒ¨</li><li>å¯¹äºä¸èƒ½æ”¾åœ¨ <code>useEffect</code> å†…éƒ¨çš„ï¼Œå¯ä»¥è€ƒè™‘æ˜¯å¦ä½¿ç”¨ <code>useCallback</code> æ¥è§£å†³è¿™æ ·çš„é—®é¢˜</li><li>ä½¿ç”¨ <code>ref</code> æˆ–è€… æ”¾åˆ°ç»„ä»¶å¤–é¢</li></ul><p>å¯¹äºè¿™ä¸ª <a href="https://github.com/facebook/react/issues/14920">Feedback for â€œexhaustive-depsâ€ lint rule</a> Dan ä¹Ÿåœ¨é‡Œé¢ç»™å‡ºäº†ä¸€äº›è§£å†³åŠæ³•ã€‚å¯ä»¥å‚è€ƒ</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[react callback thinking]]></title>
            <link>/posts/2019-11-02/a-callback-thinking/</link>
            <guid>/posts/2019-11-02/a-callback-thinking/</guid>
            <pubDate>Fri, 01 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>é¦–å…ˆä¸ºä»€ä¹ˆä¼šæƒ³åˆ°å†™è¿™ç¯‡æ–‡ç« ï¼Œå†™è¿™ç¯‡æ–‡ç« çš„ç”±æ¥ä¸»è¦æ˜¯å†…éƒ¨çš„ä¸€ä¸ªé¡¹ç›®å¯¼è‡´çš„ï¼Œè¿™ä¸ªå¼•èµ·äº†æˆ‘çš„ä¸€äº›æ€è€ƒã€‚é‚£åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h1 id="ç›®å½•">ç›®å½•</h1><ul><li>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§åœºæ™¯</li><li>å¦‚ä½•è§£å†³è¿™ä¸ªåœºæ™¯</li><li>react å†…éƒ¨æ˜¯å¦‚ä½•è¿ä½œçš„æ‰ä¼šå¯¼è‡´è¿™ç§åœºæ™¯çš„å‡ºç°</li></ul><h2 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§åœºæ™¯">ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§åœºæ™¯</h2><p>åœ¨ä½¿ç”¨ <code>React</code> çš„æ—¶å€™ï¼Œçˆ¶å­é—´æ˜¯å¦‚ä½•é€šä¿¡çš„ï¼Œæˆ‘ç›¸ä¿¡åŸºæœ¬ä¸Šæ‰€æœ‰äººéƒ½æ˜¯çŸ¥é“çš„ï¼Œçˆ¶ä¼ é€’æ•°æ®ç»™å­æ˜¯é€šè¿‡ <code>props</code> çš„å½¢å¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="2"><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">B</span> name<span class="token operator">=</span><span class="token string">'lanyincao'</span> age<span class="token operator">=</span><span class="token string">'18'</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span></span><span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ B ç»„ä»¶æ¥å— <code>name</code> å’Œ <code>age</code> è¿™ä¸¤ä¸ª props, åœ¨ B ç»„ä»¶å†…éƒ¨å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸¤ä¸ªæ•°æ®è¿›è¡Œç›¸åº”çš„å¤„ç†æ“ä½œã€‚é‚£ä¹ˆå­å¦‚ä½•æŠŠæ•°æ®ä¼ é€’ç»™çˆ¶å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“åº”è¯¥å›è°ƒçš„æ–¹å¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="7,8,9"><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">B</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>onChange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">    <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token string">'XXXX'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">  <span class="token punctuation">}</span></span>  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ B ç»„ä»¶å†…éƒ¨è°ƒç”¨ A ç»„ä»¶ä¼ é€’ä¸‹æ¥çš„ <code>onChange</code> å›è°ƒï¼Œé€šè¿‡ <code>onChange</code> å†æŠŠ B ä¸­çš„æ•°æ®åä¼ å›å»ã€‚åŸºæœ¬ä¸Šçˆ¶å­é€šä¿¡å°±å¯ä»¥å¾ˆå¿«çš„å®Œæˆäº†ã€‚è‡³äºå…¶ä»–çš„æ–¹æ³•æˆ‘åœ¨è¿™é‡Œä¸åšè¿‡å¤šçš„æè¿°ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¼•å‡º
å¦ä¸€ä¸ªé—®é¢˜ã€‚</p><p>æ­¤æ—¶æœ‰è¿™æ ·çš„ä¸€ä¸ªç»„ä»¶çš„ç»“æ„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="5,6,7,8"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getAge<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render Parent component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>getAge<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getAge:'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">    <span class="token function">getAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">  <span class="token punctuation">}</span></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>span<span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> age <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render Node component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'age:'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render Test component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ageRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'update Test component'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Parent getAge<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">age</span> <span class="token operator">=></span> <span class="token punctuation">(</span>ageRef<span class="token punctuation">.</span>current <span class="token operator">=</span> age<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Node age<span class="token operator">=</span><span class="token punctuation">{</span>ageRef<span class="token punctuation">.</span>current<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Parent<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ReactDom<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Test <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>Test</code> ç»„ä»¶æœ‰ä¸€ä¸ª <code>children</code> ç»„ä»¶å«åš <code>Parent</code>, åœ¨ <code>Parent</code> ç»„ä»¶å†…éƒ¨è°ƒç”¨äº† <code>getAge</code> æ–¹æ³•, <code>getAge</code> æ–¹æ³•å°±æ˜¯ä¸€ä¸ªå›è°ƒ, é€šè¿‡ <code>getAge</code> æ–¹æ³•æŠŠ
age è¿”å›å‡ºå»ç»™çˆ¶ç»„ä»¶ä½¿ç”¨ã€‚é‚£ä¹ˆä¸å¦¨åœ¨ä»”ç»†çœ‹ä¸‹ <code>Test</code> ç»„ä»¶ï¼Œåœ¨è°ƒç”¨ <code>getAge</code> æ–¹æ³•çš„æ—¶å€™æŠŠ age æŒ‚åˆ° ref ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å‡½æ•°ä¸­ ref å¯ä»¥å½“åšå’Œ class ä¸­çš„ this
ä¸€æ ·å»ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨ render Parent çš„æ—¶å€™ï¼Œ ageRef.current å°±ä¼šè¢«èµ‹äºˆæ–°çš„å€¼, é‚£ä¹ˆ ageRef.current è¢«èµ‹äºˆæ–°çš„å€¼åï¼Œæ˜¯å¦æ­¤æ—¶ <code>Node</code> ç»„ä»¶è·å–åˆ°çš„ age å°±æ˜¯æ–°çš„å€¼å‘¢ï¼Ÿ
ä¸å¦¨çœ‹ä¸€ä¸‹è¾“å‡º</p><div><img src="./static/media/hook-1.5eadc3d4.jpg"/></div><p>å¯ä»¥çœ‹å‡ºåœ¨ <code>Node</code> ç»„ä»¶ä¸­, æ­¤æ—¶ age æ˜¯ null, å¯¹å•Šä¸ºä»€ä¹ˆä¼šæ˜¯ null å‘¢ï¼Œä¸åº”è¯¥å•Šï¼Œå¦‚æœæ˜¯ 18 åº”è¯¥å¤šå¥½å•Šã€‚æœ‰å¯èƒ½åœ¨ <code>Node</code> ç»„ä»¶å†…éƒ¨ï¼Œä¼šä½¿ç”¨æ•°å­—çš„ä¸€äº›æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯ null,
è¿™æ ·å°±ä¼šå¯¼è‡´é¡µé¢ç™½å±äº†ï¼Œå°±ä¼šé€ æˆä¸¥é‡çš„é—®é¢˜ã€‚</p><h2 id="å¦‚ä½•è§£å†³è¿™ä¸ªåœºæ™¯">å¦‚ä½•è§£å†³è¿™ä¸ªåœºæ™¯</h2><p>ä¸Šé¢å‡ºç°çš„ age is null, è¿™æ ·çš„æƒ…å†µï¼Œåº”è¯¥å¦‚ä½•å»è§£å†³å‘¢ï¼Ÿ é¦–å…ˆæˆ‘ä»¬çŸ¥é“ ageRef æ˜¯ä¸€ä¸ªæ‹¥æœ‰ current å±æ€§çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸å¦¨æŠŠ ageRef ä¼ é€’åˆ°å­ç»„ä»¶ä¸­ï¼Œåœ¨å­ç»„ä»¶ä¸­ä½¿ç”¨
<code>ageRef.current</code> æ¥è·å–åˆ°æ–°çš„ age çš„å€¼ï¼Œå¥½äº†ä¸å¦¨è¯•ä¸€ä¸‹ï¼ï¼ï¼</p><ul><li>ä¼ é€’å¼•ç”¨åˆ°å­ç»„ä»¶ä¸­</li></ul><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="13,22"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getAge<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>getAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getAge:'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ResovedNode</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> age <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'age:'</span><span class="token punctuation">,</span> age<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ResovedTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ageRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Parent getAge<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">age</span> <span class="token operator">=></span> <span class="token punctuation">(</span>ageRef<span class="token punctuation">.</span>current <span class="token operator">=</span> age<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
<span class="highlighted-line">      <span class="token operator">&lt;</span>ResovedNode age<span class="token operator">=</span><span class="token punctuation">{</span>ageRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>Parent<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç°åœ¨ä¼ é€’åˆ° Node ç»„ä»¶ä¸­çš„ age æ˜¯ <code>ageRef.current</code>, åœ¨çœ‹çœ‹è¾“å‡º</p><div><img src="./static/media/hook-2.a9921c74.jpg"/></div><p>æ­¤æ—¶åœ¨ <code>Node</code> ç»„ä»¶ä¸­è·å–åˆ°çš„ ageRef.current å°±æ˜¯æ­£ç¡®çš„å€¼äº†ï¼Œä¸ºä»€ä¹ˆï¼Œå› ä¸ºåœ¨ Parent ä¸­çš„ ageRef å’Œä¼ é€’ä¸‹å»çš„æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åœ¨ render parent çš„æ—¶å€™ï¼Œ
è°ƒç”¨äº† getAge æ­¤æ—¶ ageRef.current è¢«ä¿®æ”¹äº†ã€‚é‚£ä¹ˆå½“æ¸²æŸ“åˆ° Node çš„æ—¶å€™ï¼Œè·å–åˆ°çš„ <code>ageRef</code> å°±å¯ä»¥æ‹¿åˆ°åœ¨ Parent ç»„ä»¶ä¸­çš„ age çš„å€¼äº†ã€‚</p><p><a href="https://codesandbox.io/s/yici-huidiaodefenxi-y20cf">try it in codesandbox</a></p><ul><li>ä¼ é€’å‡½æ•°åˆ°å­ç»„ä»¶ä¸­</li></ul><p>å‡½æ•°æ˜¯å…·æœ‰æ‡’æ‰§è¡Œä¹Ÿå°±æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€ä»¥å¦‚ä½•ä¼ é€’ä¸€ä¸ªå‡½æ•°åˆ°å­ç»„ä»¶ä¸­æ˜¯å¦ä¹Ÿå¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="13,22"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getAge<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>getAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getAge:'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ResovedNode2</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> age <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'age:'</span><span class="token punctuation">,</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ResovedTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ageRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Parent getAge<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">age</span> <span class="token operator">=></span> <span class="token punctuation">(</span>ageRef<span class="token punctuation">.</span>current <span class="token operator">=</span> age<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
<span class="highlighted-line">      <span class="token operator">&lt;</span>ResovedNode2 age<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> ageRef<span class="token punctuation">.</span>current<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>Parent<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶ä¼ é€’ç»™ Node çš„ age æ˜¯ä¸€ä¸ªå‡½æ•° <code>() =&gt; ageRef.current</code>, è¿™ä¸ªå‡½æ•°è¿”å›äº† <code>ageRef.current</code>, å› ä¸ºç°åœ¨ä¼ é€’ç»™ Node çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨ Node ç»„ä»¶çš„
render æ—¶æœºï¼Œæ‰€ä»¥åœ¨ Node ä¸­æ€»æ˜¯å¯ä»¥æ‹¿åˆ°æ–°çš„å€¼ã€‚ä¸å¦¨çœ‹ä¸€ä¸‹æ•°æ®</p><div><img src="./static/media/hook-3.25ce9ca0.jpg"/></div><p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶è¾“å‡ºçš„ age éƒ½æ˜¯æ­£ç¡®çš„ã€‚</p><p><a href="https://codesandbox.io/s/yici-huidiaodefenxi-y20cf">try it in codesandbox</a></p><h2 id="react-å†…éƒ¨æ˜¯å¦‚ä½•è¿ä½œçš„æ‰ä¼šå¯¼è‡´è¿™ç§åœºæ™¯çš„å‡ºç°">react å†…éƒ¨æ˜¯å¦‚ä½•è¿ä½œçš„æ‰ä¼šå¯¼è‡´è¿™ç§åœºæ™¯çš„å‡ºç°</h2><p>åœ¨ä¸Šé¢çš„åœºæ™¯ä¸­å·²ç»çŸ¥é“æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼Œé‚£ä¹ˆä¸å¦¨è€ƒè™‘ä¸€ä¸‹ä¸ºä»€ä¹ˆç¬¬ä¸€ç§æ˜¯ä¸è¡Œçš„å‘¢ï¼Ÿé‚£ä¹ˆä¸å¦¨å¯¹ react è¿›è¡Œè°ƒè¯•ä¸€ä¸‹å°±èƒ½çŸ¥é“ä¸ºä»€ä¹ˆäº†</p><p>é¦–å…ˆåœ¨ react çš„æºç çš„ createElement çš„å†…éƒ¨æ‰“å°ä¸€ä¸‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> propName<span class="token punctuation">;</span> <span class="token comment">// Reserved names are extracted</span>

  <span class="token operator">...</span>some

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'createElement-'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token string">'props:'</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> ReactCurrentOwner<span class="token punctuation">.</span>current<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸ºä»€ä¹ˆè¦åœ¨ <code>createElement</code> é‡Œé¢æ‰“å°å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“ React ä¼šè°ƒç”¨ <code>React.createElement</code> è¿”å› ReactElment å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯åœ¨ <code>babel</code> æ’ä»¶ä¸­åšçš„ï¼Œå…·ä½“
å¯ä»¥å»çœ‹ä¸€ä¸‹æ’ä»¶ã€‚å¯ä»¥ä¸»åŠ¨è°ƒç”¨ <code>React.createElement</code>, ä¹Ÿå¯ä»¥å†™æˆ <code>JSX</code> çš„å½¢å¼ï¼Œ React ä¼šè‡ªè¡Œè§£æã€‚é‚£ä¸å¦¨çœ‹ä¸€ä¸‹æ­¤æ—¶çš„è¾“å‡º</p><div><img src="./static/media/hook-4.8834fdd9.jpg"/></div><p>ä»è¾“å…¥å¯ä»¥çœ‹å‡ºåœ¨è°ƒç”¨ <code>createElement</code> çš„æ—¶å€™, æ­¤æ—¶ Node çš„ props å·²ç»ç¡®å®šäº†ï¼Œ æ­¤æ—¶çš„ age æ˜¯ null, æ‰€ä»¥å½“ render Node ç»„ä»¶çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ age å°±æ˜¯ null,
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‹¿ä¸åˆ°æœ€æ–°çš„å€¼çš„åŸå› äº†ï¼Œå› ä¸º <code>createElement</code> çš„æ—¶å€™å·²ç»ç¡®å®šäº†è¿™ä¸ª props çš„å€¼ã€‚å¦‚æœåç»­å‘ç”Ÿ <code>update</code>, ä¼šç»§ç»­è°ƒç”¨ <code>createElement</code>, æ­¤æ—¶ Test ç»„ä»¶ä¸­çš„
<code>ageRef.current</code> å·²ç»æ›´æ–°æˆæœ€æ–°çš„å€¼äº†ã€‚ä¸å¦¨çœ‹ä¸€ä¸‹è¾“å‡º</p><div><img src="./static/media/hook-5.16282898.jpg"/></div><p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶çš„ <code>ageRef.current</code> å·²ç»æ˜¯æœ€æ–°çš„å•¦</p><h1 id="conclusion">conclusion</h1><p>é€šè¿‡è¿™æ¬¡åœºæ™¯ï¼Œåˆ†æäº†ä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨ <code>React</code> ä¸­ç¬¬ä¸€æ¬¡ age æ˜¯ null çš„åŸå› ï¼Œä¹ŸçŸ¥é“äº†å¦‚ä½•æ¥è§£å†³è¿™ä¸ª null çš„é—®é¢˜ã€‚</p><p>åˆæ˜¯ä¸€ä¸ªæ„‰å¿«çš„å‘¨æœ«å‘€ ğŸ˜„ğŸ˜Œ</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[useSubscription]]></title>
            <link>/posts/2019-11-16/use-subscription/</link>
            <guid>/posts/2019-11-16/use-subscription/</guid>
            <pubDate>Fri, 15 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p><code>useSubscription</code> å³è®¢é˜…æ¨¡å¼ï¼Œè¿™æ˜¯ <code>react</code> è‡ªèº«æä¾›çš„ <code>Hook</code>, æœ¬æ–‡ä¸»è¦é€šè¿‡å‡ ä¸ªæ–¹é¢æ¥ä»‹ç»è¿™ä¸ª <code>Hook</code>, å¤§å®¶ä¹Ÿå¯ä»¥è‡ªè¡Œå‚è€ƒ<a href="https://github.com/facebook/react/blob/master/packages/use-subscription/README.md">å®˜ç½‘</a></p><h2 id="ç›®å½•">ç›®å½•</h2><ul><li>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ª useSubscription<ul><li>When should you NOT use this?</li><li>What types of subscriptions can this support?</li></ul></li><li>useSubscription çš„å†…éƒ¨å®ç°</li><li>æ‰‹åŠ¨å®ç°ä¸€ä¸ª useSubscription</li></ul><h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ª-usesubscription">ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ª useSubscription</h3><p><a href="https://github.com/facebook/react/tree/master/packages/use-subscription">useSubscription</a> çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†åœ¨ React concurrent mode ä¸‹å¯ä»¥å®‰å…¨çš„ç®¡ç†çŠ¶æ€ã€‚
ä¸»è¦ç”¨äºè¯»å–æŸä¸ªå€¼ï¼Œå€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å¯ä»¥åŒæ­¥æ›´æ–°ç›¸åº”çš„ç»„ä»¶ç„¶åå±•ç¤ºå‡ºæ¥ã€‚</p><h4 id="when-should-you-not-use-this">When should you NOT use this?</h4><ul><li>Redux/Flux stores should use the context API instead.</li><li>I/O subscriptions (e.g. notifications) that update infrequently should use a mechanism like react-cache instead.</li><li>Complex libraries like Relay/Apollo should manage subscriptions manually with the same techniques which this library uses under the hood (as referenced here) in a way that is most optimized for their library usage.</li></ul><h4 id="what-types-of-subscriptions-can-this-support">What types of subscriptions can this support?</h4><p>This abstraction can handle a variety of subscription types, including:</p><ul><li>Event dispatchers like HTMLInputElement.</li><li>Custom pub/sub components like Relayâ€™s FragmentSpecResolver.</li><li>Observable types like RxJS BehaviorSubject and ReplaySubject. (Types like RxJS Subject or Observable are not supported, because they provide no way to read the â€œcurrentâ€ value after it has been emitted.)</li></ul><p>Note that JavaScript promises are also not supported because they provide no way to synchronously read the â€œcurrentâ€ value.</p><p>ä»¥ä¸Šä¿¡æ¯éƒ½æ¥è‡ªå®˜ç½‘</p><h3 id="usesubscription-çš„å†…éƒ¨å®ç°">useSubscription çš„å†…éƒ¨å®ç°</h3><p><code>useSubscription</code> çš„<a href="https://github.com/facebook/react/blob/master/packages/use-subscription/src/useSubscription.js">å†…éƒ¨ä»£ç </a>å¾ˆç®€å•ï¼Œä¸è¶…è¿‡ 20 è¡Œï¼Œåœ¨å†…éƒ¨å®ç°å¯¹ä»»æ„çš„å€¼çš„è®¢é˜…</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="24,25,26,27,28,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47"><span class="token keyword">import</span> <span class="token punctuation">{</span> useDebugValue<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token comment">// Hook used for safely managing subscriptions in concurrent mode.</span>
<span class="token comment">//</span>
<span class="token comment">// In order to avoid removing and re-adding subscriptions each time this hook is called,</span>
<span class="token comment">// the parameters passed to this hook should be memoized in some wayâ€“</span>
<span class="token comment">// either by wrapping the entire params object with useMemo()</span>
<span class="token comment">// or by wrapping the individual callbacks with useCallback().</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> useSubscription<span class="token operator">&lt;</span>Value<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// (Synchronously) returns the current value of our subscription.</span>
  getCurrentValue<span class="token punctuation">,</span>

  <span class="token comment">// This function is passed an event handler to attach to the subscription.</span>
  <span class="token comment">// It should return an unsubscribe function that removes the handler.</span>
  subscribe
<span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token function-variable function">getCurrentValue</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Value<span class="token punctuation">,</span>
  <span class="token function-variable function">subscribe</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Value <span class="token punctuation">{</span>
  <span class="token comment">// Read the current value from our subscription.</span>
  <span class="token comment">// When this value changes, we'll schedule an update with React.</span>
  <span class="token comment">// It's important to also store the hook params so that we can check for staleness.</span>
  <span class="token comment">// (See the comment in checkForUpdates() below for more info.)</span>
<span class="highlighted-line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="highlighted-line">    getCurrentValue<span class="token punctuation">,</span></span><span class="highlighted-line">    subscribe<span class="token punctuation">,</span></span><span class="highlighted-line">    value<span class="token punctuation">:</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="highlighted-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
  <span class="token keyword">let</span> valueToReturn <span class="token operator">=</span> state<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

  <span class="token comment">// If parameters have changed since our last render, schedule an update with its current value.</span>
<span class="highlighted-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="highlighted-line">    state<span class="token punctuation">.</span>getCurrentValue <span class="token operator">!==</span> getCurrentValue <span class="token operator">||</span></span><span class="highlighted-line">    state<span class="token punctuation">.</span>subscribe <span class="token operator">!==</span> subscribe</span><span class="highlighted-line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">    <span class="token comment">// If the subscription has been updated, we'll schedule another update with React.</span></span><span class="highlighted-line">    <span class="token comment">// React will process this update immediately, so the old subscription value won't be committed.</span></span><span class="highlighted-line">    <span class="token comment">// It is still nice to avoid returning a mismatched value though, so let's override the return value.</span></span><span class="highlighted-line">    valueToReturn <span class="token operator">=</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line"></span><span class="highlighted-line">    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="highlighted-line">      getCurrentValue<span class="token punctuation">,</span></span><span class="highlighted-line">      subscribe<span class="token punctuation">,</span></span><span class="highlighted-line">      value<span class="token punctuation">:</span> valueToReturn</span><span class="highlighted-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">  <span class="token punctuation">}</span></span>
  <span class="token comment">// Display the current value for this hook in React DevTools.</span>
  <span class="token function">useDebugValue</span><span class="token punctuation">(</span>valueToReturn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// It is important not to subscribe while rendering because this can lead to memory leaks.</span>
  <span class="token comment">// (Learn more at reactjs.org/docs/strict-mode.html#detecting-unexpected-side-effects)</span>
  <span class="token comment">// Instead, we wait until the commit phase to attach our handler.</span>
  <span class="token comment">//</span>
  <span class="token comment">// We intentionally use a passive effect (useEffect) rather than a synchronous one (useLayoutEffect)</span>
  <span class="token comment">// so that we don't stretch the commit phase.</span>
  <span class="token comment">// This also has an added benefit when multiple components are subscribed to the same source:</span>
  <span class="token comment">// It allows each of the event handlers to safely schedule work without potentially removing an another handler.</span>
  <span class="token comment">// (Learn more at https://codesandbox.io/s/k0yvr5970o)</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didUnsubscribe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">checkForUpdates</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// It's possible that this callback will be invoked even after being unsubscribed,</span>
      <span class="token comment">// if it's removed as a result of a subscription event/update.</span>
      <span class="token comment">// In this case, React will log a DEV warning about an update from an unmounted component.</span>
      <span class="token comment">// We can avoid triggering that warning with this check.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>didUnsubscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// We use a state updater function to avoid scheduling work for a stale source.</span>
      <span class="token comment">// However it's important to eagerly read the currently value,</span>
      <span class="token comment">// so that all scheduled work shares the same value (in the event of multiple subscriptions).</span>
      <span class="token comment">// This avoids visual "tearing" when a mutation happens during a (concurrent) render.</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore values from stale sources!</span>
        <span class="token comment">// Since we subscribe an unsubscribe in a passive effect,</span>
        <span class="token comment">// it's possible that this callback will be invoked for a stale (previous) subscription.</span>
        <span class="token comment">// This check avoids scheduling an update for that stale subscription.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          prevState<span class="token punctuation">.</span>getCurrentValue <span class="token operator">!==</span> getCurrentValue <span class="token operator">||</span>
          prevState<span class="token punctuation">.</span>subscribe <span class="token operator">!==</span> subscribe
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Some subscriptions will auto-invoke the handler, even if the value hasn't changed.</span>
        <span class="token comment">// If the value hasn't changed, no update is needed.</span>
        <span class="token comment">// Return state as-is so React can bail out and avoid an unnecessary render.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>value <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>prevState<span class="token punctuation">,</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>checkForUpdates<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Because we're subscribing in a passive effect,</span>
    <span class="token comment">// it's possible that an update has occurred between render and our effect handler.</span>
    <span class="token comment">// Check for this and schedule an update if work has occurred.</span>
    <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      didUnsubscribe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>getCurrentValue<span class="token punctuation">,</span> subscribe<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the current value for our caller to use while rendering.</span>
  <span class="token keyword">return</span> valueToReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸å¦¨å¯¹æºç è¿›è¡Œåˆ†æï¼Œé¦–å…ˆå…³æ³¨</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  getCurrentValue<span class="token punctuation">,</span>
  subscribe<span class="token punctuation">,</span>
  value<span class="token punctuation">:</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™é‡ŒæŠŠ <code>props</code> è½¬æ¢æˆ <code>state</code> æ¥å­˜å‚¨ï¼Œè¿™ä¸ªç›¸å½“äº class ä¸­çš„ props è½¬æˆ state æ˜¯ä¸€æ ·çš„ã€‚é‚£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåšå‘¢ï¼Ÿ
åœ¨ class ä¸­æŠŠ props åŒæ­¥æˆ state çš„åœ°æ–¹æœ‰ä¸‰ä¸ªå£°æ˜å‘¨æœŸçš„é’©å­å¯ä»¥åšåˆ°ï¼Œ</p><ol><li>ä¸€ä¸ªæ˜¯å·²ç»æ ‡è®°ä¸º <code>unsafe</code> çš„ <code>componentWillReceiveProps</code> åœ¨æ¥æ”¶åˆ°æ–°çš„ props çš„æ—¶å€™å¯ä»¥è½¬æ¢æˆ state,</li><li>å¦å¤–æ˜¯ <code>componentDidUpdate</code> åœ¨æ¯æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œå¯ä»¥å¯¹ <code>this.props</code> å’Œ <code>pre.props</code> è¿›è¡Œæ¯”è¾ƒï¼Œç„¶ååœ¨å†…éƒ¨è¿›è¡Œ <code>setState</code></li><li>æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•å³ <code>getDrivedStateFromProps</code> åœ¨è¿™ä¸ªé™æ€æ–¹æ³•ä¸­è¿”å›ç›¸åº”çš„ state.</li></ol><p>è¿™ä¸‰ä¸ªæ–¹æ³•æ‰§è¡Œçš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ã€‚ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œæ·¡åŒ–äº†ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œé‚£ä¹ˆå¦‚ä½•æ¨¡æ‹Ÿ <code>getDrivedStateFromProps</code> æˆ– <code>componentWillReceiveProps</code> å‘¢ã€‚
å¦‚æœéœ€è¦æ¨¡æ‹Ÿè¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸçš„è¯ï¼Œé‚£ä¹ˆåˆæƒ³åšä¼˜åŒ–ï¼Œå°±éœ€è¦æ¯”è¾ƒä¸Šä¸€æ¬¡çš„å€¼å’Œä¸‹ä¸€æ¬¡çš„å€¼ï¼Œä¸Šä¸€æ¬¡çš„å€¼å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿæ­¤æ—¶å°±å¯ä»¥å­˜å‚¨åˆ° state ä¸­ï¼Œç„¶åä¸‹ä¸€æ¬¡ <code>render</code> çš„æ—¶å€™ï¼Œ
æ¯”è¾ƒè¿™ä¸€æ¬¡çš„ props å’Œ state å¦‚æœä¸ä¸€æ ·åˆ™é‡æ–° <code>setState</code>, å³ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>
  state<span class="token punctuation">.</span>getCurrentValue <span class="token operator">!==</span> getCurrentValue <span class="token operator">||</span>
  state<span class="token punctuation">.</span>subscribe <span class="token operator">!==</span> subscribe
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the subscription has been updated, we'll schedule another update with React.</span>
  <span class="token comment">// React will process this update immediately, so the old subscription value won't be committed.</span>
  <span class="token comment">// It is still nice to avoid returning a mismatched value though, so let's override the return value.</span>
  valueToReturn <span class="token operator">=</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    getCurrentValue<span class="token punctuation">,</span>
    subscribe<span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> valueToReturn
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é€šè¿‡ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•æ›´æ–°æ–°çš„çŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è¿˜éœ€è¦æ‰§è¡ŒçŠ¶æ€çš„å˜æ›´ä»è€Œå®ç°ç»„ä»¶çš„ <code>re-render</code>ï¼Œè¿™æ®µä»£ç å°±æ˜¯åœ¨ <code>useEffect</code> ä¸­</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="24,25,26,46"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> didUnsubscribe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">checkForUpdates</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// It's possible that this callback will be invoked even after being unsubscribed,</span>
    <span class="token comment">// if it's removed as a result of a subscription event/update.</span>
    <span class="token comment">// In this case, React will log a DEV warning about an update from an unmounted component.</span>
    <span class="token comment">// We can avoid triggering that warning with this check.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>didUnsubscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We use a state updater function to avoid scheduling work for a stale source.</span>
    <span class="token comment">// However it's important to eagerly read the currently value,</span>
    <span class="token comment">// so that all scheduled work shares the same value (in the event of multiple subscriptions).</span>
    <span class="token comment">// This avoids visual "tearing" when a mutation happens during a (concurrent) render.</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Ignore values from stale sources!</span>
      <span class="token comment">// Since we subscribe an unsubscribe in a passive effect,</span>
      <span class="token comment">// it's possible that this callback will be invoked for a stale (previous) subscription.</span>
      <span class="token comment">// This check avoids scheduling an update for that stale subscription.</span>
<span class="highlighted-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="highlighted-line">        prevState<span class="token punctuation">.</span>getCurrentValue <span class="token operator">!==</span> getCurrentValue <span class="token operator">||</span></span><span class="highlighted-line">        prevState<span class="token punctuation">.</span>subscribe <span class="token operator">!==</span> subscribe</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Some subscriptions will auto-invoke the handler, even if the value hasn't changed.</span>
      <span class="token comment">// If the value hasn't changed, no update is needed.</span>
      <span class="token comment">// Return state as-is so React can bail out and avoid an unnecessary render.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>value <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>prevState<span class="token punctuation">,</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>checkForUpdates<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Because we're subscribing in a passive effect,</span>
  <span class="token comment">// it's possible that an update has occurred between render and our effect handler.</span>
  <span class="token comment">// Check for this and schedule an update if work has occurred.</span>
<span class="highlighted-line">  <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    didUnsubscribe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>getCurrentValue<span class="token punctuation">,</span> subscribe<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>useEffect</code> ä¸­ä¼šè¿›è¡Œå€¼çš„æ¯”è¾ƒæ¥ä¼˜åŒ– <code>render</code>ï¼Œ å¦‚æœå€¼ä¸å‘ç”Ÿå˜åŒ–åˆ™ä¸è¿›è¡Œ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>value <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> prevState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¹¶ä¸”åœ¨ <code>getCurrentValue</code> å’Œ <code>subscribe</code> å‘ç”Ÿå˜åŒ–çš„æ—¶å€™åˆ™é‡æ–°æ‰§è¡Œ <code>useEffect</code>, æ€»çš„æ¥è¯´æºç éå¸¸ç®€å•ï¼Œé‚£ä¹ˆ <code>useSubscription</code> çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›å‘¢ï¼Ÿ
è¿™äº›åœ¨å®˜ç½‘ä¸Šéƒ½å·²ç»æ ‡è®°äº†å‡ºæ¥ã€‚<a href="https://github.com/facebook/react/blob/master/packages/use-subscription/src/__tests__/useSubscription-test.internal.js">ç‚¹å‡»æŸ¥çœ‹</a></p><h3 id="æ‰‹åŠ¨å®ç°ä¸€ä¸ª-usesubscription">æ‰‹åŠ¨å®ç°ä¸€ä¸ª useSubscription</h3><p>æˆ‘ä»¬å·²ç»çŸ¥é“äº† React æœ¬èº«çš„ <code>useSubscription</code> çš„äº‹æƒ…ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¦è‡ªå·±å®ç°ä¸€ä¸ªè¿™æ ·å½¢å¼çš„è®¢é˜…å‘¢ï¼Ÿé¦–å…ˆ <code>useSubscription</code> ç°åœ¨é€šå¸¸ç”¨äºçŠ¶æ€ç®¡ç†åº“ä¸­ï¼Œç±»ä¼¼çš„æœ‰ Redux çš„ <code>useSelector</code>,
ç›®å‰å…¶ä»–çš„ä¸€äº›åº“ä¹Ÿéƒ½å®ç°äº†ç±»ä¼¼çš„æ•ˆæœã€‚é‚£ä¹ˆä¸å¦¨å°±å®ç°ä¸€ä¸ªç±»ä¼¼çš„ä¹Ÿå«åš <code>useSelector</code></p><p>é¦–å…ˆå®šä¹‰è¿™ä¸ªå‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre><p>å…ˆè€ƒè™‘ä¸€ä¸‹ useSelector éœ€è¦åšä»€ä¹ˆï¼Œ <code>useSelector</code> éœ€è¦æ˜¯åœ¨ç›‘å¬çš„å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ¸²æŸ“è¿™ä¸ªç»„ä»¶ã€‚é€šè¿‡æ¸²æŸ“ä¸€ä¸ªç»„ä»¶æœ‰å¤šç§æ–¹å¼ï¼Œä¸å¦¨å†™ä¸€ä¸ª hook å«åš <code>useForceUpdate</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useForceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>update<span class="token punctuation">,</span> setUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">forceUpdate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setUpdate</span><span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> forceUpdate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æœ‰äº† <code>forceUpdate</code> åéœ€è¦å®ç°ä¸€ä¸ªå’Œ <code>useSubscription</code> ä¸€ä¸ªçš„ä¼˜åŒ–æ•ˆæœï¼Œå°±æ˜¯éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°ï¼Œ æˆ‘ä»¬ä¸åƒ <code>useSubscription</code> é‚£æ ·ç›´æ¥æš´éœ²ä¸€ä¸ªå«åš getCurrentValue çš„æ–¹æ³•ï¼Œå› ä¸º
<code>useSelector</code> æ˜¯ä¸ºäº†æ‹¿åˆ° <code>store</code> ä¸­çš„æ•°æ®ï¼Œåªæœ‰åœ¨ store ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰ä¼š <code>render</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token parameter">oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// value æ˜¯ä¸€ä¸ªæ•°ç»„</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue<span class="token punctuation">.</span>length <span class="token operator">!==</span> newValue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldValue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> newValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æœ‰äº†æ¯”è¾ƒå‡½æ•°åå°±å¯ä»¥å®ç° <code>useSelector</code>, <code>useSelector</code> éœ€è¦ç›‘å¬å™¨çš„å€¼æ˜¯ç”¨æˆ·ä¼ å…¥çš„ï¼Œé€šå¸¸ç”¨æˆ·éœ€è¦ç›‘å¬å™¨çš„å€¼æ˜¯å­˜å‚¨åœ¨ store ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™ <code>useSelector</code> ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œ
å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬çš„ <code>store</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token parameter">depFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€šè¿‡æŸä¸ª context è·å–åˆ° sunscribers</span>
  <span class="token keyword">const</span> subscribers <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> forceUpdate <span class="token operator">=</span> <span class="token function">useForceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depFnRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>depFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  depFnRef<span class="token punctuation">.</span>current <span class="token operator">=</span> depFn<span class="token punctuation">;</span>
  <span class="token keyword">const</span> depValueRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token function">depFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è¿™é‡Œæ˜¯ useEffect ä¸­çš„ è®¢é˜…å‡½æ•°</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¢é˜…å‡½æ•°å­˜å‚¨çš„æ˜¯ store, å¯ä»¥åœ¨ useSelector å†…éƒ¨ä½¿ç”¨ useContext() æ¥è·å–è¿™ä¸ª store</span>
    <span class="token keyword">function</span> <span class="token function">subscriber</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> depValueRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
      <span class="token keyword">const</span> newValue <span class="token operator">=</span> depFnRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compare</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœä¸ç›¸ç­‰åˆ™å¼ºåˆ¶æ›´æ–°</span>
        <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        depValueRef<span class="token punctuation">.</span>current <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    subscribers<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      subscribers<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é‚£ä¹ˆ <code>subscribers</code> æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ<code>subscribers</code> éœ€è¦æœ‰ <code>register</code> å’Œ <code>unregister</code> æ–¹æ³•</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useSubscriber</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> subscribersRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token parameter">subscriber</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    subscribersRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">unregister</span> <span class="token operator">=</span> <span class="token parameter">subscriber</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribersRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subscribersRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> subscriber <span class="token keyword">of</span> subscribersRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">subscriber</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> unregister <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™å°±æ˜¯ä¸€ä¸ª <code>useSubscriber</code>, å†…éƒ¨å®ç°äº†æ³¨å†Œå’Œå–æ¶ˆæ³¨å†Œçš„åŠŸèƒ½ã€‚é‚£ä¹ˆè¿™ä¸ª <code>useSubscriber</code> ä¸ºä»€ä¹ˆè¿˜æœ‰ä¸€ä¸ª <code>notify</code> åŠŸèƒ½å‘¢ï¼Ÿ <code>notify</code> çš„ä½œç”¨å°±æ˜¯æ‰§è¡Œæ¯ä¸€ä¸ª
ç›‘å¬å™¨å°±æ˜¯ <code>Redux</code> ä¸­çš„ <code>listener()</code> æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹åšçš„ <code>listener()</code>ã€‚</p><p>è¿™åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªå¾ˆåŸºç¡€çš„ <code>useSelector</code> å› ä¸ºä¸ºäº†ç®€ä¾¿æ‰€ä»¥ä¾èµ–äºçŠ¶æ€ç®¡ç†çš„ä¸€äº›å‚æ•°ï¼Œå¦‚æœè¦å®ç°ä»»æ„å€¼çš„ç›‘å¬ã€‚é‚£ä¹ˆä½¿ç”¨ React æœ¬èº«çš„ <code>useSubscription</code> å³å¯ã€‚ç›®å‰å¯ä»¥ç”¨äº
äº‹ä»¶çš„ç›‘å¬ç­‰ç­‰ã€‚è¿™ä¸ªå¯¹äºéå—æ§çš„è¡¨å•ä½œç”¨ä¼šæœ‰å¾ˆå¤§å¾ˆå¤§ã€‚</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[a thought about hook]]></title>
            <link>/posts/2019-11-23/a-thought-of-hook/</link>
            <guid>/posts/2019-11-23/a-thought-of-hook/</guid>
            <pubDate>Fri, 22 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>è¿™å‡ å¤©ä¸€ç›´å¿™äºå„ç§äº‹æƒ…ï¼Œä»”ç»†æ€è€ƒä¸€ä»¶äº‹çš„æ—¶é—´çœŸçš„ä¸æ˜¯å¾ˆå¤šï¼Œä½†æ˜¯ç”±äºä»Šå¤©å€¼ç­æ‰€ä»¥æ—¶é—´è¿˜æ˜¯åå¤šçš„ï¼Œåœ¨çœ‹å®Œäº†æƒ³çœ‹çš„æ–‡ç« æˆ–è€…åšå®¢åï¼Œå¼€å§‹äº†ç»§ç»­å†™æ‰‹åŠ¿è¿™ä¸€å—çš„ <code>Hook</code>,
æ°å¥½é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ç»è¿‡äº†æˆ‘ä»¬å†…éƒ¨è®¨è®ºå‡ºæœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼Œä¸¤ç§åŠæ³•éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå„æœ‰ä¼˜ç¼ºç‚¹ã€‚é‚£ä¹ˆä»Šå¤©é‡åˆ°çš„é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h1 id="ç›®å½•">ç›®å½•</h1><ul><li>é‡åˆ°çš„é—®é¢˜ï¼Ÿ</li><li>å¦‚ä½•è§£å†³</li><li>æ˜¯å¦è¿™æ ·çš„è§£å†³æ˜¯å¥½çš„, å¦‚ä½•é€‰æ‹©</li></ul><h2 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h2><p>ä¹‹å‰æˆ‘ä»¬çš„æ‰€æœ‰åº“éƒ½æ˜¯å¼€å¯äº† <a href="https://reactjs.org/docs/hooks-rules.html#eslint-plugin">react-hook-eslint-plugin</a>, é‡ç‚¹æ˜¯è¿™ä¸ªè§„åˆ™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token string">"react-hooks/exhaustive-deps"</span><span class="token punctuation">:</span> <span class="token string">"warn"</span>
</code></pre><p>æ­£å¥½æˆ‘è¿™æ¬¡çš„åº“æˆ‘å¿˜è®°å»å¼€å¯äº†å°±é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œç®€åŒ–ä¸€ä¸‹ä¾‹å­</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nodeRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä½¿ç”¨ nodeRef.current ä½œä¸ºä¾èµ–æ˜¯ä¸ºäº†å½“æœ‰èŠ‚ç‚¹çš„æ˜¯å¯ä»¥é‡æ–°æ‰§è¡Œ effect</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>nodeRef<span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getNode</span> <span class="token operator">=</span> <span class="token parameter">node</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    nodeRef<span class="token punctuation">.</span>current <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> getNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„è‡ªå®šä¹‰ hook, è¿™ä¸ª Hook æš´éœ²å‡ºäº†ä¸€ä¸ªå‡½æ•°å«åš <code>getNode</code>, ä½¿ç”¨è¿™ä¸ª <code>getNode</code> æŒ‚è½½åˆ°ä»»ä½•ä¸€ä¸ª <code>dom</code> èŠ‚ç‚¹ä¸Šï¼Œå½“ <code>node</code> å­˜åœ¨çš„æ—¶å€™æ‰§è¡Œä¸€äº›é€»è¾‘æ“ä½œ, é‚£ä¹ˆæ­¤æ—¶ä½¿ç”¨è¿™ä¸ª hook</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> getNode <span class="token operator">=</span> <span class="token function">useZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setVisible<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>visible <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>getNode<span class="token punctuation">}</span><span class="token operator">></span>node<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä»”ç»†çœ‹è¿™ä¸ª <code>Test</code>ï¼Œå› ä¸ºåœ¨é¡¶å±‚è°ƒç”¨äº† <code>useZoom</code>, æ­¤æ—¶å†…éƒ¨æ‹¿åˆ°çš„ <code>nodeRef.current = null</code>, æ‰€ä»¥ <code>console</code> ä¸ä¼šèµ°è¿™æ˜¯åˆç†çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶åœ¨ç‚¹å‡» <code>setVisible</code>, æ­¤æ—¶æ”¹å˜äº†
<code>visible</code>, node èŠ‚ç‚¹å°†ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œæ­¤æ—¶ getNode å°†ä¼šæ‹¿åˆ°æ­£ç¡®çš„ä¿¡æ¯ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡å°±æ˜¯ä¸ºä»€ä¹ˆå†…éƒ¨çš„ <code>console</code> ä»ç„¶æ²¡æœ‰æ‰“å°å‡ºæ¥ï¼Ÿï¼Ÿï¼Ÿè¿™è¯¥ä¸ä¼šæ˜¯ react çš„ bug å§
é‚£ä¹ˆä¸å¦¨åœ¨ <code>useEffect</code> ä¸­ç­”åº”ä¸€ä¸‹ä¿¡æ¯çœ‹çœ‹ï¼Œä¿®æ”¹ä¸‹ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nodeRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä½¿ç”¨ nodeRef.current ä½œä¸ºä¾èµ–æ˜¯ä¸ºäº†å½“æœ‰èŠ‚ç‚¹çš„æ˜¯å¯ä»¥é‡æ–°æ‰§è¡Œ effect</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>nodeRef<span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getNode</span> <span class="token operator">=</span> <span class="token parameter">node</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"node:"</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeRef<span class="token punctuation">.</span>current <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> getNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™ï¼Œåº”è¯¥åªä¼šæ˜¾ç¤º <code>render effect</code>ï¼Œ æ­¤æ—¶æˆ‘ä»¬ç‚¹å‡» <code>setVisible</code>, çœ‹ä¸€ä¸‹è¾“å‡º</p><div><img src="./static/media/1.42122356.png"/></div><p><a href="https://codesandbox.io/s/stoic-firefly-drrui">try it</a></p><p>å¯ä»¥çœ‹å‡º <code>render effect</code> åªè¾“å‡ºäº†ä¸€æ¬¡å¯¹ä¸å¯¹ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥‡æ€ªï¼Œæ˜æ˜ <code>nodeRef.current</code> å·²ç»ä¿®æ”¹äº†ï¼Œå¯æ˜¯ä¸ºå•¥è¿™é‡Œçš„ <code>effect</code> æ²¡æœ‰é‡æ–°æ‰§è¡Œå‘¢ï¼Ÿäºæ˜¯æˆ‘å°±å–Šäº†æˆ‘ä»¬ç»„çš„
<code>ç…œå¯’</code> è¿‡æ¥(æ­¤æ—¶æ—¶é—´æ¯”è¾ƒæ—©åªæœ‰ç…œå¯’æ¥å…¬å¸äº†)å¼€å¯<code>å°é»„é¸­</code>è°ƒè¯•æ³•ï¼Œç»“æœè¿˜æ˜¯æ²¡çœ‹å‡ºä»€ä¹ˆåŸå› ï¼Œä½†æ˜¯ç…œå¯’æå‡ºäº†ä¹‹å‰åœ¨ç»„ä»¶åº“é‡Œå¼€å¯äº† Hook è§„åˆ™ä½¿ç”¨ <code>ref</code> ä½œä¸ºä¾èµ–çš„æ—¶å€™æ˜¯æ— æ•ˆçš„ï¼Œ
æˆ‘å¿ƒé‡Œæƒ³åº”è¯¥ä¸ä¼šå§ï¼Œå»å¹´ <code>hook</code> åˆšå‡ºæ¥çš„æ—¶å€™æˆ‘å°è¯•è¿‡æ˜¯å¯ä»¥çš„å‘€ã€‚ç°åœ¨ä¸è¡Œäº†å˜›ã€‚äºæ˜¯æˆ‘å» condsandbox ä¸Šè¯•éªŒäº†ä¸€ä¸‹ï¼Œç»“æœä¼šæœ‰è¿™æ ·çš„æç¤º</p><div><img src="./static/media/2.a678357b.png"/></div><h2 id="å¦‚ä½•è§£å†³">å¦‚ä½•è§£å†³</h2><p>è¿™ä¸ªè§„åˆ™æ˜ç¡®æç¤ºäº† <code>ref</code> ä½œä¸ºä¾èµ–æ˜¯æ— æ•ˆçš„ï¼Œè‚¯å®šæ˜¯ <code>React</code> å†…éƒ¨åšäº†å¤„ç†ï¼Œè‡³äºåšäº†ä»€ä¹ˆå¤„ç†ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªå¤„ç†ï¼Œè¿™ä¸ªåœ¨è¿™é‡Œå…ˆä¸è®¨è®ºã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“é—®é¢˜å‡ºè‡ªå“ªé‡Œäº†ï¼Œå°±æ˜¯ä¸èƒ½æŠŠ <code>ref</code>
ä½œä¸ºä¾èµ–ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•ä¿®æ”¹å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬çš„ç›®çš„å¾ˆç®€å•å°±æ˜¯å½“ <code>node</code> å˜åŒ–æ—¶å€™é‡æ–° <code>re-render</code> è·å–åˆ°æ–°çš„èŠ‚ç‚¹ç„¶ååšä¸€äº›é€»è¾‘ã€‚é‚£ä¹ˆå¯ä»¥è¿™æ ·ä¿®æ”¹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="2,13,14,15"><span class="token keyword">function</span> <span class="token function">useZoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>node<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render zoom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä½¿ç”¨ nodeRef.current ä½œä¸ºä¾èµ–æ˜¯ä¸ºäº†å½“æœ‰èŠ‚ç‚¹çš„æ˜¯å¯ä»¥é‡æ–°æ‰§è¡Œ effect</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line">  <span class="token keyword">const</span> <span class="token function-variable function">getNode</span> <span class="token operator">=</span> <span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="highlighted-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">      <span class="token function">setState</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"node:"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> getNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><a href="https://codesandbox.io/s/stoic-firefly-drrui">try it</a></p><p>é¦–å…ˆè¿™é‡Œæœ‰å‡ ä¸ªé‡è¦çš„ç‚¹ç¬¬ä¸€ä¿®æ”¹ <code>useRef</code> å˜æˆ <code>useState</code>, ç¬¬äºŒè¦æ³¨æ„çš„å°±æ˜¯åœ¨ <code>getNode</code> å¤„ï¼Œåœ¨ <code>getNode</code> é‡Œéœ€è¦ä¿¡æ¯åˆ¤æ–­ï¼Œå› ä¸ºä¸åˆ¤æ–­å°±ä¼šé€ æˆæ­»å¾ªç¯(åœ¨ class é‡Œçš„è¯)ï¼Œå› ä¸ºæ¯æ¬¡ setState, éƒ½ä¼š
é€ æˆ <code>re-render</code>, ä¸‹æ¬¡åˆ <code>setState</code>, ä½†æ˜¯å› ä¸ºæ­¤æ—¶æ˜¯åœ¨ <code>function component</code> ä¸­ï¼Œæ‰€ä»¥ä¼šåš <code>Object.is</code> æ¯”è¾ƒï¼Œæ­»å¾ªç¯çš„é—®é¢˜ä¸ä¼šå­˜åœ¨ï¼Œä½†æ˜¯æœ€å¥½è¿›è¡Œåˆ¤æ–­, å†æ¬¡çœ‹ä¸€ä¸‹è¾“å‡º</p><div><img src="./static/media/3.f928f31b.png"/></div><p>ä»è¾“å‡ºä¸­å¯ä»¥å¯¼å‡ºï¼Œ <code>useEffect</code> æ‰§è¡Œäº† 2 æ¬¡ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæœ‰ä¸€æ¬¡è¾“å‡ºçš„ <code>node: null null</code>, è¿™ä¸ªæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šã€‚åé¢ä¼šæ¢è®¨ä¸€ä¸‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ã€‚</p><h2 id="æ˜¯å¦è¿™æ ·çš„è§£å†³æ˜¯å¥½çš„-å¦‚ä½•é€‰æ‹©">æ˜¯å¦è¿™æ ·çš„è§£å†³æ˜¯å¥½çš„, å¦‚ä½•é€‰æ‹©</h2><p>çœ‹ä¸Šé¢çš„ä»£ç ä»¥åŠè¾“å‡ºæ˜¯å·²ç»è§£å†³äº†é—®é¢˜ï¼Œå¯¹ä¸å¯¹ï¼Ÿé‚£ä¹ˆæ˜¯å¦è¿™æ ·è§£å†³å°±æ˜¯æœ€åˆç†çš„å‘¢ï¼Ÿæˆ‘æå‡ºäº†è¿™ä¸ªé—®é¢˜åœ¨æˆ‘ä»¬ç»„é‡Œé¢è¿›è¡Œäº†æ¿€çƒˆçš„è®¨è®ºã€‚å¯¹äºè¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§ä¸åŒçš„æ–¹æ¡ˆï¼Œé¦–å…ˆæŒ‰ç…§ <code>react</code> çš„æ¨¡å¼æ¥è¯´ï¼Œå¯¼è‡´
è¿™ä¸ª <code>node</code> æ”¹å˜çš„åŸå› æ˜¯ <code>visible</code> çš„æ”¹å˜å¯¹ä¸å¯¹ï¼Ÿå¹¶ä¸æ˜¯å…¶ä»–çš„ä¸œè¥¿å¯¼è‡´çš„(å½“ç„¶äº†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ä¸€äº›å±æ€§å¯¼è‡´çš„)ï¼Œé‚£ä¹ˆæ—¢ç„¶æ˜¯ <code>visible</code> å¯¼è‡´çš„ä¸ºä»€ä¹ˆä¸æŠŠ <code>visible</code> ä½œä¸ºä¾èµ–å‘¢ï¼Ÿè¿™æ˜¯ <code>æ¡ƒå¤­</code> å°å§å§
è¯´çš„ï¼Œå¯¹è¿™ä¸ªæ²¡æœ‰é—®é¢˜ï¼Œç”±äºä»€ä¹ˆåŸå› å¼•èµ·çš„å°±åº”è¯¥æŠŠè¿™ä¸ªåŸå› ä½œä¸ºä¾èµ–ï¼Œä½†æ˜¯åœ¨ <code>useZoom</code> çš„å†…éƒ¨å¥½åƒå¹¶ä¸çŸ¥é“è¿™ä¸ª <code>visible</code> æ˜¯ä»€ä¹ˆï¼ŸåªçŸ¥é“è¿™ä¸ª <code>node</code> æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ª node å°±æ˜¯ <code>visible</code> æ”¹å˜å¯¼è‡´çš„ç»“æœ</p><p>æ—¢ç„¶ä¸çŸ¥é“ visible æ˜¯ä»€ä¹ˆä¹Ÿä¸èƒ½æŠŠ <code>visible</code> ä¼ å…¥åˆ° <code>useZoom</code> ä¸­ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥æŠŠè¿™ä¸ª node çš„æ”¹å˜äº¤ç»™ç”¨æˆ·å‘¢ï¼Ÿè¿™å°±æ˜¯æŠŠä¹‹å‰å¤„ç†çŠ¶æ€çš„æ”¹å˜äº¤ç»™äº†ç”¨æˆ·è€Œä¸æ˜¯æ¡†æ¶å†…éƒ¨ï¼Œç±»ä¼¼äº <code>&#x27;æ§åˆ¶åè½¬&#x27;</code> äº†ã€‚æ­¤æ—¶
<code>useZoom</code> ä¸åœ¨å­˜å‚¨ <code>node</code> èŠ‚ç‚¹ï¼Œç°åœ¨ node èŠ‚ç‚¹æœ‰ç”¨æˆ·ä¼ å…¥è¿›æ¥ã€‚ä¸å¦¨ä¿®æ”¹ä¸€ä¸‹ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">useZoom</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render zoom"</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä½¿ç”¨ nodeRef.current ä½œä¸ºä¾èµ–æ˜¯ä¸ºäº†å½“æœ‰èŠ‚ç‚¹çš„æ˜¯å¯ä»¥é‡æ–°æ‰§è¡Œ effect</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨ <code>useZoom</code> çš„ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useZoom</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setVisible<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>visible <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">></span>node<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><a href="https://codesandbox.io/s/stoic-firefly-drrui">try it</a></p><p>æ­¤æ—¶ç‚¹å‡» <code>setVisible</code>, å‘ç°æ²¡æœ‰ render, è¿™æ˜¯æ­£å¸¸çš„å› ä¸º <code>Test</code> ç»„ä»¶ <code>re-render</code> çš„æ—¶å€™ï¼Œæ­¤æ—¶ <code>ref.current</code> ä»ç„¶æ˜¯ null, æ‰€ä»¥ä»ç„¶æ˜¯ä¸å¯è¡Œçš„ã€‚</p><div><img src="./static/media/4.7d7dab29.png"/></div><p>é‚£ä¹ˆåœ¨ä¿®æ”¹ä¸‹ä¾‹å­å§</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="10,11,12,13,14,15,16"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>node<span class="token punctuation">,</span> setNode<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useZoom</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setVisible<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>visible <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
<span class="highlighted-line">        <span class="token operator">&lt;</span>div</span><span class="highlighted-line">          ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="highlighted-line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!==</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="highlighted-line">              <span class="token function">setNode</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="highlighted-line">            <span class="token punctuation">}</span></span><span class="highlighted-line">          <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="highlighted-line">        <span class="token operator">></span></span>          node
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><a href="https://codesandbox.io/s/stoic-firefly-drrui">try it</a></p><div><img src="./static/media/5.4c916022.png"/></div><p>æ­¤æ—¶å‘ç°ä¸šåŠ¡ä»£ç å¤„ç†å°†å˜å¾—å¾ˆå¤æ‚ã€‚å¦‚æœä¸åœ¨ ref é‡Œé¢ setNode, é‚£ä¹ˆå°±éœ€è¦è®°ä½èŠ‚ç‚¹åœ¨ effect é‡Œé¢ setNode, æ‰€ä»¥è¿™æ ·å°†ä¼šå¢åŠ ä½¿ç”¨çš„éš¾åº¦ï¼Œè¿™æ ·çš„<code>åè½¬</code>æ˜¯æ— æ„ä¹‰çš„ã€‚</p><h2 id="conclusion">conclusion</h2><p>å½“éœ€è¦ç”¨åˆ° ref è¿™æ ·çš„ api çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹å‡ºäº¤ç»™ç”¨æˆ·å¤„ç†æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§åœºæ™¯æœ€å¥½å†…ç½®çš„å¯¹åº”çš„ <code>Hook</code> é‡Œé¢ã€‚<em>åŒæ—¶è¦æ³¨æ„ <code>ref</code> ä¸èƒ½ä½œä¸ºä¾èµ–ï¼ï¼ï¼</em></p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[how to study]]></title>
            <link>/posts/2019-11-24/how-to-study/</link>
            <guid>/posts/2019-11-24/how-to-study/</guid>
            <pubDate>Sat, 23 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>è¿™å‡ å¤©åœ¨çœ‹ twitter çš„æ—¶å€™çœ‹åˆ°äº† React çš„ä½œè€…æ˜¯å¦‚ä½•çªç ´è‡ªå·±çš„ä»¥åŠå¦‚ä½•åœ¨æ–°çš„é¢†åŸŸé‡Œåšåˆ°éšæœºåº”å˜çš„ã€‚æ‰€ä»¥æœ‰æ‰€æƒ³æ³•ï¼Œæ­£å¥½å°±åœ¨è¿™ç¯‡åšå®¢é‡Œè®°ä¸‹æ¥å§</p><p>ä»¥æˆ‘è‡ªå·±çš„æ¥ä¸¾ä¸ªä¾‹å­å§ã€‚æ¯”å¦‚åœ¨å‰å‡ ä¸ªå…¬å¸éœ€è¦å¼€å‘ä¸€ä¸ª <code>sketch</code> æ’ä»¶ï¼Œè€Œæˆ‘å¯¹è¿™ä¸ªæ˜¯å®Œå…¨ä¸çŸ¥é“çš„ï¼Œå»ç½‘ä¸ŠæŸ¥çœ‹äº†å¾ˆå¤šçš„èµ„æ–™éƒ½æ˜¯ <code>OC</code> å†™çš„ï¼Œæ­¤æ—¶æˆ‘çš„å¿ƒé‡Œä¸ç”±çš„äº§ç”Ÿäº†
é€€å´ï¼Œæˆ‘æƒ³è¿™ä¸ªæ–¹å‘æˆ‘ä¸€ç‚¹éƒ½ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥å°±ç»™äº§å“åŒå­¦æå‡ºäº†å¦ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯ç”¨ app æ¥ä»£æ›¿ï¼Œå› ä¸ºç°åœ¨å¯ä»¥ä½¿ç”¨ js æ¥å¼€å‘ app, æœ¬æ¥è¿™ä¸ªåŠŸèƒ½å°±ä¸æ˜¯å¾ˆå¤æ‚ï¼Œé‚£åšèµ·æ¥åº”è¯¥å¾ˆå¿«å§ã€‚</p><p>æ˜¯çš„ï¼Œäº§å“å› ä¸ºå¯¹è¿™å—ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ‰€ä»¥äº§å“ä¹ŸåŒæ„äº†æˆ‘çš„æƒ³æ³•ï¼Œç”±äºé¡µé¢çš„è§†è§‰ä¼˜å…ˆå‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘å°±å…ˆå»å¼€å‘é¡µé¢äº†ã€‚åæ¥åœ¨ä¸ç»„å†…çš„åŒå­¦è¿›è¡Œäº¤æµçš„æ—¶å€™ï¼Œä»–ä»¬è¯´ï¼š ç°åœ¨å¼€å‘ app, å¦‚æœåé¢è¿˜è¦å¼€å‘
è¿™æ ·çš„æ’ä»¶ä¸ºä»€ä¹ˆä¸ç›´æ¥å¼€å‘å‘¢ï¼Ÿæˆ‘å½“æ—¶æ˜¯è¿™æ ·è¯´çš„ï¼š å› ä¸ºæˆ‘å¯¹ sketch å®Œå…¨ä¸ç†Ÿæ‚‰ï¼Œå¹¶ä¸”æœ‰æ—¶ <code>OC</code>, å¯¹äºè¿™ä¸ªè¯­è¨€ä¹Ÿæ˜¯æ²¡çœ‹è¿‡ï¼Œé‚£ç›¸å½“äºä» 0 å¼€å§‹ï¼Œè¿™æ ·ä¼šå¾ˆæ…¢å¾ˆæ…¢ã€‚æ‰€ä»¥ç”±äºè¿™äº›åŸå› æˆ‘äº§ç”Ÿäº†é€€å´æ„Ÿã€‚
æˆ‘ä¸æƒ³åœ¨æµªè´¹å¤ªå¤šæ—¶é—´å»å­¦ä¹ ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œè¿™æ ·ä¸ä»…æµªè´¹æ—¶é—´ï¼Œä¹Ÿä¼šå»¶è¿Ÿè¿›åº¦ã€‚åæ¥ç»„å†…åŒå­¦è¯´æœäº†æˆ‘ï¼Œæ— è®ºæ€ä¹ˆæ ·æ—¢ç„¶åé¢ä¸€å®šè¦å¼€å‘çš„ï¼Œæ™šç—›ä¸å¦‚æ—©ç—›ã€‚æ˜¯çš„ï¼Œæˆ‘è§‰å¾—ä»–ä»¬è¯´çš„æ˜¯å¯¹çš„ï¼Œæ‰€ä»¥åœ¨é‚£ä¸€æ®µæ—¶é—´å†…
æˆ‘å¼€å§‹å¤§é‡çš„æ˜¯çœ‹ sketch çš„æ–‡æ¡£ä»¥åŠç›¸å…³çš„æ’ä»¶å…·ä½“æ˜¯æ€ä¹ˆå†™çš„ï¼Œä»¥åŠå‘å¸ƒã€æ„å»ºçš„æµç¨‹ã€‚</p><p>å› ä¸º sketch æ˜¯ä¸€ä¸ªæ–°çš„ï¼Œåæ¥å‘ç° sketch ä¹Ÿå¯ä»¥ä½¿ç”¨ js å¼€å‘ï¼Œå“‡ï¼Œå¾ˆå¼€å¿ƒã€‚ä½†æ˜¯ sketch çš„ api å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæ ¹æœ¬è®°ä¸ä½ã€‚æ‰€ä»¥æˆ‘å°±ä¸æ–­çš„å»é‡å¤çœ‹æ–‡æ¡£ï¼Œä¸æ–­çš„å»çœ‹ï¼Œååå¤å¤çœ‹äº†è‡³å°‘ 5ï¼Œ6 éæ‰è®°ä½ç›¸å…³
api çš„ä½ç½®ä»¥åŠä¸€äº›ç”¨æ³•ã€‚å…·ä½“å±æ€§è¿˜æ˜¯æ¯æ¬¡å¼€å‘çš„æ—¶å€™æ‰“å¼€å»çœ‹ã€‚</p><p>åœ¨è¿™é‡Œæœ‰ä¸ªç‚¹æˆ‘æƒ³è¯´çš„æ˜¯ä¸å…¶ç©ºæ‰‹æ’¸ä»£ç ï¼Œä¸å¦‚å»çœ‹æ–‡æ¡£ã€‚æˆ‘åœ¨ä¸€ä¸ªæŠ€æœ¯ç¾¤é‡Œé¢ï¼Œæœ‰ä¸ªåŒå­¦å°±ä¸€ç›´é—®æ–‡æ¡£ä¸Šéƒ½è¯´è¿‡çš„é—®é¢˜ï¼Œæˆ‘å‘Šè¯‰ä»–å¦‚ä½•è§£å†³ï¼Œç„¶åé—®ä»–ä½ ä¸ºä»€ä¹ˆä¸å…ˆå»çœ‹æ–‡æ¡£å‘¢ï¼Ÿä»–è¯´ï¼šä»–ä¸æƒ³çœ‹ï¼Œä»–å°±æ˜¯æƒ³ç›´æ¥æ’¸ä»£ç ï¼Œæ’¸ä»£ç åˆä¸æ˜¯
æ’¸çŒ«ä¸Šæ‰‹å°±èƒ½æ’¸ã€‚å¯æ˜¯ä½ æ–‡æ¡£éƒ½ä¸çœ‹å°±å»ç›´æ¥æ’¸ï¼Œè¿™æ ·çš„æ—¶é—´å¯èƒ½æ˜¯ä½ çœ‹è¿‡æ–‡æ¡£å†å»æ’¸ä»£ç çš„å‡ å€éƒ½ä¸æ­¢ã€‚</p><p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘æƒ³è¯´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šåœ¨å­¦ä¹ ä¸€ä¸ªæ–°çš„çŸ¥è¯†ç‚¹çš„æ—¶å€™ï¼Œ<code>å…ˆå»çœ‹ä¸€éå®˜ç½‘æ–‡æ¡£</code>ï¼Œå¯èƒ½çœ‹å®˜ç½‘æ–‡æ¡£ä¼šèŠ±è´¹ä½ å‡ ä¸ªå°æ—¶ç”šè‡³ä¸€å¤©çš„æ—¶é—´æˆ‘è®¤ä¸ºéƒ½æ˜¯å€¼å¾—çš„ï¼Œè¿™æ ·ä½ å†æ¬¡å¼€å‘çš„æ—¶å€™å°±å…·æœ‰äº†ä¸€ç‚¹çš„çŸ¥è¯†å‚¨å¤‡æ¥åº”å¯¹ï¼Œä¸ç„¶ä»€ä¹ˆéƒ½ä¸æ‡‚ç›´æ¥å»
çœ‹åˆ«äººçš„ä¾‹å­å°±å»å†™ä»£ç ï¼Œæ˜¯çš„ï¼Œä½ æŠŠä»£ç å†™å‡ºæ¥äº†ï¼Œå¯æ˜¯ä½ å†™çš„ä»£ç çœŸçš„æ˜¯å¥½çš„ä»£ç å—ï¼ŸçœŸçš„ä¸ä¼šå¼•èµ· bug å—ï¼Ÿæˆ‘çœ‹è¿‡é‚£ä½åŒå­¦çš„ä»£ç ï¼Œåœ¨ <code>React</code> ä¸­è¿˜é‡‡ç”¨ <code>Jquery</code> çš„å†™æ³•æ¥å†™ä»£ç ã€‚å¦‚æœçœ‹ä¸€éæ–‡æ¡£æˆ‘è§‰å¾—å®Œå…¨ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜å§ã€‚
è¿˜æœ‰ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œæˆ‘ç›¸ä¿¡å†™è¿‡ React çš„éƒ½çŸ¥é“åœ¨ç”¨ useState è¿”å›çš„ set å‡½æ•°ä¸­ä¼šè¿›è¡Œ <code>Object.is</code> æ¯”è¾ƒï¼Œå½“æ—¶é‚£ä½åŒå­¦ç»„ä»¶ä¸ä¼š <code>render</code>, å°±ä¸€ç›´ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä»–æ˜¯è¿™æ ·å†™çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token punctuation">[</span>list<span class="token punctuation">,</span> setList<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">updateXxx</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ˜¯çš„è¿™ä¸ªåœ¨ class ä¸­æ˜¯ä¼š <code>re-render</code> çš„ï¼Œå¦‚æœæ˜¯ <code>PureComponent</code>, ç…§æ ·ä¼šæœ‰é—®é¢˜ã€‚è¿™äº›åœ¨å®˜ç½‘ä¸­éƒ½è¯´çš„éå¸¸æ¸…æ¥šäº†ã€‚ç»“æœå› ä¸ºè¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼Œæ­»æ´»æ‰¾ä¸åˆ°åŸå› ï¼Œ debug å‡ ä¸ªå°æ—¶è¿˜æ˜¯ä¸çŸ¥é“åªèƒ½å¯»æ±‚å¤§å®¶å¸®åŠ©ã€‚å¦‚æœçœ‹äº†å®˜ç½‘çš„ä»‹ç»æœ‰äº†ä¸€ç‚¹çš„çŸ¥è¯†
å‚¨å¤‡è¿™ä¸ªé—®é¢˜ä¸ä¼šå‡ºç°çš„ã€‚</p><p>æ‰€ä»¥è¿™å°±æ˜¯æˆ‘æƒ³è¯´çš„ç¬¬ä¸€ä¸ªï¼Œ<code>åœ¨å­¦ä¹ æ–°çš„é¢†åŸŸçš„æ—¶å€™æœ€å¥½å…ˆå»çœ‹ä¸€éå®˜ç½‘ï¼Œäº†è§£ä¸€ä¸‹çŸ¥è¯†ç‚¹åœ¨å»å†™ä¼šæ›´å¥½</code></p><p>çœ‹äº†å®˜ç½‘çš„ä»‹ç»å†™åŸºæœ¬çš„ä»£ç è‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œé€šå¸¸åœ¨åšä¸€ä¸ªæ–°çš„é¢†åŸŸçš„æ—¶å€™ï¼Œéœ€æ±‚ä¹Ÿéƒ½æ˜¯ç›¸å¯¹ç®€å•çš„åæ¥ä¼šæ…¢æ…¢çš„å˜å¾—å¤æ‚ï¼Œé‚£ä¹ˆå¯èƒ½åªæœ‰å®˜ç½‘çš„æ˜¯ä¸å¤Ÿçš„ï¼Œæ­¤æ—¶å°±å¯ä»¥å»å‚è€ƒåˆ«äººçš„ä»£ç ï¼Œgithub ä¸Šæœ‰å¤ªå¤šè¿™æ ·çš„ä»£ç ï¼Œéƒ½å¯ä»¥å» clone å­¦ä¹ å¦‚ä½•å»ç»„ç»‡ä»¥åŠå¦‚ä½•å»å†™ã€‚
ä½†æ˜¯å³ä½¿è¿™æ ·æˆ‘ç›¸ä¿¡(åŒ…æ‹¬æˆ‘)å¾ˆå¤šäººä¹Ÿéƒ½æ˜¯å†™ä¸å‡ºæ¥ï¼Œå¾ˆå¤šæ—¶å€™åœ¨çœ‹ä»£ç çš„æ˜¯å¿ƒé‡Œä¼šæƒ³ï¼Œå“‡è¿™ä¸ªä»£ç å†™çš„å¾ˆç®€å•å˜›ã€‚æˆ‘ä¸Šæˆ‘ä¹Ÿè¡Œã€‚æ˜¯çš„ï¼Œåˆ«äººçš„ä»£ç çœ‹èµ·æ¥å¾ˆç®€å•ã€‚ä½†æ˜¯å½“è‡ªå·±å¼€å§‹å†™çš„æ—¶å€™çœŸçš„èƒ½å†™å‡ºæ¥å—ï¼Ÿ</p><p>æˆ‘ç»å¸¸ä¼šåœ¨ github ä¸Šå†™ä¸€äº›å°é¡¹ç›®ï¼Œå…¶å®å¹¶ä¸æ˜¯è¯´æˆ‘æƒ³ç€è¿™ä¸ªé¡¹ç›®ç¬é—´èƒ½å‡ºåï¼Œæœ‰å¾ˆå¤šäººä¼šå»ç”¨ã€‚æˆ‘æƒ³çš„æ˜¯é€šè¿‡è‡ªå·±å»å†™æ¥é”»ç‚¼è¿™ä¸ªèƒ½åŠ›ã€‚çœ‹æ‡‚å¹¶ä¸€å®šæ˜¯çœŸçš„æ‡‚ï¼Œå†™å‡ºæ¥å®Œå…¨ç†è§£äº†æ‰æ˜¯çœŸçš„æ‡‚ã€‚å½“ä½ å¼€å§‹å»å†™çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°å¾ˆå¤šé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªä»£ç ä¸€å®šè¦åœ¨è¿™é‡Œï¼Œåœ¨è¿™é‡Œ
æœ‰ä»€ä¹ˆå¥½å¤„éƒ½ä¼šè¢«æŒ–æ˜å‡ºæ¥ã€‚è¿™æ ·ä½ å°±èƒ½å¾ˆå®¹æ˜“ç†Ÿæ‚‰è¿™ä¸€å—ã€‚</p><p>æ‰€ä»¥æˆ‘ç¬¬äºŒä¸ªæƒ³è¯´çš„å°±æ˜¯ï¼š <code>çœ‹æ‡‚ä¸ä¸€å®šæ˜¯çœŸçš„æ‡‚ï¼Œè¦å†™å‡ºæ¥</code></p><p>é‚£ä¹ˆæ˜¯å¦å†™å‡ºæ¥å°±çœŸçš„è¶³å¤Ÿäº†å—ï¼Ÿ è¦ä¹äºäº¤æµå’Œåˆ†äº«ï¼Œå½“ä½ æ‡‚äº†ä¸€ä¸ªçŸ¥è¯†ç‚¹çš„æ—¶å€™ï¼Œä½ è§‰å¾—ä½ æ‡‚äº†ã€‚ä½†æ˜¯å¦‚æœä½ èƒ½è®²å‡ºæ¥ï¼ŒæŠŠå®Œå…¨ä¸æ‡‚çš„äººè®²æ‡‚äº†è¿™æ‰æ˜¯çœŸçš„æ‡‚ï¼Œè¯´æ˜çœŸçš„å·²ç»æ·±å…¥äº†ï¼Œå®Œå…¨ç†è§£å†…éƒ¨çš„åŸç†äº†ã€‚æ‰€ä»¥åœ¨å¤§å®¶å­¦ä¹ å®Œä¸€ä¸ªçŸ¥è¯†ç‚¹çš„æ—¶å€™è¦æ£€éªŒè‡ªå·±æ˜¯å¦çœŸçš„æ‡‚çš„è¯å°±å­¦ä¼šäº¤æµ
å’Œåˆ†äº«ã€‚äº¤æµå¯ä»¥å’Œè‡ªå·±çš„æœ‹å‹æˆ–è€…åŒäº‹æ¥äº¤æµï¼ŒæŠŠä½ å­¦ä¹ åˆ°çš„å’Œä»–ä»¬è¯´ï¼Œå¦‚æœä½ æŠŠä»–ä»¬éƒ½è®²æ‡‚äº†ï¼Œé‚£å°±å®Œå…¨æ²¡æœ‰é—®é¢˜äº†ã€‚ä½ å¯èƒ½ä¼šè¯´ä¸ä¸€å®šæœ‰é‚£ä¹ˆå¤šæ—¶é—´å»äº¤æµï¼Œåˆ«äººä¹Ÿä¸ä¸€å®šä¼šæœ‰ç©ºæ¥å¬ä½ æ¥äº¤æµã€‚é‚£ä¹ˆä¸å¦‚æ¥ä¸€æ¬¡åˆ†äº«ã€‚æ¯ä¸ªå…¬å¸çš„å›¢é˜Ÿä¸€èˆ¬éƒ½ä¼šæœ‰åˆ†äº«è¿™ç§ä¼šè®®ï¼Œ
å¯ä»¥åˆ†äº«è‡ªå·±å­¦åˆ°çš„ï¼Œä¹Ÿå¯ä»¥åˆ†äº«è‡ªå·±çš„ç»éªŒã€‚åˆ†äº«çš„ä¸œè¥¿ä¸åœ¨äºæœ‰å¤šå°‘è€Œåœ¨äºèƒ½å¦æŠŠä¸€ä»¶äº‹æƒ…è¯´æ¸…æ¥šã€‚å³ä½¿ä½ åˆ†äº«è®²äº†ä¸¤ä¸ªå°æ—¶ï¼Œä½†æ˜¯å°±æŠŠè¿™ä¸€ä»¶äº‹è¯´çš„å¾ˆæ¸…æ¥šä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœæ¯ä»¶äº‹éƒ½æ˜¯ä¸€ç¬”å¸¦è¿‡ï¼Œé‚£ä¹ˆå³ä½¿åˆ†äº« 100 æ¬¡åˆæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿæ‹¿æˆ‘æ¥è¯´å§ï¼Œæˆ‘ç°åœ¨è¿˜æ˜¯
å±äºç¬¬äºŒç§çš„æƒ…å†µï¼Œæ­£åœ¨å‘ç¬¬ä¸€ç§æ¥è¿‡åº¦ã€‚</p><p>é‚£ä¹ˆæ­¤æ—¶æœ‰çš„äººä¼šé—®ï¼Œåˆ°åº•æ˜¯å…ˆç²¾åå¹¿ï¼Œè¿˜æ˜¯å…ˆå¹¿åœ¨ç²¾ã€‚æˆ‘çš„æƒ³æ³•å°±æ˜¯æƒ³æ·±å…¥ä¸€é—¨æ— è®ºä½ æ˜¯å†™ä»£ç çš„ï¼Œè¿˜æ˜¯å…¶ä»–çš„æŠ€æœ¯é¢†åŸŸã€‚æœ€å¥½éƒ½æ˜¯å…ˆæ·±å…¥ä¸€é—¨ï¼ŒæŠŠè¿™ä¸€é¡¹æŠ€æœ¯åšçš„éå¸¸å¥½äº†ï¼Œå†å»è¿›è¡Œå¹¿åº¦ã€‚è¿™æ ·æ— è®ºå¦‚ä½•ä½ éƒ½åº”å¯¹å…¶ä¸­ä¸€é¡¹æŠ€æœ¯çš„å˜æ›´ã€‚</p><p>æ‰€ä»¥æˆ‘ç¬¬ä¸‰ä¸ªæƒ³è¯´çš„å°±æ˜¯ï¼š<code>è¦ä¹äºåˆ†äº«å’Œäº¤æµ</code></p><p>å¤§å®¶å‘¨æœ«æ„‰å¿«</p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[dev sketch]]></title>
            <link>/posts/2019-11-26/dev-sketch/</link>
            <guid>/posts/2019-11-26/dev-sketch/</guid>
            <pubDate>Mon, 25 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«ä¸€ä¸‹ sketch æ’ä»¶å¼€å‘çš„ä¸€äº›ç»éªŒå’Œå¿ƒå¾—ã€‚</p><p>åœ¨æ”¶åˆ°ä»»åŠ¡è¦å¼€å‘ sketch æ’ä»¶çš„æ—¶å€™å°±å¤§é‡çš„å»å¯»æ‰¾èµ„æ–™ã€‚ä½†æ˜¯å‘ç° github ä¸Šå¾ˆå¤šéƒ½æ˜¯ç”¨ <code>OC</code> å’Œ <code>JS</code> æ··åˆå†™çš„ã€‚ä½†æ˜¯å› ä¸ºæˆ‘æ²¡å¤šå°‘æ—¶é—´å»å­¦ä¹  <code>OC</code> çš„å†™æ³•ï¼Œ
å¹¶ä¸”åœ¨ <code>sketch</code> <a href="https://developer.sketch.com/">å®˜ç½‘</a>ä¸Šä¹Ÿè¯´äº†ã€‚<code>sketch</code> å‡çº§çš„æ—¶å€™æœ‰å¯èƒ½å†…éƒ¨çš„ <code>api</code> ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä½†æ˜¯æš´éœ²å‡ºå»çš„ <code>js api</code> åŸºæœ¬æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚
æ‰€ä»¥æœ€ç»ˆå†³å®šå…¨éƒ¨é‡‡ç”¨ <code>js</code> çš„å†™æ³•ã€‚</p><h2 id="ç›®å½•">ç›®å½•</h2><ul><li>sketch å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜<ul><li>å¦‚ä½•å®šä¹‰èœå•</li><li>å¦‚ä½•è§¦å‘ action</li><li>å¦‚ä½•æ„å»º webview</li><li>webview ä¸ sketch æ˜¯å¦‚ä½•é€šä¿¡çš„</li><li>ç¯å¢ƒé…ç½®</li><li>æ„å»º</li><li>å‘å¸ƒ</li></ul></li><li>å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜</li></ul><h3 id="å¦‚ä½•å®šä¹‰èœå•">å¦‚ä½•å®šä¹‰èœå•</h3><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ sketch æ’ä»¶çš„æ—¶å€™ç»å¸¸ä¼šçœ‹åˆ°è¿™äº›èœå•ã€‚æ¯”å¦‚ antd çš„ <code>kitchen</code> æ’ä»¶ã€‚æ‰€æœ‰çš„æ’ä»¶éƒ½å¯ä»¥<a href="https://github.com/sketchplugins/plugin-directory">åœ¨è¿™é‡Œæ‰¾åˆ°</a></p><div><img src="./static/media/1.f12b94d3.jpg"/></div><p>è¿™æ˜¯ä¸€ä¸ªæ’ä»¶çš„å·¥å…·æ ã€‚é‚£ä¹ˆè¿™ä¸ªå·¥å…·æ æ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„å‘¢ï¼Ÿåœ¨ sketch ä¸­æœ‰ä¸€ä¸ªå«åš <code>manifest.json</code> çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ’ä»¶ä¸­å¯ä»¥å®šä¹‰è¿™æ ·çš„ä¸€ç³»åˆ—èœå•ã€‚çœ‹ä¸‹ antd çš„ <code>manifest.json</code> çš„
å®šä¹‰ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token string">"commands"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"action.js"</span><span class="token punctuation">,</span>
      <span class="token string">"handlers"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"actions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">"Startup"</span><span class="token punctuation">:</span> <span class="token string">"onStartup"</span><span class="token punctuation">,</span>
          <span class="token string">"Shutdown"</span><span class="token punctuation">:</span> <span class="token string">"onShutdown"</span><span class="token punctuation">,</span>
          <span class="token string">"ToggleInspectorVisibility.begin"</span><span class="token punctuation">:</span> <span class="token string">"onToggleInterface"</span><span class="token punctuation">,</span>
          <span class="token string">"OpenDocument"</span><span class="token punctuation">:</span> <span class="token string">"onOpenDocument"</span><span class="token punctuation">,</span>
          <span class="token string">"CloseDocument"</span><span class="token punctuation">:</span> <span class="token string">"onCloseDocument"</span><span class="token punctuation">,</span>
          <span class="token string">"SelectionChanged.finish"</span><span class="token punctuation">:</span> <span class="token string">"onSelectionChanged"</span><span class="token punctuation">,</span>
          <span class="token string">"TextChanged"</span><span class="token punctuation">:</span> <span class="token string">"onTextChanged"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
      <span class="token string">"identifier"</span><span class="token punctuation">:</span> <span class="token string">"showToolbar"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"åˆ‡æ¢å·¥å…·æ "</span><span class="token punctuation">,</span>
      <span class="token string">"shortcut"</span><span class="token punctuation">:</span> <span class="token string">"ctrl alt k"</span><span class="token punctuation">,</span>
      <span class="token string">"handler"</span><span class="token punctuation">:</span> <span class="token string">"onShow"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
      <span class="token string">"identifier"</span><span class="token punctuation">:</span> <span class="token string">"uploadArtboards"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Artboard ä¸Šä¼ "</span><span class="token punctuation">,</span>
      <span class="token string">"shortcut"</span><span class="token punctuation">:</span> <span class="token string">"ctrl alt a"</span><span class="token punctuation">,</span>
      <span class="token string">"handler"</span><span class="token punctuation">:</span> <span class="token string">"onUploadArtboards"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
      <span class="token string">"identifier"</span><span class="token punctuation">:</span> <span class="token string">"syncSymbols"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Symbol åŒæ­¥"</span><span class="token punctuation">,</span>
      <span class="token string">"shortcut"</span><span class="token punctuation">:</span> <span class="token string">"ctrl alt w"</span><span class="token punctuation">,</span>
      <span class="token string">"handler"</span><span class="token punctuation">:</span> <span class="token string">"onSyncSymbols"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
      <span class="token string">"identifier"</span><span class="token punctuation">:</span> <span class="token string">"resource"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Iconfont"</span><span class="token punctuation">,</span>
      <span class="token string">"shortcut"</span><span class="token punctuation">:</span> <span class="token string">"ctrl alt i"</span><span class="token punctuation">,</span>
      <span class="token string">"handler"</span><span class="token punctuation">:</span> <span class="token string">"onResource"</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>other commands
<span class="token punctuation">]</span>
</code></pre><p>è¿™ä¸ªä»£ç ä¸­ <code>name</code> å±æ€§ä»£è¡¨çš„æ˜¯èœå•çš„åå­—ã€‚å¯ä»¥çœ‹å‡ºå®Œå…¨ç¬¦åˆä¸Šè¿°æˆªå›¾çš„éƒ¨åˆ†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªå®šä¹‰çš„æ¯ä¸ª <code>action</code> éƒ½æ˜¯å®šä¹‰åœ¨ <code>commands</code> è¿™ä¸ªå¯¹è±¡ä¸‹é¢ã€‚
<code>identifier</code> æ˜¯æ¯ä¸ªå®šä¹‰çš„èœå•çš„æ ‡å¿—ã€‚ <code>shortcut</code> æ˜¯çŸ­å‘½ä»¤ã€‚å¯ä»¥ç”¨è¿‡å¿«æ·ç‚¹æ¥å¿«é€Ÿç‚¹å‡»èœå•ã€‚<code>handler</code> ä¸ºå‡½æ•°ï¼Œå°±æ˜¯ç‚¹å‡»è¿™ä¸ªèœå•éœ€è¦æ‰§è¡Œçš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ¥è‡ªäº
<code>script</code> è¿™ä¸ªå­—æ®µå®šä¹‰çš„æ–‡ä»¶ä¸­ã€‚æ¯”å¦‚æ­¤æ—¶ <code>script</code> é‡Œæ˜¯ <code>index.js</code>, é‚£ä¹ˆè¿™ä¸ªå‡½æ•°åº”è¯¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ˜¯å¯ä»¥æŸ¥åˆ°çš„ã€‚<a href="https://developer.sketch.com/plugins/">å…·ä½“å…¶ä»–çš„æŸ¥çœ‹å®˜ç½‘</a></p><h3 id="å¦‚ä½•è§¦å‘-action">å¦‚ä½•è§¦å‘ action</h3><p>å¦‚æœä»”ç»†çœ‹ä¸€ä¸‹ä¸Šè¿°ä»£ç ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°æœ‰è¿™æ ·ä¸€ä¸ªä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token punctuation">{</span>
  <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"action.js"</span><span class="token punctuation">,</span>
  <span class="token string">"handlers"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"actions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"Startup"</span><span class="token punctuation">:</span> <span class="token string">"onStartup"</span><span class="token punctuation">,</span>
      <span class="token string">"Shutdown"</span><span class="token punctuation">:</span> <span class="token string">"onShutdown"</span><span class="token punctuation">,</span>
      <span class="token string">"ToggleInspectorVisibility.begin"</span><span class="token punctuation">:</span> <span class="token string">"onToggleInterface"</span><span class="token punctuation">,</span>
      <span class="token string">"OpenDocument"</span><span class="token punctuation">:</span> <span class="token string">"onOpenDocument"</span><span class="token punctuation">,</span>
      <span class="token string">"CloseDocument"</span><span class="token punctuation">:</span> <span class="token string">"onCloseDocument"</span><span class="token punctuation">,</span>
      <span class="token string">"SelectionChanged.finish"</span><span class="token punctuation">:</span> <span class="token string">"onSelectionChanged"</span><span class="token punctuation">,</span>
      <span class="token string">"TextChanged"</span><span class="token punctuation">:</span> <span class="token string">"onTextChanged"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä»”ç»†çœ‹ä¸‹è¿™ä¸ªå®šä¹‰äº†ä¸€ä¸ªå«åš <code>handlers</code> çš„å¯¹è±¡ã€‚é‡Œé¢æœ‰ä¸€ä¸ªå«åš <code>actions</code>, è¿™ä¸ª <code>actions</code> çš„å®šä¹‰æ˜æ˜¾å’Œä¸Šè¿°èœå•çš„å®šä¹‰ä¸ä¸€æ ·å¯¹å—ï¼Ÿä¸Šé¢çš„èœå•çš„å®šä¹‰æ˜¯è¿™æ ·çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token punctuation">{</span>
  <span class="token string">"script"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string">"identifier"</span><span class="token punctuation">:</span> <span class="token string">"resource"</span><span class="token punctuation">,</span>
  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Iconfont"</span><span class="token punctuation">,</span>
  <span class="token string">"shortcut"</span><span class="token punctuation">:</span> <span class="token string">"ctrl alt i"</span><span class="token punctuation">,</span>
  <span class="token string">"handler"</span><span class="token punctuation">:</span> <span class="token string">"onResource"</span>
<span class="token punctuation">}</span>
</code></pre><p>é‚£ä¹ˆè¿™é‡Œçš„ <a href="https://developer.sketch.com/plugins/actions">actions</a> æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿè¿™äº› <code>actions</code> éƒ½æ˜¯ <code>sketch</code> å†…éƒ¨æš´éœ²å‡ºæ¥çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘å¬è¿™ä¸ª
<code>action</code> æ¥å®ç°ä¸€äº›åŠŸèƒ½ã€‚æ¯”å¦‚ <code>OpenDocument</code> åœ¨æ‰“å¼€ä¸€ä¸ª sketch æ–‡ä»¶çš„æ—¶å€™åšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œã€‚sketch ä¹Ÿå†…ç½®äº†å¯ä»¥ç›´æ¥æ‰§è¡Œä»£ç ã€‚</p><div><img src="./static/media/2.7eae8f95.png"/></div><p>ç‚¹å‡»è¿è¡Œä»£ç å°±å¯ä»¥ç›´æ¥è¿è¡Œä¸€äº›è„šæœ¬ã€‚æ‰€ä»¥å¦‚æœéœ€è¦ç”¨åˆ° <code>sketch</code> å†…éƒ¨å‘½ä»¤çš„æ—¶å€™, å°±å¯ä»¥å®šä¹‰è¿™äº› <code>action</code>, ç„¶ååœ¨å¯¹åº”çš„ <code>js</code> æ–‡ä»¶ä¸­å£°æ˜å¹¶ä¸” export å‡ºæ¥ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token comment">// onOpenDocument</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">onOpenDocument</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"open document success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="å¦‚ä½•æ„å»º-webwiew">å¦‚ä½•æ„å»º webwiew</h3><p>å› ä¸ºåœ¨ github ä¸Šå¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ç”¨ <code>OC</code> æ¥å†™çš„ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ <code>OC</code> æ¥åˆ›å»ºä¸€ä¸ª <code>webview</code> ã€‚è¿™é‡Œçš„ä»£ç éƒ½æ˜¯ <code>js</code> å†™çš„ã€‚æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸ªä¸»è¦çš„ç”¨äºåˆ›å»º <code>webview</code> çš„
åŒ… <a href="https://github.com/skpm/sketch-module-web-view">skpm-module-web-view</a> ã€‚å®‰è£…å¥½è¿™ä¸ªåŒ…å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŒ…åˆå§‹åŒ–æ¨¡æ¿ã€‚æ¯”å¦‚åˆ›å»ºä¸€ä¸ª <code>webview</code> çš„æ¨¡æ¿ã€‚è¿™ä¸ªä½¿ç”¨äº†
with-webview çš„æ¨¡æ¿</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">skpm create my<span class="token operator">-</span>plugin<span class="token operator">-</span>name <span class="token operator">--</span>template<span class="token operator">=</span>skpm<span class="token operator">/</span><span class="token keyword">with</span><span class="token operator">-</span>webview
</code></pre><p>å…³äºè¿™ä¸ª webview çš„æ–‡æ¡£ä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯ä¸¤éƒ¨åˆ†ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ <a href="https://github.com/skpm/sketch-module-web-view/blob/master/docs/browser-window.md">brower-window</a> å¦‚ä½•åˆ›å»ºä¸€ä¸ª webview,
å¹¶ä¸”å¦‚ä½•åŠ è½½ä¸€ä¸ªé¡µé¢ã€‚è¿™ä¸ªé¡µé¢å¯ä»¥æ˜¯æ¥è‡ªäº server ä¹Ÿå¯ä»¥æ˜¯æ¥è‡ªäºæœ¬åœ°ã€‚</p><h3 id="webview-ä¸-sketch-æ˜¯å¦‚ä½•é€šä¿¡çš„">webview ä¸ sketch æ˜¯å¦‚ä½•é€šä¿¡çš„</h3><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯ webview ä¸ sketch <a href="https://github.com/skpm/sketch-module-web-view/blob/master/docs/communication-plugin-webview.md">å¦‚ä½•é€šä¿¡</a> æ¯”å¦‚ webview ç»™ sketch
å‘é€ä¿¡æ¯</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"nativeLog"</span><span class="token punctuation">,</span> <span class="token string">"Called from the webview"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you can pass any argument that can be stringified</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"nativeLog"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> b
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you can also pass multiple arguments</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"nativeLog"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `window.postMessage` returns a Promis with the array of results from plugin listeners</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"nativeLog"</span><span class="token punctuation">,</span> <span class="token string">"blabla"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// res === ['result']</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>postMessage</code> æ¥å‘é€æ¶ˆæ¯åˆ° <code>sketch</code> ä¸­ã€‚åœ¨ sketch ä¸­é€šè¿‡</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">var</span> sketch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sketch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"nativeLog"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sketch<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token string">"result"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>æ¥æ¥æ”¶ <code>web-view</code> å‘é€è¿‡æ¥çš„æ¶ˆæ¯ã€‚</p><p>sketch ç»™ webView å‘é€æ¶ˆæ¯ã€‚é¦–å…ˆåœ¨ webview ä¸­å®šä¹‰æ–¹æ³•ã€‚æ³¨æ„éœ€è¦æŒ‚è½½åˆ° <code>window</code> ä¸Š</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">window<span class="token punctuation">.</span><span class="token function-variable function">someGlobalFunctionDefinedInTheWebview</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>sketch</code> ä¸­è°ƒç”¨ <code>executeJavaScript</code> æ–¹æ³•ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">browserWindow<span class="token punctuation">.</span>webContents
  <span class="token punctuation">.</span><span class="token function">executeJavaScript</span><span class="token punctuation">(</span><span class="token string">'someGlobalFunctionDefinedInTheWebview("hello")'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do something with the result</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¼ é€’ç»™ function ä¸­çš„å€¼ä¸€å®šè¦æ˜¯ä¸€ä¸ª string, å¯ä»¥ä½¿ç”¨ <code>JSON.stringify()</code> æ¥è½¬æˆ <code>string</code></p><h3 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h3><p>æœ‰çš„æ—¶å€™æ˜¯éœ€è¦è¿›è¡Œç¯å¢ƒé…ç½®çš„ã€‚å› ä¸ºå¯èƒ½åœ¨æµ‹è¯•ç¯å¢ƒéœ€è¦åŠ è½½æµ‹è¯•ç¯å¢ƒçš„ <code>url</code>, æ­£å¼ç¯å¢ƒéœ€è¦åŠ è½½æ­£å¼ç¯å¢ƒçš„ <code>url</code>ã€‚æ‰€ä»¥æ˜¯éœ€è¦åŒºåˆ†çš„ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•å»åšå‘¢ï¼Ÿ
åœ¨ Node ä¸­é€šè¿‡å¤§å®¶ä¼šä½¿ç”¨ <code>process.env</code> è¿™ä¸ªã€‚åœ¨ <code>sketch</code> ä¸­å¦‚æœä½¿ç”¨äº† <code>sketch-module-web-view</code>, é‚£ä¹ˆæ˜¯å¯ä»¥è‡ªå®šä¹‰ webpack ç¯å¢ƒçš„ã€‚æ‰€ä»¥æƒ³è®¾ç½®
ä¸åŒçš„ç¯å¢ƒå¯ä»¥è¿™æ ·æ¥åšã€‚é¦–å…ˆéœ€è¦å»ºç«‹ä¸€ä¸ªåå­—å« <code>webpack.skpm.config.js</code> æ–‡ä»¶ã€‚é‡Œé¢çš„ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>EnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">NODE_ENV</span><span class="token punctuation">:</span> <span class="token string">"development"</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡è¿™æ ·é…ç½®å¯ä»¥è®¾ç½® <code>NODE_ENV</code> é»˜è®¤ä¸º <code>development</code>ã€‚è¿™ä¸ªå¤§å®¶ä¹Ÿå¯ä»¥è®¾ç½®å…¶ä»–çš„ã€‚è¿™ä¸ªå°±æ˜¯ä¸ºäº†å†…éƒ¨è¿›è¡Œç¯å¢ƒçš„åŒºåˆ†çš„ã€‚ç„¶åå¯ä»¥é…ç½®ç›¸åº”çš„å‘½ä»¤ã€‚åœ¨ <code>package.json</code> ä¸­</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token string">"NODE_ENV=development skpm-build --watch --run"</span><span class="token punctuation">,</span>
<span class="token string">"start:test"</span><span class="token punctuation">:</span> <span class="token string">"NODE_ENV=test skpm-build --watch --run"</span><span class="token punctuation">,</span>
<span class="token string">"start:pro"</span><span class="token punctuation">:</span> <span class="token string">"NODE_ENV=production  yarn start"</span><span class="token punctuation">,</span>
</code></pre><p>å¯ä»¥é€šè¿‡ä¸åŒçš„å‘½ä»¤æ¥è¿è¡Œä¸åŒçš„ç¯å¢ƒã€‚åˆ°è¿™é‡ŒåŸºæœ¬çš„æ“ä½œåº”è¯¥éƒ½æ˜¯å¯ä»¥å®Œæˆçš„ã€‚</p><h3 id="æ„å»ºå’Œå‘å¸ƒ">æ„å»ºå’Œå‘å¸ƒ</h3><p>å¦‚æœæ˜¯åœ¨ github ä¸Šçš„è¯å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>skpm</code> å†…ç½®çš„æ„å»ºå‘½ä»¤ä»¥åŠå‘å¸ƒï¼Œå…¶ä»–çš„ä¸åŒæ‹…å¿ƒã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token string">"postinstall"</span><span class="token punctuation">:</span> <span class="token string">"npm run build &amp;&amp; skpm-link"</span>
</code></pre><p>ä½†æ˜¯æˆ‘è¿™é‡Œä¸»è¦è®²çš„æ˜¯åœ¨å…¬å¸å†…éƒ¨å¦‚ä½•å‘å¸ƒè¿™ä¸ªã€‚é¦–å…ˆå¯ä»¥æŸ¥çœ‹<a href="https://developer.sketch.com/plugins/publish-a-plugin">å®˜ç½‘å‘å¸ƒæµç¨‹</a>ã€‚æ€•æœ‰äº›äººä¼šå’Œä¸€æ ·ä¸€å¼€å§‹éƒ½æ˜¯ä¸æ€ä¹ˆç†è§£
è¿™ä¸ªå‘å¸ƒã€‚æ‰€ä»¥æˆ‘è¯¦ç»†è®²è§£ä¸€ä¸‹è¿™ä¸ªå‘å¸ƒã€‚é¦–å…ˆçœ‹å®˜ç½‘ä»‹ç»éœ€è¦ä¸€ä¸ª <code>appcast.xml</code> çš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å¯ä»¥é€‰æ‹©æ”¾åœ¨æœåŠ¡å™¨ä¸­ã€‚åªè¦å¯ä»¥è®¿é—®åˆ°å°±å¯ä»¥ã€‚å…¶å®å¯ä»¥çœ‹ä¸‹ <code>kitchen</code> çš„ <code>appcast.xml</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token string">"appcast"</span><span class="token punctuation">:</span> <span class="token string">"https://kitchen.alipay.com/appcast.xml"</span><span class="token punctuation">,</span>
</code></pre><p>ç‚¹å‡»è¿™ä¸ªæ˜¯å®Œå…¨å¯ä»¥è®¿é—®çš„ã€‚é‚£ä¹ˆåœ¨å†…éƒ¨æ¯”å¦‚æˆ‘ä»¬ä¹Ÿç”Ÿæˆè¿™æ ·ä¸€ä¸ª <code>xml</code> æ–‡ä»¶ã€‚è¿™ä¸ªå¯ä»¥è®©æœåŠ¡ç«¯å¸®ä½ ç”Ÿæˆã€‚æ¯”å¦‚ç”Ÿæˆçš„åœ°å€æ˜¯ <code>http://xxx.yyy.com/appcast.xml</code> ã€‚ç„¶ååœ¨
<code>manifest.json</code> æ–‡ä»¶ä¸­å®šä¹‰è¿™æ ·ä¸€ä¸ªå­—æ®µå«åš <code>appcast</code> è¿™ä¸ªå­—æ®µçš„ value å°±æ˜¯è¿™ä¸ª urlã€‚é‚£ä¹ˆè¿™ä¸ªé‡Œé¢åº”è¯¥æ”¾å“ªäº›å†…éƒ¨å‘¢ï¼Ÿä¸å¦¨ä»¥ <code>kitchen</code> ä¸ºä¾‹å­ã€‚</p><div><img src="./static/media/3.234ad5a4.png"/></div><p>å¯ä»¥çœ‹å‡ºæ¯ä¸ª <code>item</code> ä¸‹é¢éƒ½æœ‰æ¯ä¸ªç‰ˆæœ¬çš„å…·ä½“åŒ…çš„åœ°å€ï¼Œæ‰€ä»¥è¿™æ˜¯å¿…è¦çš„ã€‚åœ¨ <code>appcast.xml</code> ä¸­åº”è¯¥åŒ…å«æ¯ä¸ªç‰ˆæœ¬çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬<code>ç‰ˆæœ¬å·</code>ä»¥åŠç›¸åº”çš„åŒ…çš„åœ°å€ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åŠ ä¸Šæ¯ä¸ª
ç‰ˆæœ¬çš„æè¿°ä¿¡æ¯ã€‚å½“å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬åã€‚åœ¨ sketch ä¸­å°±ä¼šæ˜¾ç¤ºæœ‰æ–°çš„ç‰ˆæœ¬éœ€è¦æ›´æ–°ã€‚</p><div><img src="./static/media/4.91119792.png"/></div><h3 id="ç»“æŸè¯­">ç»“æŸè¯­</h3><p>ä¸Šé¢å°±æ˜¯åœ¨å¼€å‘ <code>sketch</code> æ’ä»¶ä¸­ä¸€ä¸ªæµç¨‹éœ€è¦æ³¨æ„çš„ä¸€äº›åŸºæœ¬æ“ä½œã€‚åé¢è¿˜æ˜¯é‡åˆ°å¾ˆå¤šé—®é¢˜çš„ï¼Œé‚£ä¹ˆè¯¦ç»†çš„æ–‡æ¡£éƒ½å¯ä»¥å‚è€ƒ<a href="https://developer.sketch.com/plugins/reference">api æ–‡æ¡£</a>
åœ¨è¿™ä¸ªæ–‡æ¡£ä¸­ä»‹ç»äº†å¾ˆå¤šåŠŸèƒ½ã€‚å¦‚ä½•å»è·å–å›¾å±‚ã€é€‰ä¸­çš„ç”»æ¿ã€åˆ›å»ºç”»æ¿ç­‰ç­‰ã€‚ä»¥åŠå¯¼å‡ºå¯¼å…¥è¿™äº›ã€‚å½“ç„¶ç›®å‰ js å¼€æ”¾çš„ api ä¸æ˜¯ç‰¹åˆ«çš„å¤šï¼Œä½†æ˜¯å¾ˆå¤šå°åŠŸèƒ½éƒ½æ˜¯å¯ä»¥å®ç°çš„ã€‚å¦‚æœå‘ç°æœ‰ä¸èƒ½å®ç°çš„
å¯ä»¥æéœ€æ±‚ç»™ <code>sketch</code> çš„ã€‚</p><p>æœ€åå°±æ˜¯ä»‹ç»ä¸€ä¸ª sketch è®¨è®ºçš„ç½‘ç«™ã€‚å¾ˆå¤šäººä¼šåœ¨<a href="https://sketchplugins.com/">ä¸Šé¢</a>è®¨è®ºå¼€å‘ <code>sketch</code> é‡åˆ°çš„é—®é¢˜ </p></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[éšæ–‡]]></title>
            <link>/posts/2019-11-27/suiwen/</link>
            <guid>/posts/2019-11-27/suiwen/</guid>
            <pubDate>Tue, 26 Nov 2019 16:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<div><p>ä»Šå¤©æ—©ä¸Šæ‰“å¼€æ‰‹æœºï¼Œçœ‹åˆ°ä¸€æ¡æƒŠäººçš„æ–°é—»å°±æ˜¯ <code>é«˜ä»¥ç¿”</code> å½•èŠ‚ç›®çš„è¿‡ç¨‹ä¸­å‡ºç°äº†æ„å¤–ã€‚è¿™ä¸ªæ–°é—»çœŸçš„ä»¤äººå¾ˆæ„å¤–ã€‚è™½ç„¶æˆ‘æ²¡æœ‰å…³æ³¨è¿™ä¸ªèŠ‚ç›®ï¼Œ
ä½†æ˜¯è¿˜æ˜¯æ„Ÿåˆ°åƒæƒŠã€‚åœ¨ååœ°é“çš„æ—¶å€™ç¿»äº†ä¸‹å…¶ä»–çš„æ–°é—»ï¼Œå¾ˆå¤šéƒ½æ˜¯ä¼  <code>é«˜ä»¥ç¿”</code> æŠ¢æ•‘æ— æ•ˆèµ°äº†ã€‚ä½†æ˜¯æˆ‘è¿˜æ˜¯ä¸å¤ªæ•¢ç›¸ä¿¡ï¼Œä¸€ä¸ªäººæ€ä¹ˆè¯´èµ°å°±èµ°äº†å‘€ã€‚ç”Ÿå‘½çœŸçš„æ˜¯å¦‚æ­¤çš„
è„†å¼±ã€‚å¾ˆå¤šæ–°é—»éƒ½åœ¨è¯´é‚£ä¸ªèŠ‚ç›®å¾ˆå¯æ€•ï¼Œå¾ˆå¤šæ˜æ˜Ÿç¡è§‰éƒ½å¾ˆå°‘å¾ˆå°‘ï¼Œå¹¶ä¸”æœ‰çš„è¿˜éœ€è¦ä¸»åŠ¨å»å¸æ°§ã€‚çœ‹èµ·æ¥çœŸçš„å¤ªå¯æ€•äº†ï¼Œæ—¢ç„¶è¿™ä¸ªèŠ‚ç›®è¿åŠ¨é‡å¦‚æ­¤å·¨å¤§ï¼Œä¸ºä»€ä¹ˆä¸å…·å¤‡è‰¯å¥½çš„
åŒ»ç–—è®¾å¤‡æˆ–è€…æ¡ä»¶å‘¢ï¼Ÿè¿™ç§éš¾é“éƒ½ä¸æ˜¯åº”è¯¥æå‰éƒ½å‡†å¤‡å¥½çš„å—ï¼Ÿç­‰å‡ºäº†æ„å¤–æ‰çŸ¥é“è¿™ä¸ªåœ°æ–¹å‡†å¤‡çš„ä¸å‘¨åˆ°å—ï¼Ÿæˆ‘åªæ˜¯èŒ«èŒ«äººæµ·ä¸­çš„ä¸€ç²’æ²™å­ï¼Œæˆ‘æ²¡æœ‰èƒ½åŠ›å»è¿™äº›äººå»åšä»€ä¹ˆã€‚åªèƒ½åœ¨è¿™é‡Œ
ç¥ˆç¥·ã€‚ğŸ™ğŸ™ğŸ™</p><p>ä»Šå¤©æƒ³å†™è¿™ç¯‡åšæ–‡çš„åŸå› å°±æ˜¯å‡ºè‡ªè¿™ä¸ªï¼Œè¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯æŠ€æœ¯æ–‡ç« ã€‚å¦‚æœéœ€è¦çœ‹æŠ€æœ¯çš„ç«¥é‹å¯ä»¥è·³è¿‡è¿™é‡Œã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºäº†ç»™å¤§å®¶ä¼ æ’­ä¸€äº›æ­£èƒ½é‡çš„è§‚ç‚¹ã€‚å¸Œæœ›å¤§å®¶çæƒœç°åœ¨ï¼Œçæƒœç”Ÿå‘½ã€‚
ä¿—è¯è¯´ï¼šæ²¡ç»å†è¿‡æ­»äº¡çš„äººæ˜¯ä¸çŸ¥é“æ´»ç€æ˜¯å¤šä¹ˆçš„å¹¸ç¦ã€‚è¿™è¯å¬èµ·æ¥æ˜¯å¯¹çš„ï¼Œä½†æ˜¯çœŸçš„ä¸æ˜¯æ¯ä¸ªäººéƒ½ä¼šå»ç»å†ä¸€æ¬¡ï¼Œæœ‰å¯èƒ½è¿™ä¸€æ¬¡å¯èƒ½å°±ä¸åœ¨äº†ã€‚æ‰€ä»¥å³ä½¿æ— æ³•ç†è§£è¿™å¥è¯ï¼Œä¹Ÿè¦è¯·æ¯ä¸ªäººçæƒœ
è‡ªå·±çš„<code>ç”Ÿå‘½</code>ã€‚</p><p>æœ€è¿‘éƒ½åœ¨å–œé©¬æ‹‰é›…å¬è¯»è€…ï¼Œä¹‹å‰æˆ‘ç‰¹åˆ«å–œæ¬¢å¬<code>é¬¼æ•…äº‹</code>ï¼Œä¹Ÿä¼šå»å“äººã€‚å¾ˆå¤šæ—¶å€™å“äººæ˜¯å¾ˆå®¹æ˜“æŠŠäººå“æ­»çš„ï¼Œå³ä½¿ä¸å“æ­»æœ‰å¯èƒ½ä¹Ÿä¼šå“å‡ºæ¯›ç—…æ¥ã€‚è‡ªå·±ä¹Ÿä¼šæœ‰æ‰€æ„Ÿå—ã€‚æ‰€ä»¥è¿™å‘¨æˆ‘å°±åˆ æ‰äº†æ‰€æœ‰è¿™äº›æ²¡æœ‰
è¥å…»çš„æ•…äº‹ã€‚å¬èµ·äº†<code>è¯»è€…</code>ï¼Œ <code>è¯»è€…</code>è¿™æœ¬æ‚å¿—ï¼Œå¾ˆå¤šäººéƒ½åº”è¯¥çœ‹è¿‡ï¼Œå°¤å…¶æ˜¯ 90 åï¼Œåº”è¯¥éƒ½æ˜¯é‚£ä¸ªæ—¶ä»£è¿‡æ¥çš„ã€‚ä»¥å‰ä¸‹è¯¾çš„æ—¶å€™æ€»æ˜¯ä¼šå»ä¹°è¿™äº›æ‚å¿—æ¥çœ‹ï¼Œä»è¿™äº›æ‚å¿—ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå¤šå¥½çš„æ–‡ç« ï¼Œå­¦ä¹ åˆ°
æ–°çš„çŸ¥è¯†ã€‚å½“æ—¶ç›¸åº”çš„æ‚å¿—æ˜¯ä¸æ˜¯è¿˜æœ‰<code>æ„æ—</code>å•Šã€‚è™½ç„¶æˆ‘ä¸çŸ¥é“è¿™äº›æ‚å¿—æ€ä¹ˆå°±ä¸è§äº†(æœ‰å¯èƒ½è¿˜åœ¨ï¼Œå¯èƒ½æˆ‘æ²¡æœ‰æ‰¾åˆ°å§, æˆ–è€…æˆ‘å·²ç»ä¸å»çœ‹äº†)ã€‚è‡³äºåé¢çš„è¯»è€…çš„æ•…äº‹æˆ‘å¯ä»¥é™†é™†ç»­ç»­åˆ†äº«ç»™å¤§å®¶ï¼Œåœ¨è¿™ä¸ªæŠ€æœ¯
åšå®¢åœ¨å¼€ä¸€ä¸ªè½¯æ–‡ç±»ã€‚å¸Œæœ›å¯ä»¥å’Œå¤§å®¶ä¸€èµ·ä»ä¹¦ä¸­å­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚</p><p>å›åˆ°ä»Šå¤©çš„äº‹æƒ…ï¼Œä»ç°åœ¨çš„å¾ˆå¤šæ–°é—»ä¸­ç›¸ä¿¡å¤§å®¶éƒ½çœ‹åˆ°æœ€å¤šçš„å°±æ˜¯æŸæŸæŸå…¬å¸ç¨‹åºå‘˜çŒæ­»äº†ã€‚å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªåšå®¢ï¼Œé‚£è¯´æ˜ <code>90%</code> çš„å¯èƒ½æ€§ä½ æ˜¯ä¸€ä¸ªç¨‹åºå‘˜ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¹Ÿæ˜¯é’ˆå¯¹æ­£åœ¨çœ‹è¿™ç¯‡æ–‡ç« çš„ä½ ã€‚è¯·å¤§å®¶
ä¸€å®šè¦çæƒœç”Ÿå‘½ã€‚é‚£ä¹ˆçæƒœç”Ÿå‘½ä»å“ªäº›åšèµ·å‘¢ï¼Ÿæˆ‘åœ¨è¿™é‡Œè®²è®²æˆ‘çš„åšæ³•å§ã€‚</p><p>æˆ‘ç‰¹åˆ«<code>æ€•é«˜</code>ã€‚æˆ‘ç›¸ä¿¡æ€•é«˜çš„äººéƒ½çŸ¥é“ç«™åœ¨é«˜å¤„çš„æ„Ÿå—æ˜¯ä»€ä¹ˆæ ·å­çš„å§ã€‚æˆ‘æ¥æè¿°ä¸€ä¸‹ç»™ä¸æ€•é«˜çš„äººå¬ä¸€ä¸‹å§ã€‚å¦‚æœåªæ˜¯ç«™åœ¨ 2â€“3 æ¥¼é‚£å¯èƒ½è¿˜å¥½ï¼Œå› ä¸ºè¿™æ˜¯çš„æ¥¼å±‚å¹¶ä¸æ˜¯å¾ˆé«˜ã€‚ä½†æ˜¯å¦‚æœè¶…è¿‡äº†è¿™ä¸ªé«˜åº¦å°±ä¼šè§‰å¾—å¾ˆ
é«˜äº†ï¼Œä¸åŒçš„äººå¯èƒ½å¯¹è¿™ä¸ªé«˜åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚æˆ‘çš„é«˜åº¦å¯èƒ½å°±æ˜¯æ¥¼å±‚ 3 å±‚å·¦å³ã€‚æˆ‘å®¶æ˜¯åœ¨ 6 æ¥¼(æˆ‘å®¶çŒ«ä¹Ÿæ€•é«˜),æ¯æ¬¡æˆ‘å‘ä¸‹çœ‹çš„æ—¶å€™éƒ½è§‰å¾—è‡ªå·±ä¼šæ‰ä¸‹å»ï¼Œè¿™åº”è¯¥æ˜¯æ€•é«˜çš„äººéƒ½æœ‰çš„æ„Ÿè§‰å§ã€‚å¹¶ä¸”çœ‹çš„è¶Šä¹…ï¼Œè¿™æ ·çš„
æ„Ÿè§‰è¶Šå¼ºçƒˆã€‚å¹¶ä¸”è…¿æ˜¯è½¯çš„ï¼Œå®Œå…¨èµ°ä¸åŠ¨è·¯çš„ã€‚æ‰€ä»¥ä¹‹å‰ä¸æ˜¯æœ‰ä¸€äº›æŠ¥é“å˜›ï¼Œè¯´æœ‰çš„äººè¢«å“çš„èµ°ä¸åŠ¨è·¯äº†ï¼Ÿçœ‹åˆ°ä¸€äº›ä¸œè¥¿ä¸ºå•¥ä¸è·‘å‘¢? å½“ä½ çœŸæ­£çš„é‡åˆ°ä½ æ‰€ææƒ§çš„ä¸œè¥¿çš„æ—¶å€™ï¼Œèº«ä½“çš„æœ¬èƒ½å¹¶ä¸æ˜¯è·‘ï¼Œè€Œæ˜¯è½¯æ‰äº†ã€‚
è…¿ä¸€ä¸‹å­å°±ååº”å‡ºæ¥äº†ï¼Œæ ¹æœ¬ä¸ä¼šæœ‰åŠ›æ°”è·‘ã€‚ä½ ä¸è¦ä¸ä¿¡ï¼Œé™¤éä½ æ²¡æœ‰ææƒ§çš„ä¸œè¥¿ã€‚å¯¹äºæ€•é«˜çš„æˆ‘æ¥è¯´è¿™æ˜¯è‚¯å®šçš„ã€‚</p><p>å› ä¸ºæˆ‘æ¯”è¾ƒæ€•é«˜ï¼Œæ‰€ä»¥æˆ‘ä¸ä¼šå»ç©ä¸€äº›ç‰¹åˆ«åˆºæ¿€çš„ä¸œè¥¿ã€‚æ¯”å¦‚<code>è·³è·³æœº</code>è¿™ç§æˆ‘æ˜¯ä¸æ•¢ç©çš„ï¼Œæˆ‘ç©è¿‡ä¸€æ¬¡ç„¶åå°±å†ä¹Ÿæ²¡ç©è¿‡ï¼Œç©çš„é‚£ä¸€æ¬¡è¿˜æ˜¯å…¨ç¨‹é—­çœ¼çš„ã€‚é¦–å…ˆæˆ‘æ¯”è¾ƒæ€•é«˜ï¼Œæ‰€ä»¥æˆ‘ä¸æ•¢å†ç©äº†ã€‚å†è€…ï¼Œæˆ‘ç¬¬ä¸€æ¬¡ç©é‚£ä¸ªè·³è·³æœºçš„
æ—¶å€™ï¼Œåœ¨è¿‡ç¨‹ä¸­å¬åˆ°äº†åçš„é‚£ä¸ªæ¤…å­æ‰£å­çš„å£°éŸ³ï¼Œæˆ‘å½“æ—¶å“å¾—åŠæ­»ï¼Œæˆ‘ä»¥ä¸ºæ˜¯æ²¡æ‰£ç´§ï¼Œæˆ‘æ˜¯ä¸æ˜¯è¦å‡‰äº†ã€‚æ‰€ä»¥åæ¥æˆ‘å†ä¹Ÿæ²¡ç©è¿‡ï¼ŒåŒ…æ‹¬æ¬¢ä¹è°·çš„<code>å¤§æ‘†é”¤</code>ï¼Œæˆ‘ä¸ä¼šå»å°è¯•ã€‚æœ‰çš„äººä¼šè¯´å¯ä»¥å°è¯•ä¸€ä¸‹ï¼ŒçœŸçš„å¾ˆå¥½ç©ã€‚ä½†æ˜¯
æˆ‘ä¸æƒ³å»å†’é™©ã€‚å°¤å…¶æ˜¯è‡ªå·±çš„ç”Ÿå‘½å»å†’é™©ã€‚</p><p>åœ¨ä¸Šé¢è¯´è¿‡æˆ‘ä¹‹å‰å–œæ¬¢å¬é¬¼æ•…äº‹ï¼Œç°åœ¨å·²ç»ä¸å¬äº†ã€‚åˆ«ä»¥ä¸ºæˆ‘ä¸æ€•ï¼Œæˆ‘å¾ˆæ€•çš„ã€‚å°¤å…¶æ˜¯è¿™äº›æ–¹é¢çš„ï¼Œç‰›é¬¼è›‡ç¥å•Šä¹‹ç±»çš„ã€‚å…ˆå£°æ˜ï¼š<code>æˆ‘åšå†³æ‹¥æŠ¤ä¸­å›½å…±äº§å…šçš„é¢†å¯¼ï¼Œåšä¿¡é©¬å…‹æ€åˆ—å®ä¸»ä¹‰ï¼Œæ¯›æ³½ä¸œæ€æƒ³ã€é‚“å°å¹³ç†è®ºã€ä¸‰ä¸ªä»£è¡¨é‡è¦æ€æƒ³</code><code>ç§‘å­¦å‘å±•è§‚ï¼Œä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³</code>ã€‚ä½†æ˜¯æˆ‘æœ‰çš„æ—¶å€™ä¹Ÿä¼šç›¸ä¿¡è¿™äº›<code>ç‰›é¬¼è›‡ç¥</code>.ä¸»è¦è¿™ä¸ªæ˜¯å¤ä»£å°±æµä¼ ä¸‹æ¥çš„ã€‚å¤äººå¾ˆå¤šè¯´çš„éƒ½æ˜¯æœ‰é“ç†çš„ã€‚æ‰€ä»¥çœŸçš„è®©æˆ‘å®Œå…¨ä¸ä¿¡ï¼Œè¿˜æ˜¯å¾ˆéš¾çš„ã€‚æ—¢ç„¶æˆ‘è¿™ä¹ˆæ€•ä¸ºä»€ä¹ˆè¿˜è¦å»å¬å‘¢ï¼Ÿ
æˆ‘æ„Ÿè§‰å°±æ˜¯è‡ªå·±åœ¨ä½œæ­»ã€‚å¬èµ·æ¥çœŸçš„å¾ˆåˆºæ¿€ï¼Œä½†æ˜¯ç»å¸¸ä¼šè‡ªå·±å“åˆ°è‡ªå·±ã€‚æ™šä¸Šä¸‹ç­å›å®¶çš„è·¯ä¸Šï¼Œåˆ°äº†å°åŒºçš„æ—¶å€™ï¼Œå°åŒºåŸºæœ¬ä¸Šå°±æˆ‘ä¸€ä¸ªäººåœ¨èµ°è·¯ã€‚æ­¤æ—¶å¾ˆå®¹æ˜“ä¼šè”æƒ³åˆ°é¬¼æ•…äº‹ä¸­çš„åœºæ™¯ï¼Œè¶Šæƒ³è¶Šå®³æ€•ï¼Œè¶Šå®³æ€•è¶Šæƒ³ã€‚
äºæ˜¯æˆ‘å°±åŠ å¿«äº†è„šæ­¥ï¼Œä»¥è¿…é›·ä¸åŠæ©è€³ä¹‹åŠ¿å†²åˆ°å®¶é‡Œã€‚åˆ°äº†å®¶é‡Œï¼Œå¿ƒé‡Œå°±æ”¾äº†ä¸€å¤§æˆªäº†ï¼Œå› ä¸ºæˆ‘æœ‰ä¸€åª<code>èƒ–èƒ–çš„çŒ«</code>ï¼Œæ®è¯´çŒ«èƒ½çœ‹åˆ°äººçœ‹ä¸è§çš„ä¸œè¥¿ã€‚æ¯æ¬¡çœ‹åˆ°æˆ‘å®¶çŒ«ç¡çš„å’ŒçŒªä¸€æ ·ï¼Œæˆ‘å°±çŸ¥é“å®¶é‡Œå¹³å®‰æ— äº‹ï¼Œç®€ç›´ç¾æ»‹æ»‹ã€‚</p><p>å†è¯´ä¸€ä¸ªå°±æ˜¯ä½œä¸ºç¨‹åºå‘˜æˆ–è€…ä¸æ˜¯ç¨‹åºå‘˜å§ã€‚å¤§å®¶å¤©å¤©éƒ½ä¼šæœ‰çš„é—®é¢˜ - <code>ç†¬å¤œ</code>ã€‚ä¸çŸ¥é“å…¶ä»–äººæ˜¯å¦‚ä½•çœ‹å¾…ç†¬å¤œè¿™ä»¶äº‹æƒ…çš„ã€‚åæ­£å¯¹æˆ‘æ¥è¯´ï¼Œæˆ‘ä»¥å‰æ˜¯å¾ˆå–œæ¬¢ç†¬å¤œçš„ã€‚æ¯å¤©æ™šä¸Š 2 ç‚¹ä»¥åç¡è§‰çš„ã€‚ä½†æ˜¯è¿™æ ·ä¸€æ®µæ—¶é—´åï¼Œé¦–å…ˆ
çš®è‚¤ä¼šå¾ˆå·®ï¼Œç„¶åç™½å¤©ç²¾ç¥æ˜¯çœŸçš„ä¸å¥½ã€‚ä¼šå¾ˆå›°å¾ˆå›°çš„ã€‚å¾ˆå¤šäººä¼šè¯´ï¼Œé‚£æ˜¯ä½ ç¡çš„å¤ªå°‘äº†ï¼Œå¤šç¡ä¼šä¸å°±è¡Œäº†å˜›ã€‚å¦‚æœè¿™æ ·çš„çœŸçš„èƒ½è§£å†³é—®é¢˜ï¼Œæˆ‘å°±ä¸ä¼šåœ¨è¿™é‡Œé‡ç‚¹è¯´è¿™ä¸ªäº†ã€‚ä¸¾ä¸ªä¾‹å­å§ã€‚</p><p>æˆ‘åœ¨å¤§å­¦çš„æ—¶å€™æˆ‘è®°å¾—æ˜¯å¤§ä¸‰çš„æ—¶å€™ï¼Œæ¯ä¸ªæœˆä¼šæœ‰ä¸€æ™šå»ç½‘å§å’Œé«˜ä¸‰çš„åŒå­¦å¼€é»‘ã€‚æ¯æ¬¡ç©éƒ½æ˜¯ä¸€æ•´å¤œçš„ç©ï¼Œä¸€ç›´åˆ°æ—©ä¸Š 7 ç‚¹ã€‚å…¶å®åˆ°äº†åŠå¤œå°±ä¼šå‘ç°ï¼ŒçœŸçš„å¾ˆå›°ï¼Œå³ä½¿åœ¨æ‰“æ¸¸æˆã€‚å¦‚æœä½ å»è¿‡ç½‘å§ï¼ŒåŒæ—¶ä¹ŸåŒ…è¿‡å¤œ(ä¸è¦çæƒ³)é‚£ä¹ˆ
ä½ åœ¨ç½‘å§ä¼šçœ‹åˆ°åŒ…å¤œçš„äººä¸­ç©æ¸¸æˆçš„äººçœŸçš„æ²¡æœ‰é‚£ä¹ˆå¤šã€‚å¾ˆå¤šäººç©ç€ç©ç€å°±ç¡ç€äº†ï¼Œå¯èƒ½å°±ä¼šç¡åˆ°å¤©äº®ã€‚æˆ‘åŒ…å¤œçš„ç»å¸¸äº²çœ¼æ‰€è§å¾ˆå¤šäººéƒ½æ˜¯è¿™æ ·çš„ã€‚å¥½äº†ï¼Œç»§ç»­è¯´ç¡å¾—æ—¶é—´çš„é—®é¢˜å§ã€‚åŒæ ·æ˜¯ç¡äº† 8 å°æ—¶ï¼Œç™½å¤©ç¡è§‰
å’Œæ™šä¸Šç¡è§‰æ˜¯ä¸€æ ·çš„å—ï¼Ÿæˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¼šå‘ç°è¿™æ˜æ˜¾æ˜¯ä¸ä¸€æ ·çš„ã€‚æˆ‘æ¯æ¬¡åŒ…å¤œå›æ¥ï¼Œç™½å¤©åˆ«ç¡ç¡ 8 å°æ—¶ï¼Œç¡ 10 å°æ—¶æ„Ÿè§‰éƒ½ç´¯çš„å¾ˆã€‚ä¸€æ•´å¤©ä¸è¦è¯´å»å­¦ä¹ äº†ï¼Œå°±è¿åƒé¥­éƒ½æ‡’å¾—åƒå°±æƒ³åœ¨åºŠä¸Šå…»ç€ç»§ç»­ç¡è§‰ã€‚æœ‰å¯èƒ½ä½ 
æ™šä¸Šå¤šç¡ 1 å°æ—¶ä¼šæ˜¯ç™½å¤© 2 å°æ—¶çš„æ•ˆæœã€‚æ‰€ä»¥æˆ‘ç°åœ¨å°±ä¸ä¼šç†¬å¤œäº†ï¼Œæˆ‘åŸºæœ¬ä¸Šæ¯å¤© 12 ç‚¹çš„æ—¶å€™å°±ä¼šç¡è§‰ï¼Œç„¶åå¤å¤©æ˜¯å‡†æ—¶çš„ 7:30 èµ·åºŠã€‚å†¬å¤©æ˜¯ 8 ç‚¹èµ·åºŠï¼Œä¸åˆ†æ˜¯å‘¨æœ«è¿˜æ˜¯å·¥ä½œæ—¥ã€‚æ—¥å¤ä¸€æ—¥ã€‚ç°åœ¨å¯èƒ½æ—©å°±ä¹ æƒ¯äº†
è¿™æ ·ã€‚</p><p>æˆ‘åœ¨å¤šè¯´ä¸€ç‚¹æœ‰å¤šå°‘äººç†¬å¤œæ˜¯ä¸ºäº†å­¦ä¹ æˆ–è€…è¯´æ˜¯å·¥ä½œçš„å‘¢ï¼Ÿæˆ‘ä¸ç›¸ä¿¡å…¬å¸ä¼šç»™ä½ å®‰æ’æ²¡æœ‰å·¥ä½œåˆ°å¤œé‡Œ 2 ç‚¹çš„äº‹æƒ…ã€‚åŸºæœ¬ä¸Šéƒ½æ˜¯åˆ°å®¶èººåœ¨åºŠä¸Šçš„æ—¶å€™ï¼Œæ‹¿èµ·æ‰‹æœºï¼Œåˆ·åˆ·æ‰‹æœºã€çœ‹çœ‹æŠ–éŸ³ã€çœ‹çœ‹æ–°é—»ã€‚å†è€…å°±æ˜¯æ¥ä¸€ç›˜ç‹è€…è£è€€
å˜›ã€‚æ‰“ä¸€ç›˜è¾“äº†ï¼Œä½ å¿ƒé‡Œåœ¨æƒ³ä»Šå¤©è¦æ˜¯ä¸èµ¢ä¸€å±€æˆ‘å°±ä¸ç¡è§‰ï¼Œç„¶ååˆè¾“äº†ã€‚åœ¨æ‰“ä¸€å±€ï¼Œå“å‘€ï¼Œç»ˆäºèµ¢å•¦ã€‚èµ¢äº†ä¹‹åå‘ç°ï¼Œèµ¢äº†è¿™å±€ï¼Œæˆ‘å¿ƒé‡Œè¿˜æ˜¯ä¸çˆ½ï¼Œæˆ‘è¿˜è¦å†èµ¢ä¸€å±€ã€‚äºæ˜¯åˆå¼€å¿ƒçš„ç©èµ·æ¥äº†ã€‚ç­‰è¿™å±€ç»“æŸå
çœ‹äº†ä¸€çœ¼æ—¶é—´å‘ç°éƒ½å·²ç»å¿« 4 ç‚¹äº†å•Šã€‚æˆ‘çš„å¤©ï¼Œç°åœ¨æ‰ç¡è§‰ã€‚ä¸€ç›´ç¡åˆ° 12 ç‚¹æ‰èµ·æ¥ã€‚å› ä¸ºçœŸçš„å¾ˆå°‘äººä¼šåœ¨ 12 ç‚¹çš„æ—¶å€™ä¼šå»å­¦ä¹ çš„ï¼Œåæ­£æˆ‘æ˜¯ä¸ä¼šçš„ã€‚ä½†æ˜¯å¦‚æœæ­¤æ—¶ä½ å»ç¡è§‰ï¼Œæ—©ä¸Š 8 ç‚¹èµ·æ¥å›æ€ä¹ˆæ ·å‘¢ï¼Ÿ
ä½ ä¼šå‘ç°èµ·æ¥çš„å°±ä½ ä¸€ä¸ªï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œä½ æƒ³æ‰¾åˆ«äººç©éƒ½æ‰¾ä¸åˆ°ã€‚é‚£ä¹ˆè¿™ä¹ˆç¾å¥½çš„æ—©æ™¨æ€»ä¸èƒ½èµ·åºŠçœ‹ç”µè§†å§ã€‚æƒ³çœ‹çš„ç”µè§†å‰§æ²¡æ›´æ–°ï¼Œæ™šä¸Šæ‰ä¼šæœ‰ï¼Ÿç„¶åé€‰æ‹©å»çœ‹ç›´æ’­ï¼Œè¿™ä¹ˆæ—©è°ä¼šç›´æ’­å•Šï¼Œç›´æ’­éƒ½ä¼šé€‰æ‹©åœ¨ä¸‹åˆæˆ–è€…æ˜¯æ™šä¸Š
å§ã€‚è°ä¼šåœ¨æ—©ä¸Šç»™ä½ å¼€ç›´æ’­å‘¢ï¼Ÿå¯¹ä¸å¯¹ï¼Œè¿™æ ·ä½ å‘ç°ä»€ä¹ˆéƒ½åšä¸äº†äº†ï¼Œäºæ˜¯å¼€å¼€å¿ƒå¿ƒçš„åƒä¸ªæ—©é¥­ã€‚å¥½äº†åˆ°è¿™é‡Œä½ å°±æ¯”åˆ«äººå¥åº·äº†ï¼Œæ—©é¥­çœŸçš„å¾ˆé‡è¦ã€‚å¤§å®¶ä¸€å®šè¦è®°å¾—åƒæ—©é¥­å•Šï¼Œåƒå®Œæ—©é¥­åï¼Œå› ä¸ºæ²¡æœ‰å¨±ä¹çš„å•Šï¼Œæ‰€ä»¥
å°±ä¼šå»çœ‹çœ‹ä¹¦å•Šï¼Œçœ‹çœ‹åšå®¢å•Šï¼Œå†™å†™ä»£ç å•Šã€‚ä¸€å¤©ä¸­æœ€å¥½çš„æ—¶é—´ä½ ç”¨åœ¨å­¦ä¹ ä¸Šï¼Œåˆ«äººç”¨åœ¨äº†ç¡è§‰äº†ã€‚é•¿æ­¤ä»¥å¾€ä½ ä¼šå‘ç°ï¼Œä½ å˜çš„è¶Šæ¥è¶Šå¥åº·ï¼Œè¶Šæ¥è¶Šä¼˜ç§€ã€‚è¿™ä¸ªæ”¶ç›Šæ˜¯å·¨å¤§çš„ã€‚</p><p>æ‰€ä»¥æ— è®ºæ˜¯ä»å“ªä¸ªæ–¹é¢æ¥è¯´ï¼Œéƒ½ä¸è¦ç†¬å¤œã€‚</p><p>æœ€ååœ¨å¼ºè°ƒä¸€ä¸‹ - <code>çæƒœç”Ÿå‘½ï¼Œä»ç°åœ¨å¼€å§‹</code></p></div>]]></content:encoded>
        </item>
    </channel>
</rss>