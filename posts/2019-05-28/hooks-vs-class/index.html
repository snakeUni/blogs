<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="shortcut icon" href="/fa.jpg"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="theme-color" content="#000000"/><link rel="manifest" href="/manifest.json"/>
    <title>React Hooks vs Class</title>
    <link rel="canonical" href="/posts/2019-05-28/hooks-vs-class" />
    <link rel="stylesheet" href="/static/css/1.27c8494b.chunk.css" />
  <link href="/static/css/main.0e6724e3.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__1wjbv"><div class="
        LoadingIndicator_LoadingIndicator__LXZCC
        
        undefined
      "></div><header><h3 class="BlogLayout_title__U0zfd"><a class=" " href="/">lanyincao</a></h3></header><main><article><header class="BlogPostLayout_header__6lPZ1"><h1 class="BlogPostLayout_title__1egAZ"><a class=" " href="/posts/2019-05-28/hooks-vs-class/">React Hooks vs Class</a></h1><small><time dateTime="Mon, 27 May 2019 16:00:00 GMT">May 28, 2019</time> <!-- -->â€¢<!-- --> <ul class="ArticleMeta_tags__30Wbg"><li><a class=" " href="/tags/react/">react</a></li><li><a class=" " href="/tags/hook/">hook</a></li><li><a class=" " href="/tags/class/">class</a></li></ul> <!-- -->â€¢<!-- --> <span>â˜•ï¸<!-- --> <!-- -->7<!-- --> min read</span></small></header><div class="BlogPostLayout_content__1CRXP"><h1 id="hooks-vs-class">Hooks vs Class</h1><p>React é‡Šæ”¾ <code>hooks</code> å·²ç»åŠå¹´äº†ï¼Œä» hooks åˆšåˆšé‡Šæ”¾çš„æ—¶å€™æˆ‘å°±å¼€å§‹å…³æ³¨ï¼Œå¹¶ä¸”å°±å¼€å§‹å»å°è¯•ä½¿ç”¨å®ƒã€‚ ä»é‡Šæ”¾åˆ°ç°åœ¨ hooks åˆšè¿‡ä¸å°‘ï¼Œ å†…éƒ¨æºç è‡³å°‘æ”¹äº†ä¸¤ä¸‰æ¬¡ï¼Œ é‚£ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« å‘¢ ï¼Ÿ æ˜¯å› ä¸ºä¸€æ¬¡å¶ç„¶çš„äº‹æƒ…å¼•å‘çš„ã€‚ æœ‰ä¸€å¤©<code>æ¸Šè™¹</code>è€å“¥æŠ±ç€ç”µè„‘å¯¹æˆ‘è¯´ï¼Œ ä½ çœ‹æˆ‘è¿™ä¸ªè¡¨å•çš„æäº¤æ—¶é—´å°±æ˜¯åœ¨è°ƒç”¨ <code>onSubmit</code> çš„æ—¶å€™æœ‰ç‚¹å»¶è¿Ÿå•Šï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘€? æˆ‘è¯•äº†ä¸€ä¸‹æœç„¶æ˜¯è¿™æ ·ï¼Œ å¾ˆå¥‡æ€ªäº†ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ ? äºæ˜¯æˆ‘æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯éš¾é“æˆ‘æŠŠ<code>åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†</code>å¯¼è‡´çš„ï¼Ÿ è¿˜æ˜¯æœ‰å¯èƒ½çš„å•Šï¼Œäºæ˜¯æˆ‘åœ¨ç¾¤é‡Œé—®äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜</p><img src="https://user-images.githubusercontent.com/17973020/58377052-f8fcdd80-7faa-11e9-9755-773651feb5a1.png" height="500"/><img src="https://user-images.githubusercontent.com/17973020/58377171-0ca94380-7fad-11e9-9030-cd2a7d5fe676.png" height="500"/><p>äºæ˜¯æˆ‘å°±åœ¨ç¬¬äºŒå¤©è·‘äº†ä¸€ä¸‹ï¼Œè¯•è¯•åŒæ­¥å½“åšå¼‚æ­¥å¤„ç†çš„è¯ï¼Œä¼šé€ æˆå¤šå°‘çš„å»¶è¿Ÿã€‚å½“æ•°é‡<code>å°äº100ä¸ª</code>æ—¶å€™ï¼Œç®€å•çš„å‡½æ•°åŒæ­¥å¼‚æ­¥æ—¶é—´åŸºæœ¬ä¸€è‡´ï¼Œ1000 ä¸ªçš„æ—¶å€™æ—¶é—´å°±æœ‰ä¸€äº›å°çš„å·®è·äº†ï¼Œ 10000 ä¸ªçš„æ—¶å€™å·®è·éå¸¸æ˜æ˜¾ï¼Œ <code>æ‰€ä»¥å¿…è¦çš„æ—¶å€™ï¼ŒåŒæ­¥è¿˜æ˜¯åŒæ­¥ï¼Œä¸è¦å½“åšå¼‚æ­¥æ¥å¤„ç†äº†</code>, é‚£ä¸€ä¸ª <code>form</code> å†…éƒ¨è¶…è¿‡ 100 ä¸ªæ ¡éªŒå‡½æ•°åŸºæœ¬ä¸å¯èƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹é¢æˆ‘å°±å¿½ç•¥äº†, é‚£ä¼šä¸ä¼šæ˜¯å¦å¤–ä¸€ç§å¯èƒ½å‘¢ï¼Ÿ</p><h2 id="render-æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ">render æ—¶é—´é•¿ä¸”æ¬¡æ•°å¤šå¯¼è‡´çš„å»¶è¿Ÿ</h2><p>å†ä¸€æ¬¡åˆ†æäº†<code>æ¸Šè™¹</code>è€å“¥çš„ä»£ç ï¼Œå‘ç°åœ¨æäº¤è¡¨å•çš„æ—¶å€™ï¼Œ<code>render</code> äº†å››æ¬¡ï¼Œäºæ˜¯æˆ‘å»æŸ¥äº†ä¸‹æºç ï¼Œå‘ç°è¿™å››æ¬¡åˆ†åˆ«æ˜¯ï¼Œ<code>æ ¡éªŒè®¾ç½®é”™è¯¯</code> =&gt; <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>è®¾ç½®è¡¨å•æ˜¯å¦æœ‰æ•ˆ</code> =&gt; <code>è®¾ç½®æäº¤æ¬¡æ•°</code>, ç„¶ååœ¨è°ƒç”¨ <code>onSubmit</code>ï¼Œ å“å‘€è¿™ä¸ªåœ°æ–¹æœ‰æœ‰å¾…ä¿®æ”¹çš„ï¼Œæ¯”å¦‚å¯ä»¥æ”¹æˆè¿™æ · <code>è®¾ç½®æäº¤çŠ¶æ€</code> =&gt; <code>å¦‚æœæœ‰æ•ˆï¼Œè°ƒç”¨ onSubmit åœ¨è®¾ç½®æœ‰æ•ˆçŠ¶æ€å’Œæäº¤æ¬¡æ•°</code>ã€‚ å¦åˆ™åœ¨ <code>è®¾ç½®é”™è¯¯å’ŒçŠ¶æ€</code>ï¼Œ è¿™æ ·å‘¢å°±èƒ½ä¿è¯ <code>onSubmit</code> çš„æäº¤åªæœ‰ä¸€æ¬¡ <code>setState</code> çš„æ“ä½œï¼Œçœ‹ä¸‹ä»£ç çš„æˆªå›¾</p><p>ä¹‹å‰çš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377128-31e98200-7fac-11e9-8627-685ce89c7ccf.png" alt="d97dca23"/></p><p>ä¿®æ”¹åçš„æäº¤</p><p><img src="https://user-images.githubusercontent.com/17973020/58377137-52194100-7fac-11e9-9503-dfc0e707c492.png" alt="fc8f38a3"/></p><p>è¿™æ ·åœ¨ <code>onSubmit</code> ä¹‹å‰å°±ä¼šè°ƒç”¨çš„å¾ˆå¿«ï¼Œ å³ä½¿ <code>render</code> å¾ˆè€—æ—¶</p><p>é‚£è‚¯å®šä¼šæœ‰äººæå‡ºæ¥è¿™æ ·çš„é—®é¢˜ï¼Œ render æ—¶é—´é•¿è¿™ä¸ªæ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„é—®é¢˜å¯¼è‡´çš„ï¼Œ é‚£ä¹ˆ <code>render</code> æ¬¡æ•°è¿‡å¤šè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œä¼š <code>render</code> è¿™ä¹ˆå¤šæ¬¡å‘¢ ï¼Ÿé‚£ä»è¿™é‡Œå°±å¼•èµ·ä»Šå¤©è¿™ä¸ªè¯é¢˜äº†ï¼Ÿ <code>class vs hooks</code></p><p>ä»£ç ç‚¹å‡»è¿™é‡Œ =&gt; <a class=" " href="https://codesandbox.io/s/hooks-vs-class-5buww">hooks vs class - CodeSandbox</a></p><p>æœ€ç®€å•çš„å°±æ˜¯åœ¨äº‹ä»¶ä¸­æ¥æµ‹è¯•åŒºåˆ«ã€‚<code>hooks and class</code> çš„ <code>increase</code> äº‹ä»¶éƒ½æ˜¯åŒæ­¥çš„ï¼Œæˆ‘ä»¬åœ¨ç‚¹å‡» <code>increasement</code> çš„æŒ‰é’®çš„æ—¶å€™æ‰“å¼€æ§åˆ¶å°çœ‹ä¸‹è¾“å‡ºæ˜¯ä»€ä¹ˆ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377138-65c4a780-7fac-11e9-9267-9b40f275e8c5.png" alt="45965b8f"/></p><p>å¯ä»¥çœ‹åˆ° <code>console</code> çš„é¡ºåºæ˜¯å…ˆè¾“å‡ºäº†äº‹ä»¶è°ƒç”¨ä¸­çš„ <code>console</code>ï¼Œ åœ¨è¾“å‡ºäº† <code>render</code> ä¸­çš„ <code>console</code>ï¼Œ è¿™ä¸ªå¤§å®¶éƒ½æ˜¯çŸ¥é“çš„ï¼Œ <code>setState</code> æ˜¯<a class=" " href="https://reactjs.org/docs/faq-state.html#when-is-setstate-asynchronous">å¼‚æ­¥çš„</a> , ä¿®æ”¹ä¸‹ä»£ç ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶å‡½æ•°é‡Œå¤šæ¬¡ <code>setState</code> ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿç»“æœè¾“å‡ºè¿˜æ˜¯ä¸€æ ·å‘¢ï¼Ÿå¯¹äºè¿™æ ·æ˜¯ä¸ºä»€ä¹ˆï¼Œå¯ä»¥çœ‹<a class=" " href="https://reactjs.org/docs/state-and-lifecycle.html#state-updates-may-be-asynchronous">å®˜ç½‘</a>ä»¥åŠ<a class=" " href="https://juejin.im/post/5b45c57c51882519790c7441">setState è§£æ</a>ï¼Œ
åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®ï¼Œè¿™ä¸ªå’Œ <code>decrease</code> æ˜¯ä¸€æ ·çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬åªå–ä¸€ä¸ªæ¥åˆ†æï¼Œ ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®åçœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377148-7ecd5880-7fac-11e9-8686-523fb69f01d7.png" alt="e5a1163b"/></p><p><code>hooks</code> render çš„æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œç„¶è€Œåœ¨ class ä¸­ render äº† å››æ¬¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿçœ‹èµ·æ¥å¾ˆå¥‡æ€ªæ˜¯ä¸æ˜¯ã€‚é‚£æˆ‘ä»¬ä¸å¦¨åœ¨ <code>hooks</code> ä¸­åœ¨å¢åŠ å‡ ä¸ªçœ‹çœ‹æ€ä¹ˆæ ·?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨çœ‹ä¸‹æ§åˆ¶å°çš„è¾“å‡º</p><p><img src="https://user-images.githubusercontent.com/17973020/58377153-8bea4780-7fac-11e9-8757-52307d8b6463.png" alt="2e4c8768"/></p><p>å®Œå…¨ä¸€æ ·ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨ä¿®æ”¹ä¸‹ï¼Œåœ¨ <code>hooks</code> ä¸­æ¯æ¬¡éƒ½è®¾ç½®ä¸ä¸€æ ·çš„å€¼çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¾“å‡ºå¦‚ä¸‹</p><p><img src="https://user-images.githubusercontent.com/17973020/58377157-986ea000-7fac-11e9-88d3-ca0bbd31882c.png" alt="47307b50"/></p><p>è¿™æ¬¡æ˜¯ä¸€è‡´äº†å¯¹ä¸å¯¹ï¼Œ éƒ½æ˜¯ <code>render</code> äº† 4 æ¬¡åæ‰è°ƒç”¨ <code>console</code> çš„ï¼Œè‡³äºåœ¨ class ä¸­ä¸ºä»€ä¹ˆè¡¨ç°æ˜¯è¿™æ ·çš„çœ‹<a class=" " href="https://juejin.im/post/5b45c57c51882519790c7441">ä¸Šé¢çš„æ–‡ç« </a></p><p>é‚£åœ¨ <code>hooks</code> ä¸­ä¸ºä»€ä¹ˆä¼šè¡¨ç°çš„å¦‚æ­¤ä¸ä¸€è‡´å‘¢ï¼Ÿ <a class=" " href="https://reactjs.org/docs/hooks-reference.html#bailing-out-of-a-state-update">å®˜ç½‘</a>ä¹Ÿè´´äº†å‡ºæ¥</p><p><img src="https://user-images.githubusercontent.com/17973020/58377158-a6bcbc00-7fac-11e9-9b78-54572ac17b52.png" alt="dccae51f"/></p><p>ä¼šç”¨ <code>Objest.is</code> ä¼šè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè®¤ä¸ºæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±ä¼š <code>bailout</code>, æœ‰çš„äººå¯èƒ½ä¼šå’Œæˆ‘æœ‰ä¸€æ ·çš„æƒ³æ³•ï¼Œå½“åˆæˆ‘åœ¨çœ‹è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘è§‰å¾—åœ¨è°ƒç”¨ç¬¬äºŒæ¬¡ <code>render</code> çš„æ—¶å€™å°±çŸ¥é“æ˜¯ä¸€æ ·çš„äº†ï¼Œé‚£åº”è¯¥ä¸ä¼šåœ¨åˆ° <code>commit</code> é˜¶æ®µäº†å§ã€‚æˆ‘ä»¬ä¸å¦¨æ¥è¯•è¯•</p><p>åœ¨ <code>hooks</code> åŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ class ä¸­ä¹ŸåŠ ä¸Šè¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>hooks</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy hook"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>class</code> ä¸­çš„ <code>increase</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function-variable function">increaseBy</span> <span class="token operator">=</span> <span class="token parameter">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fire increaseBy class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶åœ¨ç‚¹å‡» <code>increaseBy</code> æŒ‰é’®çœ‹ä¸‹è¾“å‡ºå¦‚ä½•ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/58377167-da97e180-7fac-11e9-930d-74da2f014e1e.png" alt="77290f12"/></p><p>æœçœŸæ˜¯è¿™æ ·çš„ï¼Œ åœ¨ <code>hooks</code> ä¸­ç¬¬äºŒæ¬¡æ‰§è¡Œ <code>render</code> å¹¶ä¸ä¼šåœ¨å»æ‰§è¡Œ <code>commit</code> äº†ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡ <code>render</code> çš„æ—¶å€™æ‰§è¡Œäº† <code>commit</code>ï¼Œ ç„¶è€Œ <code>class</code> ä¸­å´æ¯æ¬¡éƒ½æ‰§è¡Œäº†ã€‚</p><p>æœ‰çš„åŒå­¦ä¼šé—®æ‰§è¡Œ <code>setCount</code> çš„æ—¶å€™å†…éƒ¨æºç è‚¯å®šéƒ½ä¼šå»æ‰§è¡Œï¼Œ é‚£ä¸ºå•¥ä¸æ˜¯ <code>4</code> æ¬¡ <code>render</code>ï¼Œ <code>ä¸€æ¬¡ commit</code> å‘¢ ï¼Ÿé‚£æˆ‘ä»¬æ¥çœ‹ä¸‹æºç ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ</p><p>åœ¨ <code>è°ƒç”¨ setCount</code> çš„æ—¶å€™ä¼šè°ƒç”¨æºç ä¸­çš„ <code>dispatch</code>å‡½æ•°ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>count + number = 2</code> ç»“æœæ˜¯ <code>2</code> ä¸ç­‰äºä¸Šä¸€æ¬¡çš„ <code>0</code>, æ‰€ä»¥ä¼šèµ°åˆ° <code>updateReducer</code>,
åœ¨ <code>updateReducer</code> é‡Œé¢ä¼šè¿›è¡Œæ¯”è¾ƒ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ç›¸åŒä¼šå¦‚ä½•ï¼Œ ä¼šè¿›è¡Œæ ‡è®° <code>didReceiveUpdate</code>, æŠŠ <code>didReceiveUpdate</code> æ ‡è®°ä¸º <code>true</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸º <code>true</code>ï¼Œä¼šè¿›è¡Œæ›´æ–°ã€‚å¯¹äº <code>didReceiveUpdate</code> çš„å…¶ä»–æ ‡è®°æ˜¯åœ¨ <code>beginWork</code> å‡½æ•°ä¸­.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldProps <span class="token operator">=</span> current$<span class="token number">1.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ˜¯ç¬¬ä¸€æ¬¡ <code>setCount</code>ï¼Œ å½“ç¬¬äºŒæ¬¡ setCount çš„æ—¶å€™, <code>didReceiveUpdate</code> ä¸º <code>false</code>ï¼Œ ä¼šèµ°ä¸‹é¢è¿™æ®µä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>current$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didReceiveUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">bailoutHooks</span><span class="token punctuation">(</span>current$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
    current$<span class="token number">1</span><span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    renderExpirationTime
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ®µä»£ç åœ¨å¥½å‡ å¤„éƒ½æœ‰ï¼Œ å…¶ä¸­ä¸€å¤„å°±æ˜¯åœ¨ <code>updateFunctionComponent</code> è¿™ä¸ªå‡½æ•°ä¸­ã€‚é‚£ä¹ˆ <code>bailoutHooks</code> åšäº†ä»€ä¹ˆ ?</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>WIP</code> çš„ <code>updateQueue</code> æ›´æ–°ä¸º <code>current</code> çš„ <code>updateQueue</code></p><p><code>bailoutOnAlreadyFinishedWork</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
  <span class="token parameter">current$<span class="token number">1</span><span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  renderExpirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cancelWorkTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current$<span class="token number">1</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reuse previous context list</span>
    workInProgress<span class="token punctuation">.</span>contextDependencies <span class="token operator">=</span> current$<span class="token number">1.</span>contextDependencies<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't update "base" render times for bailouts.</span>
    <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check if the children have any pending work.</span>
  <span class="token keyword">var</span> childExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The children don't have any work either. We can skip them.</span>
    <span class="token comment">// TODO: Once we add back resuming, we should check if the children are</span>
    <span class="token comment">// a work-in-progress set. If so, we need to transfer their effects.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// This fiber doesn't have work, but its subtree does. Clone the child</span>
    <span class="token comment">// fibers and continue.</span>
    <span class="token function">cloneChildFibers</span><span class="token punctuation">(</span>current$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å½“æ‰§è¡Œåˆ°ç¬¬ä¸‰æ¬¡ <code>setCount</code> çš„æ—¶å€™ï¼Œ ä¼šè¢«ç›´æ¥ <code>return</code> ä»£ç åœ¨ <code>dispatchAction</code> ä¸­,
å› ä¸ºåœ¨ <code>queue.dispatch</code> ç»‘å®šäº† <code>dispatchAction</code></p><pre><code class="language-jsx(84)" data-language="jsx(84)" data-highlighted-line-numbers="">function dispatchAction(fiber, queue, action) {
  !(numberOfReRenders &lt; RE_RENDER_LIMIT)
    ? invariant(
        false,
        &quot;Too many re-renders. React limits the number of renders to prevent an infinite loop.&quot;
      )
    : void 0;

  {
    !(arguments.length &lt;= 3)
      ? warning$1(
          false,
          &quot;State updates from the useState() and useReducer() Hooks don&#39;t support the &quot; +
            &quot;second callback argument. To execute a side effect after &quot; +
            &quot;rendering, declare it in the component body with useEffect().&quot;
        )
      : void 0;
  }

  var alternate = fiber.alternate;
  if (
    fiber === currentlyRenderingFiber$1 ||
    (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber$1)
  ) {
    // This is a render phase update. Stash it in a lazily-created map of
    // queue -&gt; linked list of updates. After this render pass, we&#39;ll restart
    // and apply the stashed updates on top of the work-in-progress hook.
    didScheduleRenderPhaseUpdate = true;
    var update = {
      expirationTime: renderExpirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };
    if (renderPhaseUpdates === null) {
      renderPhaseUpdates = new Map();
    }
    var firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);
    if (firstRenderPhaseUpdate === undefined) {
      renderPhaseUpdates.set(queue, update);
    } else {
      // Append the update to the end of the list.
      var lastRenderPhaseUpdate = firstRenderPhaseUpdate;
      while (lastRenderPhaseUpdate.next !== null) {
        lastRenderPhaseUpdate = lastRenderPhaseUpdate.next;
      }
      lastRenderPhaseUpdate.next = update;
    }
  } else {
    flushPassiveEffects();

    var currentTime = requestCurrentTime();
    var _expirationTime = computeExpirationForFiber(currentTime, fiber);

    var _update2 = {
      expirationTime: _expirationTime,
      action: action,
      eagerReducer: null,
      eagerState: null,
      next: null
    };

    // Append the update to the end of the list.
    var _last = queue.last;
    if (_last === null) {
      // This is the first update. Create a circular list.
      _update2.next = _update2;
    } else {
      var first = _last.next;
      if (first !== null) {
        // Still circular.
        _update2.next = first;
      }
      _last.next = _update2;
    }
    queue.last = _update2;

    if (
      fiber.expirationTime === NoWork &amp;&amp;
      (alternate === null || alternate.expirationTime === NoWork)
    ) {
      // The queue is currently empty, which means we can eagerly compute the
      // next state before entering the render phase. If the new state is the
      // same as the current state, we may be able to bail out entirely.
      var _lastRenderedReducer = queue.lastRenderedReducer;
      if (_lastRenderedReducer !== null) {
        var prevDispatcher = void 0;
        {
          prevDispatcher = ReactCurrentDispatcher$1.current;
          ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnUpdateInDEV;
        }
        try {
          var currentState = queue.lastRenderedState;
          var _eagerState = _lastRenderedReducer(currentState, action);
          // Stash the eagerly computed state, and the reducer used to compute
          // it, on the update object. If the reducer hasn&#39;t changed by the
          // time we enter the render phase, then the eager state can be used
          // without calling the reducer again.
          _update2.eagerReducer = _lastRenderedReducer;
          _update2.eagerState = _eagerState;
          if (is(_eagerState, currentState)) {
            console.log(&quot;ç›´æ¥é€€å‡º&quot;);
            // Fast path. We can bail out without scheduling React to re-render.
            // It&#39;s still possible that we&#39;ll need to rebase this update later,
            // if the component re-renders for a different reason and by that
            // time the reducer has changed.
            return;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        } finally {
          {
            ReactCurrentDispatcher$1.current = prevDispatcher;
          }
        }
      }
    }
    {
      if (shouldWarnForUnbatchedSetState === true) {
        warnIfNotCurrentlyBatchingInDev(fiber);
      }
    }
    scheduleWork(fiber, _expirationTime);
  }
}
</code></pre><p><code>_lastRenderedReducer</code> å°±æ˜¯ <code>basicStateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç¬¬ä¸‰ç¬¬å››æ¬¡ä¼šåœ¨è¿™ä¸ªåˆ¤æ–­è¯­å¥é‡Œé€€å‡ºã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is</span><span class="token punctuation">(</span>_eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Fast path. We can bail out without scheduling React to re-render.</span>
  <span class="token comment">// It's still possible that we'll need to rebase this update later,</span>
  <span class="token comment">// if the component re-renders for a different reason and by that</span>
  <span class="token comment">// time the reducer has changed.</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>é‚£ä¹ˆç¬¬äºŒæ¬¡ä¸ºä»€ä¹ˆä¸åœ¨è¿™é‡Œé€€å‡ºå‘¢ ï¼Ÿ åœ¨ç¬¬äºŒæ¬¡è¿™é‡Œçš„è¯­å¥æ˜¯ <code>false</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>è¿½æº¯ä¸‹å†…éƒ¨çš„è°ƒç”¨ï¼Œ åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ <code>fiber.expirationTime !== NoWork</code>, æ‰€ä»¥è¿™ä¸ªåˆ¤æ–­è¯­å¥å°±ä¸ä¼šèµ°, é‚£ä¹ˆç¬¬ä¸‰æ¬¡ä¸ºä»€ä¹ˆåˆç›¸ç­‰äº†å‘¢ï¼Ÿå†ä¸€æ¬¡çœ‹ä¸‹ <code>bailoutHooks</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">bailoutHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>Passive <span class="token operator">|</span> Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>current.expirationTime = NoWork;</code> è¿›è¡Œäº†èµ‹å€¼ã€‚æ‰€ä»¥è¿™å°±æ˜¯æ•´ä¸ªè¿‡ç¨‹äº†ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p><code>class</code> å’Œ <code>hooks</code> ä¸­åŸºæœ¬ä¿æŒä¸€è‡´, ä½†æ˜¯ <code>hooks</code> ä¸­ä¼šåšä¸€å±‚ <code>Object.is</code> çš„åˆ¤æ–­ï¼Œ
æ‰€ä»¥åœ¨è¿›è¡ŒçŠ¶æ€æ›´æ–°çš„æ—¶å€™ï¼Œ éœ€è¦æ³¨æ„ä¸‹è¿™ç‚¹ã€‚è¿˜æœ‰åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œ <code>hooks</code> ä¹Ÿæ— æ³•æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œ å› ä¸ºåœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œ æ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°ï¼Œ æ‰€ä»¥è¾“å‡ºçš„éƒ½æ˜¯ä¹‹å‰çš„å€¼ï¼Œ è¿™ä¸ªç‚¹è¦æ³¨æ„ä¸€ä¸‹ã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒ <code>Dan</code> çš„åšå®¢ <a class=" " href="https://overreacted.io/a-complete-guide-to-useeffect/">A Complete Guide to useEffect</a></p><p><a class=" " href="https://codesandbox.io/s/hooks-vs-class-5buww">æŸ¥çœ‹ä»£ç </a></p></div><footer class="BlogPostLayout_footer__1p0Ii"><h3 class="BlogPostLayout_title__1egAZ"><a class=" " href="/">lanyincao</a></h3><div class="
      Bio_Bio__1eiKY
      BlogPostLayout_bio__2AHhA
    "><img src="/static/media/bio-pic.fdbb64ab.jpeg" alt="lanyincao"/><p>Personal blog by <a href="https://twitter.com/lanyincao">lanyincao</a>.<br/>I can&#x27;t sing, dance, rap but can code, ğŸ€</p></div><section class="BlogPostLayout_links__1fVhZ"><a class=" " href="/posts/2019-06-03/state/">â† <!-- -->React Hooks State ğŸ¤”</a><a class="BlogPostLayout_next__3tOcG " href="/posts/2019-04-13/forwardRef/">React.forwardRef<!-- --> â†’</a></section></footer></article></main></div></div><script>!function(o){function e(e){for(var t,r,n=e[0],c=e[1],f=e[2],d=0,a=[];d<n.length;d++)r=n[d],l[r]&&a.push(l[r][0]),l[r]=0;for(t in c)Object.prototype.hasOwnProperty.call(c,t)&&(o[t]=c[t]);for(p&&p(e);a.length;)a.shift()();return i.push.apply(i,f||[]),u()}function u(){for(var e,t=0;t<i.length;t++){for(var r=i[t],n=!0,c=1;c<r.length;c++){var f=r[c];0!==l[f]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},a={43:0},l={43:0},i=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(i){var e=[];a[i]?e.push(a[i]):0!==a[i]&&{1:1,23:1}[i]&&e.push(a[i]=new Promise(function(e,n){for(var t="static/css/"+({}[i]||i)+"."+{1:"27c8494b",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0",16:"31d6cfe0",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0",20:"31d6cfe0",21:"31d6cfe0",22:"31d6cfe0",23:"d3b34b05",24:"31d6cfe0",25:"31d6cfe0",26:"31d6cfe0",27:"31d6cfe0",28:"31d6cfe0",29:"31d6cfe0",30:"31d6cfe0",31:"31d6cfe0",32:"31d6cfe0",33:"31d6cfe0",34:"31d6cfe0",35:"31d6cfe0",36:"31d6cfe0",37:"31d6cfe0",38:"31d6cfe0",39:"31d6cfe0",40:"31d6cfe0",41:"31d6cfe0"}[i]+".chunk.css",c=s.p+t,r=document.getElementsByTagName("link"),f=0;f<r.length;f++){var d=(o=r[f]).getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(d===t||d===c))return e()}var a=document.getElementsByTagName("style");for(f=0;f<a.length;f++){var o;if((d=(o=a[f]).getAttribute("data-href"))===t||d===c)return e()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=e,u.onerror=function(e){var t=e&&e.target&&e.target.src||c,r=new Error("Loading CSS chunk "+i+" failed.\n("+t+")");r.request=t,n(r)},u.href=c,document.getElementsByTagName("head")[0].appendChild(u)}).then(function(){a[i]=0}));var r=l[i];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[i]=[e,t]});e.push(r[2]=t);var n,c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.charset="utf-8",f.timeout=120,s.nc&&f.setAttribute("nonce",s.nc),f.src=s.p+"static/js/"+({}[i]||i)+"."+{1:"18016ef5",2:"f51ae852",3:"2d812e0c",4:"959e45b9",5:"031228ef",6:"da64b01a",7:"c20265b4",8:"3708fc80",9:"76d5a1f1",10:"64d279dc",11:"15bdaa3d",12:"a289339e",13:"6ed3fae5",14:"c0219476",15:"1b2dfa34",16:"c95df50e",17:"854d2668",18:"fe4e0156",19:"75b2ab08",20:"5cc3e2dd",21:"85a6bb34",22:"f5b6dab9",23:"873b678f",24:"299ad1b2",25:"26732315",26:"8ed938bb",27:"9e08b9c8",28:"8c5bf47d",29:"651315e7",30:"4de03612",31:"a827ef55",32:"9f8e8c89",33:"4e98a6ac",34:"8fa7acd9",35:"f7fd16e7",36:"c8a9136e",37:"7fd46dad",38:"ab859197",39:"242ef20f",40:"a8b763a6",41:"fe59cd2f"}[i]+".chunk.js",n=function(e){f.onerror=f.onload=null,clearTimeout(d);var t=l[i];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,c=new Error("Loading chunk "+i+" failed.\n("+r+": "+n+")");c.type=r,c.request=n,t[1](c)}l[i]=void 0}};var d=setTimeout(function(){n({type:"timeout",target:f})},12e4);f.onerror=f.onload=n,c.appendChild(f)}return Promise.all(e)},s.m=o,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var c=0;c<t.length;c++)e(t[c]);var p=n;u()}([])</script><script src="/static/js/42.e4ff5a7a.chunk.js"></script><script src="/static/js/main.763db4b1.chunk.js"></script></body></html>