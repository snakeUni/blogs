<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="shortcut icon" href="/fa.jpg"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="theme-color" content="#000000"/><link rel="manifest" href="/manifest.json"/>
    <title>React Hooks State ğŸ¤”</title>
    <link rel="canonical" href="/posts/2019-06-03/state" />
    <link rel="stylesheet" href="/static/css/1.2800b7fc.chunk.css" />
  <link href="/static/css/main.b2d7ecbb.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__1wjbv"><div class="
        LoadingIndicator_LoadingIndicator__LXZCC
        
        undefined
      "></div><header><h3 class="BlogLayout_title__U0zfd"><a class=" " href="/">lanyincao</a></h3></header><main><article><header class="BlogPostLayout_header__6lPZ1"><h1 class="BlogPostLayout_title__1egAZ"><a class=" " href="/posts/2019-06-03/state/">React Hooks State ğŸ¤”</a></h1><small><time dateTime="Sun, 02 Jun 2019 16:00:00 GMT">June 3, 2019</time> <!-- -->â€¢<!-- --> <ul class="ArticleMeta_tags__30Wbg"><li><a class=" " href="/tags/react/">react</a></li><li><a class=" " href="/tags/hook/">hook</a></li><li><a class=" " href="/tags/state/">state</a></li></ul> <!-- -->â€¢<!-- --> <span>â˜•ï¸<!-- --> <!-- -->6<!-- --> min read</span></small></header><div class="BlogPostLayout_content__1CRXP"><h1 id="setxxxx-vs-setstate">setXXXX vs setState</h1><p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºäº†åˆ†æ <code>Hooks</code> ä¸­ <code>setXXX</code> å’Œ class ä¸­ <code>setState</code> çš„ä¸€äº›ä¸åŒä¹‹å¤„ï¼Œ <a class=" " href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> åˆ†æäº† <code>state</code> çš„éƒ¨åˆ†ä¸åŒï¼Œä»¥åŠå„è‡ªè°ƒç”¨è§¦å‘çš„ <code>render</code> æ¬¡æ•°çš„åˆ†æï¼Œ åŒæ­¥å’Œå¼‚æ­¥çŠ¶æ€ä¸‹çš„åŒºåˆ«ã€‚è¦è®°ä½çš„æ˜¯åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œ<code>setXXX</code> ä¼šè¿›è¡Œ <code>Object.is</code> è¿›è¡Œæ¯”è¾ƒã€‚</p><h2 id="åŸå› ">åŸå› </h2><p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºæ˜¨å¤© <code>åŸå‹é“¾</code> åœ¨å†™ <code>form</code> çš„æ—¶å€™é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œ è‡³äºä¸ºä»€ä¹ˆåˆæ˜¯ <code>form</code> æˆ‘å°±ä¸å¤šåšæè¿°äº†ã€‚è¿™æ˜¯æˆ‘å’Œ <code>åŸå‹é“¾</code> çš„å¯¹è¯:</p><p><code>åŸå‹é“¾</code>: è“é“¶è‰ä¸ºä»€ä¹ˆæˆ‘è°ƒç”¨ <code>setFieldValue</code> è®¾ç½®çš„å€¼ä¸æ­£ç¡®å‘¢ï¼Ÿ
<code>æˆ‘</code>ï¼šä½ æ˜¯æ€ä¹ˆè°ƒç”¨çš„å‘¢ï¼Ÿ
<code>åŸå‹é“¾</code>: æˆ‘æ˜¯è¿ç»­è°ƒç”¨ <code>setFieldValue</code> ä¸¤æ¬¡ï¼Œç»“æœéƒ½æ˜¯æœ€åä¸€æ¬¡ç”Ÿæ•ˆï¼Œä½†æ˜¯è°ƒç”¨ <code>setValues</code> å°±æ˜¯å¥½çš„ã€‚
<code>æˆ‘</code>ï¼šä¸å¯èƒ½å§ï¼Œæˆ‘çœ‹ä¸‹ä½ çš„å®ç°ï¼Œçœ‹äº†ä¸‹åŸå‹é“¾çš„æ¼”ç¤ºï¼ŒåŸæ¥å¦‚æ­¤ï¼Œæˆ‘çŸ¥é“äº†ä¸ºä»€ä¹ˆåªæ˜¾ç¤ºæœ€åä¸€ä¸ªäº†ï¼Œè¿™æ˜¯ <code>React</code> å‡½æ•°ç»„ä»¶å¯¼è‡´çš„è¿™ä¸ªé—®é¢˜ã€‚</p><p><a class=" " href="https://codesandbox.io/s/funny-mclean-6lru4">å…·ä½“æ —å­ç‚¹å‡»è¿™é‡Œ</a></p><p><code>hook</code> ä»£ç </p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render hook"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hooks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      name:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby sync</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick1<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick2<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick3<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginLeft<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          set name and hobby by callback async
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨ä»£ç é‡Œç‚¹å‡»æŒ‰é’®ï¼Œç„¶åè®¾ç½® <code>name</code> å’Œ <code>hobby</code>, å¯èƒ½æœ‰äººä¼šé—®è¿™ä¸æ˜¯ä¸¤ä¸ªå±æ€§å€¼ä¸€èµ·è®¾ç½®å˜›ï¼Œä¸ºä»€ä¹ˆä¸<code>setState({ ...state, name: &#x27;ç‰§äº‘äº‘&#x27;, hobby: &#x27;coding&#x27; })</code>, å› ä¸ºå½“æ—¶ <code>setFieldValue</code> çš„ç”¨æ³•æ˜¯ <code>setFieldValue(key, value)</code>, æ‰€ä»¥å°±è°ƒç”¨äº†å¤šæ¬¡ã€‚æ­¤æ—¶ç‚¹å‡» <code>set name and hobby sync</code> æŒ‰é’®ï¼Œä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817731-a3221800-9353-11e9-8a15-88bdbc67bcdd.png" alt="cc37e062"/></p><p>å¯ä»¥çœ‹åˆ°åœ¨äº‹ä»¶ä¸­è¾“å‡ºçš„éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ <code>state</code>, ç„¶å <code>render</code> äº†ä¸€æ¬¡ï¼Œä¸ºä»€ä¹ˆ <code>render</code> äº†ä¸€æ¬¡å¯ä»¥çœ‹æˆ‘<a class=" " href="https://uni-blog.netlify.com/posts/2019-05-28/hooks-vs-class/">ä¸Šç¯‡æ–‡ç« </a> ä¸­çš„é“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè·³è¿‡è¿™é‡Œï¼Œçœ‹ <code>render éƒ¨åˆ†</code>çš„è¾“å‡º</p><p><code>handleClick</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change hobby sync"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>å¯ä»¥çœ‹å‡ºåªæœ‰ç¬¬äºŒä¸ªç”Ÿæ•ˆäº†ï¼Œç›´æ¥çœ‹è¿™ä¸ªåº”è¯¥å¾ˆå®¹æ˜“çŸ¥é“ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸€æ¬¡ <code>setState</code> çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>name</code> æ˜¯ <code>ç‰§äº‘äº‘</code>, ä½†æ˜¯åœ¨è®¾ç½®ç¬¬äºŒä¸ªçš„æ—¶å€™ï¼Œ æ­¤æ—¶çš„ <code>state</code> è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ <code>name: ç‰§è€å¸ˆ</code> è¿™ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥åœ¨åˆå¹¶çš„è¿‡ç¨‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœ€åä¸€æ¬¡çš„ <code>setState</code> çš„å†…å®¹ï¼Œé‚£ä¹ˆè¾“å‡ºçš„å°±æ˜¯åªæœ‰ <code>hobby: coding</code> ç”Ÿæ•ˆã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥è¿‡ç¨‹ä¸­å‘¢ï¼Ÿæˆ–è€…æ˜¯ <code>é React åˆæˆäº‹ä»¶å’Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­</code>, å†æ¬¡ç‚¹å‡» <code>set name and hobby async</code>, é‚£ä¹ˆè¾“å‡ºåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><code>handleClick1</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setTimeout(() => {</span>
    <span class="token comment">//   setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">//   console.log("hook state change name async", state);</span>
    <span class="token comment">// }, 3000);</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817757-b8974200-9353-11e9-9dda-b211de81e24d.png" alt="55a12b25"/></p><p>å¯ä»¥çœ‹åˆ° <code>render</code> äº†ä¸¤æ¬¡ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¹Ÿèµ°äº†ä¸¤æ¬¡ï¼Œè¿™ä¸ªä¸æ˜¯æˆ‘ä»¬ä»Šå¤©å…³å¿ƒçš„é‡ç‚¹ï¼Œä»Šå¤©å…³å¿ƒçš„é‡ç‚¹åœ¨ <code>state</code> çš„æ›´æ–°ä¸Š, ç¬¬ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ <code>name</code> å‘ç”Ÿäº†å˜æ›´ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> ä»ç„¶æ˜¯ä¹‹å‰çš„ <code>name: ç‰§è€å¸ˆ</code>ï¼Œ æ‰€ä»¥ç¬¬ä¸€æ¬¡è®¾ç½®çš„ <code>name: ç‰§äº‘äº‘</code> è¢«è¦†ç›–äº†ï¼Œé¡µé¢ä¸ŠåŸºæœ¬çœ‹ä¸å‡ºæ¥ <code>name</code> å˜åŒ–çš„è¿‡ç¨‹, é‚£æˆ‘ä»¬æŠŠç¬¬äºŒä¸ª <code>setState</code> æ”¾åˆ° <code>setTimeout</code> ä¸­å‘¢ï¼Œ æ­¤æ—¶é¡µé¢çš„å˜åŒ–è¿‡ç¨‹æ˜¯å¾ˆå®¹æ˜“çœ‹å‡ºæ¥çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// setState({ ...state, hobby: "coding" });</span>
    <span class="token comment">// console.log("hook state change name async", state);</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook state change name async"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>è¿™æ ·ä¿®æ”¹çš„è¯ï¼Œ é¡µé¢çš„å˜åŒ–è¿‡ç¨‹å°±å¾ˆæ¸…æ™°.è¿™ä¸ªå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ä¾‹å­.</p><h4 id="usecallback">useCallback</h4><p><code>setState</code> åœ¨ hooks ä¸­å’Œ class ä¸­éƒ½æ˜¯æ”¯æŒå›è°ƒçš„æ–¹å¼çš„ï¼Œé‚£ä¹ˆä¸å¦¨å°è¯•ä¸€ä¸‹å›è°ƒçš„æ–¹å¼</p><p><code>handleClick2</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook sync:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆè¾“å‡ºçš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817787-d5337a00-9353-11e9-88e1-e2306f65b8cf.png" alt="42e8111c"/></p><p>å’Œæˆ‘ä»¬é¢„æœŸçš„æ˜¯ä¸€è‡´çš„ï¼Œ<code>name</code> å’Œ <code>hobby</code> éƒ½å‘ç”Ÿäº†æ›´æ–°, è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå•ç‹¬çœ‹ä»£ç å¯ä»¥çŸ¥é“åœ¨æ‰§è¡Œå‡½æ•°çš„æ—¶å€™éƒ½ä¼šæŠŠä¸Šä¸€æ¬¡çš„ <code>state</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ¯æ¬¡ <code>preState</code> éƒ½æ˜¯ä¸Šä¸€æ¬¡æœ€æ–°çš„ <code>state</code> æ‰€ä»¥èƒ½æ‹¿åˆ°æœ€æ–°çš„ã€‚é‚£ä¹ˆåœ¨å¼‚æ­¥ä¸­è¡¨ç°åˆæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ
æ‰§è¡Œå¼‚æ­¥çš„ä»£ç </p><p><code>handleClick3</code> å‡½æ•°</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">preState</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pre hook async:"</span><span class="token punctuation">,</span> preState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>preState<span class="token punctuation">,</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817797-e2506900-9353-11e9-8aac-c71f58ceb4e6.png" alt="1bf0c6c2"/></p><p>è¡¨ç°çš„æ˜¯ä¸€è‡´çš„ã€‚åœ¨ class ä¸­è¡¨ç°çš„æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ ?</p><h3 id="class">Class</h3><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"ç‰§è€å¸ˆ"</span><span class="token punctuation">,</span>
    hobby<span class="token punctuation">:</span> <span class="token string">"å”±, è·³, rap"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"update class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"ç‰§äº‘äº‘"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hobby<span class="token punctuation">:</span> <span class="token string">"coding"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render class"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Class</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
        name:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">, hobby:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hobby<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">set name and hobby</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ç‚¹å‡»æŒ‰é’®çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœ</p><p><img src="https://user-images.githubusercontent.com/17973020/59817816-f5fbcf80-9353-11e9-8d37-9aa3820dacbb.png" alt="c6f6e146"/></p><p><code>class</code> ä¸­è¡¨ç°çš„æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåœ¨ class ä¸­ï¼Œ state æ˜¯æŒ‚åœ¨ <code>this</code> ä¸Šå§‹ç»ˆè¿™ä¸ª state éƒ½æ˜¯ç›¸åŒçš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡ <code>setState</code> åï¼Œæ­¤æ—¶çš„ <code>name</code> ä¿®æ”¹ä¸ºäº† <code>ç‰§äº‘äº‘</code>ï¼Œ å†ä¸€æ¬¡è°ƒç”¨ <code>setState</code> çš„æ—¶å€™ï¼Œå†…éƒ¨æ‹¿åˆ°çš„ <code>this.state</code> å·²ç»æ˜¯æœ€æ–°çš„ <code>name</code> äº†ï¼Œæ‰€ä»¥åœ¨è®¾ç½® <code>hobby</code> çš„æ—¶å€™å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚</p><p>çœ‹ä¸‹ <code>updateReducer</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
  <span class="token operator">!</span><span class="token punctuation">(</span>queue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Should have a queue. This is likely a bug in React. Please file an issue.'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>numberOfReRenders <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a re-render. Apply the new render phase updates to the previous</span>
    <span class="token keyword">var</span> _dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render phase updates are stored in a map of queue -> linked list</span>
      <span class="token operator">...</span>çœç•¥éƒ¨åˆ†
    <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> _dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The last update in the entire queue</span>
  <span class="token keyword">var</span> last <span class="token operator">=</span> queue<span class="token punctuation">.</span>last<span class="token punctuation">;</span>
  <span class="token comment">// The last update that is part of the base state.</span>
  <span class="token keyword">var</span> baseUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">;</span>
  <span class="token keyword">var</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>

  <span class="token comment">// Find the first unprocessed update.</span>
  <span class="token keyword">var</span> first <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseUpdate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// For the first update, the queue is a circular linked list where</span>
      <span class="token comment">// `queue.last.next = queue.first`. Once the first update commits, and</span>
      <span class="token comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span>
      last<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    first <span class="token operator">=</span> baseUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    first <span class="token operator">=</span> last <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> last<span class="token punctuation">.</span>next <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _newState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevUpdate <span class="token operator">=</span> baseUpdate<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _update <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token keyword">var</span> didSkip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> updateExpirationTime <span class="token operator">=</span> _update<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Priority is insufficient. Skip this update. If this is the first</span>
        <span class="token comment">// skipped update, the previous update/state is the new base</span>
        <span class="token comment">// update/state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          didSkip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
          newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update the remaining priority in the queue.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">></span> remainingExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          remainingExpirationTime <span class="token operator">=</span> updateExpirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Process this update.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
          <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
          _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
          _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      prevUpdate <span class="token operator">=</span> _update<span class="token punctuation">;</span>
      _update <span class="token operator">=</span> _update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>_update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> _update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newBaseUpdate <span class="token operator">=</span> prevUpdate<span class="token punctuation">;</span>
      newBaseState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark that the fiber performed work, but only if the new state is</span>
    <span class="token comment">// different from the current state.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseUpdate <span class="token operator">=</span> newBaseUpdate<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>

    queue<span class="token punctuation">.</span>lastRenderedState <span class="token operator">=</span> _newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><img src="https://user-images.githubusercontent.com/17973020/59817874-23e11400-9354-11e9-8f56-bf6995fc93e3.jpg" alt="ddda387a"/></p><p>å…³æ³¨è¿™å—ä»£ç </p><p><img src="https://user-images.githubusercontent.com/17973020/59817900-38bda780-9354-11e9-8769-0d2e3d62336d.jpg" alt="8764128b"/></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">if</span> <span class="token punctuation">(</span>_update<span class="token punctuation">.</span>eagerReducer <span class="token operator">===</span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If this update was processed eagerly, and its reducer matches the</span>
  <span class="token comment">// current reducer, we can use the eagerly computed state.</span>
  _newState <span class="token operator">=</span> _update<span class="token punctuation">.</span>eagerState<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _action2 <span class="token operator">=</span> _update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
  _newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>_newState<span class="token punctuation">,</span> _action2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ª <code>reducer</code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span>basicStateReducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰€ä»¥è¿™ä¸ª <code>reducer</code> å°±æ˜¯ <code>basicStateReducer</code>, ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°å°±æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯å‡½æ•°å°±ç›´æ¥è¿”å›è¿™ä¸ª <code>state</code>. <code>_update.action</code> å­˜å‚¨çš„å°±æ˜¯<code>setXX</code> çš„å‚æ•°ï¼Œæ‰€ä»¥åœ¨ä¼ é€’çš„ä¸æ˜¯å‡½æ•°çš„æ—¶å€™ç›´æ¥å°±ä¼šè¿”å› <code>_action2</code>, å¦åˆ™å°±ä¼šè¿”å› <code>_action2(_newState)</code> æ‹¿åˆ°æœ€æ–°çš„å€¼.</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆ <code>ä¼ é€’è¿›å»çš„ State</code> ä¸æ˜¯æœ€æ–°çš„å‘¢ï¼Ÿ å¯ä»¥å‚è€ƒ <a class=" " href="https://overreacted.io/how-are-function-components-different-from-classes/">How Are Function Components Different from Classes?</a> <code>Dan</code> åœ¨è¿™ç¯‡æ–‡ç« é‡Œé¢è¯¦ç»†è¯´æ˜äº†ï¼Œæ¯æ¬¡ <code>render</code> éƒ½æ˜¯æ–°çš„å‡½æ•°.</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç±»ç»„ä»¶ä¸­ï¼Œ <code>setState</code> ä¼šè‡ªåŠ¨è¿›è¡Œå€¼çš„åˆå¹¶ï¼Œæ‰€ä»¥å¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯åœ¨ <code>hooks</code> ä¸­åœ¨è°ƒç”¨ <code>setXXX</code> çš„æ—¶å€™å¿…é¡»è¦è®¾ç½®å…¨éƒ¨çš„å€¼ï¼Œå¹¶ä¸”ç”±äºå‡½æ•°é—­åŒ…çš„ç‰¹æ€§ï¼Œè°ƒç”¨å¤šæ¬¡ <code>setXXXX</code> è¿›è¡Œå¯¹è±¡ç»“æ„èµ‹å€¼çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„ <code>state</code> å§‹ç»ˆæ˜¯ä¹‹å‰çš„ <code>state</code>ï¼Œ å¦‚æœè¦æƒ³è·å–åˆ°æœ€æ–°çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>setXXX(callback)</code> çš„æ–¹å¼æ‹¿åˆ°æœ€æ–°çš„å€¼.</p></div><footer class="BlogPostLayout_footer__1p0Ii"><h3 class="BlogPostLayout_title__1egAZ"><a class=" " href="/">lanyincao</a></h3><div class="
      Bio_Bio__1eiKY
      BlogPostLayout_bio__2AHhA
    "><img src="/static/media/bio-pic.fdbb64ab.jpeg" alt="lanyincao"/><p>Personal blog by <a href="https://twitter.com/lanyincao">lanyincao</a>.<br/>I can&#x27;t sing, dance, rap but can code, ğŸ€</p></div><section class="BlogPostLayout_links__1fVhZ"><a class=" " href="/posts/2019-08-10/context/">â† <!-- -->React Context ğŸ˜</a><a class="BlogPostLayout_next__3tOcG " href="/posts/2019-05-28/hooks-vs-class/">React Hooks vs Class<!-- --> â†’</a></section></footer></article></main></div></div><script>!function(u){function e(e){for(var t,r,n=e[0],o=e[1],c=e[2],a=0,f=[];a<n.length;a++)r=n[a],l[r]&&f.push(l[r][0]),l[r]=0;for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&(u[t]=o[t]);for(p&&p(e);f.length;)f.shift()();return d.push.apply(d,c||[]),i()}function i(){for(var e,t=0;t<d.length;t++){for(var r=d[t],n=!0,o=1;o<r.length;o++){var c=r[o];0!==l[c]&&(n=!1)}n&&(d.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},f={21:0},l={21:0},d=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return u[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(d){var e=[];f[d]?e.push(f[d]):0!==f[d]&&{1:1,11:1,12:1}[d]&&e.push(f[d]=new Promise(function(e,n){for(var t="static/css/"+({}[d]||d)+"."+{1:"2800b7fc",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"8dbc6811",12:"9aab19da",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0",16:"31d6cfe0",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0"}[d]+".chunk.css",o=s.p+t,r=document.getElementsByTagName("link"),c=0;c<r.length;c++){var a=(u=r[c]).getAttribute("data-href")||u.getAttribute("href");if("stylesheet"===u.rel&&(a===t||a===o))return e()}var f=document.getElementsByTagName("style");for(c=0;c<f.length;c++){var u;if((a=(u=f[c]).getAttribute("data-href"))===t||a===o)return e()}var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.onload=e,i.onerror=function(e){var t=e&&e.target&&e.target.src||o,r=new Error("Loading CSS chunk "+d+" failed.\n("+t+")");r.request=t,n(r)},i.href=o,document.getElementsByTagName("head")[0].appendChild(i)}).then(function(){f[d]=0}));var r=l[d];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[d]=[e,t]});e.push(r[2]=t);var n,o=document.getElementsByTagName("head")[0],c=document.createElement("script");c.charset="utf-8",c.timeout=120,s.nc&&c.setAttribute("nonce",s.nc),c.src=s.p+"static/js/"+({}[d]||d)+"."+{1:"b92c5504",2:"61c14a7e",3:"eb71df06",4:"dc812a82",5:"8e805893",6:"eb3cf416",7:"ea93d973",8:"794ef84a",9:"e97c4388",10:"fb0080af",11:"9e63d0ee",12:"31d76608",13:"b787dedf",14:"678e07ab",15:"30cd6c1f",16:"db80ebde",17:"32898ce9",18:"74127409",19:"79829299"}[d]+".chunk.js",n=function(e){c.onerror=c.onload=null,clearTimeout(a);var t=l[d];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,o=new Error("Loading chunk "+d+" failed.\n("+r+": "+n+")");o.type=r,o.request=n,t[1](o)}l[d]=void 0}};var a=setTimeout(function(){n({type:"timeout",target:c})},12e4);c.onerror=c.onload=n,o.appendChild(c)}return Promise.all(e)},s.m=u,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var o=0;o<t.length;o++)e(t[o]);var p=n;i()}([])</script><script src="/static/js/20.40c457c6.chunk.js"></script><script src="/static/js/main.e993fd60.chunk.js"></script></body></html>