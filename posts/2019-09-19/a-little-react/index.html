<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="shortcut icon" href="./fa.jpg"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="theme-color" content="#000000"/><link rel="manifest" href="./manifest.json"/>
    <title>A little About React</title>
    <link rel="canonical" href="/posts/2019-09-19/a-little-react" />
    <link rel="stylesheet" href="./static/css/1.27c8494b.chunk.css" />
  <link href="./static/css/main.0e6724e3.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__1wjbv"><div class="
        LoadingIndicator_LoadingIndicator__LXZCC
        
        undefined
      "></div><header><h3 class="BlogLayout_title__U0zfd"><a class=" " href="/">lanyincao</a></h3></header><main><article><header class="BlogPostLayout_header__6lPZ1"><h1 class="BlogPostLayout_title__1egAZ"><a class=" " href="/posts/2019-09-19/a-little-react/">A little About React</a></h1><small><time dateTime="Wed, 18 Sep 2019 16:00:00 GMT">September 19, 2019</time> <!-- -->â€¢<!-- --> <ul class="ArticleMeta_tags__30Wbg"><li><a class=" " href="/tags/react/">react</a></li><li><a class=" " href="/tags/little/">little</a></li></ul> <!-- -->â€¢<!-- --> <span>â˜•ï¸<!-- --> <!-- -->4<!-- --> min read</span></small></header><div class="BlogPostLayout_content__1CRXP"><p>æœ¬æ¥æ˜¯ä¸æ‰“ç®—å†™è¿™ç¯‡æ–‡ç« çš„ï¼Œä½†æ˜¯æœ€è¿‘æ­£å¥½é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ–è€…è¯´æ˜¯ç»„å†…é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå°±é¡ºä¾¿å†™è¿™ç¯‡æ–‡ç« </p><h2 id="ç›®å½•">ç›®å½•</h2><ul><li>React Virtual Dom Terminology</li><li>useLayoutEffect and useEffect</li></ul><h2 id="react-virtual-dom-terminology">React Virtual Dom Terminology</h2><p>åœ¨ React ä¸­æœ‰å‡ ä¸ªç±»å‹éœ€è¦åŒºåˆ†æ¸…æ¥šï¼Œåœ¨åŒ <code>TS</code> å†™çš„æ—¶å€™ä¹Ÿä¼šç»å¸¸é‡åˆ°è¿™å‡ ç§ç±»å‹</p><ul><li>ReactElement / ReactElement Factory</li><li>ReactNode</li><li>ReactComponent / ReactComponent Class</li></ul><h3 id="react-elements">React Elements</h3><p>åœ¨ React ä¸­åŸå§‹ç±»å‹å°±æ˜¯ ReactElementï¼ŒReactElement æœ‰å››ä¸ªå±æ€§åˆ†åˆ«ä¸º <code>type</code>, <code>props</code>, <code>key</code>, <code>ref</code>. åç»­ key æœ‰å¯èƒ½ä¼šä» props ä¸­
è¿›è¡Œå‰¥ç¦». å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨æ–¹æ³•å’Œå…¶ä»–çš„ä»»ä½•ä¸œè¥¿åœ¨ <code>prototype</code> ä¸Š.</p><p>åœ¨ React ä¸­å¯ä»¥é€šè¿‡è°ƒç”¨ React.createElement æ¥åˆ›å»º</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> root <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä¸ºäº†æ¸²æŸ“åˆ° DOM ä¸­ï¼Œéœ€è¦æŠŠåˆ›å»ºçš„ <code>ReactElement</code> ä¼ é€’ç»™ <code>React.render</code> å¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ­£å¸¸çš„ DOM å…ƒç´ æ¯”å¦‚ <code>HTMLElement</code>, <code>ReactElement</code> æ˜¯ä¸€ä¸ª
æ— çŠ¶æ€çš„ï¼Œä¸å¯çªå˜çš„ï¼Œè™šæ‹Ÿçš„ dom elementã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœéœ€è¦ä¼ é€’é¢å¤–çš„å±æ€§ï¼Œåœ¨ React.createElement çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æä¸ªå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª child</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> child <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'my-root'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœä½¿ç”¨ <code>JSX</code>, é‚£ä¹ˆè¿™æ ·å†™ä¹Ÿæ˜¯ä¸€æ ·çš„</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'my-root'</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>text<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="factory">Factory</h4><p>ä¸€ä¸ª <code>ReactElement</code> çš„å·¥å‚æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æ¥åˆ›å»º <code>ReactElement</code> å¸¦ç€ç‰¹å®šçš„ <code>type</code>ã€‚React æœ¬èº«å†…éƒ¨æ˜¯æœ‰è¿™æ ·çš„ä¸€ä¸ªå‡½æ•°çš„ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">function</span> <span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™æ ·å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç±»å‹çš„å‡½æ•°ï¼Œç„¶ååœ¨æ­¤è°ƒç”¨å‡½æ•°ï¼Œä¸éœ€è¦åœ¨ä¼ é€’é¢å¤–çš„ç±»å‹ã€‚æ¯”å¦‚ä¸åœ¨éœ€è¦æ¯æ¬¡éƒ½ä¼ å…¥ç±»å‹ <code>React.createElement(&#x27;type&#x27;)</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> div <span class="token operator">=</span> <span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'my-root'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœä½¿ç”¨çš„æ˜¯ <code>JSX</code> çš„è¯ï¼Œé‚£ä¹ˆæ ¹æœ¬ä¸éœ€è¦è¿™ä¹ˆåšï¼Œ React å†…éƒ¨å·²ç»å¤„ç†å¥½äº†ã€‚</p><h3 id="react-nodes">React Nodes</h3><p><code>React Node</code> å¯èƒ½æ˜¯å…¶ä¸­çš„ä¸€ç§ï¼š</p><ul><li>React Element</li><li>string</li><li>number</li><li>ReactFrament</li></ul><p>å¯ä»¥ç›´æ¥çœ‹ ReactNode çš„å®šä¹‰</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">type ReactNode <span class="token operator">=</span>
  <span class="token operator">|</span> ReactChild
  <span class="token operator">|</span> ReactFragment
  <span class="token operator">|</span> ReactPortal
  <span class="token operator">|</span> boolean
  <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
</code></pre><p>ç›¸å…³ç±»å‹çš„å®šä¹‰</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers="">type ReactText <span class="token operator">=</span> string <span class="token operator">|</span> number<span class="token punctuation">;</span>
type ReactChild <span class="token operator">=</span> ReactElement <span class="token operator">|</span> ReactText<span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ReactNodeArray</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>ReactNode<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
type ReactFragment <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">|</span> ReactNodeArray<span class="token punctuation">;</span>
</code></pre><p><code>React Element</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">ReactElement</span><span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">=</span> any<span class="token punctuation">,</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">string</span> <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> string <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span>any<span class="token operator">>></span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
      props<span class="token punctuation">:</span> <span class="token constant">P</span><span class="token punctuation">;</span>
      key<span class="token punctuation">:</span> Key <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><h3 id="react-components">React Components</h3><p>ä¸€ä¸ª <code>React Components</code> Class å°±æ˜¯ä¸€ä¸ªç®€å•çš„ js class</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å½“è¿™ä¸ªæ„é€ å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°†è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ä¸€å®šè¦æœ‰ä¸€ä¸ª <code>render</code> å‡½æ•°åœ¨å†…éƒ¨ã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯ <code>ReactComponent</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyComponent</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// never do this</span>
</code></pre><p>é™¤éæ˜¯ä¸ºäº†æµ‹è¯•ï¼Œå¦åˆ™åƒä¸‡ä¸è¦è¿™ä¹ˆå†™ã€‚React ä¼šåœ¨å†…éƒ¨è°ƒç”¨çš„ã€‚Dan ä¹Ÿåœ¨<a class=" " href="https://overreacted.io/how-does-react-tell-a-class-from-a-function/">ä¹‹å‰çš„æ–‡ç« </a>ä¸­è¯´è¿‡åŸå› </p><p>ä¹Ÿå¯ä»¥æŠŠ <code>ReactComponent</code> class ä¼ é€’ç»™ React.createElement å¾—åˆ°ä¸€ä¸ª ReactElement</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>JSX</code> çš„æ–¹å¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
</code></pre><p>å½“è¿™ä¸ªè¢«ä¼ é€’ç»™ <code>React.render</code> æ—¶ï¼ŒReact å°†è°ƒç”¨æ„é€ å‡½æ•°å¹¶ä¸”è¿”å›ä¸€ä¸ª <code>ReactComponent</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> component <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¦‚æœç»§ç»­è°ƒç”¨ <code>React.render</code> å¸¦ç€ç›¸åŒçš„ <code>ReactElement</code> å’Œç›¸åŒçš„ dom, é‚£ä¹ˆæ€»æ˜¯è¿”å›ç›¸åŒçš„å®ä¾‹</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> componentA <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> componentB <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
componentA <span class="token operator">===</span> componentB<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><h2 id="uselayouteffect--useeffect">useLayoutEffect &amp; useEffect</h2><p>åœ¨<a class=" " href="https://reactjs.org/docs/hooks-intro.html">å®˜æ–¹æ–‡æ¡£</a> ä¸­å·²ç»è¯¦ç»†çš„ä»‹ç»äº†å„ä¸ª hook çš„åŒºåˆ«ã€‚</p><p>å®˜æ–¹ä»‹ç»æ˜¯è¿™æ ·è¯´çš„ï¼š</p><p>The signature is identical to useEffect, but it fires synchronously after all DOM mutations.
Use this to read layout from the DOM and synchronously re-render.
Updates scheduled inside useLayoutEffect will be flushed synchronously, <code>before the browser has a chance to paint</code>.</p><p>Tip</p><p>If youâ€™re migrating code from a class component, note useLayoutEffect fires in the same phase as componentDidMount and componentDidUpdate.
However, we recommend starting with useEffect first and only trying useLayoutEffect if that causes a problem.</p><p>If you use server rendering, keep in mind that neither useLayoutEffect nor useEffect can run until the JavaScript is downloaded.
This is why React warns when a server-rendered component contains useLayoutEffect.
To fix this, either move that logic to useEffect (if it isnâ€™t necessary for the first render),
or delay showing that component until after the client renders (if the HTML looks broken until useLayoutEffect runs).</p><p>To exclude a component that needs layout effects from the server-rendered HTML,
render it conditionally with <code>showChild &amp;&amp; &lt;Child /&gt;</code> and defer showing it with useEffect(() =&gt; { setShowChild(true); }, []).
This way, the UI doesnâ€™t appear broken before hydration.</p><p>è¿™æ˜¯åœ¨ <code>useLayoutEffect</code> ä¸­ä»‹ç»çš„ã€‚</p><p><a class=" " href="https://reactjs.org/docs/hooks-reference.html#useeffect">useEffect</a> çš„ä»‹ç»å‚è€ƒå®˜ç½‘ã€‚</p><p>å…¶ä¸­åœ¨ <code>useLayoutEffect</code> ä¸­çš„ä»‹ç»æœ‰å‡ ç‚¹éœ€è¦å…³æ³¨çš„ã€‚é¦–å…ˆ <code>it fires synchronously after all DOM mutations</code>, åŒæ­¥è§¦å‘ã€‚
ç¬¬äºŒ <code>Updates scheduled inside useLayoutEffect will be flushed synchronously, before the browser has a chance to paint</code>
åœ¨æµè§ˆå™¨æœ‰æœºä¼šç»˜ç”»ä¹‹å‰ã€‚</p><p>é‚£è¿™ä¸ªåˆ°åº•é€‚åˆäºä»€ä¹ˆæ ·çš„åœºæ™¯å‘¢ï¼Ÿä¸å¦‚å…ˆä»ä¸€ä¸ªä¾‹å­æ¥åˆ†æ, å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªæœç´¢å†å²çš„çš„éœ€æ±‚ï¼Œæœç´¢è¿‡çš„å†…å®¹éœ€è¦å¢åŠ åˆ°æœç´¢å†å²ä¸­ã€‚å¹¶ä¸”æœç´¢å†å²ä¸èƒ½è¶…è¿‡
ä¸€è¡Œï¼Œè¶…è¿‡äº†ä¸€è¡Œåˆ™è¿›è¡Œæˆªå–ï¼ŒæŠŠè¶…è¿‡çš„é‚£éƒ¨åˆ†å»æ‰ã€‚</p><div><img src="./static/media/his.a2578714.jpg"/></div><p>æ­¤æ—¶æˆ‘ä»¬åº”è¯¥å¦‚ä½•å»åšã€‚åŸºæœ¬åšæ³•åº”è¯¥æ˜¯ç‚¹å‡»æœç´¢ï¼Œåœ¨ <code>useEffect</code> é‡Œè¿›è¡Œè®¡ç®—å·²æ¸²æŸ“çš„å†å²çš„èŠ‚ç‚¹çš„å®½åº¦ï¼Œç„¶åéå†å†å²çš„ dom èŠ‚ç‚¹è¿›è¡Œå®½åº¦ç›¸åŠ ï¼Œæœ€åæ¥åˆ¤æ–­
æ˜¯å¦è¶…è¿‡äº†æœ€å¤§å®½åº¦ï¼Œå¦‚æœè¶…è¿‡äº†æœ€å¤§å®½åº¦ï¼Œé‚£ä¹ˆè¿›è¡Œæˆªå–ï¼Œå¦åˆ™ä¸è¿›è¡Œæˆªå–ã€‚ï¼ˆå½“ç„¶å¦‚æœè¦æ˜¯èƒ½æå‰çŸ¥é“ <code>input</code> è¾“å…¥çš„å†…å®¹åŒºçš„å®½åº¦ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨äº‹ä»¶å‡½æ•°ä¸­è¿›è¡Œæå‰åˆ¤æ–­å¤„ç†)ã€‚
ç›®å‰å¤„ç†æ˜¯åœ¨ <code>useEffect</code> ä¸­è¿›è¡Œéå†æ¥è®¡ç®—å®½åº¦çš„ã€‚è¿™ä¸ªçœ‹èµ·æ¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¯¹å§ã€‚ä¸å¦¨çœ‹ä¸€ä¸‹æ•ˆæœ</p><div><img src="./static/media/useEffect.578d1fbd.gif"/></div><p>å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªé—ªåŠ¨çš„è¿‡ç¨‹ï¼Œå› ä¸ºåœ¨ useEffect ä¸­è¿›è¡Œäº†æˆªå–ï¼Œæ­¤æ—¶è¿™ä¸ª dom å·²ç»è¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šäº†ã€‚åœ¨è¿›è¡Œæˆªå–ï¼Œå°±ä¼šçœ‹åˆ°<code>é—ªåŠ¨</code>çš„ç°è±¡ã€‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nextHistory <span class="token operator">=</span> <span class="token function">getNextHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">saveHistory</span><span class="token punctuation">(</span>nextHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getNextHistory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cloneHistory <span class="token operator">=</span> history<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> totalWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> historyRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> node <span class="token operator">=</span> historyRefs<span class="token punctuation">.</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> width <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      totalWidth <span class="token operator">+=</span> width <span class="token operator">+</span> offset<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>totalWidth <span class="token operator">></span> <span class="token constant">MAX_HISTORY_LENGTH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cloneHistory <span class="token operator">=</span> cloneHistory<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cloneHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£å¦‚æœæ¢æˆ <code>useLayoutEffect</code> å‘¢ï¼Ÿ</p><div><img src="./static/media/useLayoutEffect.3545cf97.gif"/></div><p>å¯ä»¥çœ‹å‡ºåœ¨ä½¿ç”¨ <code>useLayoutEffect</code> çš„æ—¶å€™ä¹‹å‰çš„é—ªåŠ¨ä¸å­˜åœ¨äº†ã€‚å›å¤´çœ‹ä¸€ä¸‹ä¹‹å‰æ ‡è®°çš„åœ°æ–¹ã€‚å…¶ä¸­æœ‰ä¸€å¤„åƒè¿™æ ·çš„</p><p><code>Updates scheduled inside useLayoutEffect will be flushed synchronously, before the browser has a chance to paint</code></p><p>æ‰€ä»¥é’ˆå¯¹å‡ºç°éœ€è¦é¢‘ç¹ä¿®æ”¹ dom æˆ–è€…éœ€è¦åœ¨ dom æ¸²æŸ“ååˆè¦ç«‹é©¬æ“ä½œ dom çš„ä»¥åŠè¿›è¡Œä¸€äº›å¸ƒå±€æ“ä½œçš„éƒ½å¯ä»¥ä½¿ç”¨ <code>useLayoutEffect</code>ã€‚æ¯”å¦‚ <code>Popover</code>,
<code>ToolTip</code>, <code>DronDown</code> ç­‰ç›¸å…³ç»„ä»¶ã€‚</p></div><footer class="BlogPostLayout_footer__1p0Ii"><h3 class="BlogPostLayout_title__1egAZ"><a class=" " href="/">lanyincao</a></h3><div class="
      Bio_Bio__1eiKY
      BlogPostLayout_bio__2AHhA
    "><img src="./static/media/bio-pic.fdbb64ab.jpeg" alt="lanyincao"/><p>Personal blog by <a href="https://twitter.com/lanyincao">lanyincao</a>.<br/>I can&#x27;t sing, dance, rap but can code, ğŸ€</p></div><section class="BlogPostLayout_links__1fVhZ"><a class=" " href="/posts/2019-10-02/the-dep-of-use-hook/">â† <!-- -->the dep of useHook</a><a class="BlogPostLayout_next__3tOcG " href="/posts/2019-09-06/the-rule-of-react/">The Rules of React<!-- --> â†’</a></section></footer></article></main></div></div><script>!function(o){function e(e){for(var t,r,n=e[0],c=e[1],f=e[2],d=0,a=[];d<n.length;d++)r=n[d],l[r]&&a.push(l[r][0]),l[r]=0;for(t in c)Object.prototype.hasOwnProperty.call(c,t)&&(o[t]=c[t]);for(p&&p(e);a.length;)a.shift()();return i.push.apply(i,f||[]),u()}function u(){for(var e,t=0;t<i.length;t++){for(var r=i[t],n=!0,c=1;c<r.length;c++){var f=r[c];0!==l[f]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},a={43:0},l={43:0},i=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(i){var e=[];a[i]?e.push(a[i]):0!==a[i]&&{1:1,23:1}[i]&&e.push(a[i]=new Promise(function(e,n){for(var t="static/css/"+({}[i]||i)+"."+{1:"27c8494b",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0",16:"31d6cfe0",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0",20:"31d6cfe0",21:"31d6cfe0",22:"31d6cfe0",23:"d3b34b05",24:"31d6cfe0",25:"31d6cfe0",26:"31d6cfe0",27:"31d6cfe0",28:"31d6cfe0",29:"31d6cfe0",30:"31d6cfe0",31:"31d6cfe0",32:"31d6cfe0",33:"31d6cfe0",34:"31d6cfe0",35:"31d6cfe0",36:"31d6cfe0",37:"31d6cfe0",38:"31d6cfe0",39:"31d6cfe0",40:"31d6cfe0",41:"31d6cfe0"}[i]+".chunk.css",c=s.p+t,r=document.getElementsByTagName("link"),f=0;f<r.length;f++){var d=(o=r[f]).getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(d===t||d===c))return e()}var a=document.getElementsByTagName("style");for(f=0;f<a.length;f++){var o;if((d=(o=a[f]).getAttribute("data-href"))===t||d===c)return e()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=e,u.onerror=function(e){var t=e&&e.target&&e.target.src||c,r=new Error("Loading CSS chunk "+i+" failed.\n("+t+")");r.request=t,n(r)},u.href=c,document.getElementsByTagName("head")[0].appendChild(u)}).then(function(){a[i]=0}));var r=l[i];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[i]=[e,t]});e.push(r[2]=t);var n,c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.charset="utf-8",f.timeout=120,s.nc&&f.setAttribute("nonce",s.nc),f.src=s.p+"static/js/"+({}[i]||i)+"."+{1:"18016ef5",2:"f51ae852",3:"2d812e0c",4:"959e45b9",5:"031228ef",6:"da64b01a",7:"c20265b4",8:"3708fc80",9:"76d5a1f1",10:"64d279dc",11:"15bdaa3d",12:"a289339e",13:"6ed3fae5",14:"c0219476",15:"1b2dfa34",16:"c95df50e",17:"854d2668",18:"fe4e0156",19:"75b2ab08",20:"5cc3e2dd",21:"85a6bb34",22:"f5b6dab9",23:"873b678f",24:"299ad1b2",25:"26732315",26:"8ed938bb",27:"9e08b9c8",28:"8c5bf47d",29:"651315e7",30:"4de03612",31:"a827ef55",32:"9f8e8c89",33:"4e98a6ac",34:"8fa7acd9",35:"f7fd16e7",36:"c8a9136e",37:"7fd46dad",38:"ab859197",39:"242ef20f",40:"a8b763a6",41:"fe59cd2f"}[i]+".chunk.js",n=function(e){f.onerror=f.onload=null,clearTimeout(d);var t=l[i];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,c=new Error("Loading chunk "+i+" failed.\n("+r+": "+n+")");c.type=r,c.request=n,t[1](c)}l[i]=void 0}};var d=setTimeout(function(){n({type:"timeout",target:f})},12e4);f.onerror=f.onload=n,c.appendChild(f)}return Promise.all(e)},s.m=o,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="./",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var c=0;c<t.length;c++)e(t[c]);var p=n;u()}([])</script><script src="./static/js/42.e4ff5a7a.chunk.js"></script><script src="./static/js/main.ec82054e.chunk.js"></script></body></html>