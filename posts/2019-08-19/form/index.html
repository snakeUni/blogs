<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="shortcut icon" href="/fa.jpg"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="theme-color" content="#000000"/><link rel="manifest" href="/manifest.json"/>
    <title>ğŸ¤” Form</title>
    <link rel="canonical" href="/posts/2019-08-19/form" />
    <link rel="stylesheet" href="/static/css/1.27c8494b.chunk.css" />
  <link href="/static/css/main.0e6724e3.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__1wjbv"><div class="
        LoadingIndicator_LoadingIndicator__LXZCC
        
        undefined
      "></div><header><h3 class="BlogLayout_title__U0zfd"><a class=" " href="/">lanyincao</a></h3></header><main><article><header class="BlogPostLayout_header__6lPZ1"><h1 class="BlogPostLayout_title__1egAZ"><a class=" " href="/posts/2019-08-19/form/">ğŸ¤” Form</a></h1><small><time dateTime="Sun, 18 Aug 2019 16:00:00 GMT">August 19, 2019</time> <!-- -->â€¢<!-- --> <ul class="ArticleMeta_tags__30Wbg"><li><a class=" " href="/tags/react/">react</a></li><li><a class=" " href="/tags/form/">form</a></li></ul> <!-- -->â€¢<!-- --> <span>â˜•ï¸<!-- --> <!-- -->7<!-- --> min read</span></small></header><div class="BlogPostLayout_content__1CRXP"><p>è¡¨å•ç»„ä»¶æ˜¯åœ¨ <code>Bç«¯</code> å¼€å‘ä¸­æœ€å¸¸ç”¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, <code>Textarea</code>, <code>DatePicker</code> ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„è¡¨å•ç±»ç»„ä»¶ï¼Œç„¶è€Œè¡¨å•çš„ç®¡ç†ç¡®æ˜¯æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†ã€‚å¸¸è§„åœ¨å¼€å‘è¡¨å•çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™å¯èƒ½ä¸ä½¿ç”¨ <code>Form</code> è¿™æ ·çš„ç»„ä»¶è€Œæ˜¯è¿™æ ·</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">submit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å§“å<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>name<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>å¹´é¾„<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>age<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> age<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>åœ°å€<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>address<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> address<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">></span>æäº¤<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœä¸ä½¿ç”¨åŸºç¡€çš„ <code>form</code> æ ‡ç­¾ï¼ŒåŸºç¡€è¡¨å•åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ä¹ˆå†™çš„ï¼Œå£°æ˜è¡¨å•ä¸­æ‰€éœ€è¦çš„çŠ¶æ€ï¼Œå¯¹åº”çš„ <code>value</code> ä¸å„è‡ªçš„ç»„ä»¶å¯¹åº”èµ·æ¥ï¼Œå¦‚æœå­˜åœ¨æ ¡éªŒä¿¡æ¯çš„æ˜¯ï¼Œè¿˜éœ€è¦è¿›è¡Œæ ¡éªŒã€‚å› ä¸ºè¡¨å•å¾ˆå¤šæ—¶å€™æ˜¯éœ€è¦è¿›è¡Œå®æ—¶æ ¡éªŒçš„ï¼ŒåŠæ—¶è®©ç”¨æˆ·å‘ç°é—®é¢˜ï¼Œç„¶åèƒ½åŠæ—¶æ”¹æ­£é—®é¢˜ã€‚é‚£è¿™æ ·æ¯ä¸€ä¸ª <code>Input</code> è¿™æ ·çš„ç»„ä»¶éƒ½åº”è¯¥éœ€è¦ <code>validate</code> è¿™æ ·çš„ä¸€ä¸ªæ ¡éªŒå‡½æ•°ï¼Œè¿˜æœ‰æ˜¯å¦åœ¨ <code>onChange</code> æ—¶å€™æ ¡éªŒè¿˜æ˜¯åœ¨ <code>onBlur</code> çš„æ—¶å€™æ ¡éªŒï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬çš„çŠ¶æ€ä¸æ˜¯ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·å†™æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿä½†æ˜¯å³ä½¿æ˜¯è¿™æ ·ç®€å•çš„è¡¨å•ï¼Œå¦‚æœæ­¤æ—¶æ˜¯ <code>A</code> é¡µé¢éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ <code>B</code> é¡µé¢ä¹ŸåŒæ ·éœ€è¦è¿™æ ·çš„è¡¨å•ï¼Œ<code>validate</code> ç­‰éƒ½éœ€è¦ã€‚é‚£ä¹ˆè¦ä¸å»æ‹·è´ä»£ç è¿‡æ¥ä¿®æ”¹ä¸€ä¸‹ï¼Œè¦ä¸è‡ªå·±å°è£…ä¸€ä¸ª <code>Form</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="å°è£…-form-">å°è£… Form ğŸ˜²</h2><p>è€ƒè™‘ä¸€ä¸‹ä¸Šé¢çš„ä»£ç å¦‚ä½•å°è£…æˆä¸€ä¸ª <code>Form</code> å‘¢ï¼Ÿå°±åƒä¸Šé¢çš„ä»£ç ä¸€æ ·ï¼Œç»„ä»¶çš„åç§°å·²ç»å‘½åä¸º <code>Form</code> äº†, æ˜¯å¦è¿™æ ·å°±å¯ä»¥äº†å‘¢ï¼Ÿå¦‚æœå­˜åœ¨è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span>'<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span>'<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span>' <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span>'<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span>'<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æ­¤æ—¶ <code>C</code> ç»„ä»¶å†…éƒ¨æ‰ç”¨äº† <code>Input</code> è¿™æ ·çš„ç»„ä»¶ï¼Œé‚£å¦‚æœåœ¨ <code>C&#x27;</code> ç»„ä»¶ä¸­ç”¨åˆ°äº† <code>C</code> ç»„ä»¶çš„ä¿¡æ¯æ€ä¹ˆåŠå‘¢ï¼Ÿ
é‡åˆ°è¿™ç§åœºæ™¯é€šå¸¸çš„åšæ³•å«åš <code>lifting state up</code>, çŠ¶æ€æå‡ï¼Œåœ¨æ›´æ–° <code>C</code> ç»„ä»¶çš„æ—¶å€™ï¼ŒæŠŠçŠ¶æ€åŒæ­¥æ›´æ–°åˆ° <code>Form</code> ç»„ä»¶ï¼Œ <code>Form</code> ç»„ä»¶åˆæŠŠè¿™ä¸ªæ•°æ®ä¼ é€’åˆ° <code>C&#x27;</code> ç»„ä»¶ï¼Œ <code>C&#x27;</code> ç»„ä»¶æ‹¿åˆ°äº†æ­£ç¡®çš„æ•°æ®ã€‚<code>Nice</code>, é€šè¿‡çŠ¶æ€æå‡ï¼ŒæˆåŠŸçš„è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™æ ·æ¯æ¬¡å°±éœ€è¦åœ¨ <code>Form</code> ä¸­å­˜å‚¨çŠ¶æ€ï¼Œç„¶åè¿˜éœ€è¦ä¼ é€’å›è°ƒå‡½æ•°åˆ°éœ€è¦çš„ç»„ä»¶ä¸­ï¼Œæ›´æ–°ç›¸åº”çš„çŠ¶æ€ã€‚å¦‚æœç»„ä»¶åµŒå¥—åªæœ‰ <code>2 - 3</code> å±‚çš„æ—¶å€™ï¼Œè¿™æ ·æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœç»„ä»¶åµŒå¥—æœ‰å¾ˆå¤šå±‚å‘¢ï¼Ÿæ¯”å¦‚æ­¤æ—¶ <code>E ç»„ä»¶</code> æ‰æ˜¯ <code>Input</code> ç»„ä»¶çš„æ‰€åœ¨ï¼Œé‚£ä¹ˆè¿™æ ·åµŒå¥—ä¸‹å»ä¼ é€’</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token constant">D</span><span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">D</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">C</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>çš„å±‚æ•°åªä¼šè¶Šæ¥è¶Šå¤šï¼Œåé¢ç»´æŠ¤èµ·æ¥è¦æ¯ä¸€å±‚æ¯ä¸€å±‚å»çœ‹ï¼Œé˜²æ­¢å…¶ä¸­ä¸€å±‚å‡ºç°é—®é¢˜äº†ã€‚é’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆå¤šç«¥é‹ä¼šæƒ³åˆ° <code>react-redux</code>, <code>mbox</code> é€šè¿‡çŠ¶æ€ç®¡ç†å·¥å…·æ¥è§£å†³è¿™æ ·çš„ä¼ é€’çš„é—®é¢˜ï¼Œæ­å–œæ€è·¯æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œé€šè¿‡ç›®å‰çš„ä¸€äº›çŠ¶æ€ç®¡ç†åº“æ˜¯å¯ä»¥åšåˆ°çš„ã€‚ä¸å¦¨ä»¥ <code>react-redux</code> ä¸¾ä¾‹ï¼Œ <code>react-redux</code> å†…éƒ¨ä½¿ç”¨äº† <code>React Context</code>, æ˜¯çš„ï¼Œ <code>React</code> å›¢é˜Ÿä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæä¾›äº† <code>context</code> è¿™æ ·çš„ <code>api</code>, é‚£ä¹ˆ <code>context</code> å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> createContext<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> FormContext <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch<span class="token punctuation">:</span> setValue <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é¦–å…ˆéœ€è¦ä½¿ç”¨ <code>React.createContext</code> æ¥åˆ›å»ºä¸€ä¸ª <code>context</code>, ç„¶ååœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>context.Provider</code>, <code>context.Provider</code> æ¥å—ä¸€ä¸ª <code>value</code> propsï¼Œ å¦‚ä½•è·å–åˆ° <code>value</code> ä¸­çš„å€¼</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>FormContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é€šè¿‡åœ¨<code>å­ç»„ä»¶</code>ä¸­ä½¿ç”¨ <code>useContext()</code> è·å–åˆ°ç›¸åº”çš„ value, å¦‚æœåœ¨ <code>class ç»„ä»¶</code>ä¸­åˆ™</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Field</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨ <code>FormContext.Consumer</code> çš„æ–¹å¼ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>render props</code> çš„ç»„ä»¶ã€‚å› ä¸ºä¸€ä¸ªæ™®é€šçš„ <code>Form</code> å°±å¯ä»¥ç®€æ´çš„å®Œæˆäº†, é¦–å…ˆåœ¨ <code>Form</code> ç»„ä»¶ä¸­åˆ©ç”¨ <code>context.Provider</code> æŠŠæƒ³è¦çš„å€¼å’Œæ–¹æ³•ä¼ é€’ä¸‹å»ï¼Œåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ‹¿åˆ° <code>value</code> å’Œ <code>dispatch</code>, è¿™æ ·å°±è§£å†³äº†å¤šå±‚ä¼ é€’çŠ¶æ€çš„é—®é¢˜ã€‚è¿™æ ·ç®€çº¦çš„è¡¨å•ç”¨èµ·æ¥å¾ˆçˆ½ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡çš„æ…¢æ…¢å¤æ‚ï¼Œéœ€è¦çš„åŠŸèƒ½ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œè¡¨å•ä¸­çš„ç»„ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>æœ‰å¯èƒ½è¿™æ ·çš„ <code>Field</code> ç»„ä»¶å¯èƒ½æœ‰å‡ åä¸ªç”šè‡³ä¸Šç™¾ä¸ªï¼Œç„¶åå‘ç°è¡¨å•å˜å¾—è¶Šæ¥è¶Šæ…¢è¶Šæ¥è¶Šæ…¢ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶ä¸­æ¯æ¬¡æ‰§è¡Œ <code>dispatch</code> éƒ½ä¼šä¿®æ”¹é¡¶å±‚çš„ value, é¡¶å±‚çš„ <code>value</code> å‘ç”Ÿå˜åŒ–äº†ï¼Œè¿™æ ·æ¯ä¸€ä¸ª <code>Field</code> ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œåªè¦æ˜¯ä½¿ç”¨äº† <code>useContext()</code> è¿™æ ·çš„ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ï¼Œè¿™ä¸ªæ¸²æŸ“çš„é‡å¯èƒ½éå¸¸éå¸¸çš„å¤§ï¼ŒåŠæ—¶ä¸€ä¸ªç®€å•çš„ <code>Input</code> ä¿®æ”¹äº†å…¶ä¸­çš„ä¸€ä¸ªå€¼ï¼Œä¹Ÿä¼šé€ æˆæ•´ä¸ª <code>Form</code> é‡æ–° render, ä¸€ä¸¤æ¬¡ render å¯èƒ½è€—æ—¶éå¸¸å°‘ï¼Œä½†æ˜¯å½“è¾¾åˆ°ä¸Šç™¾ä¸ªçš„æ—¶å€™ï¼Œæ­¤æ—¶çš„ <code>render</code> è€—æ—¶å°±ä¼šéå¸¸éå¸¸çš„é«˜ã€‚å¯èƒ½è¿™ç¬¬ä¸€ä¸ª <code>Field</code> ä¸­åªä¿®æ”¹äº† <code>a</code> å±æ€§ï¼Œå¯æ˜¯å…¶ä»–çš„ <code>Field</code> ä¸­éƒ½æ²¡æœ‰ç”¨åˆ° <code>a</code> å±æ€§ï¼Œå…¶ä½™çš„å­ç»„ä»¶çš„æ¸²æŸ“æ˜¯å¤šä½™çš„ã€‚ä½†æ˜¯ <code>context</code> æ˜¯æ— æ³•è¢« <code>bail out</code> çš„, æ‰€ä»¥æ‰€æœ‰çš„ <code>Field</code> éƒ½ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆä¸å¦¨æ§åˆ¶ä¸‹ <code>Field</code> çš„å­ç»„ä»¶</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Sub name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> validate<span class="token operator">=</span><span class="token punctuation">{</span>validate<span class="token punctuation">}</span> validateOnChange <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnchange<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>Field</code> ç»„ä»¶é€šè¿‡ä½¿ç”¨ <code>useMemo</code> è¿›è¡Œç¼“å­˜ï¼Œåªæœ‰å½“æ•°ç»„çš„å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰ä¼šå†ä¸€æ¬¡é‡æ–° <code>render</code>, <code>useMemo</code> çš„ä½œç”¨å’Œ <code>react-redux</code> çš„ <code>connect</code> é«˜é˜¶å‡½æ•°çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡ä½¿ç”¨ <code>useMemo</code> å¯ä»¥æŠŠ <code>render æ—¶é—´é•¿çš„å­ç»„ä»¶</code> è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘ <code>render</code> æ—¶é—´ï¼Œæå‡æ€§èƒ½ã€‚</p><h2 id="optimize-form-">optimize form ğŸ˜Š</h2><p>æ­¤æ—¶æ˜¯å¦å·²ç»å®Œæˆäº†æ•´ä¸ª <code>Form</code> çš„ä¼˜åŒ–è¿‡ç¨‹äº†ï¼Œæ­¤æ—¶çš„ <code>Form</code>, åŒ…æ‹¬å¸¸è§„ä½¿ç”¨çš„ <code>context</code> é€šè¿‡ <code>memo</code> è¿›è¡Œä¼˜åŒ–å®é™…ä¸Šå·²ç»æé«˜äº†å¾ˆå¤šã€‚ä½†æ˜¯å³ä½¿æ˜¯å•çº¯çš„ä¸€ä¸ª <code>Field</code> ç»„ä»¶ï¼Œå¦‚æœæ•°é‡å¾ˆå¤šçš„æƒ…å†µä¸‹ä»ç„¶è¿˜æ˜¯ä¼šå­˜åœ¨å¡é¡¿çš„æƒ…å†µçš„ã€‚ç‰¹åˆ«æ˜¯å½“æ¥å…¥äº†ç¬¬ä¸‰æ–¹ç»„ä»¶åº“çš„æ—¶å€™ã€‚æœ¬èº«ç¬¬ä¸‰æ–¹ç»„ä»¶æä¾›çš„åŠŸèƒ½æœ‰å¾ˆå¤šï¼Œç»„ä»¶æœ¬èº«ä¹Ÿä¼šå¾ˆå¤æ‚ï¼Œä¸åƒåŸç”Ÿçš„ <code>input</code> é‚£æ ·ç®€å•ï¼Œå‡è®¾æ­¤æ—¶æ¥å…¥çš„æ˜¯ <code>antd</code> çš„ç»„ä»¶åº“</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">CustomInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Field<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨å¯¹ <code>Input</code> è¿›è¡Œå¿«é€Ÿè¾“å…¥çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢çš„å“åº”ä¼šæœ‰æ‰€å»¶è¿Ÿï¼Œå¦‚æœæ‰“å¼€ <code>chrome</code> çš„ <code>performance</code> è¿›è¡Œå½•åˆ¶çš„æ—¶å€™ï¼Œå°±ä¼šçœ‹åˆ°ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œå…³äº <code>é•¿ä»»åŠ¡</code> è¿™é‡Œä¸åšè¯¦ç»†æè¿°ï¼Œè¿™ç§å¯ä»¥é€šè¿‡æ—¶é—´åˆ†ç‰‡ï¼ˆtime slicingï¼‰ æ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬é›†ä¸­åœ¨ <code>Field</code> æ¸²æŸ“è¿™å—ï¼Œ<code>Input</code> çš„æ”¹åŠ¨æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œé‚£ä¹ˆé¡¶å±‚çš„ <code>context</code> ä¿®æ”¹çš„ä¹Ÿéå¸¸é¢‘ç¹ï¼Œå³ä½¿ä½¿ç”¨äº† <code>useMemo</code> ä»ç„¶è¿˜æœ‰å¡é¡¿çš„ç°è±¡ã€‚<code>React æˆå‘˜ Dan</code> åœ¨ twitter ä¸­è¯´è¿‡ <code>context</code> å¹¶ä¸é€‚åˆä¿®æ”¹ç‰¹åˆ«é¢‘ç¹çš„ç»„ä»¶ï¼Œæ¯”å¦‚ <code>Input</code>, ä½†æ˜¯åœ¨ <code>Form</code> ä¸­çš„ç¡®éœ€è¦ <code>context</code> æ¥å¤„ç†è¿™æ ·çš„é—®é¢˜ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Ÿå¦‚ä½•æ¥ä¼˜åŒ– <code>Form</code>?</p><p>ç›®å‰æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å­˜åœ¨äº† <code>Form</code> çš„é¡¶å±‚ï¼Œåœ¨é¡¶å±‚æ›´æ–°è§¦å‘å­ç»„ä»¶çš„æ›´æ–°ï¼Œé‚£ä¹ˆé’ˆå¯¹ <code>Field</code> è¿™ä¹ˆé¢‘ç¹çš„æ¸²æŸ“ï¼Œèƒ½å¦åšåˆ°æ¯æ¬¡ä¿®æ”¹å½“å‰ <code>Field</code> çš„æ—¶å€™ï¼Œåªä¼šæ¸²æŸ“å½“å‰çš„ <code>Field</code> å‘¢ï¼Ÿ</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>Form.js</code> ä¸­é¦–å…ˆæœ‰ä¸‰ä¸ª <code>context</code> åˆ†åˆ«æ˜¯ <code>formContext</code>, <code>formStateContext</code>, <code>formApiContext</code>ã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ä¸€ä¸ª context å‘¢ï¼Ÿå› ä¸ºé€šè¿‡ä¸‰ä¸ª context, æŠŠå„è‡ªçš„èŒèƒ½è¿›è¡ŒåŒºåˆ†ã€‚å¤šä¸ª context ä¹Ÿèƒ½èµ·åˆ°ä¼˜åŒ–çš„ä½œç”¨ï¼Œæ¯”å¦‚</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é‚£ä¹ˆæ¯æ¬¡ <code>formStateContext</code> çš„ value æ›´æ–°çš„æ—¶å€™ï¼Œ<code>formApiContext</code> çš„ä½¿ç”¨å¤„çš†ä¸å—å½±å“ï¼Œ<code>A</code> ç»„ä»¶ä¸ä¼šå› ä¸º <code>B</code> ç»„ä»¶ä½¿ç”¨çš„ <code>context</code> çš„å€¼çš„å˜åŒ–è€Œè¿›è¡Œæ›´æ–°ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨å¤šä¸ª <code>context</code>ã€‚</p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨ <code>useForm.js</code> ä¸­å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>useReducer</code>, è¿™é‡Œä¸»è¦ä¸ºäº†é˜è¿°æ€æƒ³ï¼Œä½¿ç”¨ <code>useState</code>ã€‚æœ‰ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ <code>setValue</code> å’Œ <code>setError</code>, <code>setValue:</code> æ˜¯ç”¨æ¥æ›´æ–°ä¿®æ”¹çš„å€¼ï¼Œ <code>setError:</code> ç”¨æ¥è®¾ç½®é”™è¯¯çš„ä¿¡æ¯ã€‚<code>useRegister</code> è¿™é‡Œå…ˆæš‚ä¸è®¨è®ºï¼Œå…ˆçœ‹ä¸€ä¸‹å¸¸è§„çš„ <code>Field</code> ç»„ä»¶ã€‚</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸€ä¸ªç®€å•çš„ <code>Field</code> ç”¨äºä¿®æ”¹ <code>form</code> çš„å€¼ï¼Œå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Field name<span class="token operator">=</span><span class="token string">'name'</span><span class="token operator">></span>
  <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> handleChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
</code></pre><p>è¿™å°±æ˜¯ <code>Field</code> çš„ç®€å•ç”¨æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ï¼Œåªè¦ä½¿ç”¨ <code>Field</code> çš„ç»„ä»¶åœ¨å…¶ä¸­ä¸€ä¸ª <code>Field</code> ç»„ä»¶å‘ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œå…¶ä»–çš„æ‰€æœ‰çš„ <code>Field</code> ç»„ä»¶ä¹Ÿä¼šå‘ç”Ÿæ›´æ–°ã€‚å› ä¸ºåœ¨æ¯æ¬¡æ›´æ–°å€¼çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>setValue</code>, <code>useForm</code> æ›´æ–°ï¼Œè¿”å›æ–°çš„å€¼ï¼Œ<code>context</code> çš„ value å‘ç”Ÿå˜åŒ–ï¼Œæ‰€æœ‰ç”¨åˆ° <code>context</code> åœ°æ–¹éƒ½ä¼šå‘ç”Ÿæ›´æ–°ã€‚æ­¤æ—¶ä¹Ÿè®¸ä¼šæƒ³åˆ°æ¯æ¬¡è¿”å›çš„ <code>formApi</code> éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡å¥½åƒæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ˜¯çš„ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹å‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šä¸ª <code>context</code>, å› ä¸ºæ¯æ¬¡éƒ½æ˜¯æ–°çš„å¼•ç”¨è¿™æ˜¯å®Œå…¨æ²¡æœ‰æ„ä¹‰çš„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯åº”è¯¥è¿›è¡Œç¼“å­˜å‘¢ï¼Ÿè²Œä¼¼è¿™ç§æƒ³æ³•æ˜¯å¯ä»¥çš„ï¼ŒOKï¼Œåšä¸‹å»ã€‚</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨å†Œå™¨ï¼Œç”¨äºè°ƒç”¨å±€éƒ¨æ›´æ–°å‡½æ•°</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä½¿ç”¨ <code>useState</code> å¯¹ <code>formApi</code> è¿›è¡Œç¼“å­˜ï¼Œç°åœ¨æ¯æ¬¡æ›´æ–°ï¼Œ<code>formApi</code> éƒ½æ˜¯ä¹‹å‰çš„å¼•ç”¨ä¸åœ¨æ˜¯æ–°çš„å¼•ç”¨ï¼Œæ¯æ¬¡å‘ç”Ÿå˜åŒ–çš„æ˜¯ <code>formState</code>, æ­¤æ—¶ä¿®æ”¹ <code>Input</code> çš„å€¼å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<code>Input</code> è¾“å…¥ä¸è¿›å»äº†ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨ <code>Field</code> ç»„ä»¶æ˜¯ä½¿ç”¨äº† <code>useFormApi</code></p><p><code>useFormApi.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formApiContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½†æ˜¯å› ä¸ºåœ¨ <code>Form</code> ä¸­å¯¹ <code>formApi</code> è¿›è¡Œäº†ç¼“å­˜ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>useFormApi</code> çš„ç»„ä»¶éƒ½ä¸ä¼šé‡æ–° <code>render</code>, æ‰€ä»¥ <code>Input</code> ä¸­çš„å€¼ä¼šè¾“å…¥ä¸è¿›å»ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯éœ€è¦æŠŠåœ¨ <code>Field</code> ç»„ä»¶ä¸­åœ¨ä½¿ç”¨ <code>useFormState</code> å‘¢ï¼Ÿ</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formState <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚ä½•ä½¿ç”¨ <code>useFormState</code> çš„è¯ï¼Œ é‚£å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Œå› ä¸ºæ¯ä¸€ä¸ª <code>Field</code> éƒ½ä¼šè¿›è¡Œ <code>render</code>, æ‰€ä»¥è¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ <code>useFormApi</code>, ç°åœ¨è€ƒè™‘ä¸€ä¸‹å¦‚ä½•è®©å•ä¸ª <code>Field</code> æ¸²æŸ“ä¸å½±å“å…¶ä»–çš„å‘¢ï¼Ÿ</p><p>åœ¨ä¸šåŠ¡ä¸­ï¼Œå†™ç»„ä»¶çš„æ—¶å€™ï¼Œä¸¤ä¸ªç»„ä»¶å¦‚ä½•åšåˆ°äº’ä¸å½±å“ï¼Œé‚£å°±æ˜¯ç»„ä»¶ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œæ¯”å¦‚:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'lanyincao'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ <code>A</code> ç»„ä»¶çš„çŠ¶æ€åªåœ¨è‡ªå·±çš„ç»„ä»¶çš„å†…éƒ¨ï¼Œæ‰€ä»¥æœ¬èº« <code>A</code> ç»„ä»¶çš„æ›´æ–°å¹¶ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ç»„ä»¶çš„å˜åŒ–ã€‚é‚£æ˜¯å¦ <code>Field</code> ç»„ä»¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšå‘¢ï¼Ÿ</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// å‡è®¾æ‰€æœ‰çš„</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> register <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ä½ç½®å†…éƒ¨å€¼çš„çŠ¶æ€</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    register<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      setValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ­¤æ—¶ç”¨è¿‡ä¸€ä¸ª register æŠŠæ¯ä¸€ä¸ª <code>Field</code> çš„ setValue æ³¨å†Œè¿›å»ï¼Œå¾ˆå¤šå…¶ä»–çš„é«˜æ€§èƒ½çš„ <code>Form</code> éƒ½æ˜¯é‡‡å– <code>Observer</code> çš„å½¢å¼çš„ï¼ŒåŒ…æ‹¬ <code>react-redux</code> å¦‚ä½•è§£å†³æ€§èƒ½é—®é¢˜çš„ï¼Œéƒ½æ˜¯é€šè¿‡ <code>Observer</code> çš„å½¢å¼ã€‚çœ‹ä¸‹ <code>useRegister</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">unregister</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> unregister <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æŠŠ <code>Form</code> ä¸­çš„ <code>useRegister</code> ç§»åˆ° <code>useForm</code> ä¸­, ä¿®æ”¹ <code>useForm</code> çš„è¿”å›å€¼, ä»¥åŠä¿®æ”¹ <code>setValue</code></p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useRegister <span class="token keyword">from</span> <span class="token string">'./register'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–åˆ°å½“å‰ä¿®æ”¹çš„ field</span>
    <span class="token keyword">const</span> currentField <span class="token operator">=</span> fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨å†…éƒ¨çš„ setValue</span>
    currentField<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å•ä¸ªé”™è¯¯ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªå€¼</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–å•ä¸ªé”™è¯¯</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç¼“å­˜ api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldsApi<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ç°åœ¨ä¿®æ”¹å…¶ä¸­ä¸€ä¸ª <code>Field</code> çš„æ—¶å€™ä¼šè°ƒç”¨å†…éƒ¨çš„ <code>setValue</code> æ–¹æ³•ï¼Œå®ç°å±€éƒ¨æ¸²æŸ“ã€‚</p><h2 id="conclusion">conclusion</h2><ul><li><code>context</code> æ¯”è¾ƒé€‚åˆäºæ”¹åŠ¨ä¸æ˜¯å¾ˆé¢‘ç¹çš„ç»„ä»¶</li><li>å¯¹äº render æ—¶é—´è¾ƒé•¿çš„å¯ä»¥ä½¿ç”¨ <code>useMemo</code> æ¥ä¼˜åŒ–</li><li>å˜åŠ¨é¢‘ç¹çš„å¯ä»¥é‡‡ç”¨å·²æœ‰çš„çŠ¶æ€ç®¡ç†åº“æ¯”å¦‚ <a class=" " href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> æˆ–è€…é‡‡å– <code>Observer</code> çš„å½¢å¼æ¥å¤„ç†</li></ul></div><footer class="BlogPostLayout_footer__1p0Ii"><h3 class="BlogPostLayout_title__1egAZ"><a class=" " href="/">lanyincao</a></h3><div class="
      Bio_Bio__1eiKY
      BlogPostLayout_bio__2AHhA
    "><img src="/static/media/bio-pic.fdbb64ab.jpeg" alt="lanyincao"/><p>Personal blog by <a href="https://twitter.com/lanyincao">lanyincao</a>.<br/>I can&#x27;t sing, dance, rap but can code, ğŸ€</p></div><section class="BlogPostLayout_links__1fVhZ"><a class=" " href="/posts/2019-08-24/how-to-use-context-efficient/">â† <!-- -->How to use context efficient</a><a class="BlogPostLayout_next__3tOcG " href="/posts/2019-08-10/context/">React Context ğŸ˜<!-- --> â†’</a></section></footer></article></main></div></div><script>!function(o){function e(e){for(var t,r,n=e[0],c=e[1],f=e[2],d=0,a=[];d<n.length;d++)r=n[d],l[r]&&a.push(l[r][0]),l[r]=0;for(t in c)Object.prototype.hasOwnProperty.call(c,t)&&(o[t]=c[t]);for(p&&p(e);a.length;)a.shift()();return i.push.apply(i,f||[]),u()}function u(){for(var e,t=0;t<i.length;t++){for(var r=i[t],n=!0,c=1;c<r.length;c++){var f=r[c];0!==l[f]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},a={43:0},l={43:0},i=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(i){var e=[];a[i]?e.push(a[i]):0!==a[i]&&{1:1,23:1}[i]&&e.push(a[i]=new Promise(function(e,n){for(var t="static/css/"+({}[i]||i)+"."+{1:"27c8494b",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0",16:"31d6cfe0",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0",20:"31d6cfe0",21:"31d6cfe0",22:"31d6cfe0",23:"d3b34b05",24:"31d6cfe0",25:"31d6cfe0",26:"31d6cfe0",27:"31d6cfe0",28:"31d6cfe0",29:"31d6cfe0",30:"31d6cfe0",31:"31d6cfe0",32:"31d6cfe0",33:"31d6cfe0",34:"31d6cfe0",35:"31d6cfe0",36:"31d6cfe0",37:"31d6cfe0",38:"31d6cfe0",39:"31d6cfe0",40:"31d6cfe0",41:"31d6cfe0"}[i]+".chunk.css",c=s.p+t,r=document.getElementsByTagName("link"),f=0;f<r.length;f++){var d=(o=r[f]).getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(d===t||d===c))return e()}var a=document.getElementsByTagName("style");for(f=0;f<a.length;f++){var o;if((d=(o=a[f]).getAttribute("data-href"))===t||d===c)return e()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=e,u.onerror=function(e){var t=e&&e.target&&e.target.src||c,r=new Error("Loading CSS chunk "+i+" failed.\n("+t+")");r.request=t,n(r)},u.href=c,document.getElementsByTagName("head")[0].appendChild(u)}).then(function(){a[i]=0}));var r=l[i];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[i]=[e,t]});e.push(r[2]=t);var n,c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.charset="utf-8",f.timeout=120,s.nc&&f.setAttribute("nonce",s.nc),f.src=s.p+"static/js/"+({}[i]||i)+"."+{1:"18016ef5",2:"f51ae852",3:"2d812e0c",4:"959e45b9",5:"031228ef",6:"da64b01a",7:"c20265b4",8:"3708fc80",9:"76d5a1f1",10:"64d279dc",11:"15bdaa3d",12:"a289339e",13:"6ed3fae5",14:"c0219476",15:"1b2dfa34",16:"c95df50e",17:"854d2668",18:"fe4e0156",19:"75b2ab08",20:"5cc3e2dd",21:"85a6bb34",22:"f5b6dab9",23:"873b678f",24:"299ad1b2",25:"26732315",26:"8ed938bb",27:"9e08b9c8",28:"8c5bf47d",29:"651315e7",30:"4de03612",31:"a827ef55",32:"9f8e8c89",33:"4e98a6ac",34:"8fa7acd9",35:"f7fd16e7",36:"c8a9136e",37:"7fd46dad",38:"ab859197",39:"242ef20f",40:"a8b763a6",41:"fe59cd2f"}[i]+".chunk.js",n=function(e){f.onerror=f.onload=null,clearTimeout(d);var t=l[i];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,c=new Error("Loading chunk "+i+" failed.\n("+r+": "+n+")");c.type=r,c.request=n,t[1](c)}l[i]=void 0}};var d=setTimeout(function(){n({type:"timeout",target:f})},12e4);f.onerror=f.onload=n,c.appendChild(f)}return Promise.all(e)},s.m=o,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var c=0;c<t.length;c++)e(t[c]);var p=n;u()}([])</script><script src="/static/js/42.e4ff5a7a.chunk.js"></script><script src="/static/js/main.763db4b1.chunk.js"></script></body></html>