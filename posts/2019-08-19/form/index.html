<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="shortcut icon" href="/fa.jpg"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="theme-color" content="#000000"/><link rel="manifest" href="/manifest.json"/>
    <title>🤔 Form</title>
    <link rel="canonical" href="/posts/2019-08-19/form" />
    <link rel="stylesheet" href="/static/css/1.27c8494b.chunk.css" />
  <link href="/static/css/main.0e6724e3.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__1wjbv"><div class="
        LoadingIndicator_LoadingIndicator__LXZCC
        
        undefined
      "></div><header><h3 class="BlogLayout_title__U0zfd"><a class=" " href="/">lanyincao</a></h3></header><main><article><header class="BlogPostLayout_header__6lPZ1"><h1 class="BlogPostLayout_title__1egAZ"><a class=" " href="/posts/2019-08-19/form/">🤔 Form</a></h1><small><time dateTime="Sun, 18 Aug 2019 16:00:00 GMT">August 19, 2019</time> <!-- -->•<!-- --> <ul class="ArticleMeta_tags__30Wbg"><li><a class=" " href="/tags/react/">react</a></li><li><a class=" " href="/tags/form/">form</a></li></ul> <!-- -->•<!-- --> <span>☕️<!-- --> <!-- -->7<!-- --> min read</span></small></header><div class="BlogPostLayout_content__1CRXP"><p>表单组件是在 <code>B端</code> 开发中最常用的一个组件，比如 <code>Input</code>, <code>Textarea</code>, <code>DatePicker</code> 等等，这些都是常用的表单类组件，然而表单的管理确是比较复杂的部分。常规在开发表单的时候，很多时候可能不使用 <code>Form</code> 这样的组件而是这样</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">submit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>姓名<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>name<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>年龄<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>age<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> age<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>label<span class="token operator">></span>地址<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>address<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>person<span class="token punctuation">,</span> address<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">></span>提交<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>如果不使用基础的 <code>form</code> 标签，基础表单基本上都是这么写的，声明表单中所需要的状态，对应的 <code>value</code> 与各自的组件对应起来，如果存在校验信息的是，还需要进行校验。因为表单很多时候是需要进行实时校验的，及时让用户发现问题，然后能及时改正问题。那这样每一个 <code>Input</code> 这样的组件都应该需要 <code>validate</code> 这样的一个校验函数，还有是否在 <code>onChange</code> 时候校验还是在 <code>onBlur</code> 的时候校验，这些都是需要考虑的问题。如果我们的状态不是特别多的情况下，这样写是没有什么问题的？但是即使是这样简单的表单，如果此时是 <code>A</code> 页面需要这样的表单， <code>B</code> 页面也同样需要这样的表单，<code>validate</code> 等都需要。那么要不去拷贝代码过来修改一下，要不自己封装一个 <code>Form</code> 来解决这个问题。</p><h2 id="封装-form-">封装 Form 😲</h2><p>考虑一下上面的代码如何封装成一个 <code>Form</code> 呢？就像上面的代码一样，组件的名称已经命名为 <code>Form</code> 了, 是否这样就可以了呢？如果存在这样的结构呢？</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span>'<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span>'<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span>' <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span>'<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span>'<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>此时 <code>C</code> 组件内部才用了 <code>Input</code> 这样的组件，那如果在 <code>C&#x27;</code> 组件中用到了 <code>C</code> 组件的信息怎么办呢？
遇到这种场景通常的做法叫做 <code>lifting state up</code>, 状态提升，在更新 <code>C</code> 组件的时候，把状态同步更新到 <code>Form</code> 组件， <code>Form</code> 组件又把这个数据传递到 <code>C&#x27;</code> 组件， <code>C&#x27;</code> 组件拿到了正确的数据。<code>Nice</code>, 通过状态提升，成功的解决了这样的问题。但是这样每次就需要在 <code>Form</code> 中存储状态，然后还需要传递回调函数到需要的组件中，更新相应的状态。如果组件嵌套只有 <code>2 - 3</code> 层的时候，这样是完全没有问题的。但是如果组件嵌套有很多层呢？比如此时 <code>E 组件</code> 才是 <code>Input</code> 组件的所在，那么这样嵌套下去传递</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token constant">D</span><span class="token operator">></span>
          <span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">D</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">C</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">B</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>的层数只会越来越多，后面维护起来要每一层每一层去看，防止其中一层出现问题了。针对这样的问题，如何解决呢？很多童鞋会想到 <code>react-redux</code>, <code>mbox</code> 通过状态管理工具来解决这样的传递的问题，恭喜思路是完全正确的，通过目前的一些状态管理库是可以做到的。不妨以 <code>react-redux</code> 举例， <code>react-redux</code> 内部使用了 <code>React Context</code>, 是的， <code>React</code> 团队为了解决这种问题，提供了 <code>context</code> 这样的 <code>api</code>, 那么 <code>context</code> 如何使用呢？</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> createContext<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> FormContext <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch<span class="token punctuation">:</span> setValue <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>首先需要使用 <code>React.createContext</code> 来创建一个 <code>context</code>, 然后在组件中使用 <code>context.Provider</code>, <code>context.Provider</code> 接受一个 <code>value</code> props， 如何获取到 <code>value</code> 中的值</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>FormContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>通过在<code>子组件</code>中使用 <code>useContext()</code> 获取到相应的 value, 如果在 <code>class 组件</code>中则</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Field</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>FormContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>使用 <code>FormContext.Consumer</code> 的方式，这是一个 <code>render props</code> 的组件。因为一个普通的 <code>Form</code> 就可以简洁的完成了, 首先在 <code>Form</code> 组件中利用 <code>context.Provider</code> 把想要的值和方法传递下去，在 <code>Field</code> 组件中拿到 <code>value</code> 和 <code>dispatch</code>, 这样就解决了多层传递状态的问题。这样简约的表单用起来很爽，但是随着业务的慢慢复杂，需要的功能也会越来越多，表单中的组件也会越来越多，比如</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Form<span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Field <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">></span>
</code></pre><p>有可能这样的 <code>Field</code> 组件可能有几十个甚至上百个，然后发现表单变得越来越慢越来越慢，这是为什么呢？因为在 <code>Field</code> 组件中每次执行 <code>dispatch</code> 都会修改顶层的 value, 顶层的 <code>value</code> 发生变化了，这样每一个 <code>Field</code> 组件都会被渲染，只要是使用了 <code>useContext()</code> 这样的组件都会被渲染，这个渲染的量可能非常非常的大，及时一个简单的 <code>Input</code> 修改了其中的一个值，也会造成整个 <code>Form</code> 重新 render, 一两次 render 可能耗时非常少，但是当达到上百个的时候，此时的 <code>render</code> 耗时就会非常非常的高。可能这第一个 <code>Field</code> 中只修改了 <code>a</code> 属性，可是其他的 <code>Field</code> 中都没有用到 <code>a</code> 属性，其余的子组件的渲染是多余的。但是 <code>context</code> 是无法被 <code>bail out</code> 的, 所以所有的 <code>Field</code> 都会渲染，那么不妨控制下 <code>Field</code> 的子组件</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Sub name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> validate<span class="token operator">=</span><span class="token punctuation">{</span>validate<span class="token punctuation">}</span> validateOnChange <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> validate<span class="token punctuation">,</span> validateOnchange<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>此时 <code>Field</code> 组件通过使用 <code>useMemo</code> 进行缓存，只有当数组的值发生变化的时候，才会再一次重新 <code>render</code>, <code>useMemo</code> 的作用和 <code>react-redux</code> 的 <code>connect</code> 高阶函数的作用是一样的，通过使用 <code>useMemo</code> 可以把 <code>render 时间长的子组件</code> 进行缓存，减少 <code>render</code> 时间，提升性能。</p><h2 id="optimize-form-">optimize form 😊</h2><p>此时是否已经完成了整个 <code>Form</code> 的优化过程了，此时的 <code>Form</code>, 包括常规使用的 <code>context</code> 通过 <code>memo</code> 进行优化实际上已经提高了很多。但是即使是单纯的一个 <code>Field</code> 组件，如果数量很多的情况下仍然还是会存在卡顿的情况的。特别是当接入了第三方组件库的时候。本身第三方组件提供的功能有很多，组件本身也会很复杂，不像原生的 <code>input</code> 那样简单，假设此时接入的是 <code>antd</code> 的组件库</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">CustomInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Field<span class="token operator">></span>
      <span class="token operator">&lt;</span>Input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>在对 <code>Input</code> 进行快速输入的时候，可以看到页面的响应会有所延迟，如果打开 <code>chrome</code> 的 <code>performance</code> 进行录制的时候，就会看到一个长任务，关于 <code>长任务</code> 这里不做详细描述，这种可以通过时间分片（time slicing） 来解决这样的问题。但是我们集中在 <code>Field</code> 渲染这块，<code>Input</code> 的改动是非常频繁的，那么顶层的 <code>context</code> 修改的也非常频繁，即使使用了 <code>useMemo</code> 仍然还有卡顿的现象。<code>React 成员 Dan</code> 在 twitter 中说过 <code>context</code> 并不适合修改特别频繁的组件，比如 <code>Input</code>, 但是在 <code>Form</code> 中的确需要 <code>context</code> 来处理这样的问题。那么是否可以解决这样的问题？如何来优化 <code>Form</code>?</p><p>目前所有的数据都是存在了 <code>Form</code> 的顶层，在顶层更新触发子组件的更新，那么针对 <code>Field</code> 这么频繁的渲染，能否做到每次修改当前 <code>Field</code> 的时候，只会渲染当前的 <code>Field</code> 呢？</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册器，用于调用局部更新函数</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>在 <code>Form.js</code> 中首先有三个 <code>context</code> 分别是 <code>formContext</code>, <code>formStateContext</code>, <code>formApiContext</code>。为什么不使用一个 context 呢？因为通过三个 context, 把各自的职能进行区分。多个 context 也能起到优化的作用，比如</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>那么每次 <code>formStateContext</code> 的 value 更新的时候，<code>formApiContext</code> 的使用处皆不受影响，<code>A</code> 组件不会因为 <code>B</code> 组件使用的 <code>context</code> 的值的变化而进行更新。这也是为什么使用多个 <code>context</code>。</p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置单个值</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置单个错误信息</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取单个值</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取单个错误</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>在 <code>useForm.js</code> 中声明了一个状态，也可以使用 <code>useReducer</code>, 这里主要为了阐述思想，使用 <code>useState</code>。有两个函数分别是 <code>setValue</code> 和 <code>setError</code>, <code>setValue:</code> 是用来更新修改的值， <code>setError:</code> 用来设置错误的信息。<code>useRegister</code> 这里先暂不讨论，先看一下常规的 <code>Field</code> 组件。</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// 假设所有的</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>一个简单的 <code>Field</code> 用于修改 <code>form</code> 的值，如何使用？</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>Field name<span class="token operator">=</span><span class="token string">'name'</span><span class="token operator">></span>
  <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> handleChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Input value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Field<span class="token operator">></span>
</code></pre><p>这就是 <code>Field</code> 的简单用法，但是此时，只要使用 <code>Field</code> 的组件在其中一个 <code>Field</code> 组件发生更新的时候，其他的所有的 <code>Field</code> 组件也会发生更新。因为在每次更新值的时候，调用 <code>setValue</code>, <code>useForm</code> 更新，返回新的值，<code>context</code> 的 value 发生变化，所有用到 <code>context</code> 地方都会发生更新。此时也许会想到每次返回的 <code>formApi</code> 都是一个新的对象好像是没有意义的，是的，这里是没有意义的，这也是之前为什么要使用多个 <code>context</code>, 因为每次都是新的引用这是完全没有意义的，那么是不是应该进行缓存呢？貌似这种想法是可以的，OK，做下去。</p><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册器，用于调用局部更新函数</span>
  <span class="token keyword">const</span> fieldRegister <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 缓存 api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldRegister<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>api<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>使用 <code>useState</code> 对 <code>formApi</code> 进行缓存，现在每次更新，<code>formApi</code> 都是之前的引用不在是新的引用，每次发生变化的是 <code>formState</code>, 此时修改 <code>Input</code> 的值发现一个问题，就是<code>Input</code> 输入不进去了？为什么呢？</p><p>因为在 <code>Field</code> 组件是使用了 <code>useFormApi</code></p><p><code>useFormApi.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formApiContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formApiContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>但是因为在 <code>Form</code> 中对 <code>formApi</code> 进行了缓存，所以使用 <code>useFormApi</code> 的组件都不会重新 <code>render</code>, 所以 <code>Input</code> 中的值会输入不进去。那么是不是需要把在 <code>Field</code> 组件中在使用 <code>useFormState</code> 呢？</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useContxt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useFormState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formState <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formStateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> formState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>如何使用 <code>useFormState</code> 的话， 那就没有意义了，因为每一个 <code>Field</code> 都会进行 <code>render</code>, 所以还需要继续使用 <code>useFormApi</code>, 现在考虑一下如何让单个 <code>Field</code> 渲染不影响其他的呢？</p><p>在业务中，写组件的时候，两个组件如何做到互不影响，那就是组件管理自己的状态，比如:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>name<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'lanyincao'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>setAge<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>此时 <code>A</code> 组件的状态只在自己的组件的内部，所以本身 <code>A</code> 组件的更新并不会影响到其他的组件的变化。那是否 <code>Field</code> 组件也可以这么做呢？</p><p><code>Field.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useFormApi <span class="token keyword">from</span> <span class="token string">'./useFormApi'</span><span class="token punctuation">;</span>

<span class="token comment">// 假设所有的</span>
<span class="token keyword">const</span> <span class="token function-variable function">Field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formApi <span class="token operator">=</span> <span class="token function">useFormApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> register <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>formContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 位置内部值的状态</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    formApi<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    register<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      setValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> formApi<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    handleChange
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>此时用过一个 register 把每一个 <code>Field</code> 的 setValue 注册进去，很多其他的高性能的 <code>Form</code> 都是采取 <code>Observer</code> 的形式的，包括 <code>react-redux</code> 如何解决性能问题的，都是通过 <code>Observer</code> 的形式。看下 <code>useRegister</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">unregister</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> unregister <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>把 <code>Form</code> 中的 <code>useRegister</code> 移到 <code>useForm</code> 中, 修改 <code>useForm</code> 的返回值, 以及修改 <code>setValue</code></p><p><code>useForm.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useRegister <span class="token keyword">from</span> <span class="token string">'./register'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    values<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>fields<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置单个值</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneValues <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>values<span class="token punctuation">,</span> name<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取到当前修改的 field</span>
    <span class="token keyword">const</span> currentField <span class="token operator">=</span> fields<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> values<span class="token punctuation">:</span> cloneValues <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用内部的 setValue</span>
    currentField<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置单个错误信息</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneErrors <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> name<span class="token punctuation">:</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> errors<span class="token punctuation">:</span> cloneErrors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取单个值</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>values<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取单个错误</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getError</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> setValue<span class="token punctuation">,</span> setError <span class="token punctuation">}</span><span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><code>Form.js</code></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formContext<span class="token punctuation">,</span> formApiContext<span class="token punctuation">,</span> formStateContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useForm <span class="token keyword">from</span> <span class="token string">'./useForm'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 useForm</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>formState<span class="token punctuation">,</span> formApi<span class="token punctuation">,</span> fieldsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 缓存 api</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>formApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>formContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>fieldsApi<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>formStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formState<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>formApiContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>formApi<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>formApiContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>formStateContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>formContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>现在修改其中一个 <code>Field</code> 的时候会调用内部的 <code>setValue</code> 方法，实现局部渲染。</p><h2 id="conclusion">conclusion</h2><ul><li><code>context</code> 比较适合于改动不是很频繁的组件</li><li>对于 render 时间较长的可以使用 <code>useMemo</code> 来优化</li><li>变动频繁的可以采用已有的状态管理库比如 <a class=" " href="https://github.com/snakeUni/react-redux-chaos">react-redux-chaos</a> 或者采取 <code>Observer</code> 的形式来处理</li></ul></div><footer class="BlogPostLayout_footer__1p0Ii"><h3 class="BlogPostLayout_title__1egAZ"><a class=" " href="/">lanyincao</a></h3><div class="
      Bio_Bio__1eiKY
      BlogPostLayout_bio__2AHhA
    "><img src="/static/media/bio-pic.fdbb64ab.jpeg" alt="lanyincao"/><p>Personal blog by <a href="https://twitter.com/lanyincao">lanyincao</a>.<br/>I can&#x27;t sing, dance, rap but can code, 🏀</p></div><section class="BlogPostLayout_links__1fVhZ"><a class=" " href="/posts/2019-08-24/how-to-use-context-efficient/">← <!-- -->How to use context efficient</a><a class="BlogPostLayout_next__3tOcG " href="/posts/2019-08-10/context/">React Context 😁<!-- --> →</a></section></footer></article></main></div></div><script>!function(o){function e(e){for(var t,r,n=e[0],c=e[1],f=e[2],d=0,a=[];d<n.length;d++)r=n[d],l[r]&&a.push(l[r][0]),l[r]=0;for(t in c)Object.prototype.hasOwnProperty.call(c,t)&&(o[t]=c[t]);for(p&&p(e);a.length;)a.shift()();return i.push.apply(i,f||[]),u()}function u(){for(var e,t=0;t<i.length;t++){for(var r=i[t],n=!0,c=1;c<r.length;c++){var f=r[c];0!==l[f]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},a={43:0},l={43:0},i=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(i){var e=[];a[i]?e.push(a[i]):0!==a[i]&&{1:1,23:1}[i]&&e.push(a[i]=new Promise(function(e,n){for(var t="static/css/"+({}[i]||i)+"."+{1:"27c8494b",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0",16:"31d6cfe0",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0",20:"31d6cfe0",21:"31d6cfe0",22:"31d6cfe0",23:"d3b34b05",24:"31d6cfe0",25:"31d6cfe0",26:"31d6cfe0",27:"31d6cfe0",28:"31d6cfe0",29:"31d6cfe0",30:"31d6cfe0",31:"31d6cfe0",32:"31d6cfe0",33:"31d6cfe0",34:"31d6cfe0",35:"31d6cfe0",36:"31d6cfe0",37:"31d6cfe0",38:"31d6cfe0",39:"31d6cfe0",40:"31d6cfe0",41:"31d6cfe0"}[i]+".chunk.css",c=s.p+t,r=document.getElementsByTagName("link"),f=0;f<r.length;f++){var d=(o=r[f]).getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(d===t||d===c))return e()}var a=document.getElementsByTagName("style");for(f=0;f<a.length;f++){var o;if((d=(o=a[f]).getAttribute("data-href"))===t||d===c)return e()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=e,u.onerror=function(e){var t=e&&e.target&&e.target.src||c,r=new Error("Loading CSS chunk "+i+" failed.\n("+t+")");r.request=t,n(r)},u.href=c,document.getElementsByTagName("head")[0].appendChild(u)}).then(function(){a[i]=0}));var r=l[i];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[i]=[e,t]});e.push(r[2]=t);var n,c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.charset="utf-8",f.timeout=120,s.nc&&f.setAttribute("nonce",s.nc),f.src=s.p+"static/js/"+({}[i]||i)+"."+{1:"18016ef5",2:"f51ae852",3:"2d812e0c",4:"959e45b9",5:"031228ef",6:"da64b01a",7:"c20265b4",8:"3708fc80",9:"76d5a1f1",10:"64d279dc",11:"15bdaa3d",12:"a289339e",13:"6ed3fae5",14:"c0219476",15:"1b2dfa34",16:"c95df50e",17:"854d2668",18:"fe4e0156",19:"75b2ab08",20:"5cc3e2dd",21:"85a6bb34",22:"f5b6dab9",23:"873b678f",24:"299ad1b2",25:"26732315",26:"8ed938bb",27:"9e08b9c8",28:"8c5bf47d",29:"651315e7",30:"4de03612",31:"a827ef55",32:"9f8e8c89",33:"4e98a6ac",34:"8fa7acd9",35:"f7fd16e7",36:"c8a9136e",37:"7fd46dad",38:"ab859197",39:"242ef20f",40:"a8b763a6",41:"fe59cd2f"}[i]+".chunk.js",n=function(e){f.onerror=f.onload=null,clearTimeout(d);var t=l[i];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,c=new Error("Loading chunk "+i+" failed.\n("+r+": "+n+")");c.type=r,c.request=n,t[1](c)}l[i]=void 0}};var d=setTimeout(function(){n({type:"timeout",target:f})},12e4);f.onerror=f.onload=n,c.appendChild(f)}return Promise.all(e)},s.m=o,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var c=0;c<t.length;c++)e(t[c]);var p=n;u()}([])</script><script src="/static/js/42.e4ff5a7a.chunk.js"></script><script src="/static/js/main.763db4b1.chunk.js"></script></body></html>